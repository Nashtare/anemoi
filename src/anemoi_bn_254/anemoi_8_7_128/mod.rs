use super::{sbox, BigInteger256, Felt};
use crate::{Jive, Sponge};
use ark_ff::{Field, One, Zero};
use unroll::unroll_for_loops;

/// Digest for Anemoi
mod digest;
/// Sponge for Anemoi
mod hasher;
/// MDS matrix for Anemoi
mod mds;
/// Round constants for Anemoi
mod round_constants;

pub use digest::AnemoiDigest;
pub use hasher::AnemoiHash;

// ANEMOI CONSTANTS
// ================================================================================================

/// Function state is set to 8 field elements or 256 bytes.
/// 1 element of the state is reserved for capacity.
pub const STATE_WIDTH: usize = 8;
/// 7 elements of the state are reserved for rate.
pub const RATE_WIDTH: usize = 7;

/// The state is divided into two even-length rows.
pub const NUM_COLUMNS: usize = 4;

/// 1 element (32-bytes) is returned as digest.
pub const DIGEST_SIZE: usize = 1;

/// The number of rounds is set to 10 to provide 128-bit security level.
pub const NUM_HASH_ROUNDS: usize = 10;

// HELPER FUNCTIONS
// ================================================================================================

#[inline(always)]
/// Applies exponentiation of the current hash
/// state elements with the Anemoi S-Box.
pub(crate) fn apply_sbox(state: &mut [Felt; STATE_WIDTH]) {
    let mut x: [Felt; NUM_COLUMNS] = state[..NUM_COLUMNS].try_into().unwrap();
    let mut y: [Felt; NUM_COLUMNS] = state[NUM_COLUMNS..].try_into().unwrap();

    x.iter_mut().enumerate().for_each(|(i, t)| {
        let y2 = y[i].square();
        *t -= y2.double() + y2
    });

    let mut x_alpha_inv = x;
    x_alpha_inv
        .iter_mut()
        .for_each(|t| *t = sbox::exp_inv_alpha(t));

    y.iter_mut()
        .enumerate()
        .for_each(|(i, t)| *t -= x_alpha_inv[i]);

    x.iter_mut().enumerate().for_each(|(i, t)| {
        let y2 = y[i].square();
        *t += y2.double() + y2 + sbox::DELTA
    });

    state[..NUM_COLUMNS].copy_from_slice(&x);
    state[NUM_COLUMNS..].copy_from_slice(&y);
}

#[inline(always)]
/// Applies matrix-vector multiplication of the current
/// hash state with the Anemoi MDS matrix.
pub(crate) fn apply_mds(state: &mut [Felt; STATE_WIDTH]) {
    let x: [Felt; NUM_COLUMNS] = [state[0], state[1], state[2], state[3]];
    let y: [Felt; NUM_COLUMNS] = [state[5], state[6], state[7], state[4]];

    let sum_coeffs = x[0] + x[1] + x[2] + x[3];
    state[0] = sum_coeffs + x[2] + x[3].double();
    state[1] = sum_coeffs + x[3] + x[0].double();
    state[2] = sum_coeffs + x[0] + x[1].double();
    state[3] = sum_coeffs + x[1] + x[2].double();

    let sum_coeffs = y[0] + y[1] + y[2] + y[3];
    state[4] = sum_coeffs + y[2] + y[3].double();
    state[5] = sum_coeffs + y[3] + y[0].double();
    state[6] = sum_coeffs + y[0] + y[1].double();
    state[7] = sum_coeffs + y[1] + y[2].double();
}

// ANEMOI PERMUTATION
// ================================================================================================

/// Applies Anemoi permutation to the provided state.
#[inline(always)]
#[unroll_for_loops]
pub(crate) fn apply_permutation(state: &mut [Felt; STATE_WIDTH]) {
    for i in 0..NUM_HASH_ROUNDS {
        apply_round(state, i);
    }

    apply_mds(state)
}

/// Anemoi round function;
/// implementation based on algorithm 3 of <https://eprint.iacr.org/2020/1143.pdf>
#[inline(always)]
#[unroll_for_loops]
pub(crate) fn apply_round(state: &mut [Felt; STATE_WIDTH], step: usize) {
    // determine which round constants to use
    let c = &round_constants::C[step % NUM_HASH_ROUNDS];
    let d = &round_constants::D[step % NUM_HASH_ROUNDS];

    for i in 0..NUM_COLUMNS {
        state[i] += c[i];
        state[NUM_COLUMNS + i] += d[i];
    }

    apply_mds(state);
    apply_sbox(state);
}

#[cfg(test)]
mod tests {
    use super::*;

    fn apply_naive_mds(state: &mut [Felt; STATE_WIDTH]) {
        let x: [Felt; NUM_COLUMNS] = state[..NUM_COLUMNS].try_into().unwrap();
        let mut y: [Felt; NUM_COLUMNS] = [Felt::zero(); NUM_COLUMNS];
        y[0..NUM_COLUMNS - 1].copy_from_slice(&state[NUM_COLUMNS + 1..]);
        y[NUM_COLUMNS - 1] = state[NUM_COLUMNS];

        let mut result = [Felt::zero(); STATE_WIDTH];
        for (i, r) in result.iter_mut().enumerate().take(NUM_COLUMNS) {
            for (j, s) in x.into_iter().enumerate().take(NUM_COLUMNS) {
                *r += s * mds::MDS[i * NUM_COLUMNS + j];
            }
        }
        for (i, r) in result.iter_mut().enumerate().skip(NUM_COLUMNS) {
            for (j, s) in y.into_iter().enumerate() {
                *r += s * mds::MDS[(i - NUM_COLUMNS) * NUM_COLUMNS + j];
            }
        }

        state.copy_from_slice(&result);
    }

    #[test]
    fn test_sbox() {
        // Generated from https://github.com/Nashtare/anemoi-hash/
        let mut input = [
            [Felt::zero(); 8],
            [Felt::one(); 8],
            [
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
            ],
            [
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
            ],
            [
                Felt::new(BigInteger256([
                    0xc38d9831b5eeb362,
                    0xf28287b5d87903cb,
                    0x77122e1fe1932210,
                    0x10c0327efec2d4f2,
                ])),
                Felt::new(BigInteger256([
                    0xc92786ef36401706,
                    0x8a20ae63b18a9722,
                    0xa46e3aa52866746b,
                    0x171f04f750b92aa6,
                ])),
                Felt::new(BigInteger256([
                    0x2d312b9e86f6bae5,
                    0x3a9e35f9614de537,
                    0x128115a30ce0c590,
                    0x1be3a7d280b37f1f,
                ])),
                Felt::new(BigInteger256([
                    0xd92d3e1aed9658ff,
                    0x9964b78be5fae7f1,
                    0xa394d8a524c600d6,
                    0x27960dc4807ecb2d,
                ])),
                Felt::new(BigInteger256([
                    0x88f3041bebe1fa74,
                    0x12b8bbbfbb0d3763,
                    0x520756c78f2defe4,
                    0x2bb7b22ad62d6a5e,
                ])),
                Felt::new(BigInteger256([
                    0x1b0f7700f726dccd,
                    0x494fd0f88e76d7eb,
                    0xb5d482ef66239d2d,
                    0x26448d6cc5892362,
                ])),
                Felt::new(BigInteger256([
                    0xc8fc6075a579d3b4,
                    0x85b62e39af8496c9,
                    0x234d2e6d1eb1069f,
                    0x0589074fe43e93af,
                ])),
                Felt::new(BigInteger256([
                    0xf0376e38ca159db2,
                    0x04bd2d2c5e772bc5,
                    0x594d3e4d73d0a728,
                    0x11e688e51cfa90ab,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x683f1c2eed3e07cf,
                    0xd90b6126e8c30b86,
                    0xccd4909e4153c0d7,
                    0x06129889fd7e072b,
                ])),
                Felt::new(BigInteger256([
                    0x4bed6fcdfb669a95,
                    0x49e54b190087de07,
                    0x30df47a280a6928d,
                    0x226610b553f0267b,
                ])),
                Felt::new(BigInteger256([
                    0x228fbbe669c86fb3,
                    0xa15efec84b623e81,
                    0x13a65b4016040532,
                    0x0962f47d40b6fbc2,
                ])),
                Felt::new(BigInteger256([
                    0x688574dd58beef29,
                    0x70c21dad35fabb76,
                    0xf8d3846d9bde6b82,
                    0x08a47c417740e154,
                ])),
                Felt::new(BigInteger256([
                    0x7a32e4e689c3e705,
                    0x3c7bd29abf39cdd2,
                    0x6f6e6268ffbe4698,
                    0x21149997c027ffda,
                ])),
                Felt::new(BigInteger256([
                    0xa0c2e88678c6da4b,
                    0xbaba2c0f8089f2aa,
                    0xc025b491c9323f13,
                    0x03ae67e7de3d4421,
                ])),
                Felt::new(BigInteger256([
                    0x9892bdf8973ab717,
                    0xaf4c74ef127aa9ac,
                    0x7f598725c70f17d4,
                    0x2b7b47082c400627,
                ])),
                Felt::new(BigInteger256([
                    0x6d490a670bc35538,
                    0xfcfed09671ef9bcd,
                    0xd56582e7ea069ad5,
                    0x149b1e06921daa16,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xb06ffc19bbba9175,
                    0x99b30ad67973350c,
                    0xedce21ee38c781db,
                    0x0df1061dd7b13323,
                ])),
                Felt::new(BigInteger256([
                    0x32204270adba3c2c,
                    0x0aa7df189e472aeb,
                    0x310973fa13943b5c,
                    0x0df3c9a35443e651,
                ])),
                Felt::new(BigInteger256([
                    0x09dc52918faf3a21,
                    0x2c6eb8a9ba623290,
                    0xe157ac1c45378cb2,
                    0x14d066f7927e131c,
                ])),
                Felt::new(BigInteger256([
                    0x324c6fd059b4e731,
                    0x0d19e030ab2f95af,
                    0x10bf5c06feb63544,
                    0x1374a4e73800853e,
                ])),
                Felt::new(BigInteger256([
                    0x90083a2ccf594917,
                    0x36fbd47dcdbf2f2a,
                    0xe69cfb8cd265a0ca,
                    0x036b972e43613d96,
                ])),
                Felt::new(BigInteger256([
                    0xb739c2c0b0d4046e,
                    0xa444ddf8e161d502,
                    0xfe36b44d1c742c9f,
                    0x2bb419b32dff978a,
                ])),
                Felt::new(BigInteger256([
                    0x48b20d459d0fffe8,
                    0xcf722170c5659dd3,
                    0x3114721760577450,
                    0x2e445b29fbb1f913,
                ])),
                Felt::new(BigInteger256([
                    0x7cebe444a9759bcb,
                    0xea5efeefdba4df64,
                    0xfb2d34da42680456,
                    0x13c257d02dc67042,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xab2b529ae17a5387,
                    0xab660015b450093a,
                    0xd3037b219ac7b884,
                    0x0e00505ae9f495cd,
                ])),
                Felt::new(BigInteger256([
                    0xcd913917b51d0883,
                    0x9ee007dfb3294bed,
                    0x01a97f52ea00ceeb,
                    0x02ff163da57cbab5,
                ])),
                Felt::new(BigInteger256([
                    0xfe9d856e5f70172b,
                    0x9463eaa0f670a8a8,
                    0xd97708a70b37fed0,
                    0x0fcc1b424b8665cb,
                ])),
                Felt::new(BigInteger256([
                    0xb8f8da2a94fec87f,
                    0x540bda039ce5ecb5,
                    0xd40640a7b3a1b538,
                    0x18bb00781cdbb578,
                ])),
                Felt::new(BigInteger256([
                    0x6a116a8f68e0efcc,
                    0xb3ed6b3954d1986f,
                    0xdbc108c49e543c5e,
                    0x032f5d08e39452e4,
                ])),
                Felt::new(BigInteger256([
                    0x29c227e3c77e5860,
                    0x46aa75bc5271b948,
                    0x61bbab35d80a76b0,
                    0x00d22ce56e117d5a,
                ])),
                Felt::new(BigInteger256([
                    0xa3b8181fe099eae5,
                    0xb05ca4cf12e44f34,
                    0xdca44eb3c721714a,
                    0x0eb7874594b7d1a0,
                ])),
                Felt::new(BigInteger256([
                    0x106b0b8be7d19475,
                    0x88e14a3bd4e1ee0c,
                    0xcdb7d43cffbce290,
                    0x13981d6fc2370621,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xe167c40dff42f062,
                    0xd6750fb310ac1cd6,
                    0x1ee52cc6d0d5761a,
                    0x29813e4eb2831310,
                ])),
                Felt::new(BigInteger256([
                    0x5b97a27655e20a6f,
                    0x0252bae80d5a8ec1,
                    0x432bc2ce925f71f2,
                    0x11b15d3fe1ab8a2a,
                ])),
                Felt::new(BigInteger256([
                    0xf3ad8fb20d966eaf,
                    0x51e37bf8ce6f6bb7,
                    0x704966def7ef76fb,
                    0x2d1e7ed3e9158201,
                ])),
                Felt::new(BigInteger256([
                    0xd04298ba2ebb3dec,
                    0x5249ac27a2994c4f,
                    0xef2b62c63ed34fa4,
                    0x1c4b7380fae47a20,
                ])),
                Felt::new(BigInteger256([
                    0x543bc68baf3b7bf5,
                    0x5383ec0f0706d87c,
                    0x3683d43567d9f1c3,
                    0x0c088948f81b577c,
                ])),
                Felt::new(BigInteger256([
                    0x925966a1d9ec5892,
                    0x295b860e4eb39395,
                    0x0d4fd44e656835ad,
                    0x2ebb8e2fe4374d48,
                ])),
                Felt::new(BigInteger256([
                    0xc5ca2f075cc4bf58,
                    0x24cd79d1ee918c4e,
                    0x992dee0b8ba6db96,
                    0x2e5c6ffe7f02c084,
                ])),
                Felt::new(BigInteger256([
                    0xcd7166346f7956a5,
                    0xb81a5f7812f09896,
                    0x65ded0c123b59809,
                    0x29a4afc594a44512,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xaab8e35021a31409,
                    0x18778898e281aa82,
                    0xb7612d981b207dc7,
                    0x2ced508d522589c8,
                ])),
                Felt::new(BigInteger256([
                    0xf1dad144a023a459,
                    0xf2a8b5d86ac61014,
                    0x4a77a29934078a02,
                    0x241f2adb434735b6,
                ])),
                Felt::new(BigInteger256([
                    0x4bea7516be848c0d,
                    0x095febb177e180f5,
                    0xffb6cea9ecff4d5d,
                    0x29aed9b370c3b0d4,
                ])),
                Felt::new(BigInteger256([
                    0xef292d09fdb8be98,
                    0x9e2540682bfbd69b,
                    0xba871da2d150b240,
                    0x06b13affb24db92a,
                ])),
                Felt::new(BigInteger256([
                    0x30e5adcc28f75a5a,
                    0x7cefad37caddc29c,
                    0x86a593f676f96cce,
                    0x27f2d850457ddb0a,
                ])),
                Felt::new(BigInteger256([
                    0x08ecfd5c3d78bb26,
                    0xa95d0d2712c82c49,
                    0xf424d70db1585b7a,
                    0x19555b8a7fca25e8,
                ])),
                Felt::new(BigInteger256([
                    0x873c9d2ce3268aed,
                    0x9158c8d1b38d9c9a,
                    0x9a119005caa1d49c,
                    0x2835053d46191da1,
                ])),
                Felt::new(BigInteger256([
                    0xd80feca69819bad5,
                    0x7e9f4d3a7fc89767,
                    0xa59eed3796803246,
                    0x2beb14ba08220588,
                ])),
            ],
        ];

        let output = [
            [
                Felt::new(BigInteger256([
                    0xafd49a8c34aeae4c,
                    0xe0a8c73e1f684743,
                    0xb4ea4db753538a2d,
                    0x14cf9766d3bdd51d,
                ])),
                Felt::new(BigInteger256([
                    0xafd49a8c34aeae4c,
                    0xe0a8c73e1f684743,
                    0xb4ea4db753538a2d,
                    0x14cf9766d3bdd51d,
                ])),
                Felt::new(BigInteger256([
                    0xafd49a8c34aeae4c,
                    0xe0a8c73e1f684743,
                    0xb4ea4db753538a2d,
                    0x14cf9766d3bdd51d,
                ])),
                Felt::new(BigInteger256([
                    0xafd49a8c34aeae4c,
                    0xe0a8c73e1f684743,
                    0xb4ea4db753538a2d,
                    0x14cf9766d3bdd51d,
                ])),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
            ],
            [
                Felt::new(BigInteger256([
                    0xbebb490c2e6f962f,
                    0x465ac2ad04e364b4,
                    0xff4b8beb7ecbd2f7,
                    0x1daa245477c958e5,
                ])),
                Felt::new(BigInteger256([
                    0xbebb490c2e6f962f,
                    0x465ac2ad04e364b4,
                    0xff4b8beb7ecbd2f7,
                    0x1daa245477c958e5,
                ])),
                Felt::new(BigInteger256([
                    0xbebb490c2e6f962f,
                    0x465ac2ad04e364b4,
                    0xff4b8beb7ecbd2f7,
                    0x1daa245477c958e5,
                ])),
                Felt::new(BigInteger256([
                    0xbebb490c2e6f962f,
                    0x465ac2ad04e364b4,
                    0xff4b8beb7ecbd2f7,
                    0x1daa245477c958e5,
                ])),
                Felt::new(BigInteger256([
                    0xe07a0c33042f6fc0,
                    0xfbc9e1489023576a,
                    0xd40daa7093c5a810,
                    0x01eb281368a433ca,
                ])),
                Felt::new(BigInteger256([
                    0xe07a0c33042f6fc0,
                    0xfbc9e1489023576a,
                    0xd40daa7093c5a810,
                    0x01eb281368a433ca,
                ])),
                Felt::new(BigInteger256([
                    0xe07a0c33042f6fc0,
                    0xfbc9e1489023576a,
                    0xd40daa7093c5a810,
                    0x01eb281368a433ca,
                ])),
                Felt::new(BigInteger256([
                    0xe07a0c33042f6fc0,
                    0xfbc9e1489023576a,
                    0xd40daa7093c5a810,
                    0x01eb281368a433ca,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x9221c13bf351088f,
                    0x7ba14974192568d6,
                    0x764d83e12590a30c,
                    0x1efdfa43167d3d99,
                ])),
                Felt::new(BigInteger256([
                    0x9221c13bf351088f,
                    0x7ba14974192568d6,
                    0x764d83e12590a30c,
                    0x1efdfa43167d3d99,
                ])),
                Felt::new(BigInteger256([
                    0x9221c13bf351088f,
                    0x7ba14974192568d6,
                    0x764d83e12590a30c,
                    0x1efdfa43167d3d99,
                ])),
                Felt::new(BigInteger256([
                    0x9221c13bf351088f,
                    0x7ba14974192568d6,
                    0x764d83e12590a30c,
                    0x1efdfa43167d3d99,
                ])),
                Felt::new(BigInteger256([
                    0xa8fad3571dcabf05,
                    0x20a54df8cdb610bd,
                    0xb562a9b2221bf6a7,
                    0x113c1d95ad2f3ee3,
                ])),
                Felt::new(BigInteger256([
                    0xa8fad3571dcabf05,
                    0x20a54df8cdb610bd,
                    0xb562a9b2221bf6a7,
                    0x113c1d95ad2f3ee3,
                ])),
                Felt::new(BigInteger256([
                    0xa8fad3571dcabf05,
                    0x20a54df8cdb610bd,
                    0xb562a9b2221bf6a7,
                    0x113c1d95ad2f3ee3,
                ])),
                Felt::new(BigInteger256([
                    0xa8fad3571dcabf05,
                    0x20a54df8cdb610bd,
                    0xb562a9b2221bf6a7,
                    0x113c1d95ad2f3ee3,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xc1291cac726de779,
                    0x730b09508e12a9ad,
                    0x965495beb3b74a80,
                    0x1c9527fa5aabb1b1,
                ])),
                Felt::new(BigInteger256([
                    0xc1291cac726de779,
                    0x730b09508e12a9ad,
                    0x965495beb3b74a80,
                    0x1c9527fa5aabb1b1,
                ])),
                Felt::new(BigInteger256([
                    0xc1291cac726de779,
                    0x730b09508e12a9ad,
                    0x965495beb3b74a80,
                    0x1c9527fa5aabb1b1,
                ])),
                Felt::new(BigInteger256([
                    0xc1291cac726de779,
                    0x730b09508e12a9ad,
                    0x965495beb3b74a80,
                    0x1c9527fa5aabb1b1,
                ])),
                Felt::new(BigInteger256([
                    0x68c3488912edefaa,
                    0x8d087f6872aabf4f,
                    0x51e1a24709081231,
                    0x2259d6b14729c0fa,
                ])),
                Felt::new(BigInteger256([
                    0x68c3488912edefaa,
                    0x8d087f6872aabf4f,
                    0x51e1a24709081231,
                    0x2259d6b14729c0fa,
                ])),
                Felt::new(BigInteger256([
                    0x68c3488912edefaa,
                    0x8d087f6872aabf4f,
                    0x51e1a24709081231,
                    0x2259d6b14729c0fa,
                ])),
                Felt::new(BigInteger256([
                    0x68c3488912edefaa,
                    0x8d087f6872aabf4f,
                    0x51e1a24709081231,
                    0x2259d6b14729c0fa,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x9831e4e6b30bc309,
                    0x7fcdae2c35190e8e,
                    0xb8407cfea1f419a6,
                    0x2d7b410d62fb3875,
                ])),
                Felt::new(BigInteger256([
                    0xc611b43d34ef2cc9,
                    0x6a778ade48ef635f,
                    0x00c1ccbb8db65cba,
                    0x2d7ddac75e73b610,
                ])),
                Felt::new(BigInteger256([
                    0x009ba9fa7f866214,
                    0x5daf53e390248800,
                    0x372399ba3e2f99e7,
                    0x0810220be0d49745,
                ])),
                Felt::new(BigInteger256([
                    0x0f57237a42204f44,
                    0x0533a1938b010296,
                    0x18534a8ab9f12a7d,
                    0x245181ccfb8dcf4f,
                ])),
                Felt::new(BigInteger256([
                    0x6ded7aec7b0da43a,
                    0x505e1a4d916393c2,
                    0xbb40bcd8d1467897,
                    0x2a2f6edfdbd97519,
                ])),
                Felt::new(BigInteger256([
                    0xcc848c107ea255d9,
                    0x20720b4457a1ab8d,
                    0x45fd9ae60f781f58,
                    0x040de28450ca817b,
                ])),
                Felt::new(BigInteger256([
                    0xb66d63dc1d864bdf,
                    0xb9dfdf637365ed64,
                    0x011bb6b3216cc0bf,
                    0x01328bc1078a232e,
                ])),
                Felt::new(BigInteger256([
                    0x67d277ed7c958261,
                    0xf4079634837bb85c,
                    0x166699eacb3fd3de,
                    0x26466f85756927d7,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x273ec8f6d6e5ba0e,
                    0xaf91ea42656eb268,
                    0xf9f29b516fe2170e,
                    0x07d2d23031eb1d35,
                ])),
                Felt::new(BigInteger256([
                    0x81ba20101782c1e6,
                    0x90cc638bb797e96a,
                    0xf829499e204c5838,
                    0x27b4f9cc99eb141e,
                ])),
                Felt::new(BigInteger256([
                    0xa4b0522d46d2df43,
                    0xf1e3e5e83ed804c3,
                    0xe5739d6f8747156d,
                    0x29d26fde67689be1,
                ])),
                Felt::new(BigInteger256([
                    0x14c5d72289ff6b3a,
                    0xb5707052c59f1e51,
                    0x103c1a700ffcfd95,
                    0x1769c9e9ec9ea37c,
                ])),
                Felt::new(BigInteger256([
                    0x60f99fb4d96ad5c9,
                    0x1a54ea76f3daa2f9,
                    0x7950a2ce340b24ab,
                    0x1237d180d3f2624e,
                ])),
                Felt::new(BigInteger256([
                    0xe8ce0e0086c6a71c,
                    0x3133a0e75121014f,
                    0x04e0bf2da84dbe5c,
                    0x000143de565bcd8f,
                ])),
                Felt::new(BigInteger256([
                    0x68f8781d1cde4599,
                    0x15ed540d1aca230e,
                    0xd8dc918611689c12,
                    0x0e135f0869d0cec0,
                ])),
                Felt::new(BigInteger256([
                    0x6f992f17a12e5f9a,
                    0x70bd7873aa6ffd92,
                    0xd6031e755a364e45,
                    0x1dff9ba4c12c1562,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xe3a784d95e128799,
                    0xdbc94f4301ea65f6,
                    0x017d2514d74bd1b0,
                    0x2bdf5b1abe40e8cb,
                ])),
                Felt::new(BigInteger256([
                    0x798d49149ac9208a,
                    0xa9eb907bd52906e3,
                    0x4b12550fa89b8e83,
                    0x2b687f7d7e2a5588,
                ])),
                Felt::new(BigInteger256([
                    0x5d434ef7ec59f309,
                    0x72fae1725dfcbcec,
                    0x127da5833028d3f4,
                    0x11e345e5b742c4a9,
                ])),
                Felt::new(BigInteger256([
                    0xf19026287b90b1bd,
                    0x217dde452f81afd0,
                    0x8dc1c30dc99924e1,
                    0x08fa439f9c4b9a11,
                ])),
                Felt::new(BigInteger256([
                    0x97ac0e73c42e07f8,
                    0x67172a0b98975e0a,
                    0xa43eccdb519d4e9d,
                    0x2eb83539fe5fbef8,
                ])),
                Felt::new(BigInteger256([
                    0x0f0eaf28a0954d60,
                    0x7e135dc55743d222,
                    0x44ab754ed3854b4d,
                    0x28df51da8cf5621e,
                ])),
                Felt::new(BigInteger256([
                    0xc730272cb09d2271,
                    0x4400374e2ac99d63,
                    0x1b42d469d1a6db93,
                    0x0c0b79b4161b23e4,
                ])),
                Felt::new(BigInteger256([
                    0x68699a67eaf9f741,
                    0xac68fef884adfcf8,
                    0xc3e625c6b6cc01eb,
                    0x0265701f4816a5bc,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x4b1d36f5bc402afa,
                    0x9a83c41995ed1c09,
                    0x28335fb5741b43e6,
                    0x0e73cd624d38ddf8,
                ])),
                Felt::new(BigInteger256([
                    0xb93443c099470267,
                    0x35f44ad5b5c7c447,
                    0x9cba3f29d05811a1,
                    0x06bca6dc6ad4dc59,
                ])),
                Felt::new(BigInteger256([
                    0xd49f6516c8b00a56,
                    0x1ad59631f263403d,
                    0x257c2d957063d6ae,
                    0x2ba478a055d6ef08,
                ])),
                Felt::new(BigInteger256([
                    0xef268acb224c2448,
                    0x6b0c3af23f4fe52d,
                    0x03159b3d44feb724,
                    0x1cecbca024762dcd,
                ])),
                Felt::new(BigInteger256([
                    0xbc592b704053cee0,
                    0x17b6a7e864623c74,
                    0x94672524414ba612,
                    0x0b22b1bc5dcc7c79,
                ])),
                Felt::new(BigInteger256([
                    0x756a66e1845fe2f2,
                    0x22a970fa965a7c83,
                    0x46e952da2780aae0,
                    0x2a0e38eb701da0f7,
                ])),
                Felt::new(BigInteger256([
                    0x7e191a857e5c735e,
                    0xd726995dbe23abce,
                    0xb06a77d5bcb36d6e,
                    0x28f72a2693b60b88,
                ])),
                Felt::new(BigInteger256([
                    0x9110d8cbe615756e,
                    0x4fe28677ce7b4f1c,
                    0x1579d83f203a58b7,
                    0x215f109f8847afbb,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xa460c66f429e2f26,
                    0x58b3b701498e7a35,
                    0xc393c08509fea595,
                    0x04d5444dfb99f9bd,
                ])),
                Felt::new(BigInteger256([
                    0xc30c8cf16869b6de,
                    0x2694ddd349d1140a,
                    0xaf86ca606651617b,
                    0x18c2e1b4b3ea5560,
                ])),
                Felt::new(BigInteger256([
                    0x64a9a79c5f9ee189,
                    0x992b491b35593190,
                    0x695521e275ebb4bf,
                    0x0541d2da947c1aee,
                ])),
                Felt::new(BigInteger256([
                    0x8eb5222ccef2ecea,
                    0x09c7157c00b68643,
                    0x2a4ff07a8b816adb,
                    0x0f4b1af1a2900289,
                ])),
                Felt::new(BigInteger256([
                    0x91896dab463ba4aa,
                    0x24ebc5f93abef445,
                    0xb47b6102779a2323,
                    0x17a515633c04f84a,
                ])),
                Felt::new(BigInteger256([
                    0xcee6a5f68d2f52e8,
                    0x55534914a04ad9fc,
                    0xa077df0286516c50,
                    0x08048728eeae0054,
                ])),
                Felt::new(BigInteger256([
                    0x797eddecdacac0cf,
                    0x79f5758ff1082129,
                    0x5d13de7915ebb99a,
                    0x217f1bf0b18e8652,
                ])),
                Felt::new(BigInteger256([
                    0x41c8a623887ce6eb,
                    0x94b9ec9b231b3040,
                    0x746c15f7a33d6afe,
                    0x1f4642ab4974175e,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xd530e22d2822edb2,
                    0x03946ad2aa0f2eff,
                    0x5e9d3eb75aba38bf,
                    0x04e268ac393d456d,
                ])),
                Felt::new(BigInteger256([
                    0xeded38a8924157c4,
                    0x006f7e3d9383f66f,
                    0x0a131f7baa1c3da7,
                    0x0b1a84805c3656b2,
                ])),
                Felt::new(BigInteger256([
                    0x6d60604d07df0aab,
                    0x7a86c76a0a611633,
                    0x85be755c079b76ac,
                    0x0d5ba702ab80b5c3,
                ])),
                Felt::new(BigInteger256([
                    0x538a79c9e3965163,
                    0x40e1f72b4cb8a3f8,
                    0x6627eb420574956b,
                    0x1633a8eec0af9f6f,
                ])),
                Felt::new(BigInteger256([
                    0x6ed913d5a563e15e,
                    0x27d5be41a1b09119,
                    0x7e759c36f3d52ca4,
                    0x2eada9fa9e788559,
                ])),
                Felt::new(BigInteger256([
                    0x725fc8584d047be9,
                    0x2893b7dd0acf4c9e,
                    0xe02bfbac00a108b0,
                    0x253c2ba357b70c2f,
                ])),
                Felt::new(BigInteger256([
                    0x71043e4cb9af40a2,
                    0x93ed71d87de53c79,
                    0x950a5fba4496597f,
                    0x10b8dfdaf2a3d1d0,
                ])),
                Felt::new(BigInteger256([
                    0x7fdb4601402212b6,
                    0xf3ce333cc42f2765,
                    0xf42304f80cedd9ec,
                    0x2e5cc0f4d3694afa,
                ])),
            ],
        ];

        for i in input.iter_mut() {
            apply_sbox(i);
        }

        for (&i, o) in input.iter().zip(output) {
            assert_eq!(i, o);
        }
    }

    #[test]
    fn test_mds() {
        // Generated from https://github.com/Nashtare/anemoi-hash/
        let mut input = [
            [Felt::zero(); 8],
            [Felt::one(); 8],
            [
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
            ],
            [
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
            ],
            [
                Felt::new(BigInteger256([
                    0xdef83fdd7baf724c,
                    0x98d03c758e7acf4f,
                    0x1e0b529d14ed912f,
                    0x1d4f108dbbda0f5f,
                ])),
                Felt::new(BigInteger256([
                    0x4504fb6a26997bb7,
                    0xa9bf3bf65ab9edd1,
                    0xfa0604e4e3a710b1,
                    0x21fe4aabb6cedebf,
                ])),
                Felt::new(BigInteger256([
                    0xac01b2f9831e6b50,
                    0x2aee5a77cc81a02b,
                    0xb1015a1168adb721,
                    0x1848cfe50590c1f8,
                ])),
                Felt::new(BigInteger256([
                    0x7c7bf806143bf240,
                    0x4fe186c3b18abefc,
                    0xca12ea888f37cc51,
                    0x116311ccd7dc577c,
                ])),
                Felt::new(BigInteger256([
                    0xe661488d72fdce1d,
                    0xfe8508d9358ef83d,
                    0x46048cbb605339bf,
                    0x185eab7d809c2fc1,
                ])),
                Felt::new(BigInteger256([
                    0xdd48de3c72232727,
                    0x099a3af624902fae,
                    0x48678fc04079109c,
                    0x049fa1d2dc37dd3e,
                ])),
                Felt::new(BigInteger256([
                    0x916340936686beb0,
                    0x1f8ceb27afdc4bd2,
                    0xa39e9c5fdf47a3d5,
                    0x0ae587612e7fd85b,
                ])),
                Felt::new(BigInteger256([
                    0x01525259346441c8,
                    0x35b737dd9f10513d,
                    0x21ec762e7351b3b0,
                    0x112f5e0d214183a2,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x244db21a9d384f9d,
                    0x866c0a668b6573c4,
                    0x8637d2903012d03a,
                    0x035eae066b23b268,
                ])),
                Felt::new(BigInteger256([
                    0xac344dd8cd166d17,
                    0x986978ef007ccf0a,
                    0x16e59bae968091f0,
                    0x0b6a16d44cc49b81,
                ])),
                Felt::new(BigInteger256([
                    0x9242d84f2dc6803a,
                    0xf30dfe7458e77bd8,
                    0x4bbb385970ed9938,
                    0x2c38d5cf77ddd965,
                ])),
                Felt::new(BigInteger256([
                    0x6420421d84c8ce2c,
                    0x2da1e6fbff22facb,
                    0xf8365b272864e750,
                    0x1e4df15b0491e83f,
                ])),
                Felt::new(BigInteger256([
                    0x65973c0797949898,
                    0x99a4e3ca692adeda,
                    0xfdb241d702586d51,
                    0x042f48b410897e37,
                ])),
                Felt::new(BigInteger256([
                    0x9487669cebfb13e6,
                    0x644bda2d1b9f5d15,
                    0xfe98d9bf357452c0,
                    0x2032fd53a712735b,
                ])),
                Felt::new(BigInteger256([
                    0xd322a6a0b80a4ec9,
                    0x293a3e9524deb641,
                    0xae6761d84f872ab4,
                    0x296809206c0f7f0f,
                ])),
                Felt::new(BigInteger256([
                    0xffa6990f531d60cf,
                    0x4851c7287681f503,
                    0x8a0e153b68cb0828,
                    0x11b6ecc3222a8a25,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xf7b7c3f168f5e4de,
                    0xc08cbdeae5e42ae7,
                    0x31ec799e6e79ef29,
                    0x1ff4aece58e20b75,
                ])),
                Felt::new(BigInteger256([
                    0x5c3d8ba5f080a109,
                    0x5c1153b20f835b06,
                    0x4826a186614ae5e1,
                    0x1c499b5ce93f7868,
                ])),
                Felt::new(BigInteger256([
                    0xa7c0aee24453db3f,
                    0x3ff5de9ad1b18d04,
                    0x1dec6bf06abc691c,
                    0x28929c1e1c85448a,
                ])),
                Felt::new(BigInteger256([
                    0x87c4f039f338660d,
                    0x902551c8f1c7727a,
                    0x0299f55bb6bc91bb,
                    0x11725c637c597b1a,
                ])),
                Felt::new(BigInteger256([
                    0x5dc89a4e022531b0,
                    0xf79ccf96aa58651c,
                    0x803bdfa60de73882,
                    0x0ff1866bb0bb55be,
                ])),
                Felt::new(BigInteger256([
                    0xb9989d31491a50d3,
                    0x4451da4609c61a62,
                    0x6b93ff4e093ca228,
                    0x1972b07a978be3f2,
                ])),
                Felt::new(BigInteger256([
                    0x7e439ebf2e22c4f9,
                    0x9ac286cb00e4c82e,
                    0xbf3743529beca8bd,
                    0x0a3d299752a3526d,
                ])),
                Felt::new(BigInteger256([
                    0x53732952e91af848,
                    0x0602be2b0b087f83,
                    0x2db4a86e13e89180,
                    0x04707ed238d3f5a8,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x6df3090f6b141d0c,
                    0x672784721ef309f3,
                    0x2f59a7b2f50c8a0e,
                    0x1fd7c148d8850c8c,
                ])),
                Felt::new(BigInteger256([
                    0xc638d0afbfd6a8da,
                    0x69265eb694090d4b,
                    0x0abbf80dfc89ae75,
                    0x199c31916ff444b4,
                ])),
                Felt::new(BigInteger256([
                    0x655e3cb68b57ba1f,
                    0x2869b65773561f30,
                    0x6dfcd328815c4c01,
                    0x1e64e34a2545db9c,
                ])),
                Felt::new(BigInteger256([
                    0xff1a7a50aed290c3,
                    0xecf94a2abd559b1a,
                    0xa3c2e5accfc28f3b,
                    0x0a09130edf91889a,
                ])),
                Felt::new(BigInteger256([
                    0x099a9907b3cad45a,
                    0xd3148b071d4e26b8,
                    0xc80ebcaf8eec1e57,
                    0x2cf3e429b6c2bd7b,
                ])),
                Felt::new(BigInteger256([
                    0x6a16e0ee86c1717b,
                    0xdccb792a6e59b1ca,
                    0x655d1b4807565c75,
                    0x2d057a807323061c,
                ])),
                Felt::new(BigInteger256([
                    0xb8e60bee306c8856,
                    0xbc1c0bc3df086cab,
                    0x236c21ef51fd13e9,
                    0x2518c31d666b05c2,
                ])),
                Felt::new(BigInteger256([
                    0x8e270394990586e6,
                    0xadd489c561405207,
                    0xbf0bc8e2efe0f336,
                    0x0efcd632aa32b83d,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xb1f037dc8882edc8,
                    0x55b9795eda289c49,
                    0xd90d39e234e338c2,
                    0x05f88b74e6c83c01,
                ])),
                Felt::new(BigInteger256([
                    0x429c5b76c72b2474,
                    0xc252859d72aafb6b,
                    0x78dfff24856106e7,
                    0x208e022efffef41f,
                ])),
                Felt::new(BigInteger256([
                    0x7f1da3a3d1b15d80,
                    0xcc82bfea8d40312e,
                    0x5aa4defc704a8913,
                    0x1b5da543cfac96fd,
                ])),
                Felt::new(BigInteger256([
                    0x1b64bbc8a933cae7,
                    0x12ebff2348ae9dcd,
                    0x5e58aa98ea3c03fb,
                    0x09805a081e23c84b,
                ])),
                Felt::new(BigInteger256([
                    0x9e32e975958557d5,
                    0x10579ae935e6ecbb,
                    0xb63a18881442f1c9,
                    0x27cfa5fc789a2314,
                ])),
                Felt::new(BigInteger256([
                    0x15848872ef97269a,
                    0x182c582a5d3399da,
                    0x8b029d9c581c5557,
                    0x1abff64c6b6e6d8d,
                ])),
                Felt::new(BigInteger256([
                    0xf75a5c25957bed9b,
                    0x9ca994adf0525a45,
                    0x19ce169f35f08320,
                    0x10f6ca1778ab544a,
                ])),
                Felt::new(BigInteger256([
                    0x2d6312b3dba4e9ea,
                    0x1aedf20962e37b56,
                    0x7fd105fae2d576e5,
                    0x1f54fe234974a386,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xcf9bbf11f3ebd9b4,
                    0x70bc04489f63fee3,
                    0x6f8c1dcffee677f7,
                    0x02cdc4a3fc19c5f5,
                ])),
                Felt::new(BigInteger256([
                    0x6968c63cf3ea40ad,
                    0x167946708bfb0cfc,
                    0x90b75798d086b9be,
                    0x09a7f13500953380,
                ])),
                Felt::new(BigInteger256([
                    0xe9b6d8703fef6c7b,
                    0x1df466c21e02f1e1,
                    0x02647edce2c0865e,
                    0x17e91a80919206a8,
                ])),
                Felt::new(BigInteger256([
                    0x06acfb6245c6ce76,
                    0xe55451dfe9f0b191,
                    0xb207103832641e23,
                    0x18120e7885118dbc,
                ])),
                Felt::new(BigInteger256([
                    0xb9c69dd3c15b5bfc,
                    0x61d8d36785d2dd56,
                    0x23ee3a16131285ee,
                    0x2f365a59321b0744,
                ])),
                Felt::new(BigInteger256([
                    0xf05d282c840273df,
                    0x5e1137a210d97f12,
                    0xe22126df3d66eea9,
                    0x139a0fd2ff2f2b22,
                ])),
                Felt::new(BigInteger256([
                    0x3cc61abb8eb5b386,
                    0x43571f5388cc8c6d,
                    0x0bd919a9d973b451,
                    0x0ce0a96becb986ce,
                ])),
                Felt::new(BigInteger256([
                    0x51c97423dcb74199,
                    0x4f182cd677e0fde2,
                    0x920225e33625c168,
                    0x2dd7766675ac165f,
                ])),
            ],
        ];

        let mut input2 = input;

        // Generated from https://github.com/Nashtare/anemoi-hash/
        let output = [
            [Felt::zero(); 8],
            [
                Felt::new(BigInteger256([
                    0x4f4bc0b2b5ef64bd,
                    0x1a4b98fbe78db996,
                    0x5c65ec9f484e3a79,
                    0x0180a96573d3d9f8,
                ])),
                Felt::new(BigInteger256([
                    0x4f4bc0b2b5ef64bd,
                    0x1a4b98fbe78db996,
                    0x5c65ec9f484e3a79,
                    0x0180a96573d3d9f8,
                ])),
                Felt::new(BigInteger256([
                    0x4f4bc0b2b5ef64bd,
                    0x1a4b98fbe78db996,
                    0x5c65ec9f484e3a79,
                    0x0180a96573d3d9f8,
                ])),
                Felt::new(BigInteger256([
                    0x4f4bc0b2b5ef64bd,
                    0x1a4b98fbe78db996,
                    0x5c65ec9f484e3a79,
                    0x0180a96573d3d9f8,
                ])),
                Felt::new(BigInteger256([
                    0x4f4bc0b2b5ef64bd,
                    0x1a4b98fbe78db996,
                    0x5c65ec9f484e3a79,
                    0x0180a96573d3d9f8,
                ])),
                Felt::new(BigInteger256([
                    0x4f4bc0b2b5ef64bd,
                    0x1a4b98fbe78db996,
                    0x5c65ec9f484e3a79,
                    0x0180a96573d3d9f8,
                ])),
                Felt::new(BigInteger256([
                    0x4f4bc0b2b5ef64bd,
                    0x1a4b98fbe78db996,
                    0x5c65ec9f484e3a79,
                    0x0180a96573d3d9f8,
                ])),
                Felt::new(BigInteger256([
                    0x4f4bc0b2b5ef64bd,
                    0x1a4b98fbe78db996,
                    0x5c65ec9f484e3a79,
                    0x0180a96573d3d9f8,
                ])),
            ],
            [
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::new(BigInteger256([
                    0x4f4bc0b2b5ef64bd,
                    0x1a4b98fbe78db996,
                    0x5c65ec9f484e3a79,
                    0x0180a96573d3d9f8,
                ])),
                Felt::new(BigInteger256([
                    0x4f4bc0b2b5ef64bd,
                    0x1a4b98fbe78db996,
                    0x5c65ec9f484e3a79,
                    0x0180a96573d3d9f8,
                ])),
                Felt::new(BigInteger256([
                    0x4f4bc0b2b5ef64bd,
                    0x1a4b98fbe78db996,
                    0x5c65ec9f484e3a79,
                    0x0180a96573d3d9f8,
                ])),
                Felt::new(BigInteger256([
                    0x4f4bc0b2b5ef64bd,
                    0x1a4b98fbe78db996,
                    0x5c65ec9f484e3a79,
                    0x0180a96573d3d9f8,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x4f4bc0b2b5ef64bd,
                    0x1a4b98fbe78db996,
                    0x5c65ec9f484e3a79,
                    0x0180a96573d3d9f8,
                ])),
                Felt::new(BigInteger256([
                    0x4f4bc0b2b5ef64bd,
                    0x1a4b98fbe78db996,
                    0x5c65ec9f484e3a79,
                    0x0180a96573d3d9f8,
                ])),
                Felt::new(BigInteger256([
                    0x4f4bc0b2b5ef64bd,
                    0x1a4b98fbe78db996,
                    0x5c65ec9f484e3a79,
                    0x0180a96573d3d9f8,
                ])),
                Felt::new(BigInteger256([
                    0x4f4bc0b2b5ef64bd,
                    0x1a4b98fbe78db996,
                    0x5c65ec9f484e3a79,
                    0x0180a96573d3d9f8,
                ])),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
            ],
            [
                Felt::new(BigInteger256([
                    0x3d12e5085bc2a38e,
                    0xc18c81f25d82dac6,
                    0xaf5bfa1af3136bfe,
                    0x12db451161ca9809,
                ])),
                Felt::new(BigInteger256([
                    0xd285b9c3bbc72a96,
                    0x785d19a1fc6c1a3d,
                    0x705e5abb25090aeb,
                    0x23cd847afc119d52,
                ])),
                Felt::new(BigInteger256([
                    0xc4faec9da091c031,
                    0x4ba863c409689d06,
                    0xc3fbe1a8c6b07670,
                    0x08b3a904f4c753cc,
                ])),
                Felt::new(BigInteger256([
                    0x3521a35fdd02a615,
                    0xf6770ad921a8eaca,
                    0xc63d840020f89b2e,
                    0x2a5c3c086e7189c8,
                ])),
                Felt::new(BigInteger256([
                    0xac3384fce971d930,
                    0x6121db41e256719a,
                    0x914c3342245b1856,
                    0x1a374ae10cac0bce,
                ])),
                Felt::new(BigInteger256([
                    0xbb3232a5fed314e0,
                    0xd79b7b08bf49520a,
                    0x727a958f5329a47b,
                    0x2a4cd36f046fb311,
                ])),
                Felt::new(BigInteger256([
                    0x1a4e8d02e6bf9cfc,
                    0x0e960d88c4e2c1c3,
                    0x2b4bb1d370eca1ca,
                    0x231994e1049b56c9,
                ])),
                Felt::new(BigInteger256([
                    0x722686ce9e613d6e,
                    0xb95bec94c6251e2e,
                    0xcace2c59b64dfc5b,
                    0x058ed9545b350849,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x30e6468ef2423290,
                    0x2fd18aec995300ad,
                    0x3bf5d98d1b97e917,
                    0x00930abf309338cd,
                ])),
                Felt::new(BigInteger256([
                    0xfb5fa8852b1d7df2,
                    0x4afc8f6c28f706ab,
                    0x75147699e56db9be,
                    0x1d923c874cce1c4c,
                ])),
                Felt::new(BigInteger256([
                    0xcb5a4ffea3493a57,
                    0xc7c18fe79f683631,
                    0x2471803fb9f72614,
                    0x12b9cace76a1b8a6,
                ])),
                Felt::new(BigInteger256([
                    0xe33d7492bc0a80d0,
                    0xf7869ee95ce32086,
                    0x667a3cfd53bd9dfd,
                    0x2bfe631fcd437d5d,
                ])),
                Felt::new(BigInteger256([
                    0x1f7bdb456003f387,
                    0xbc157d4f981f04d4,
                    0x4992a0265a9824fe,
                    0x18ce1d30c6b0410b,
                ])),
                Felt::new(BigInteger256([
                    0xa72c475174cb24a5,
                    0x0b351c25873f2093,
                    0x06b3b6dbd8dbfca8,
                    0x12e993ee00ef7f3c,
                ])),
                Felt::new(BigInteger256([
                    0x173265d788d31872,
                    0xc83770c6e3c0869a,
                    0xaee7193fbe9c39a0,
                    0x10f311b44040eb9d,
                ])),
                Felt::new(BigInteger256([
                    0xeaf616cf638574a8,
                    0x62d650e6f8b827d7,
                    0xce534dd58cb824da,
                    0x1b2a333952a5ada6,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x4a434dae59d37970,
                    0xeef419e7cc59cd32,
                    0xdc78bc3ec36dfaff,
                    0x00295dc66b71fd98,
                ])),
                Felt::new(BigInteger256([
                    0x0a2d3674f43301e0,
                    0x9ff26559d4a92383,
                    0x1fcb4e2f7ee8de7b,
                    0x060dc2e1845754df,
                ])),
                Felt::new(BigInteger256([
                    0x432b99957905f907,
                    0x0762fd0a1c043c2d,
                    0x7b9222421c482959,
                    0x0d39ee69819abf20,
                ])),
                Felt::new(BigInteger256([
                    0x3eb7a7c2a837299e,
                    0x6ab0a8a2c9ffd048,
                    0x3d57defe21fc2686,
                    0x2220dc7a7883c457,
                ])),
                Felt::new(BigInteger256([
                    0xbbfbd16977659e25,
                    0x3a6ee199b753465f,
                    0x4e97ecb8752ebf11,
                    0x2c011c868cd782c2,
                ])),
                Felt::new(BigInteger256([
                    0x41d0bc1445dd188c,
                    0x2df19dd2ad0ccbf8,
                    0xbf7f1d89e456e101,
                    0x1a2029caf12e5f16,
                ])),
                Felt::new(BigInteger256([
                    0x26f6c21356e31ffb,
                    0x2788018bfab7dcd6,
                    0x521dc53b050c57d1,
                    0x053646134e2dca41,
                ])),
                Felt::new(BigInteger256([
                    0xd22164df8a58f806,
                    0xebfa87626e8fc3d8,
                    0x3b0c192d09358848,
                    0x1acbb818b6d81f5b,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x47d61dd9c49af498,
                    0x2188eea39853c749,
                    0xd86725f4df127521,
                    0x032c07428e24c1cb,
                ])),
                Felt::new(BigInteger256([
                    0xbf4378f16098e3ce,
                    0xda74f705a58e20e4,
                    0x255abc85780cae00,
                    0x1a6d937b3a5776ad,
                ])),
                Felt::new(BigInteger256([
                    0xdea796f0c65f87b3,
                    0x58a0e5d5f157966d,
                    0x67b61f41ac50f1a1,
                    0x23c5224662296aee,
                ])),
                Felt::new(BigInteger256([
                    0x7538369eb224360b,
                    0xd9266f5c2507bd8f,
                    0x099a25d1bd73511f,
                    0x271af600643bd0e7,
                ])),
                Felt::new(BigInteger256([
                    0x2f7802aaca289248,
                    0x784724b75d9441eb,
                    0xc57ba87b5e52f800,
                    0x04fe0e41ec4393fc,
                ])),
                Felt::new(BigInteger256([
                    0x6be427eb8adb19fe,
                    0xb0f5023fbbb92cc0,
                    0x091b5978ee329f5d,
                    0x231848e671942a7c,
                ])),
                Felt::new(BigInteger256([
                    0x69fec5d1b127e4d5,
                    0x794d1595ee222d95,
                    0x2287c55ffbea4c63,
                    0x1350707714847268,
                ])),
                Felt::new(BigInteger256([
                    0x9f706c350481f617,
                    0xd3900ec3cbb27dbb,
                    0xd0265fa503da1ace,
                    0x0f902db1708d772e,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xccb4f5c73db23363,
                    0xbad2a718707c3e5e,
                    0xb1a06b5d568aad07,
                    0x18fa495e1e2876aa,
                ])),
                Felt::new(BigInteger256([
                    0x96130613d3d2e68c,
                    0x86d6dac84edea7f6,
                    0xaabd558c65ca917d,
                    0x000d60fbfde88f65,
                ])),
                Felt::new(BigInteger256([
                    0x11d63d4557f5797e,
                    0x0b5502efa8eb9a29,
                    0xacc729a3cfec0a32,
                    0x014c316a17c8d32d,
                ])),
                Felt::new(BigInteger256([
                    0x1b84f139abaa2242,
                    0x8c4e83c8769864d1,
                    0x1023ae95f63cdcaf,
                    0x1180ee4dd05ad107,
                ])),
                Felt::new(BigInteger256([
                    0x51bb96059af8fa6c,
                    0xbdb2f761133a86ca,
                    0xe5dff2ef8a7b3a26,
                    0x203e74d45c0af17b,
                ])),
                Felt::new(BigInteger256([
                    0xb12eaac208fd05e1,
                    0xc2c61ac334d7526c,
                    0xc5da0fa5439b7c26,
                    0x0e99bd4d70d905fb,
                ])),
                Felt::new(BigInteger256([
                    0x284c7d3b87555fef,
                    0x6b16bb9cead34af0,
                    0x7089cc75c49e93a5,
                    0x1e5c03a65f58be17,
                ])),
                Felt::new(BigInteger256([
                    0x3a1331f3e10f2247,
                    0x549b4845faa282ef,
                    0x130ade797abb509a,
                    0x00eaf1162cf6a323,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xa8381028880f642b,
                    0x441838ba54536f3c,
                    0xaa81185e2917e822,
                    0x23b5795deca46fa8,
                ])),
                Felt::new(BigInteger256([
                    0x932c4690c2add9e9,
                    0xb9c8f33af399941e,
                    0x8d7e0a9f93418bec,
                    0x29ba281faf660758,
                ])),
                Felt::new(BigInteger256([
                    0x8fb5189670cfb319,
                    0x90ab29f3823afda2,
                    0x8d598bc90304694d,
                    0x222a376d2f651aa7,
                ])),
                Felt::new(BigInteger256([
                    0xedfdb811305b7467,
                    0xaddd422d2a700af8,
                    0xd98ece637796ebf6,
                    0x1522682274a88e57,
                ])),
                Felt::new(BigInteger256([
                    0xd1674838d5c7cc28,
                    0x6f9c160210a7aa86,
                    0xe437de0134d6fdc2,
                    0x17d72cd90799d3ab,
                ])),
                Felt::new(BigInteger256([
                    0xe2b212b118371398,
                    0x124eef999d189800,
                    0xaada117ce7edec1c,
                    0x1261ca323f62ac77,
                ])),
                Felt::new(BigInteger256([
                    0xee3b0e3ec8c1a810,
                    0x70948dc880771efe,
                    0x74cd2991cbdd3884,
                    0x19b70150c8bd27d6,
                ])),
                Felt::new(BigInteger256([
                    0x288a278796fb0696,
                    0xd5db25ee6e2144b6,
                    0xf286ef189fccbffc,
                    0x2486e66be6fb027a,
                ])),
            ],
        ];

        for i in input.iter_mut() {
            apply_mds(i);
        }
        for i in input2.iter_mut() {
            apply_naive_mds(i);
        }

        for (index, (&i_1, i_2)) in input.iter().zip(input2).enumerate() {
            assert_eq!(output[index], i_1);
            assert_eq!(output[index], i_2);
        }
    }
}
