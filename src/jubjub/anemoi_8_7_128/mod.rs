use super::{mul_by_generator, sbox, BigInteger256, Felt};
use crate::{Jive, Sponge};
use ark_ff::{Field, One, Zero};
use unroll::unroll_for_loops;

/// Digest for Anemoi
mod digest;
/// Sponge for Anemoi
mod hasher;
/// MDS matrix for Anemoi
mod mds;
/// Round constants for Anemoi
mod round_constants;

pub use digest::AnemoiDigest;
pub use hasher::AnemoiHash;

// ANEMOI CONSTANTS
// ================================================================================================

/// Function state is set to 8 field elements or 256 bytes.
/// 1 element of the state is reserved for capacity.
pub const STATE_WIDTH: usize = 8;
/// 7 elements of the state are reserved for rate.
pub const RATE_WIDTH: usize = 7;

/// The state is divided into two even-length rows.
pub const NUM_COLUMNS: usize = 4;

/// 1 element (32-bytes) is returned as digest.
pub const DIGEST_SIZE: usize = 1;

/// The number of rounds is set to 10 to provide 128-bit security level.
pub const NUM_HASH_ROUNDS: usize = 10;

// HELPER FUNCTIONS
// ================================================================================================

#[inline(always)]
/// Applies exponentiation of the current hash
/// state elements with the Anemoi S-Box.
pub(crate) fn apply_sbox(state: &mut [Felt; STATE_WIDTH]) {
    let mut x: [Felt; NUM_COLUMNS] = state[..NUM_COLUMNS].try_into().unwrap();
    let mut y: [Felt; NUM_COLUMNS] = state[NUM_COLUMNS..].try_into().unwrap();

    x.iter_mut().enumerate().for_each(|(i, t)| {
        let y2 = y[i].square();
        let beta_y2 = y2 + (y2 + y2.double()).double();
        *t -= beta_y2;
    });

    let mut x_alpha_inv = x;
    x_alpha_inv
        .iter_mut()
        .for_each(|t| *t = sbox::exp_inv_alpha(t));

    y.iter_mut()
        .enumerate()
        .for_each(|(i, t)| *t -= x_alpha_inv[i]);

    x.iter_mut().enumerate().for_each(|(i, t)| {
        let y2 = y[i].square();
        let beta_y2 = y2 + (y2 + y2.double()).double();
        *t += beta_y2 + sbox::DELTA;
    });

    state[..NUM_COLUMNS].copy_from_slice(&x);
    state[NUM_COLUMNS..].copy_from_slice(&y);
}

#[inline(always)]
/// Applies matrix-vector multiplication of the current
/// hash state with the Anemoi MDS matrix.
pub(crate) fn apply_mds(state: &mut [Felt; STATE_WIDTH]) {
    let x: [Felt; NUM_COLUMNS] = [state[0], state[1], state[2], state[3]];
    let y: [Felt; NUM_COLUMNS] = [state[5], state[6], state[7], state[4]];

    let g_x0 = mul_by_generator(&x[0]);
    let g_x1 = mul_by_generator(&x[1]);
    let g_x2 = mul_by_generator(&x[2]);
    let g_x3 = mul_by_generator(&x[3]);
    let g_squared_x0 = mul_by_generator(&g_x0);
    let g_squared_x1 = mul_by_generator(&g_x1);

    state[0] = x[0] + x[1] + g_x1 + g_x2 + g_x3;
    state[2] = g_squared_x0 + g_squared_x1 + x[2] + x[3] + g_x3;
    state[1] = state[2] + g_x1 + g_x2 + g_x3;
    state[3] = state[0] + g_x0 + g_x1 + x[3];

    let g_y0 = mul_by_generator(&y[0]);
    let g_y1 = mul_by_generator(&y[1]);
    let g_y2 = mul_by_generator(&y[2]);
    let g_y3 = mul_by_generator(&y[3]);
    let g_squared_y0 = mul_by_generator(&g_y0);
    let g_squared_y1 = mul_by_generator(&g_y1);

    state[4] = y[0] + y[1] + g_y1 + g_y2 + g_y3;
    state[6] = g_squared_y0 + g_squared_y1 + y[2] + y[3] + g_y3;
    state[5] = state[6] + g_y1 + g_y2 + g_y3;
    state[7] = state[4] + g_y0 + g_y1 + y[3];
}

// ANEMOI PERMUTATION
// ================================================================================================

/// Applies Anemoi permutation to the provided state.
#[inline(always)]
#[unroll_for_loops]
pub(crate) fn apply_permutation(state: &mut [Felt; STATE_WIDTH]) {
    for i in 0..NUM_HASH_ROUNDS {
        apply_round(state, i);
    }

    apply_mds(state)
}

/// Anemoi round function;
/// implementation based on algorithm 3 of <https://eprint.iacr.org/2020/1143.pdf>
#[inline(always)]
#[unroll_for_loops]
pub(crate) fn apply_round(state: &mut [Felt; STATE_WIDTH], step: usize) {
    // determine which round constants to use
    let c = &round_constants::C[step % NUM_HASH_ROUNDS];
    let d = &round_constants::D[step % NUM_HASH_ROUNDS];

    for i in 0..NUM_COLUMNS {
        state[i] += c[i];
        state[NUM_COLUMNS + i] += d[i];
    }

    apply_mds(state);
    apply_sbox(state);
}

#[cfg(test)]
mod tests {
    use super::*;

    fn apply_naive_mds(state: &mut [Felt; STATE_WIDTH]) {
        let x: [Felt; NUM_COLUMNS] = state[..NUM_COLUMNS].try_into().unwrap();
        let mut y: [Felt; NUM_COLUMNS] = [Felt::zero(); NUM_COLUMNS];
        y[0..NUM_COLUMNS - 1].copy_from_slice(&state[NUM_COLUMNS + 1..]);
        y[NUM_COLUMNS - 1] = state[NUM_COLUMNS];

        let mut result = [Felt::zero(); STATE_WIDTH];
        for (i, r) in result.iter_mut().enumerate().take(NUM_COLUMNS) {
            for (j, s) in x.into_iter().enumerate().take(NUM_COLUMNS) {
                *r += s * mds::MDS[i * NUM_COLUMNS + j];
            }
        }
        for (i, r) in result.iter_mut().enumerate().skip(NUM_COLUMNS) {
            for (j, s) in y.into_iter().enumerate() {
                *r += s * mds::MDS[(i - NUM_COLUMNS) * NUM_COLUMNS + j];
            }
        }

        state.copy_from_slice(&result);
    }

    #[test]
    fn test_sbox() {
        // Generated from https://github.com/Nashtare/anemoi-hash/
        let mut input = [
            [Felt::zero(); 8],
            [Felt::one(); 8],
            [
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
            ],
            [
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
            ],
            [
                Felt::new(BigInteger256([
                    0x45c048bfaaf03451,
                    0xce72454c6a76dee8,
                    0xb965049553afecd9,
                    0x2bb8aa431cd115b4,
                ])),
                Felt::new(BigInteger256([
                    0x87294b4f1bebc886,
                    0x7961cc5d71bc4109,
                    0x7983e3d20475bc23,
                    0x36cdccea52802b37,
                ])),
                Felt::new(BigInteger256([
                    0x61b0a078fa2896b1,
                    0x2c83f3fb284eb37a,
                    0x7c11c033efa37dec,
                    0x11f25fa6d916a722,
                ])),
                Felt::new(BigInteger256([
                    0xabe75adcc78fb098,
                    0x37b8521ac80bed39,
                    0xccab5dc1b177e258,
                    0x51d58a351e57a915,
                ])),
                Felt::new(BigInteger256([
                    0x84373d18a7d6eb32,
                    0x5c95c14b883571be,
                    0x0b058786b4cbee39,
                    0x65efaae4154462bb,
                ])),
                Felt::new(BigInteger256([
                    0x5507063e85abf7f2,
                    0xe18a3bb2d9787da7,
                    0xeb97f0f97a248c79,
                    0x48a2a7ab61700e5e,
                ])),
                Felt::new(BigInteger256([
                    0x78a5dcad7bd2259e,
                    0x820e5ce93ab073f1,
                    0x9d498d6caf73ed0a,
                    0x3b72dc4eaae85328,
                ])),
                Felt::new(BigInteger256([
                    0x1ab0a21e4ca5c50f,
                    0x4e09df044d391be6,
                    0x24eacefc82797a84,
                    0x245c97199ad4b242,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xe60509ea896c493b,
                    0xc4d044df0e5ad3a5,
                    0x2372775748d1a103,
                    0x573b4c45ad79b6db,
                ])),
                Felt::new(BigInteger256([
                    0xc4bc29c0c52cb098,
                    0xc10695554c2a19c6,
                    0xcdab169c38364bcc,
                    0x3f9197516eb15054,
                ])),
                Felt::new(BigInteger256([
                    0x3d141e8aa5683a55,
                    0x601421b2efe9ec6b,
                    0xb51c60a68728936b,
                    0x3e6861e8dadcff7e,
                ])),
                Felt::new(BigInteger256([
                    0x8dfc8d8b691c57a0,
                    0x51616a3791614d7b,
                    0xe4a8f40b17d43b7d,
                    0x179195c723fd0978,
                ])),
                Felt::new(BigInteger256([
                    0x9a39b95eaa35bbb8,
                    0xc90ab4b6aaa82af1,
                    0xa8c84a0ed4a7720f,
                    0x5b840a5c9f57b317,
                ])),
                Felt::new(BigInteger256([
                    0xae3d6b46a2f35c49,
                    0x82313c88a4df86cc,
                    0x834fe7301f757472,
                    0x2dee2677e30301d4,
                ])),
                Felt::new(BigInteger256([
                    0xd3aaadda59edeec1,
                    0xa4a3b2ecb1f1287d,
                    0x55ffa7d9e468b478,
                    0x3e44913a0017eef0,
                ])),
                Felt::new(BigInteger256([
                    0xa512850d3ca33462,
                    0x9fcd7d443fda54a9,
                    0x8ef9d99008604ea0,
                    0x0622bfa743070932,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x6d9524dd1a092788,
                    0x6de9fc70ccf64b23,
                    0xb54da90a89be4a0d,
                    0x5bb60b7bba687ffa,
                ])),
                Felt::new(BigInteger256([
                    0x47f3f88e8d5b67c1,
                    0xedb0d2ac8a94f1f2,
                    0x3d5cb4183ce6b1c3,
                    0x46e48098d9b62977,
                ])),
                Felt::new(BigInteger256([
                    0x9372e90017ec349e,
                    0x69664f1059835f39,
                    0xc1ff6cbafba52745,
                    0x2d46ebaf17fea14c,
                ])),
                Felt::new(BigInteger256([
                    0x9d427c998a9748c2,
                    0x07090ad0f2ee6e12,
                    0x857c0cf1f8afb64e,
                    0x2e81a87835bc2487,
                ])),
                Felt::new(BigInteger256([
                    0x4a10669363ed5298,
                    0x52af5054d14b5fbe,
                    0xd06dde6a3bc46c9c,
                    0x48678060e067988a,
                ])),
                Felt::new(BigInteger256([
                    0x941cd363881f7169,
                    0x8e6e31ccf96cd536,
                    0x3b8f110b43f99c0b,
                    0x29f2398459b9d9d6,
                ])),
                Felt::new(BigInteger256([
                    0xe3c7b46fe38fee8a,
                    0x1488b79e5ace502c,
                    0xb03991fc9c2b9bac,
                    0x3805a418ac7beed6,
                ])),
                Felt::new(BigInteger256([
                    0x46260fcf10b2e0bc,
                    0xbf6af20a9c195a99,
                    0xa056e6b30db1ff57,
                    0x59eef56ccbb42006,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xcaedc14a1088661d,
                    0x3dd22a6f31f75866,
                    0xf42a73a61cdf1786,
                    0x56cc584ed0d34066,
                ])),
                Felt::new(BigInteger256([
                    0x25e25ab8f3d8c5ed,
                    0x62f6a135e2821273,
                    0xe7cba2ea5984eaea,
                    0x4300185c4a03cc50,
                ])),
                Felt::new(BigInteger256([
                    0x03063be1da115163,
                    0xcfb95e0067eb3989,
                    0x9026209f7c94298a,
                    0x1eca5324680e5e70,
                ])),
                Felt::new(BigInteger256([
                    0x3c5bdd8e315d9736,
                    0x5c1e2714a98241e1,
                    0x3ae62a9da1af5a3b,
                    0x66e7cb434b63cb8a,
                ])),
                Felt::new(BigInteger256([
                    0xfbe10891c07cb5f9,
                    0x148fa35a71ccd0c7,
                    0x7bbb11480ebbc668,
                    0x6bc352271eebd5a8,
                ])),
                Felt::new(BigInteger256([
                    0x0180983854f379d6,
                    0x3a8d7beeeb2a8959,
                    0x187d928fe19b873d,
                    0x03b2ae9885e33ac4,
                ])),
                Felt::new(BigInteger256([
                    0xee7288d0fd5e2938,
                    0x02813fab087f062b,
                    0x6b40e41f8986e6c0,
                    0x025f12e2edbc7471,
                ])),
                Felt::new(BigInteger256([
                    0xe88703d0eaf73c3a,
                    0x12af060e41fb1285,
                    0x1de729e4caf0a199,
                    0x525afa35c36cd348,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x2a7dbde7494c3aed,
                    0xbddcc6b34a4dbaab,
                    0xd95cd8101a215208,
                    0x5011df300344a78f,
                ])),
                Felt::new(BigInteger256([
                    0x32ca9c20f5d01b85,
                    0x85258c6200122530,
                    0x7683c9cb57cb22aa,
                    0x666a1c4dd06e51cd,
                ])),
                Felt::new(BigInteger256([
                    0xa5de0191a895a225,
                    0x51d5609faf71fe05,
                    0x68e87a6f9cac0146,
                    0x4b09f709f0892972,
                ])),
                Felt::new(BigInteger256([
                    0xe5a5d60656439df3,
                    0x21235cb37b3cdc4a,
                    0x4ef4aca9498d224d,
                    0x089df7edcf2c3247,
                ])),
                Felt::new(BigInteger256([
                    0xd01579aa01a083be,
                    0x14e4c36168bd0249,
                    0x4133dceed35d4d43,
                    0x71e8efcea23f6985,
                ])),
                Felt::new(BigInteger256([
                    0x3b3d8732680eb389,
                    0xbdf9fe08f7a17b1e,
                    0x4f268f704cd44779,
                    0x41a8832b4adc05df,
                ])),
                Felt::new(BigInteger256([
                    0xc166bcf4495cac90,
                    0x3136a896830c7b4e,
                    0x67e3b6f07ea70be0,
                    0x04fdc0ae5a99ae36,
                ])),
                Felt::new(BigInteger256([
                    0x601640d32c2cf95e,
                    0x0ec4fdea22334cf1,
                    0x83b23a3b1052617a,
                    0x129bedf8e1bf5044,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xee993a13110ce4c2,
                    0x753126bbb0b03221,
                    0xbf4cc3cf6b2a80d4,
                    0x38f64e9007ef52c4,
                ])),
                Felt::new(BigInteger256([
                    0x297b3770b4e658b2,
                    0x48311b7d81b990a5,
                    0x4b6cf53552a70faf,
                    0x1ee8ef23b3fd3f41,
                ])),
                Felt::new(BigInteger256([
                    0xad1ad2bac6900b0f,
                    0x8d7160761bb4dabc,
                    0xa71ba4481b39275b,
                    0x53096d428a65355b,
                ])),
                Felt::new(BigInteger256([
                    0x75519cd418cd783c,
                    0x02fcc606abba5d98,
                    0x69143b43d5322751,
                    0x18e7a951524add34,
                ])),
                Felt::new(BigInteger256([
                    0xa4b87ae9b101b16b,
                    0xe64caaaa5601cdf6,
                    0x17b4fe349cf600e8,
                    0x46d7e5e88021c3eb,
                ])),
                Felt::new(BigInteger256([
                    0x5d779b9d28511b0d,
                    0x2f2a8243cf379207,
                    0x3740ddad66b6b447,
                    0x174f77300bdc739c,
                ])),
                Felt::new(BigInteger256([
                    0xfbd840eb5c0a0bcc,
                    0xff296101d309a7a6,
                    0x1ebd68839e472d5a,
                    0x1109093003a2c038,
                ])),
                Felt::new(BigInteger256([
                    0xd19ed51e40582aac,
                    0x27d3ce8abe8b6331,
                    0x4b6335737afe635e,
                    0x5c00019208679e0d,
                ])),
            ],
        ];

        let output = [
            [
                Felt::new(BigInteger256([
                    0xdb6db6dadb6db6dc,
                    0xe6b5824adb6cc6da,
                    0xf8b356e005810db9,
                    0x66d0f1e660ec4796,
                ])),
                Felt::new(BigInteger256([
                    0xdb6db6dadb6db6dc,
                    0xe6b5824adb6cc6da,
                    0xf8b356e005810db9,
                    0x66d0f1e660ec4796,
                ])),
                Felt::new(BigInteger256([
                    0xdb6db6dadb6db6dc,
                    0xe6b5824adb6cc6da,
                    0xf8b356e005810db9,
                    0x66d0f1e660ec4796,
                ])),
                Felt::new(BigInteger256([
                    0xdb6db6dadb6db6dc,
                    0xe6b5824adb6cc6da,
                    0xf8b356e005810db9,
                    0x66d0f1e660ec4796,
                ])),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
            ],
            [
                Felt::new(BigInteger256([
                    0xd99f4a8fe00e11bd,
                    0xe12a753d82b33b30,
                    0xba87bf86c47e6f0b,
                    0x58de312b5993b67f,
                ])),
                Felt::new(BigInteger256([
                    0xd99f4a8fe00e11bd,
                    0xe12a753d82b33b30,
                    0xba87bf86c47e6f0b,
                    0x58de312b5993b67f,
                ])),
                Felt::new(BigInteger256([
                    0xd99f4a8fe00e11bd,
                    0xe12a753d82b33b30,
                    0xba87bf86c47e6f0b,
                    0x58de312b5993b67f,
                ])),
                Felt::new(BigInteger256([
                    0xd99f4a8fe00e11bd,
                    0xe12a753d82b33b30,
                    0xba87bf86c47e6f0b,
                    0x58de312b5993b67f,
                ])),
                Felt::new(BigInteger256([
                    0xb4c1972e044567f4,
                    0x8e14aacbecb9fb59,
                    0x2c0f182612f81cd9,
                    0x34d6a5db27797543,
                ])),
                Felt::new(BigInteger256([
                    0xb4c1972e044567f4,
                    0x8e14aacbecb9fb59,
                    0x2c0f182612f81cd9,
                    0x34d6a5db27797543,
                ])),
                Felt::new(BigInteger256([
                    0xb4c1972e044567f4,
                    0x8e14aacbecb9fb59,
                    0x2c0f182612f81cd9,
                    0x34d6a5db27797543,
                ])),
                Felt::new(BigInteger256([
                    0xb4c1972e044567f4,
                    0x8e14aacbecb9fb59,
                    0x2c0f182612f81cd9,
                    0x34d6a5db27797543,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x34413b9512617cf9,
                    0x7e6bdaab3f8443c5,
                    0x752178862c9a6ab7,
                    0x3dde7b14d2951772,
                ])),
                Felt::new(BigInteger256([
                    0x34413b9512617cf9,
                    0x7e6bdaab3f8443c5,
                    0x752178862c9a6ab7,
                    0x3dde7b14d2951772,
                ])),
                Felt::new(BigInteger256([
                    0x34413b9512617cf9,
                    0x7e6bdaab3f8443c5,
                    0x752178862c9a6ab7,
                    0x3dde7b14d2951772,
                ])),
                Felt::new(BigInteger256([
                    0x34413b9512617cf9,
                    0x7e6bdaab3f8443c5,
                    0x752178862c9a6ab7,
                    0x3dde7b14d2951772,
                ])),
                Felt::new(BigInteger256([
                    0xbdf2fa0b931e7a04,
                    0x60f39c6eae7a9a3c,
                    0x34e97cf1bd62a467,
                    0x13b9e8a487cc4745,
                ])),
                Felt::new(BigInteger256([
                    0xbdf2fa0b931e7a04,
                    0x60f39c6eae7a9a3c,
                    0x34e97cf1bd62a467,
                    0x13b9e8a487cc4745,
                ])),
                Felt::new(BigInteger256([
                    0xbdf2fa0b931e7a04,
                    0x60f39c6eae7a9a3c,
                    0x34e97cf1bd62a467,
                    0x13b9e8a487cc4745,
                ])),
                Felt::new(BigInteger256([
                    0xbdf2fa0b931e7a04,
                    0x60f39c6eae7a9a3c,
                    0x34e97cf1bd62a467,
                    0x13b9e8a487cc4745,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xdb6db6ecdb6db6ca,
                    0x035ffa14db8a4eec,
                    0x5ea2264f581fdd5a,
                    0x401b2e0d73d97883,
                ])),
                Felt::new(BigInteger256([
                    0xdb6db6ecdb6db6ca,
                    0x035ffa14db8a4eec,
                    0x5ea2264f581fdd5a,
                    0x401b2e0d73d97883,
                ])),
                Felt::new(BigInteger256([
                    0xdb6db6ecdb6db6ca,
                    0x035ffa14db8a4eec,
                    0x5ea2264f581fdd5a,
                    0x401b2e0d73d97883,
                ])),
                Felt::new(BigInteger256([
                    0xdb6db6ecdb6db6ca,
                    0x035ffa14db8a4eec,
                    0x5ea2264f581fdd5a,
                    0x401b2e0d73d97883,
                ])),
                Felt::new(BigInteger256([
                    0xfffffffd00000003,
                    0xfb38ec08fffb13fc,
                    0x99ad88181ce5880f,
                    0x5bc8f5f97cd877d8,
                ])),
                Felt::new(BigInteger256([
                    0xfffffffd00000003,
                    0xfb38ec08fffb13fc,
                    0x99ad88181ce5880f,
                    0x5bc8f5f97cd877d8,
                ])),
                Felt::new(BigInteger256([
                    0xfffffffd00000003,
                    0xfb38ec08fffb13fc,
                    0x99ad88181ce5880f,
                    0x5bc8f5f97cd877d8,
                ])),
                Felt::new(BigInteger256([
                    0xfffffffd00000003,
                    0xfb38ec08fffb13fc,
                    0x99ad88181ce5880f,
                    0x5bc8f5f97cd877d8,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xa5a06672dbac8a80,
                    0x83869481ae0e0b93,
                    0xe347807b58724a7c,
                    0x2edcc34bace1c311,
                ])),
                Felt::new(BigInteger256([
                    0x2ea5e0ede90edd43,
                    0x0d035d277fce9e55,
                    0xd4d89686c9246ebe,
                    0x2d318fcf866b471d,
                ])),
                Felt::new(BigInteger256([
                    0xf7e06075ca257dae,
                    0x7d1145141bb32e13,
                    0x0fa535dbeb22d94f,
                    0x1cc604f17d99e430,
                ])),
                Felt::new(BigInteger256([
                    0x0595143236ca9c3e,
                    0xbd245e62e83f42f5,
                    0xc32fafab601be9e6,
                    0x3e32a16570527392,
                ])),
                Felt::new(BigInteger256([
                    0xdc85b578f1e716af,
                    0x19f5f9ea3d18b26d,
                    0xe56bfe8d734d2eda,
                    0x3af2bac283efe7f7,
                ])),
                Felt::new(BigInteger256([
                    0xe14acfa06a8ab228,
                    0x7b199fad016599cf,
                    0x3371f163a79f927b,
                    0x36047f9b58e9014b,
                ])),
                Felt::new(BigInteger256([
                    0x57c524a066bd4aca,
                    0xfebc2f0d23c988df,
                    0xae4b787ce8f18b45,
                    0x0062000b5407e94b,
                ])),
                Felt::new(BigInteger256([
                    0x516240f1e60c00bf,
                    0x3453e58369e61444,
                    0x7a15564df0e8f50f,
                    0x260d76a062c9599c,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x26b748cec909ee9f,
                    0x2923aa8b97eb274e,
                    0x58497d8fd4883ac2,
                    0x63901920698d5bdc,
                ])),
                Felt::new(BigInteger256([
                    0xdb4af838eb2a72ee,
                    0xfd85b109925e1b99,
                    0xf73c87521f841b88,
                    0x2986e25e39226ace,
                ])),
                Felt::new(BigInteger256([
                    0x5c2ecb88db31cbeb,
                    0x46a3d77875d93950,
                    0xcfe2db087c740077,
                    0x33c31f4d8b7a3875,
                ])),
                Felt::new(BigInteger256([
                    0x8e1d43c7b42122b5,
                    0x7907fb0cfda73f66,
                    0x7e927095abc8a2e4,
                    0x318a151543d9b450,
                ])),
                Felt::new(BigInteger256([
                    0x2802d884df9b5301,
                    0x4281f7414394005d,
                    0x1230e17d3c53acf1,
                    0x262492f8cf6e8f1f,
                ])),
                Felt::new(BigInteger256([
                    0x03d394eca9a184fe,
                    0xaa2fb55c83794f74,
                    0x614ab14890352cd8,
                    0x0f281338b012b774,
                ])),
                Felt::new(BigInteger256([
                    0xd0e3cb2fa82f590b,
                    0x64d23a8e8276b853,
                    0x4ed7e561992a4f69,
                    0x6a7d9635a67206ab,
                ])),
                Felt::new(BigInteger256([
                    0xd4426ef197d33769,
                    0x49b706f06c6ed780,
                    0x5de7a344f1a75ce4,
                    0x72be6d0ce8bda4ed,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xe1f6d2b6d8ee0828,
                    0x155b81fd06ece3d1,
                    0xf9132037f0a02244,
                    0x1233c9c3df618cd2,
                ])),
                Felt::new(BigInteger256([
                    0x4a4e3d8d733c4c07,
                    0xb59a5495a9210abb,
                    0x4bba2a3976d7a149,
                    0x500043be3a099c1d,
                ])),
                Felt::new(BigInteger256([
                    0x441372941e9e30c9,
                    0xd946ca7327c9f5ae,
                    0xed5f63c384e19ae1,
                    0x4b6666452ca1d05d,
                ])),
                Felt::new(BigInteger256([
                    0xd9236da3f457bbb3,
                    0xf5bcd23c3f10d545,
                    0xb941d744338ad976,
                    0x25cc7d6d15eb7364,
                ])),
                Felt::new(BigInteger256([
                    0x02b2226901f19867,
                    0xb07ec0d3a8c0e3b7,
                    0x7ca595d0411ccfa9,
                    0x1394ed3e1de54095,
                ])),
                Felt::new(BigInteger256([
                    0x376976388e627ff5,
                    0xdb415cf4f3d4f19d,
                    0x9301b983719ce63d,
                    0x210309fe78fa5d20,
                ])),
                Felt::new(BigInteger256([
                    0x8067cf5e9561f0e7,
                    0x7cea12f5bc936705,
                    0x0c954387f7baaf21,
                    0x58be8f48f00691b6,
                ])),
                Felt::new(BigInteger256([
                    0x8b51ec547c6c17b3,
                    0xbc10330632805797,
                    0xd635cb9f556fcad6,
                    0x3e8acbe20569ef6a,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xd40f7b36d5d6baea,
                    0xd0807ac240a07cd9,
                    0xf0e64d264ab55f3c,
                    0x1b75644834cefe18,
                ])),
                Felt::new(BigInteger256([
                    0xc4f97bc877b23636,
                    0x92c318b7bfb47f75,
                    0x0af8e764be267090,
                    0x35595b08ed2f5b8e,
                ])),
                Felt::new(BigInteger256([
                    0x96e0dfaccec31705,
                    0x2dd137a946663400,
                    0x8fee73db7f68fe9b,
                    0x30d06ad848d686a3,
                ])),
                Felt::new(BigInteger256([
                    0x4b122dfc9233165c,
                    0xb16297298fcd63ec,
                    0x846fa69b3f76147a,
                    0x1654f15feceadc0b,
                ])),
                Felt::new(BigInteger256([
                    0xaff357a8157c7a1c,
                    0xcefaf4d5256908c1,
                    0xcc7fd46fa2011a7a,
                    0x62cd9790f1379c4c,
                ])),
                Felt::new(BigInteger256([
                    0x7a7c68b89a81db21,
                    0xb167e0d0317cf2d7,
                    0x78fc69f2f1bd2ff0,
                    0x651a2c2dd7b2a0e0,
                ])),
                Felt::new(BigInteger256([
                    0x3fd61c10377d5f7e,
                    0xf7b5b1d1266fe15b,
                    0x9753421ebe5a6e0a,
                    0x12fdd516f2fcca5e,
                ])),
                Felt::new(BigInteger256([
                    0xc304c41d1da20d10,
                    0x27866affc08596e1,
                    0xcaee993f1181e5cf,
                    0x129c22327a483945,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x5950b6d402da315c,
                    0xdc9343eb13d6ef51,
                    0xb7eee8601b9f0fe3,
                    0x509d6d8bfb81b23d,
                ])),
                Felt::new(BigInteger256([
                    0x610449b78e0fba8f,
                    0x98e998f01bce0b0d,
                    0xbafc544d6c945369,
                    0x5546b5e4dbc7605d,
                ])),
                Felt::new(BigInteger256([
                    0xfe4218b1219d6a01,
                    0x6aa351b98aa0f849,
                    0x2e72a6a1570c39a0,
                    0x30f80b1aa19bd925,
                ])),
                Felt::new(BigInteger256([
                    0x8076cad1e5e4b11e,
                    0x5555a3fc03301cc0,
                    0xfff7e54c71a26f9e,
                    0x5654664d0ca507e7,
                ])),
                Felt::new(BigInteger256([
                    0xdabd6c2ae9ea37a0,
                    0x38cdabaf57b19a75,
                    0x8739866f1ff5e608,
                    0x4bf39db2b02a8c9d,
                ])),
                Felt::new(BigInteger256([
                    0x2b86b43504c1463b,
                    0xf826680447b43710,
                    0x5088dcbe081052f5,
                    0x49502288c188b10b,
                ])),
                Felt::new(BigInteger256([
                    0xc8faaa134c3ebeb8,
                    0x04252aaecdd99e95,
                    0x5fe9aa19a1a52d71,
                    0x215738f05dff6737,
                ])),
                Felt::new(BigInteger256([
                    0x2eab7a6af860692b,
                    0x1ac7d65ea53b24ca,
                    0x4a8f9237698d1e6a,
                    0x17cb04da3c553e16,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x1b1fbce9eefce81f,
                    0xe0ef916197c48226,
                    0xac8548f0fe12b951,
                    0x5a0601ce4448cb19,
                ])),
                Felt::new(BigInteger256([
                    0x87df6e8b2279753b,
                    0xb74c6fe7b60cb074,
                    0x86de26e51a320aea,
                    0x205d12062be7e0bf,
                ])),
                Felt::new(BigInteger256([
                    0xb23d8d614fb80170,
                    0x42109c7567a59a95,
                    0x50138e84dd939df3,
                    0x1d546eb8ed55b37d,
                ])),
                Felt::new(BigInteger256([
                    0x75b78394aca82dfd,
                    0x3cbadab379734dc7,
                    0x59450ca4a2f3a5bb,
                    0x39d0e6c4813e4e5a,
                ])),
                Felt::new(BigInteger256([
                    0x739eb4dfdaee8f24,
                    0xd41742619b64f578,
                    0x548646dbc959de45,
                    0x6e374e80b6da5597,
                ])),
                Felt::new(BigInteger256([
                    0xe31bbaa84b638978,
                    0x95920967d01edbf1,
                    0x6872103367a17fcb,
                    0x00e1167fd056c9ea,
                ])),
                Felt::new(BigInteger256([
                    0x39b05327055dd0dc,
                    0x822557b76be91937,
                    0xc728ff0de9507944,
                    0x3f7952bd7e0f3c62,
                ])),
                Felt::new(BigInteger256([
                    0x5229417ffb133974,
                    0xc27cf24ee6e4d97c,
                    0x4b3be5793bfdc4fa,
                    0x65f07f92bd5f0ece,
                ])),
            ],
        ];

        for i in input.iter_mut() {
            apply_sbox(i);
        }

        for (&i, o) in input.iter().zip(output) {
            assert_eq!(i, o);
        }
    }

    #[test]
    fn test_mds() {
        // Generated from https://github.com/Nashtare/anemoi-hash/
        let mut input = [
            [Felt::zero(); 8],
            [Felt::one(); 8],
            [
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
            ],
            [
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
            ],
            [
                Felt::new(BigInteger256([
                    0x22f742d592082927,
                    0xc841acc115de554c,
                    0x8cf7025249993409,
                    0x2b7582beaa0ff110,
                ])),
                Felt::new(BigInteger256([
                    0xad099859b5aac6f1,
                    0x2b9c3355dc482741,
                    0xf922dc581e468855,
                    0x73bc8da6ce1aa473,
                ])),
                Felt::new(BigInteger256([
                    0x4dfbd57f383d545a,
                    0x8c7b9d08fb48fad7,
                    0xf6f4303c33cf24cc,
                    0x491a596b4ccec972,
                ])),
                Felt::new(BigInteger256([
                    0x0eeac0e74a7f7d2a,
                    0xfe64b336c1fbece4,
                    0x4630bee850b224f9,
                    0x234f901e9542a8d4,
                ])),
                Felt::new(BigInteger256([
                    0x78e0bf277f04beb1,
                    0x671acc0c298bdaec,
                    0x47bc29943e1cdae8,
                    0x0db31a4e252acebb,
                ])),
                Felt::new(BigInteger256([
                    0x823c285b4fe77cd7,
                    0x7e3f8d31646d153c,
                    0xe7917ec2a934919e,
                    0x183a1cdcc1a659bf,
                ])),
                Felt::new(BigInteger256([
                    0x41e5b04ea8b0a492,
                    0x620f8fe88b111353,
                    0x135bc11363706720,
                    0x101234c9d95296c6,
                ])),
                Felt::new(BigInteger256([
                    0xf7cc5579d7875789,
                    0xc2d377c56e2aa73e,
                    0xb580c8bd0536fc7c,
                    0x33cee4ac9e37870c,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xbde0acd840c63ba4,
                    0x7f5684b4e7939039,
                    0x5748afaccb6e6964,
                    0x664188722fc89845,
                ])),
                Felt::new(BigInteger256([
                    0x943fa3cafa74fc9b,
                    0xd6c725717f178037,
                    0x2929e5184613f53c,
                    0x30398fc2110184fb,
                ])),
                Felt::new(BigInteger256([
                    0x24ed7b5bfc6adcd1,
                    0x3c2d60a57b872ba9,
                    0x3a661fff0d7d1797,
                    0x23406731207d4c91,
                ])),
                Felt::new(BigInteger256([
                    0xfa1f9a17539eea99,
                    0x151890f9c024eaf6,
                    0xe213c46e4233708a,
                    0x158d1405060acd2a,
                ])),
                Felt::new(BigInteger256([
                    0x667b11a065ecac46,
                    0x5ad2725771a077d5,
                    0x6290b121dba6c77c,
                    0x5773a37d818df04a,
                ])),
                Felt::new(BigInteger256([
                    0x9f0b2771d90a1404,
                    0x6416664cba82cc37,
                    0xfe3a948438e3f346,
                    0x3ee553930042dfe3,
                ])),
                Felt::new(BigInteger256([
                    0xc60ff7549071ca2f,
                    0xa72924c4841f247d,
                    0x06b1037a6f27f061,
                    0x1c50bd57f8c14bf3,
                ])),
                Felt::new(BigInteger256([
                    0x761297862350f1b8,
                    0x4bc505348fa9485f,
                    0x7a5d91089e313e5e,
                    0x241b573c8554af17,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xf039933eac583027,
                    0x61298e193860ceb0,
                    0x282b2f5877f5c70f,
                    0x338204c6637f5840,
                ])),
                Felt::new(BigInteger256([
                    0xaebab5e30a68a122,
                    0xdbfbb9e9cf93034d,
                    0x97d71516df39c690,
                    0x6e5e2e4db35c2a2a,
                ])),
                Felt::new(BigInteger256([
                    0xf8bad1b43564cc3a,
                    0xa9e7aab1361dc35d,
                    0x013fa75ebaea0f91,
                    0x2f72b4aeaa3851d9,
                ])),
                Felt::new(BigInteger256([
                    0x12dcfcf815f3fd40,
                    0xc2c8ebe9183d2276,
                    0xee9f9374ae4c1e8f,
                    0x19acba6533e4f93f,
                ])),
                Felt::new(BigInteger256([
                    0xbbde8c8d174c781e,
                    0x4b6fd5e99db34257,
                    0xe4da9c6190b6dcc4,
                    0x18985e14283202a5,
                ])),
                Felt::new(BigInteger256([
                    0x0846046f09a56460,
                    0x94df809fee7b15f1,
                    0x2ed63f495dbe5d9e,
                    0x340de86fc105846e,
                ])),
                Felt::new(BigInteger256([
                    0xab69055f8a1ce52f,
                    0x919d056cbe4885d4,
                    0xb63df789d641f52a,
                    0x591f83603da99d84,
                ])),
                Felt::new(BigInteger256([
                    0x0103fa2b3ff9d958,
                    0x96dc5692db1838ed,
                    0x2ed41437ebb37897,
                    0x236dbb5254d75ef8,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xa42cf9c349ece5cb,
                    0x2ed70e845647a04b,
                    0xaa9f11b688b75a55,
                    0x262854565d1181a1,
                ])),
                Felt::new(BigInteger256([
                    0x5895a43d929df236,
                    0x4fbb919d74ce81b6,
                    0x0aef98b5458c571e,
                    0x3df4a5ce42b503ae,
                ])),
                Felt::new(BigInteger256([
                    0x03401cfbe6ef4864,
                    0x72f0fef2a138bcdd,
                    0x84a357d432531aa8,
                    0x4be4583b5e1c5671,
                ])),
                Felt::new(BigInteger256([
                    0x71925348b788ceb8,
                    0xb1c76688cf563d46,
                    0x85f9b0bc248518bf,
                    0x09220b093e00751f,
                ])),
                Felt::new(BigInteger256([
                    0x3b9c48817a90129c,
                    0x8e970097d4320a34,
                    0x4d3845905d8910f1,
                    0x3317393f274cd2a2,
                ])),
                Felt::new(BigInteger256([
                    0x5dce38a73ac83a79,
                    0xc984bfb30f70a504,
                    0x3e531d1513e1580a,
                    0x6055f9fa6419a1ba,
                ])),
                Felt::new(BigInteger256([
                    0xc5a5dca75de2e23d,
                    0x5238de12e8c1c0a8,
                    0xe8d29f35cb3325ab,
                    0x2d8331f00d03b72a,
                ])),
                Felt::new(BigInteger256([
                    0x256285f6420eb371,
                    0x13d97ead68a4c66c,
                    0xa8ec6bb002560212,
                    0x10759e1fbe23fa5b,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x844306055ecc7804,
                    0xc107a9363ec1b5fa,
                    0xdf6184008ccabd4e,
                    0x2c77259397d32552,
                ])),
                Felt::new(BigInteger256([
                    0x98fea593d7a23fca,
                    0xf378f60d61d0a367,
                    0xbace256aed723793,
                    0x09904e16d0afd739,
                ])),
                Felt::new(BigInteger256([
                    0x169dbce54da4d70f,
                    0xd15af0ca3d5220f6,
                    0x204857cecbef3acd,
                    0x279ef1813022c2ee,
                ])),
                Felt::new(BigInteger256([
                    0xe84b9b60376d1f58,
                    0x3c9c6d7f0052acd4,
                    0xcab7406ec0181e80,
                    0x086d790e9071faf8,
                ])),
                Felt::new(BigInteger256([
                    0xb84d9d80324cf647,
                    0x2d055a32e874552b,
                    0x845905fa6a33b4c5,
                    0x5f5696bd26e24d2c,
                ])),
                Felt::new(BigInteger256([
                    0xdb714dd62f7f7ba2,
                    0xae8a83d9ce03665e,
                    0x7fd81044f436eedd,
                    0x0fe584512f2742fe,
                ])),
                Felt::new(BigInteger256([
                    0x58bbdc3e8ba39fd3,
                    0x0a0c8c39228024ae,
                    0x81bcf1a481474389,
                    0x1eec17b7809d63f7,
                ])),
                Felt::new(BigInteger256([
                    0x2088ba2c5d316080,
                    0x780446f3ddaf3c94,
                    0x09215521cea8d4ba,
                    0x23f984568e6f547f,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x5c5afa06c79f7256,
                    0x93034b2ea97a049a,
                    0x327b13c3651dbc07,
                    0x6791338e2e6f8c52,
                ])),
                Felt::new(BigInteger256([
                    0x13cfb0c003137efd,
                    0x471990c4333a476f,
                    0x1b580e260e36e6a3,
                    0x7310ae52765b6f19,
                ])),
                Felt::new(BigInteger256([
                    0xa6aabe4b513a14d2,
                    0xdc144f60c2e7d3a5,
                    0x0cbc96ee537ef0dd,
                    0x10cf1d440591befe,
                ])),
                Felt::new(BigInteger256([
                    0xde843a6413664b91,
                    0x1517dcdefe81dd1a,
                    0x8c690a9f531d6ad5,
                    0x4bd90559edd3e2ff,
                ])),
                Felt::new(BigInteger256([
                    0x378532c4f481c0fc,
                    0xced33d0ffe3721b7,
                    0x120fa09e34f62fc5,
                    0x3249c9bb72957f34,
                ])),
                Felt::new(BigInteger256([
                    0xdc63852a70ee4190,
                    0x48ed81a5fe1953bb,
                    0x888ba240e9790bb0,
                    0x2746ca7705b2800a,
                ])),
                Felt::new(BigInteger256([
                    0xc570ed14e5257fd1,
                    0x1cbb5ea6113fd736,
                    0x329a4fa49ef900d0,
                    0x2fb7e0440708ee96,
                ])),
                Felt::new(BigInteger256([
                    0x19800a15465b4d51,
                    0x13769a983b11c8a5,
                    0x341fc977bea695e3,
                    0x536ba2c09d4d5cf3,
                ])),
            ],
        ];

        let mut input2 = input;

        let output = [
            [Felt::zero(); 8],
            [
                Felt::new(BigInteger256([
                    0x00000031ffffffce,
                    0xa4f5f76a00520832,
                    0xfeb3ce6e1e63cef5,
                    0x5b9551c1df3d87e5,
                ])),
                Felt::new(BigInteger256([
                    0x00000119fffffee6,
                    0xc11954b201cea91a,
                    0x9248072563b80a21,
                    0x4c35ae642883fe77,
                ])),
                Felt::new(BigInteger256([
                    0x000000ebffffff14,
                    0xcd2ccd3c018330ec,
                    0xc6acd8971eccdb16,
                    0x20e9bf55a2d08170,
                ])),
                Felt::new(BigInteger256([
                    0x00000052ffffffad,
                    0xd983d30700882c53,
                    0x643ef564e086f645,
                    0x69f2c00981f06197,
                ])),
                Felt::new(BigInteger256([
                    0x00000031ffffffce,
                    0xa4f5f76a00520832,
                    0xfeb3ce6e1e63cef5,
                    0x5b9551c1df3d87e5,
                ])),
                Felt::new(BigInteger256([
                    0x00000119fffffee6,
                    0xc11954b201cea91a,
                    0x9248072563b80a21,
                    0x4c35ae642883fe77,
                ])),
                Felt::new(BigInteger256([
                    0x000000ebffffff14,
                    0xcd2ccd3c018330ec,
                    0xc6acd8971eccdb16,
                    0x20e9bf55a2d08170,
                ])),
                Felt::new(BigInteger256([
                    0x00000052ffffffad,
                    0xd983d30700882c53,
                    0x643ef564e086f645,
                    0x69f2c00981f06197,
                ])),
            ],
            [
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::new(BigInteger256([
                    0x00000031ffffffce,
                    0xa4f5f76a00520832,
                    0xfeb3ce6e1e63cef5,
                    0x5b9551c1df3d87e5,
                ])),
                Felt::new(BigInteger256([
                    0x00000119fffffee6,
                    0xc11954b201cea91a,
                    0x9248072563b80a21,
                    0x4c35ae642883fe77,
                ])),
                Felt::new(BigInteger256([
                    0x000000ebffffff14,
                    0xcd2ccd3c018330ec,
                    0xc6acd8971eccdb16,
                    0x20e9bf55a2d08170,
                ])),
                Felt::new(BigInteger256([
                    0x00000052ffffffad,
                    0xd983d30700882c53,
                    0x643ef564e086f645,
                    0x69f2c00981f06197,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x00000031ffffffce,
                    0xa4f5f76a00520832,
                    0xfeb3ce6e1e63cef5,
                    0x5b9551c1df3d87e5,
                ])),
                Felt::new(BigInteger256([
                    0x00000119fffffee6,
                    0xc11954b201cea91a,
                    0x9248072563b80a21,
                    0x4c35ae642883fe77,
                ])),
                Felt::new(BigInteger256([
                    0x000000ebffffff14,
                    0xcd2ccd3c018330ec,
                    0xc6acd8971eccdb16,
                    0x20e9bf55a2d08170,
                ])),
                Felt::new(BigInteger256([
                    0x00000052ffffffad,
                    0xd983d30700882c53,
                    0x643ef564e086f645,
                    0x69f2c00981f06197,
                ])),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
            ],
            [
                Felt::new(BigInteger256([
                    0x1592227ed2881b3d,
                    0x5ce681042518dd87,
                    0x34e69ea2547caad6,
                    0x69402c2e02c25ab0,
                ])),
                Felt::new(BigInteger256([
                    0xdb0d185ad04e5d22,
                    0x0404874197e9ce5a,
                    0xb3a34be9ef310fd1,
                    0x672c002a4a2faf28,
                ])),
                Felt::new(BigInteger256([
                    0x957bd10c457931fc,
                    0x473e425164f91162,
                    0xd19cb3e9f8f24954,
                    0x29303d0e95fa6cb4,
                ])),
                Felt::new(BigInteger256([
                    0xd482e1bb12ec2905,
                    0xc0f3ecbd86329a55,
                    0x258a03e31bfa8633,
                    0x5fa5a5d341083552,
                ])),
                Felt::new(BigInteger256([
                    0xa6253b3ef3413cf8,
                    0x118bb321e2fb730b,
                    0x6ef8ef6e6bd9764b,
                    0x1fb5776713d7f5ff,
                ])),
                Felt::new(BigInteger256([
                    0x2b5029e55f74cda7,
                    0x38b577ef854a14b5,
                    0xd4c5cc5f1384bd75,
                    0x28b6b9e8fd003cf1,
                ])),
                Felt::new(BigInteger256([
                    0x494cc75064cbb218,
                    0x0778e1e791ccca39,
                    0x60ba1cc6b4503fe9,
                    0x314d942884213778,
                ])),
                Felt::new(BigInteger256([
                    0x7bf2e70e3e6ee586,
                    0xf35502dd98fdb1e8,
                    0x2cbe27ccef356e60,
                    0x5fa37e9d22965dd4,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x3939615e44b2945b,
                    0x2449cf86820fac5e,
                    0x01582f33e674e40f,
                    0x4a2cd1b7a23f074a,
                ])),
                Felt::new(BigInteger256([
                    0x9532cc4ff92f5184,
                    0x3f629e6d3f3a453e,
                    0x93625595e5893ce2,
                    0x55808e12b198e73d,
                ])),
                Felt::new(BigInteger256([
                    0xae19bb95efb7f567,
                    0x1d78d50a23d74d52,
                    0xdf42e31f06f4df6f,
                    0x2de12d3c26867feb,
                ])),
                Felt::new(BigInteger256([
                    0x723b2ff536f008a4,
                    0xa287437210f0ce77,
                    0x99856cbd4c8852d2,
                    0x69bcad3df74739ae,
                ])),
                Felt::new(BigInteger256([
                    0xd76a822d1d47b765,
                    0x39d90d29e48ef5a0,
                    0x713de738b05b071e,
                    0x6ef9377c7ff6339f,
                ])),
                Felt::new(BigInteger256([
                    0x766b6c173737b4b0,
                    0xbfc5e3cebfe2f2db,
                    0xeb2287a5fc8a37f1,
                    0x080e6d1571d397a9,
                ])),
                Felt::new(BigInteger256([
                    0x041c08af836bdb7f,
                    0xe4ea05b919f449ef,
                    0xb20a1073fddcec80,
                    0x6838edd7147f0d29,
                ])),
                Felt::new(BigInteger256([
                    0x01a36b4165977709,
                    0x9938d0e50ca87e73,
                    0x8faad818e0e8200d,
                    0x1967be20ad52e9d1,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xb735e9190f0abb81,
                    0x4cf7cb7bd988e1f6,
                    0x0f485376dea91e40,
                    0x372ba8d91dcbd7e1,
                ])),
                Felt::new(BigInteger256([
                    0x14a659253836af26,
                    0xf20721384fb84d08,
                    0xb75a3130cc3f76eb,
                    0x4effab0b78e1a347,
                ])),
                Felt::new(BigInteger256([
                    0xfc64b92edfecc4ed,
                    0x8e76f9bc7e24e110,
                    0x34da4a213b240e46,
                    0x45c68df34853d089,
                ])),
                Felt::new(BigInteger256([
                    0x22c0e607244471b6,
                    0x765d475c29812a6d,
                    0x3db555a68eefabfc,
                    0x36b13f8b518a7d3a,
                ])),
                Felt::new(BigInteger256([
                    0x8dbfde7fbd78c808,
                    0x0c747b4f2e600b81,
                    0x6a4a5f7a1663ec41,
                    0x19ec2bff796d3714,
                ])),
                Felt::new(BigInteger256([
                    0x1e8a140b6c442ce4,
                    0x95b632db5c21fc7a,
                    0xb22efc7605ef2f72,
                    0x4eedd7750fc1abda,
                ])),
                Felt::new(BigInteger256([
                    0x44793f5b428dae6a,
                    0x5c009995da8730bf,
                    0xf9befbc719e9bdf5,
                    0x4e416ff26b661970,
                ])),
                Felt::new(BigInteger256([
                    0x3367afbadf154307,
                    0xc75edb798579b049,
                    0xf8e3bb61c60e4c5a,
                    0x6f55422a4b7d3d1c,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x9a9b2d9934251936,
                    0xbc139db510b348ff,
                    0x7f5e7b0abe52e2f0,
                    0x559f57bc40f9c87f,
                ])),
                Felt::new(BigInteger256([
                    0x8eeb852f3163575f,
                    0x67e34ac3410adc9a,
                    0xa3d8039d2350c059,
                    0x3717d42786debbbe,
                ])),
                Felt::new(BigInteger256([
                    0xf112f596d9c9162a,
                    0x2a624d2ffb6db59c,
                    0xda0832fe33418edc,
                    0x4595768fe5ab788e,
                ])),
                Felt::new(BigInteger256([
                    0xf57fd2edf379cfef,
                    0xed6b8d186dae4c59,
                    0xc8e3c4894ce6c5b8,
                    0x63fa4dd2e3b6f31b,
                ])),
                Felt::new(BigInteger256([
                    0x31f4c3305236b6b4,
                    0x2e720b16ff6b7eb5,
                    0xa61a2f45bf854a54,
                    0x05dc3279c5610bc1,
                ])),
                Felt::new(BigInteger256([
                    0xd9fd8c2d08db60e7,
                    0xa2a36ae793795f77,
                    0xa7d9c3902cc914cd,
                    0x34355063df47eeaa,
                ])),
                Felt::new(BigInteger256([
                    0xcb7cde4c4f4fc6e8,
                    0x3c3159938c41ea70,
                    0xf5ab788d42b6702a,
                    0x4844a2816166be85,
                ])),
                Felt::new(BigInteger256([
                    0x65bda0e0f9749241,
                    0x8d8d97fd9d0d14ae,
                    0x38520299dfed3310,
                    0x0688bd358df1e51e,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x44999c8dbf5c3322,
                    0xc35a0198fccd5dc7,
                    0x892250eeafaa6300,
                    0x6d878a3ee48a9898,
                ])),
                Felt::new(BigInteger256([
                    0x19e46146fd2c7b79,
                    0x77eedac1584d07e2,
                    0x1aa82f99809c3bd2,
                    0x1bb0445c4a08cee5,
                ])),
                Felt::new(BigInteger256([
                    0xf28c7051743f0026,
                    0xbcd31c6efc105f7b,
                    0x5eef601e54d0a5b9,
                    0x581dd51af79eb021,
                ])),
                Felt::new(BigInteger256([
                    0xf9b0e92273d05918,
                    0xa08439e561270c4e,
                    0xbe3fd32da0e5d39e,
                    0x20728fa9aa1b8648,
                ])),
                Felt::new(BigInteger256([
                    0x8f2c958c7910d9a1,
                    0x3cc9e5944d0df01a,
                    0x6bd5aade2c265d6e,
                    0x172e76578926e999,
                ])),
                Felt::new(BigInteger256([
                    0x3a9a1fb77f3f122f,
                    0x3809595e873490a0,
                    0xafcf9ac859a65b0a,
                    0x3706f3c609893c47,
                ])),
                Felt::new(BigInteger256([
                    0xdf9ab43fc1515403,
                    0xb3d683dd2aaa2b92,
                    0x458ef1d3a2fe3002,
                    0x4eaa19773026f9a4,
                ])),
                Felt::new(BigInteger256([
                    0xb4b659a0c9539018,
                    0x7ab7c442c91ffea5,
                    0x61943622afe7eaf2,
                    0x62775b5801914fa7,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x9f214ce0a09e0ce5,
                    0xcfa60ee48d470d64,
                    0x70191f62de41a2bb,
                    0x31b071e742759917,
                ])),
                Felt::new(BigInteger256([
                    0x41ede3f28e97bd6f,
                    0xd2c501a6a6a98c06,
                    0x4203640dcdd9684b,
                    0x268354ea01a6991d,
                ])),
                Felt::new(BigInteger256([
                    0x12f741d9b8aca1dc,
                    0x897e2ab1f6186eac,
                    0xec838e8c594a9035,
                    0x5b871d903a5e7e28,
                ])),
                Felt::new(BigInteger256([
                    0x8ed032c23ee8f1ad,
                    0x4728f73d94cdf6cf,
                    0x501e46f3d1d5aff2,
                    0x20f77dd96b398213,
                ])),
                Felt::new(BigInteger256([
                    0x3f0f97d43625a428,
                    0xc5a7504f19288203,
                    0xd52dbda720963194,
                    0x51c59368e36997b4,
                ])),
                Felt::new(BigInteger256([
                    0x6c8ea41944433b61,
                    0x49c0413226ed0608,
                    0xafde25d89b06dce4,
                    0x6a1d6218f7ec1923,
                ])),
                Felt::new(BigInteger256([
                    0xcf537e846431589a,
                    0xe9c1d12f1d1daef7,
                    0x95d65a1702e2b7cf,
                    0x6f56796b213df00f,
                ])),
                Felt::new(BigInteger256([
                    0xe363ea5a8531aec5,
                    0x65a6d76182d9a862,
                    0xd1ebeb5bd6dfa8bd,
                    0x2d741c4eb56e2d9c,
                ])),
            ],
        ];

        for i in input.iter_mut() {
            apply_mds(i);
        }
        for i in input2.iter_mut() {
            apply_naive_mds(i);
        }

        for (index, (&i_1, i_2)) in input.iter().zip(input2).enumerate().skip(4) {
            println!("{:?}", index);
            assert_eq!(output[index], i_1);
            assert_eq!(output[index], i_2);
        }
    }
}
