use super::{sbox, BigInteger256, Felt};
use crate::{Jive, Sponge};
use ark_ff::{Field, One, Zero};
use unroll::unroll_for_loops;

/// Digest for Anemoi
mod digest;
/// Sponge for Anemoi
mod hasher;
/// MDS matrix for Anemoi
mod mds;
/// Round constants for Anemoi
mod round_constants;

pub use digest::AnemoiDigest;
pub use hasher::AnemoiHash;

// ANEMOI CONSTANTS
// ================================================================================================

/// Function state is set to 8 field elements or 256 bytes.
/// 1 element of the state is reserved for capacity.
pub const STATE_WIDTH: usize = 8;
/// 7 elements of the state are reserved for rate.
pub const RATE_WIDTH: usize = 7;

/// The state is divided into two even-length rows.
pub const NUM_COLUMNS: usize = 4;

/// 2 elements (64-bytes) are returned as digest.
pub const DIGEST_SIZE: usize = 2;

/// The number of rounds is set to 14 to provide 256-bit security level.
pub const NUM_HASH_ROUNDS: usize = 14;

// HELPER FUNCTIONS
// ================================================================================================

#[inline(always)]
/// Applies exponentiation of the current hash
/// state elements with the Anemoi S-Box.
pub(crate) fn apply_sbox(state: &mut [Felt; STATE_WIDTH]) {
    let mut x: [Felt; NUM_COLUMNS] = state[..NUM_COLUMNS].try_into().unwrap();
    let mut y: [Felt; NUM_COLUMNS] = state[NUM_COLUMNS..].try_into().unwrap();

    x.iter_mut().enumerate().for_each(|(i, t)| {
        let y2 = y[i].square();
        let beta_y2 = y2 + (y2 + y2.double()).double();
        *t -= beta_y2;
    });

    let mut x_alpha_inv = x;
    x_alpha_inv
        .iter_mut()
        .for_each(|t| *t = sbox::exp_inv_alpha(t));

    y.iter_mut()
        .enumerate()
        .for_each(|(i, t)| *t -= x_alpha_inv[i]);

    x.iter_mut().enumerate().for_each(|(i, t)| {
        let y2 = y[i].square();
        let beta_y2 = y2 + (y2 + y2.double()).double();
        *t += beta_y2 + sbox::DELTA;
    });

    state[..NUM_COLUMNS].copy_from_slice(&x);
    state[NUM_COLUMNS..].copy_from_slice(&y);
}

#[inline(always)]
/// Applies matrix-vector multiplication of the current
/// hash state with the Anemoi MDS matrix.
pub(crate) fn apply_mds(state: &mut [Felt; STATE_WIDTH]) {
    let x: [Felt; NUM_COLUMNS] = [state[0], state[1], state[2], state[3]];
    let y: [Felt; NUM_COLUMNS] = [state[5], state[6], state[7], state[4]];

    let sum_coeffs = x[0] + x[1] + x[2] + x[3];
    state[0] = sum_coeffs + x[2] + x[3].double();
    state[1] = sum_coeffs + x[3] + x[0].double();
    state[2] = sum_coeffs + x[0] + x[1].double();
    state[3] = sum_coeffs + x[1] + x[2].double();

    let sum_coeffs = y[0] + y[1] + y[2] + y[3];
    state[4] = sum_coeffs + y[2] + y[3].double();
    state[5] = sum_coeffs + y[3] + y[0].double();
    state[6] = sum_coeffs + y[0] + y[1].double();
    state[7] = sum_coeffs + y[1] + y[2].double();
}

// ANEMOI PERMUTATION
// ================================================================================================

/// Applies Anemoi permutation to the provided state.
#[inline(always)]
#[unroll_for_loops]
pub(crate) fn apply_permutation(state: &mut [Felt; STATE_WIDTH]) {
    for i in 0..NUM_HASH_ROUNDS {
        apply_round(state, i);
    }

    apply_mds(state)
}

/// Anemoi round function;
/// implementation based on algorithm 3 of <https://eprint.iacr.org/2020/1143.pdf>
#[inline(always)]
#[unroll_for_loops]
pub(crate) fn apply_round(state: &mut [Felt; STATE_WIDTH], step: usize) {
    // determine which round constants to use
    let c = &round_constants::C[step % NUM_HASH_ROUNDS];
    let d = &round_constants::D[step % NUM_HASH_ROUNDS];

    for i in 0..NUM_COLUMNS {
        state[i] += c[i];
        state[NUM_COLUMNS + i] += d[i];
    }

    apply_mds(state);
    apply_sbox(state);
}

#[cfg(test)]
mod tests {
    use super::*;

    fn apply_naive_mds(state: &mut [Felt; STATE_WIDTH]) {
        let x: [Felt; NUM_COLUMNS] = state[..NUM_COLUMNS].try_into().unwrap();
        let mut y: [Felt; NUM_COLUMNS] = [Felt::zero(); NUM_COLUMNS];
        y[0..NUM_COLUMNS - 1].copy_from_slice(&state[NUM_COLUMNS + 1..]);
        y[NUM_COLUMNS - 1] = state[NUM_COLUMNS];

        let mut result = [Felt::zero(); STATE_WIDTH];
        for (i, r) in result.iter_mut().enumerate().take(NUM_COLUMNS) {
            for (j, s) in x.into_iter().enumerate().take(NUM_COLUMNS) {
                *r += s * mds::MDS[i * NUM_COLUMNS + j];
            }
        }
        for (i, r) in result.iter_mut().enumerate().skip(NUM_COLUMNS) {
            for (j, s) in y.into_iter().enumerate() {
                *r += s * mds::MDS[(i - NUM_COLUMNS) * NUM_COLUMNS + j];
            }
        }

        state.copy_from_slice(&result);
    }

    #[test]
    fn test_sbox() {
        // Generated from https://github.com/Nashtare/anemoi-hash/
        let mut input = [
            [Felt::zero(); 8],
            [Felt::one(); 8],
            [
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
            ],
            [
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
            ],
            [
                Felt::new(BigInteger256([
                    0x68e74a169b229f7f,
                    0x117c6e9a2649b36c,
                    0x27b3d9352c8681fc,
                    0x6525253da77fbfbb,
                ])),
                Felt::new(BigInteger256([
                    0x98940e041e37e670,
                    0xacd6a32fc6258594,
                    0xcf31b25d036f9b39,
                    0x2cfb6a3b05aa0a91,
                ])),
                Felt::new(BigInteger256([
                    0x88c7fc137f5bd68b,
                    0x6dbd1710ee4e45eb,
                    0xf83f8480e452e623,
                    0x3738fedbf772d0d9,
                ])),
                Felt::new(BigInteger256([
                    0x659872e1bdf2f660,
                    0xc686001766f429b0,
                    0x4ad67bf14f79495f,
                    0x4d8ec7549a4a23ce,
                ])),
                Felt::new(BigInteger256([
                    0x71fdadd1093da442,
                    0x2c765d387bac32d0,
                    0x3f212c90f2b2d46b,
                    0x0b5004d191122fbb,
                ])),
                Felt::new(BigInteger256([
                    0x7da580d79371d834,
                    0xb7d80f57c44d5ca1,
                    0x03cef82f678d513f,
                    0x0abbafee223fbb35,
                ])),
                Felt::new(BigInteger256([
                    0x8b7d3c400289eab0,
                    0xadff2d1adaaa8394,
                    0xaa30a2a6edbcde35,
                    0x22c2fd84843ee5c5,
                ])),
                Felt::new(BigInteger256([
                    0x427a78f626a2de2e,
                    0xd0319a20628e9803,
                    0x993fbf1c328c4787,
                    0x07b4c4219a28163d,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xd7b64915636866c5,
                    0x06e1feee74705719,
                    0x04b047d0c393afa2,
                    0x7235e470c9fb3336,
                ])),
                Felt::new(BigInteger256([
                    0x7a171a77c1a07ed1,
                    0xd65645efdf8d9158,
                    0x81efc5fc87404216,
                    0x24799b041203de16,
                ])),
                Felt::new(BigInteger256([
                    0x364140a790bf9b7d,
                    0x1d8b01bc4b7002b9,
                    0xaab6746d8c0bce32,
                    0x70dccebe341f6c94,
                ])),
                Felt::new(BigInteger256([
                    0x2b863b794f7cf3c2,
                    0x416180d6671e5af0,
                    0xf2d748b6a1fd182e,
                    0x42b3178d81478670,
                ])),
                Felt::new(BigInteger256([
                    0x2977dd14abd1e551,
                    0x13222038e3de0b0a,
                    0x97c4c841e7ff25a3,
                    0x32c3acd0bf34c192,
                ])),
                Felt::new(BigInteger256([
                    0xc55afafd51215240,
                    0x767dab43a4aa71bc,
                    0x340d5a7468f4d5f8,
                    0x12f240877179ef72,
                ])),
                Felt::new(BigInteger256([
                    0x6e5a16a120109626,
                    0x90305552795bafe9,
                    0xbd7ed0480016f4bb,
                    0x43716031e0212535,
                ])),
                Felt::new(BigInteger256([
                    0x213f96cdc1717709,
                    0x29412c0f9b9ef24d,
                    0xa9ceea02a7329572,
                    0x3ae73ab3ca2acb64,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x3d28cb39f7b0c9b7,
                    0xcfd329282a11c3e4,
                    0xb911055307ccb0e7,
                    0x481795964d13103b,
                ])),
                Felt::new(BigInteger256([
                    0x52c841519efdf6f8,
                    0x8c9887be90febf08,
                    0xa5827d905b31f8c7,
                    0x443ad19409814a17,
                ])),
                Felt::new(BigInteger256([
                    0xb5aaf9d45224b9d4,
                    0xe6e43e9e2241834f,
                    0xe33fc9dd86625703,
                    0x1e45f042b3a020de,
                ])),
                Felt::new(BigInteger256([
                    0x7b25f4c43e2e2451,
                    0x9990834816962edb,
                    0x89ad7bcba23c4f36,
                    0x4be3e51228480477,
                ])),
                Felt::new(BigInteger256([
                    0xfed354fec3add233,
                    0x85dd293fb4afb22c,
                    0x4aa243694838f5f4,
                    0x0538e3b95448c234,
                ])),
                Felt::new(BigInteger256([
                    0x5f7ecb5370409287,
                    0x61d67a11608a25c9,
                    0xfe34b0d4ee7b8793,
                    0x289cdbc63b93d46c,
                ])),
                Felt::new(BigInteger256([
                    0x26730dcb3f59d913,
                    0x567b4a11a26c464d,
                    0xb69d5525a92df741,
                    0x5c0a851e7eb3fe64,
                ])),
                Felt::new(BigInteger256([
                    0x09a20733ec445478,
                    0x264f6df2734507fe,
                    0x6097a826b394bff6,
                    0x19ebad90fa6249d8,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xc18be1779b5f4d9c,
                    0x5671edeecc9dd12f,
                    0x93f7edec1d5d2cd9,
                    0x4ecd509222afb942,
                ])),
                Felt::new(BigInteger256([
                    0x0fff30d81e0cc995,
                    0x24f9b30296c0018e,
                    0x8c638ef088eeb4d8,
                    0x55bcee4dfbb5e544,
                ])),
                Felt::new(BigInteger256([
                    0xdba95682a2e1558d,
                    0x54c3d0ca3ceed4a4,
                    0xbadc53b84fdcf419,
                    0x2cc1bc47685ded22,
                ])),
                Felt::new(BigInteger256([
                    0x1799d5e6b67a3766,
                    0xf11cfffb63290ac9,
                    0xbbe7483fa54f8c40,
                    0x1430341caf4d09ec,
                ])),
                Felt::new(BigInteger256([
                    0xf86ed99f5722a44f,
                    0x0d4d7e353bc94327,
                    0x4699f7800c37e4b2,
                    0x297fd99be73988ea,
                ])),
                Felt::new(BigInteger256([
                    0x4725ff963aa9ca44,
                    0x0d81e36e2dafa54f,
                    0xbebdbf413a0846a0,
                    0x12ee867fe24c8159,
                ])),
                Felt::new(BigInteger256([
                    0x2a7f9427d663b9d6,
                    0x4af3d55bdfc27ce0,
                    0x360c6bdcc79f123d,
                    0x675d1161856ecb23,
                ])),
                Felt::new(BigInteger256([
                    0xaa3e4a2818472802,
                    0x19474c01ff468773,
                    0xf23f4c5a696dc24f,
                    0x72ab890ed6c90797,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xbe3c4d25ef61633e,
                    0xd412ff70c3aec4f6,
                    0xcf059f3366ece0a2,
                    0x193f45577fee91f3,
                ])),
                Felt::new(BigInteger256([
                    0x5721e29d30a54ea8,
                    0xb2ea4ce1c8eb5beb,
                    0x7e90456440b17025,
                    0x2b8b5f4cf222a004,
                ])),
                Felt::new(BigInteger256([
                    0xc23e1d1708f8d47d,
                    0x9d1c6d82913071ec,
                    0x1d0c06537390e78c,
                    0x1290fa6a1236f89d,
                ])),
                Felt::new(BigInteger256([
                    0x91504b0c58e78db3,
                    0x4dacebdc592d89eb,
                    0x0627d6f543c5eb84,
                    0x102acf8f6b4fe79b,
                ])),
                Felt::new(BigInteger256([
                    0xb4e46b640a9a3c46,
                    0xc28f1838ef9e7dc3,
                    0x3359f24ef96cf576,
                    0x5b421558b8530134,
                ])),
                Felt::new(BigInteger256([
                    0x1438025e48138834,
                    0x80baf0e3afdf0dc0,
                    0x9acaf351d0ecef0a,
                    0x14bd7e2503ab4267,
                ])),
                Felt::new(BigInteger256([
                    0xa0c57a17e3d8750b,
                    0xb3032795f88fa195,
                    0x0c3c24c51a8343de,
                    0x1dc153a3cc0a5d0f,
                ])),
                Felt::new(BigInteger256([
                    0xda4272dd687febc6,
                    0x405bcd4b4ec65c23,
                    0xd2e29e729c82f8e5,
                    0x0f8b37cf117f51ae,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xa180ca56482da656,
                    0x950651ef1603ef91,
                    0x7dc5cae16745c150,
                    0x034e628e4b320305,
                ])),
                Felt::new(BigInteger256([
                    0xcde958706d538889,
                    0x212483e1a3e310e6,
                    0x51c8d5be143a8501,
                    0x3e26c850df42f750,
                ])),
                Felt::new(BigInteger256([
                    0x7f828c4fe329827e,
                    0x4e429ba92bbaf3fc,
                    0xc015e36b02993693,
                    0x31a3647d65a71d3c,
                ])),
                Felt::new(BigInteger256([
                    0xcd828c502d05ccdb,
                    0x0770b503af38ce50,
                    0xec8a1c14c5cfa1eb,
                    0x183ca6b46a28a5e0,
                ])),
                Felt::new(BigInteger256([
                    0xa83084c08670486c,
                    0xdb6c513bdbdb9833,
                    0x83b4fc2002bbaebb,
                    0x719cf5c0a92cfa1f,
                ])),
                Felt::new(BigInteger256([
                    0x16b9185dab6ce4ad,
                    0xe7ab1616798bbf77,
                    0x060c2f915d7c473d,
                    0x3e230eaacfd0eb4a,
                ])),
                Felt::new(BigInteger256([
                    0x5212b13b49b73317,
                    0xe4e8e3c9dba561bd,
                    0xd721810084ffcdc1,
                    0x6451f441c7ea282d,
                ])),
                Felt::new(BigInteger256([
                    0xf9870c62c7018108,
                    0x87931d20bccc6148,
                    0xf01bedc61aa7a008,
                    0x647efaec44ef1cd3,
                ])),
            ],
        ];

        let output = [
            [
                Felt::new(BigInteger256([
                    0xdb6db6dadb6db6dc,
                    0xe6b5824adb6cc6da,
                    0xf8b356e005810db9,
                    0x66d0f1e660ec4796,
                ])),
                Felt::new(BigInteger256([
                    0xdb6db6dadb6db6dc,
                    0xe6b5824adb6cc6da,
                    0xf8b356e005810db9,
                    0x66d0f1e660ec4796,
                ])),
                Felt::new(BigInteger256([
                    0xdb6db6dadb6db6dc,
                    0xe6b5824adb6cc6da,
                    0xf8b356e005810db9,
                    0x66d0f1e660ec4796,
                ])),
                Felt::new(BigInteger256([
                    0xdb6db6dadb6db6dc,
                    0xe6b5824adb6cc6da,
                    0xf8b356e005810db9,
                    0x66d0f1e660ec4796,
                ])),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
            ],
            [
                Felt::new(BigInteger256([
                    0xd99f4a8fe00e11bd,
                    0xe12a753d82b33b30,
                    0xba87bf86c47e6f0b,
                    0x58de312b5993b67f,
                ])),
                Felt::new(BigInteger256([
                    0xd99f4a8fe00e11bd,
                    0xe12a753d82b33b30,
                    0xba87bf86c47e6f0b,
                    0x58de312b5993b67f,
                ])),
                Felt::new(BigInteger256([
                    0xd99f4a8fe00e11bd,
                    0xe12a753d82b33b30,
                    0xba87bf86c47e6f0b,
                    0x58de312b5993b67f,
                ])),
                Felt::new(BigInteger256([
                    0xd99f4a8fe00e11bd,
                    0xe12a753d82b33b30,
                    0xba87bf86c47e6f0b,
                    0x58de312b5993b67f,
                ])),
                Felt::new(BigInteger256([
                    0xb4c1972e044567f4,
                    0x8e14aacbecb9fb59,
                    0x2c0f182612f81cd9,
                    0x34d6a5db27797543,
                ])),
                Felt::new(BigInteger256([
                    0xb4c1972e044567f4,
                    0x8e14aacbecb9fb59,
                    0x2c0f182612f81cd9,
                    0x34d6a5db27797543,
                ])),
                Felt::new(BigInteger256([
                    0xb4c1972e044567f4,
                    0x8e14aacbecb9fb59,
                    0x2c0f182612f81cd9,
                    0x34d6a5db27797543,
                ])),
                Felt::new(BigInteger256([
                    0xb4c1972e044567f4,
                    0x8e14aacbecb9fb59,
                    0x2c0f182612f81cd9,
                    0x34d6a5db27797543,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x34413b9512617cf9,
                    0x7e6bdaab3f8443c5,
                    0x752178862c9a6ab7,
                    0x3dde7b14d2951772,
                ])),
                Felt::new(BigInteger256([
                    0x34413b9512617cf9,
                    0x7e6bdaab3f8443c5,
                    0x752178862c9a6ab7,
                    0x3dde7b14d2951772,
                ])),
                Felt::new(BigInteger256([
                    0x34413b9512617cf9,
                    0x7e6bdaab3f8443c5,
                    0x752178862c9a6ab7,
                    0x3dde7b14d2951772,
                ])),
                Felt::new(BigInteger256([
                    0x34413b9512617cf9,
                    0x7e6bdaab3f8443c5,
                    0x752178862c9a6ab7,
                    0x3dde7b14d2951772,
                ])),
                Felt::new(BigInteger256([
                    0xbdf2fa0b931e7a04,
                    0x60f39c6eae7a9a3c,
                    0x34e97cf1bd62a467,
                    0x13b9e8a487cc4745,
                ])),
                Felt::new(BigInteger256([
                    0xbdf2fa0b931e7a04,
                    0x60f39c6eae7a9a3c,
                    0x34e97cf1bd62a467,
                    0x13b9e8a487cc4745,
                ])),
                Felt::new(BigInteger256([
                    0xbdf2fa0b931e7a04,
                    0x60f39c6eae7a9a3c,
                    0x34e97cf1bd62a467,
                    0x13b9e8a487cc4745,
                ])),
                Felt::new(BigInteger256([
                    0xbdf2fa0b931e7a04,
                    0x60f39c6eae7a9a3c,
                    0x34e97cf1bd62a467,
                    0x13b9e8a487cc4745,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xdb6db6ecdb6db6ca,
                    0x035ffa14db8a4eec,
                    0x5ea2264f581fdd5a,
                    0x401b2e0d73d97883,
                ])),
                Felt::new(BigInteger256([
                    0xdb6db6ecdb6db6ca,
                    0x035ffa14db8a4eec,
                    0x5ea2264f581fdd5a,
                    0x401b2e0d73d97883,
                ])),
                Felt::new(BigInteger256([
                    0xdb6db6ecdb6db6ca,
                    0x035ffa14db8a4eec,
                    0x5ea2264f581fdd5a,
                    0x401b2e0d73d97883,
                ])),
                Felt::new(BigInteger256([
                    0xdb6db6ecdb6db6ca,
                    0x035ffa14db8a4eec,
                    0x5ea2264f581fdd5a,
                    0x401b2e0d73d97883,
                ])),
                Felt::new(BigInteger256([
                    0xfffffffd00000003,
                    0xfb38ec08fffb13fc,
                    0x99ad88181ce5880f,
                    0x5bc8f5f97cd877d8,
                ])),
                Felt::new(BigInteger256([
                    0xfffffffd00000003,
                    0xfb38ec08fffb13fc,
                    0x99ad88181ce5880f,
                    0x5bc8f5f97cd877d8,
                ])),
                Felt::new(BigInteger256([
                    0xfffffffd00000003,
                    0xfb38ec08fffb13fc,
                    0x99ad88181ce5880f,
                    0x5bc8f5f97cd877d8,
                ])),
                Felt::new(BigInteger256([
                    0xfffffffd00000003,
                    0xfb38ec08fffb13fc,
                    0x99ad88181ce5880f,
                    0x5bc8f5f97cd877d8,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x9989ceed61b5016d,
                    0xf4eb6bee33c60956,
                    0x59980468a3d00698,
                    0x031eef5d953c8ef2,
                ])),
                Felt::new(BigInteger256([
                    0x92268afe86c0fdd8,
                    0x54a914936fc99bc7,
                    0xc58e179f9ef03c25,
                    0x580efdc2de845cbc,
                ])),
                Felt::new(BigInteger256([
                    0x5b9688f39e70a70f,
                    0xbd85c0524867fa1c,
                    0x266c215b4f7529cc,
                    0x2d297e25468f1c59,
                ])),
                Felt::new(BigInteger256([
                    0x1e4cd66e6023219b,
                    0x5e24ee8adb333bbf,
                    0xed7801d719be8eac,
                    0x6ea1bc576dc6ad10,
                ])),
                Felt::new(BigInteger256([
                    0x00148452cd31352b,
                    0x5f16365097f4b863,
                    0xf41d3b2634045d44,
                    0x478e1836ea7dfdfa,
                ])),
                Felt::new(BigInteger256([
                    0xad7d3f3bad8cbcf9,
                    0x39c909ec1b46b77b,
                    0x61b8667a6f7b258b,
                    0x2e790ff1948deb24,
                ])),
                Felt::new(BigInteger256([
                    0x8361ac6a55f0a6f7,
                    0xce91184f7c1e2fe3,
                    0x98c8c5911d267f82,
                    0x41983b9ffc5ac152,
                ])),
                Felt::new(BigInteger256([
                    0xa697a239ca93fbf2,
                    0xf5eaa0c5f45cfc6c,
                    0x349b7060a5a79d82,
                    0x59ea151afe8313d8,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xcddca5157c42e184,
                    0x6a2c0eca10df23bc,
                    0x378c4dc7b84c0294,
                    0x3c19288bc4c61bc7,
                ])),
                Felt::new(BigInteger256([
                    0x7abd20179d069bb9,
                    0xaf9a046a0f96bfec,
                    0x83c9c774d6f10ffe,
                    0x480b64788ed5ace5,
                ])),
                Felt::new(BigInteger256([
                    0x2f608bb8945ae10a,
                    0x3b30807d26bbdbf6,
                    0xf4e39bffcd61ff50,
                    0x518c2023c3a809bb,
                ])),
                Felt::new(BigInteger256([
                    0xd69bd879557041a1,
                    0x2372100f10c19f8d,
                    0x49839c3fc326c17e,
                    0x6ff5b03da44db86a,
                ])),
                Felt::new(BigInteger256([
                    0xe50ed5a5d4c78199,
                    0xa7977b58adb29570,
                    0x55d14f247095b21c,
                    0x6aa3dd14e05debc9,
                ])),
                Felt::new(BigInteger256([
                    0xd66ccf708b593333,
                    0xa93ba02e7dedb913,
                    0xacbbd2ae9303096e,
                    0x47dff87973fc96bb,
                ])),
                Felt::new(BigInteger256([
                    0x5646f7f63c57a1d8,
                    0x324b6275f1e4780f,
                    0xe44c122b4aab27eb,
                    0x533696ceebbbadc5,
                ])),
                Felt::new(BigInteger256([
                    0x145a9aba2a40f76b,
                    0xea49b51270ef0965,
                    0xd5306b533b33a5fe,
                    0x3580a81cde2f6824,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x0f471551a1263b97,
                    0x4e3d72730da7e7b6,
                    0x968826917743e350,
                    0x4e9bd8ec8b476449,
                ])),
                Felt::new(BigInteger256([
                    0xc5eeb39d40f6499e,
                    0x0e3c94605350c5bd,
                    0xe9e0d46406f854cd,
                    0x598a00eb102314ec,
                ])),
                Felt::new(BigInteger256([
                    0x54158ec394fa7556,
                    0x2e7cd4ff0e63c1ba,
                    0xeee55b403d483ed4,
                    0x048ef6e5d1ae8098,
                ])),
                Felt::new(BigInteger256([
                    0x8528450d51db284b,
                    0xb7ce3d382b33ebbd,
                    0xeaefb557f00a7325,
                    0x0a0e0a51f094009e,
                ])),
                Felt::new(BigInteger256([
                    0x12e012245eb6fbcb,
                    0x1af075736d9480c2,
                    0x4f8dd773419d43e5,
                    0x46c8e6a9608eb2a8,
                ])),
                Felt::new(BigInteger256([
                    0x56953e2b27fa310b,
                    0x8c11e3e62867778f,
                    0x62f8bc19cc086c52,
                    0x5596f99e4035b365,
                ])),
                Felt::new(BigInteger256([
                    0xc8984055010d3953,
                    0x5159d4eee6d471c0,
                    0xb5b5471b2678ea8f,
                    0x3725f725bf149171,
                ])),
                Felt::new(BigInteger256([
                    0xa728ac8e963722fa,
                    0x18be188f6150621a,
                    0x7dbf06606df8f0f1,
                    0x3f5cda618cc7ce14,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x8e748215c9702b46,
                    0x48f3f42607b84f82,
                    0x35e322576cc82a22,
                    0x08944570f5e18ea3,
                ])),
                Felt::new(BigInteger256([
                    0x434bb1be84bca636,
                    0x5b5f7315416cdd6e,
                    0xc61849ba07382f81,
                    0x2a5c064be12cfaca,
                ])),
                Felt::new(BigInteger256([
                    0xe7d57462b3e0af23,
                    0xe97d7d51d970e18c,
                    0x169caafea4c99b88,
                    0x47a8be6a43b2a052,
                ])),
                Felt::new(BigInteger256([
                    0xe703965a38ff56a4,
                    0x86c79bc7969da8e7,
                    0x2758c7479bbcd98b,
                    0x5da13ed53fc88e5c,
                ])),
                Felt::new(BigInteger256([
                    0x8a0f4aa42919464d,
                    0x18490940596e27dd,
                    0xfbc57dc72d4bf387,
                    0x45928ef72adaa567,
                ])),
                Felt::new(BigInteger256([
                    0x1e5210d62e0acde9,
                    0xfdcd471d661eab6d,
                    0x94c4e138d201ac26,
                    0x643fd0ddf7a72314,
                ])),
                Felt::new(BigInteger256([
                    0xf14b8e26eefbf333,
                    0xddf3915c11f1cefe,
                    0x2a7edaea2ecfa5c0,
                    0x3d8f560f6b450c27,
                ])),
                Felt::new(BigInteger256([
                    0xcf23f07a26261854,
                    0xd9db14b9e899a996,
                    0x7d6fac8296edaebd,
                    0x6d36ac24c0109185,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xee7220a73c2b2255,
                    0x13bf7acbfbea0645,
                    0xd1165edcf6c5a837,
                    0x6ec5547399d1074e,
                ])),
                Felt::new(BigInteger256([
                    0xb64177b4cb0b1fdb,
                    0xf6c811aaa3b5b825,
                    0x137ff362be5c7cc9,
                    0x285eda0e3ebf965d,
                ])),
                Felt::new(BigInteger256([
                    0x0f09a868b7ab74ae,
                    0x3503c334bdd519c4,
                    0x7dd94451bbb577fe,
                    0x4a20ecb630a29f5c,
                ])),
                Felt::new(BigInteger256([
                    0x4ebf7c5cef591dd2,
                    0xa3746055a78027ec,
                    0xed3458645af5e598,
                    0x61a506c81d4b522a,
                ])),
                Felt::new(BigInteger256([
                    0xd7f5f3ad5dd1aabd,
                    0x3a3972d5fa13d27d,
                    0xb85bfe880796cb6d,
                    0x0afa70d8c845a466,
                ])),
                Felt::new(BigInteger256([
                    0xdaae45b79e624d09,
                    0x25115587499a454a,
                    0xfd5cfc6e1faf29ec,
                    0x5a56f0daf1b38cff,
                ])),
                Felt::new(BigInteger256([
                    0xbb86339ae959020c,
                    0x1764bb2230276de4,
                    0xb0eccdb0df9ad4c1,
                    0x3792762c1d78a405,
                ])),
                Felt::new(BigInteger256([
                    0x5dca0ad68e85934d,
                    0xc28b411b092b62b0,
                    0x32fa78922420d0c9,
                    0x511e2482fb016e9a,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x5442573d471886bd,
                    0x5412e700badfd060,
                    0x0c1a71bb81d3e0b6,
                    0x42750683d31f9156,
                ])),
                Felt::new(BigInteger256([
                    0x577ef802f7dbbb9c,
                    0x115de1a0f23a5d14,
                    0xa1a38d5dbff3a5b4,
                    0x2d31b362c175aa1b,
                ])),
                Felt::new(BigInteger256([
                    0x0bef3fe77ff83985,
                    0x403092eb8297b2bb,
                    0xa111bde9008ba42f,
                    0x4708021fb760246c,
                ])),
                Felt::new(BigInteger256([
                    0x8b0ade716d73aeba,
                    0xe64564753a6db3f0,
                    0x6d29dbba5e38c4f3,
                    0x6d19757f9f086130,
                ])),
                Felt::new(BigInteger256([
                    0x82787a90b26aaaf4,
                    0x01ca436b330d4010,
                    0xd3a5361098864bea,
                    0x709832f300c5a830,
                ])),
                Felt::new(BigInteger256([
                    0x57a301c033d10cff,
                    0x8859dc827a3949bb,
                    0x426a19c53b5e97bc,
                    0x1364b9a2f68346ef,
                ])),
                Felt::new(BigInteger256([
                    0x853b198020928577,
                    0xe896f5c54f9bca51,
                    0x1da5661ca1a7ed09,
                    0x65d23e24eee5498d,
                ])),
                Felt::new(BigInteger256([
                    0x26cb1fde84334879,
                    0xcac9fb413ceea717,
                    0x04d898e87bca75eb,
                    0x4e04ae3c86e701e6,
                ])),
            ],
        ];

        for i in input.iter_mut() {
            apply_sbox(i);
        }

        for (&i, o) in input.iter().zip(output) {
            assert_eq!(i, o);
        }
    }

    #[test]
    fn test_mds() {
        // Generated from https://github.com/Nashtare/anemoi-hash/
        let mut input = [
            [Felt::zero(); 8],
            [Felt::one(); 8],
            [
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
            ],
            [
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
            ],
            [
                Felt::new(BigInteger256([
                    0xd4079f53249e58f5,
                    0x157ba6e6df2b2454,
                    0x53414ce1fa363376,
                    0x2c152aae923f6bd1,
                ])),
                Felt::new(BigInteger256([
                    0xe458abfff99a8fe9,
                    0x6a859580bd3b81a7,
                    0xf520e2157b2b0540,
                    0x2bf5516cd4d5f8b0,
                ])),
                Felt::new(BigInteger256([
                    0x8e658eed84b2ee66,
                    0x0124f1d0bbe8d211,
                    0x7c15d452a595111b,
                    0x4bc64fcaf8837bc8,
                ])),
                Felt::new(BigInteger256([
                    0xf7f89b2316581fb6,
                    0x9b31090ffb69c770,
                    0x1dbff76937121bd9,
                    0x68a5c1f0ee7deacc,
                ])),
                Felt::new(BigInteger256([
                    0x95cc96d3af8a51e8,
                    0x803ecd57ff938c13,
                    0x3133458342ee8e06,
                    0x1cea366ffc6a687c,
                ])),
                Felt::new(BigInteger256([
                    0xdfd2c022fc1540e7,
                    0x23a066ebbf2196eb,
                    0x47c4695521b6c908,
                    0x23c823711b8f5001,
                ])),
                Felt::new(BigInteger256([
                    0x85e38ed42b5cba04,
                    0xe64a2ecdf7c5301e,
                    0x3f24d745772c562b,
                    0x28b580becd6a0b8d,
                ])),
                Felt::new(BigInteger256([
                    0x91de4f99431657b0,
                    0xc3d33b7bd9ef5038,
                    0xf0ec86dfe696c09f,
                    0x403f01df9118beec,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xe763ea7536a050c9,
                    0x606082c2d8760207,
                    0xebcd2a71b77dc611,
                    0x16618a4c38217a9a,
                ])),
                Felt::new(BigInteger256([
                    0xa2d77adc1113061f,
                    0x298716bf6b32e322,
                    0x438e72ff09a2b3b3,
                    0x6a8d34aa7477986a,
                ])),
                Felt::new(BigInteger256([
                    0x959860c04c978a41,
                    0x463b9c0546f84e2e,
                    0x7ecfb123aa42cf53,
                    0x24c298b70e794e6e,
                ])),
                Felt::new(BigInteger256([
                    0x8f75ce1be9a641fd,
                    0x2a227bf7edf5120b,
                    0x5906c1c274eae444,
                    0x64ca408fc9a383c2,
                ])),
                Felt::new(BigInteger256([
                    0xf1d28d2490ec197f,
                    0x2ae4f85c81177202,
                    0x04f98efbaed0b441,
                    0x107532981639aca0,
                ])),
                Felt::new(BigInteger256([
                    0x7dc3107771a11fcd,
                    0x7a7e823f18b382be,
                    0xf6aaeb1c2f2ea33d,
                    0x15c95a2c5c46328d,
                ])),
                Felt::new(BigInteger256([
                    0x60b3e28a4cf6c659,
                    0xb4256f018d7a4028,
                    0xf467a60493c21d79,
                    0x04940f7e446d1d89,
                ])),
                Felt::new(BigInteger256([
                    0x7ee6d8c69d8a7aec,
                    0x65825e53272a3b3d,
                    0x99c01beeb37d0400,
                    0x492ee575f1b0fc35,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xecad8318e93eb076,
                    0x1c0e4f5dbc061d63,
                    0xdae9bf0d1540829d,
                    0x10d2341b5b5f0f08,
                ])),
                Felt::new(BigInteger256([
                    0x20ea24e7ef25eb96,
                    0xeb99e94f38a8f350,
                    0xe9bdb4fe7a68dc33,
                    0x00497189654b028b,
                ])),
                Felt::new(BigInteger256([
                    0x1e750ab431632e7c,
                    0xa98bcd850ac0d1bd,
                    0x917e61d6334fffaa,
                    0x4cff04b04c197a19,
                ])),
                Felt::new(BigInteger256([
                    0x04d9cac1e1c50d25,
                    0xd816392bf84067af,
                    0x89ae31b0e8408cf0,
                    0x3ca2d0480a5bf521,
                ])),
                Felt::new(BigInteger256([
                    0x0ccda2bc24276bdf,
                    0x551f59078b70d093,
                    0xd7927f68f2010519,
                    0x33410b052f606eef,
                ])),
                Felt::new(BigInteger256([
                    0x87fe6f228caa55a8,
                    0xa6e59bd498a4c82e,
                    0x9979e26e2b76dfcc,
                    0x2b2958bb7c8bf2e8,
                ])),
                Felt::new(BigInteger256([
                    0xb9ccfd57c9c2ec0e,
                    0x707e5419dd2c78f7,
                    0xf66abbeb72a2c69f,
                    0x2a45a712e3f1ad43,
                ])),
                Felt::new(BigInteger256([
                    0x221ee81d102a986b,
                    0x2f08db2419a28963,
                    0x783027274a7399b0,
                    0x3a30fcf2d7b57ead,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xb8d73909eec44995,
                    0x22d2f4aff0f5ac16,
                    0x164665d1e44042fc,
                    0x6c42bd290d644d23,
                ])),
                Felt::new(BigInteger256([
                    0x95da92976e68324c,
                    0xe0a5cb3782ab9a3f,
                    0x0059d7ccbf91feb7,
                    0x05d441d45d71814e,
                ])),
                Felt::new(BigInteger256([
                    0x4f498b1077dad7be,
                    0xe54ffd8143273f6d,
                    0xf8d5bcaf21c6ac1b,
                    0x32d4a0ccf2bb2862,
                ])),
                Felt::new(BigInteger256([
                    0x49003e1474108648,
                    0x57efa30da7ff24fc,
                    0xd0446aac9336ec34,
                    0x3c1b5efc25d3f01b,
                ])),
                Felt::new(BigInteger256([
                    0x63747985ef7a0f74,
                    0x17bed2f118d36499,
                    0x5ade7b465a3d4012,
                    0x1398d986ccf97662,
                ])),
                Felt::new(BigInteger256([
                    0xa8f83d1ee1bcf35f,
                    0x62bcb7e97e6b070d,
                    0x48566d53709d802d,
                    0x47439f1070c6eb4f,
                ])),
                Felt::new(BigInteger256([
                    0x26d2d7ca5378c5e8,
                    0x89668fe381cfdc21,
                    0xd49149dc1c396b13,
                    0x5861903ea20477cb,
                ])),
                Felt::new(BigInteger256([
                    0x624e15595e7758da,
                    0x5ccce5f0c186f862,
                    0x1152657349625417,
                    0x3daffc5dc194034d,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x6aa74df1341269d2,
                    0x5f47ee92d04700c2,
                    0xa5e34ac2ef5931bb,
                    0x4eea0eec31aed1cc,
                ])),
                Felt::new(BigInteger256([
                    0x8600e44bdd16569c,
                    0x5d795265813d4ec3,
                    0x2a281a970959271f,
                    0x00f1b93e6a0dcb60,
                ])),
                Felt::new(BigInteger256([
                    0x4d71fbabcf28d1dd,
                    0x2f309b94be85911b,
                    0x11c17ed0102501f2,
                    0x29f4390fb37ec10c,
                ])),
                Felt::new(BigInteger256([
                    0x06fd7da35bc0f066,
                    0x0bcf54d31e107202,
                    0xd90b00fc91c67190,
                    0x08154ac1a8e60e4f,
                ])),
                Felt::new(BigInteger256([
                    0xffee56024a421879,
                    0x04cb4398b0008b46,
                    0x8bf1faa485e790d6,
                    0x5537c992bded313f,
                ])),
                Felt::new(BigInteger256([
                    0xea2c0679654abc11,
                    0xc2da66bc18838a21,
                    0x0cd6a0fb4bdd59c7,
                    0x02ec90728305fdf0,
                ])),
                Felt::new(BigInteger256([
                    0x1e82e900d711e4ea,
                    0xa7766f5778bea2e6,
                    0x4e646796ca44f32a,
                    0x33cc0d86a40b71cb,
                ])),
                Felt::new(BigInteger256([
                    0x6a5a2a034a2aebd2,
                    0x5bc8357a5238d836,
                    0x099223f3993c2479,
                    0x5bbf6d6970063d09,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x099f57cffc60d45f,
                    0xe70e2a192117d0f1,
                    0x53653cbe70264466,
                    0x1f0a044de1d46635,
                ])),
                Felt::new(BigInteger256([
                    0xf98ae743940686c1,
                    0x27991053f54712f2,
                    0x09120c8c9d2b90aa,
                    0x05177a26e7ccfb72,
                ])),
                Felt::new(BigInteger256([
                    0xeb995789467ad329,
                    0x99dc795fb101695a,
                    0xbaa84537326390e2,
                    0x45c36f5df4eb4c88,
                ])),
                Felt::new(BigInteger256([
                    0x7a5d8534708e92bc,
                    0x1cddbc28a5a592ff,
                    0x98b6ef9238904316,
                    0x71e8ea088fbff3f6,
                ])),
                Felt::new(BigInteger256([
                    0x6dd6bbff410cdb20,
                    0x9a10d468f4577c36,
                    0x258b88fa57835136,
                    0x223369b9a9c00eb0,
                ])),
                Felt::new(BigInteger256([
                    0x2c5430e8a93084d4,
                    0xe3933ecc48a06cd9,
                    0x25a8f8d4293162f1,
                    0x2c9074a70bf416e4,
                ])),
                Felt::new(BigInteger256([
                    0xc6585c6737a2f924,
                    0x060cc332b60ffc40,
                    0xab119d05bd38a1ac,
                    0x21b7063c15c9f6ad,
                ])),
                Felt::new(BigInteger256([
                    0x2263c08b89f38d67,
                    0x1d653945a10a84ff,
                    0x959bd555b05f2e82,
                    0x27151272098f303a,
                ])),
            ],
        ];

        let mut input2 = input;

        let output = [
            [Felt::zero(); 8],
            [
                Felt::new(BigInteger256([
                    0x0000000efffffff1,
                    0x17e363d300189c0f,
                    0xff9c57876f8457b0,
                    0x351332208fc5a8c4,
                ])),
                Felt::new(BigInteger256([
                    0x0000000efffffff1,
                    0x17e363d300189c0f,
                    0xff9c57876f8457b0,
                    0x351332208fc5a8c4,
                ])),
                Felt::new(BigInteger256([
                    0x0000000efffffff1,
                    0x17e363d300189c0f,
                    0xff9c57876f8457b0,
                    0x351332208fc5a8c4,
                ])),
                Felt::new(BigInteger256([
                    0x0000000efffffff1,
                    0x17e363d300189c0f,
                    0xff9c57876f8457b0,
                    0x351332208fc5a8c4,
                ])),
                Felt::new(BigInteger256([
                    0x0000000efffffff1,
                    0x17e363d300189c0f,
                    0xff9c57876f8457b0,
                    0x351332208fc5a8c4,
                ])),
                Felt::new(BigInteger256([
                    0x0000000efffffff1,
                    0x17e363d300189c0f,
                    0xff9c57876f8457b0,
                    0x351332208fc5a8c4,
                ])),
                Felt::new(BigInteger256([
                    0x0000000efffffff1,
                    0x17e363d300189c0f,
                    0xff9c57876f8457b0,
                    0x351332208fc5a8c4,
                ])),
                Felt::new(BigInteger256([
                    0x0000000efffffff1,
                    0x17e363d300189c0f,
                    0xff9c57876f8457b0,
                    0x351332208fc5a8c4,
                ])),
            ],
            [
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::new(BigInteger256([
                    0x0000000efffffff1,
                    0x17e363d300189c0f,
                    0xff9c57876f8457b0,
                    0x351332208fc5a8c4,
                ])),
                Felt::new(BigInteger256([
                    0x0000000efffffff1,
                    0x17e363d300189c0f,
                    0xff9c57876f8457b0,
                    0x351332208fc5a8c4,
                ])),
                Felt::new(BigInteger256([
                    0x0000000efffffff1,
                    0x17e363d300189c0f,
                    0xff9c57876f8457b0,
                    0x351332208fc5a8c4,
                ])),
                Felt::new(BigInteger256([
                    0x0000000efffffff1,
                    0x17e363d300189c0f,
                    0xff9c57876f8457b0,
                    0x351332208fc5a8c4,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x0000000efffffff1,
                    0x17e363d300189c0f,
                    0xff9c57876f8457b0,
                    0x351332208fc5a8c4,
                ])),
                Felt::new(BigInteger256([
                    0x0000000efffffff1,
                    0x17e363d300189c0f,
                    0xff9c57876f8457b0,
                    0x351332208fc5a8c4,
                ])),
                Felt::new(BigInteger256([
                    0x0000000efffffff1,
                    0x17e363d300189c0f,
                    0xff9c57876f8457b0,
                    0x351332208fc5a8c4,
                ])),
                Felt::new(BigInteger256([
                    0x0000000efffffff1,
                    0x17e363d300189c0f,
                    0xff9c57876f8457b0,
                    0x351332208fc5a8c4,
                ])),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
            ],
            [
                Felt::new(BigInteger256([
                    0xbd153a9b6aa724c8,
                    0x04e7ab2d067c3076,
                    0xcce65db83f3a4e64,
                    0x59d1c4377d202756,
                ])),
                Felt::new(BigInteger256([
                    0xdec64f3018d8c897,
                    0xe746a21d0d7e3b9c,
                    0x0ccd03c860a16060,
                    0x717daf2be43b15ad,
                ])),
                Felt::new(BigInteger256([
                    0xdb776cb9d1176fbe,
                    0x0ba51d27ad605326,
                    0x860d83a825af1b92,
                    0x34ad65660d29b071,
                ])),
                Felt::new(BigInteger256([
                    0x3fe23f42bc4463ab,
                    0x3a30205e88ccf54e,
                    0x029d254df1d62d0c,
                    0x0041e18d6d7dc638,
                ])),
                Felt::new(BigInteger256([
                    0x4ad8b2a6bc3da001,
                    0x6ad22cb3698353b8,
                    0x95e86ed41b989a7c,
                    0x3bdefc98ad2f184c,
                ])),
                Felt::new(BigInteger256([
                    0xe2d34c7fc1c77837,
                    0x6e00f1b70e43a543,
                    0x0351751b3580dde6,
                    0x26460b2b56ca90e6,
                ])),
                Felt::new(BigInteger256([
                    0x78fb13316ce15970,
                    0x96b61b0f3f18e281,
                    0x08a374cdbf34332f,
                    0x36feb2c7d9a4ef83,
                ])),
                Felt::new(BigInteger256([
                    0x3701636ccb9c0de5,
                    0x1471fc4d3c10bbe8,
                    0x639341f2f37e953b,
                    0x6aff125712dd11ce,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x63cd91299dd5315d,
                    0x45cfb5689b7f47ae,
                    0x6b27e4df4ddf6522,
                    0x291c14c780004608,
                ])),
                Felt::new(BigInteger256([
                    0x0d873736d4d806b2,
                    0xe9f046f4177c4783,
                    0x9e259ee4a74f15b2,
                    0x403ff76c41c3e655,
                ])),
                Felt::new(BigInteger256([
                    0xdc5c745ed6b78029,
                    0x5ebdd1b527789db5,
                    0xad34c0a68489fabe,
                    0x2640ee91ff509b84,
                ])),
                Felt::new(BigInteger256([
                    0x7d51d08d28333dc4,
                    0xb50b144071beb0e7,
                    0xaeb25d852190f7a5,
                    0x62c5085c9947a2a4,
                ])),
                Felt::new(BigInteger256([
                    0xb1bc4bfdac71287a,
                    0x2699f2f977ca336b,
                    0xfa459de92cbb0d76,
                    0x6a2d250b9d24d11a,
                ])),
                Felt::new(BigInteger256([
                    0x3c890701613cd3a9,
                    0x8b2fa0c800ef8ba8,
                    0x48e1c93728ca9baf,
                    0x3c1bc1564dc68d61,
                ])),
                Felt::new(BigInteger256([
                    0x8e5b2e79f89d270f,
                    0x4e17042f82191737,
                    0x360c9b28724f7f24,
                    0x1f05538e6420e947,
                ])),
                Felt::new(BigInteger256([
                    0xadb1ed06751a36c0,
                    0x96ba2b922a416ecc,
                    0x4b4069dd0cb6ee68,
                    0x23180d7c7d321452,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x590f1db1e07a2070,
                    0xe7c99331f2f6d73e,
                    0xeb0144b292257ce8,
                    0x053929e3fb186d53,
                ])),
                Felt::new(BigInteger256([
                    0x0f1b4e6c9fcf45bc,
                    0xf201cf3f68003499,
                    0xb8e2074daab7cd8c,
                    0x1129647584fe9972,
                ])),
                Felt::new(BigInteger256([
                    0x5f684a60b3175f4e,
                    0x28cebd572509f225,
                    0x5aff5894abaa4e6c,
                    0x3834ea78137717a8,
                ])),
                Felt::new(BigInteger256([
                    0x8ebab7c93d792039,
                    0x20807bb145de28ec,
                    0x861ad02d78ff16eb,
                    0x4d29a6e0c1627cfe,
                ])),
                Felt::new(BigInteger256([
                    0xac7224ebe338b626,
                    0x799ac5444b6db1a8,
                    0x6d4ee2caec1e6108,
                    0x07cb24ca2131727e,
                ])),
                Felt::new(BigInteger256([
                    0x8d827856c83b5d2d,
                    0x96fb6cc4d7a2440e,
                    0x83b9d91f103959dd,
                    0x6499759c3cd0e7fa,
                ])),
                Felt::new(BigInteger256([
                    0x6c506127aaef73c2,
                    0x7bf3201c6de59d3c,
                    0xff82ef1ed8070236,
                    0x5aba600158c7e0a9,
                ])),
                Felt::new(BigInteger256([
                    0x6ec2c4e874d762e1,
                    0x6ee342732b5b12dd,
                    0x2cc4c70bc532b725,
                    0x05bfb2c57e17c090,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xc8459c02a913be32,
                    0xdaaeb809f1f22028,
                    0xdf6b6eea841ed678,
                    0x3049679244ef77b1,
                ])),
                Felt::new(BigInteger256([
                    0xa1aa44f29ab0f355,
                    0x8f575cd7e8b8b7ed,
                    0x0fa43b2a8dffec1b,
                    0x25f13ac81d8b7c31,
                ])),
                Felt::new(BigInteger256([
                    0xcb87f30114ac8812,
                    0x7d5ba38f5517d357,
                    0x9040ca55a8f06a65,
                    0x7116f0f1f8713c1e,
                ])),
                Felt::new(BigInteger256([
                    0x1b693d80a735bbad,
                    0x4482deaa67c50bdc,
                    0x6b4c061548ab80e9,
                    0x64a9338e7311be73,
                ])),
                Felt::new(BigInteger256([
                    0xbec4ac2fc0929955,
                    0x457e447bcdc649c1,
                    0xe9b443d91b0fa39b,
                    0x6df465f8a9a4d24b,
                ])),
                Felt::new(BigInteger256([
                    0x4af2978f361b17c4,
                    0x42ae5769f0439ee2,
                    0xdaf665be4f0937c7,
                    0x374526e1d307b1f2,
                ])),
                Felt::new(BigInteger256([
                    0x8c2b90800bd5a0c0,
                    0x874248535ca68f7e,
                    0xadaa38d4b2ff75a9,
                    0x193e2774afb2c290,
                ])),
                Felt::new(BigInteger256([
                    0x80fca648938e992e,
                    0xa876706adf77f913,
                    0xe6a12493c28f0a9c,
                    0x68e6983449ace357,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xa084a27fc2bd3559,
                    0xead2d29828c26bc3,
                    0x4b758de7c4add969,
                    0x4816733bd3ceccec,
                ])),
                Felt::new(BigInteger256([
                    0x2163c513fff846b9,
                    0x1aa51b52ecbc0e2c,
                    0x7935cb98f7d2f159,
                    0x3ff365efb12a23e1,
                ])),
                Felt::new(BigInteger256([
                    0xbbc0c2162a5199ba,
                    0xbe3e20bb00dd94ed,
                    0x81d18d0f93077451,
                    0x5ec52611d44e57cd,
                ])),
                Felt::new(BigInteger256([
                    0x65fc8730b77a7d06,
                    0x5fde16ec2c64679e,
                    0xd5492555ba9f1f5b,
                    0x62d1d0069f8f3cb8,
                ])),
                Felt::new(BigInteger256([
                    0xdd2e458baf78c206,
                    0xe14c7bc645bc0f4d,
                    0x454de046b3c9e851,
                    0x1e2838379a6f886b,
                ])),
                Felt::new(BigInteger256([
                    0x473dd276e5a135df,
                    0xade9183174867812,
                    0x2feab3b53fa4969c,
                    0x5ae570c6c5c31093,
                ])),
                Felt::new(BigInteger256([
                    0x9a2947fce4382b29,
                    0x35304c8b9d7fa875,
                    0x33eae74302699254,
                    0x6a5931cecce6c4fa,
                ])),
                Felt::new(BigInteger256([
                    0x662eac8b3c3161d0,
                    0xdaf49966b0b273dc,
                    0x856076880b7bde49,
                    0x0344200232a6d4c0,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x49757dc76f08b9a2,
                    0x4a02d19a6958ff9c,
                    0xcf05424ff5426003,
                    0x35ac7dfdbc41e17b,
                ])),
                Felt::new(BigInteger256([
                    0xf6bd50a8b0c0fc7c,
                    0xb522944754e00122,
                    0x55aa5f0b743cecdd,
                    0x3001d48624dceaaf,
                ])),
                Felt::new(BigInteger256([
                    0x65d6422a6bdea2e4,
                    0x542672b078af1f17,
                    0xaeec23dc0f7f5eba,
                    0x1d2b81d0ac8004af,
                ])),
                Felt::new(BigInteger256([
                    0x39deb22a686cee15,
                    0x257a86ffc454b1ea,
                    0x948b8cf75d52d369,
                    0x10a33ac4a317bed1,
                ])),
                Felt::new(BigInteger256([
                    0x80f84266b7e12a24,
                    0x4b21a9bf1dcf2fbd,
                    0x06212b643a6ea53b,
                    0x1b308e4ddee19f87,
                ])),
                Felt::new(BigInteger256([
                    0x496627ad3f41cb45,
                    0x5ad219a919ae083a,
                    0x964bbebc84eeeb66,
                    0x2b08fb70437a8e64,
                ])),
                Felt::new(BigInteger256([
                    0x3bebf393c44a5d99,
                    0xe9478cd948d617ac,
                    0xa13a76f97eab7a95,
                    0x1fb32987b95a562b,
                ])),
                Felt::new(BigInteger256([
                    0x8e06e75af75dfa6f,
                    0x3a71fd658c3ab890,
                    0xfbb78bcaf8ffd2fc,
                    0x1f95d388aabaa90e,
                ])),
            ],
        ];

        for i in input.iter_mut() {
            apply_mds(i);
        }
        for i in input2.iter_mut() {
            apply_naive_mds(i);
        }

        for (index, (&i_1, i_2)) in input.iter().zip(input2).enumerate() {
            assert_eq!(output[index], i_1);
            assert_eq!(output[index], i_2);
        }
    }
}
