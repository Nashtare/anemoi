//! Implementation of the Anemoi permutation

use super::{sbox, Felt, MontFp};
use crate::{Anemoi, Jive, Sponge};
use ark_ff::{One, Zero};

/// Digest for Anemoi
mod digest;
/// Sponge for Anemoi
mod hasher;
/// Round constants for Anemoi
mod round_constants;

pub use digest::AnemoiDigest;

// ANEMOI CONSTANTS
// ================================================================================================

/// Function state is set to 4 field elements or 192 bytes.
/// 1 element of the state is reserved for capacity.
pub const STATE_WIDTH: usize = 4;
/// 3 elements of the state are reserved for rate.
pub const RATE_WIDTH: usize = 3;

/// The state is divided into two even-length rows.
pub const NUM_COLUMNS: usize = 2;

/// One element (48-bytes) is returned as digest.
pub const DIGEST_SIZE: usize = 1;

/// The number of rounds is set to 14 to provide 128-bit security level.
pub const NUM_HASH_ROUNDS: usize = 14;

// ANEMOI INSTANTIATION
// ================================================================================================

/// An Anemoi instantiation over BLS12_377 basefield with 2 columns and rate 3.
#[derive(Debug, Clone)]
pub struct AnemoiBls12_377_4_3;

impl<'a> Anemoi<'a, Felt> for AnemoiBls12_377_4_3 {
    const NUM_COLUMNS: usize = NUM_COLUMNS;
    const NUM_ROUNDS: usize = NUM_HASH_ROUNDS;

    const WIDTH: usize = STATE_WIDTH;
    const RATE: usize = RATE_WIDTH;
    const OUTPUT_SIZE: usize = DIGEST_SIZE;

    const ARK_C: &'a [Felt] = &round_constants::C;
    const ARK_D: &'a [Felt] = &round_constants::D;

    const GROUP_GENERATOR: u32 = sbox::BETA;

    const ALPHA: u32 = sbox::ALPHA;
    const INV_ALPHA: Felt = sbox::INV_ALPHA;
    const BETA: u32 = sbox::BETA;
    const DELTA: Felt = sbox::DELTA;

    fn exp_by_inv_alpha(x: Felt) -> Felt {
        sbox::exp_by_inv_alpha(&x)
    }
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_sbox() {
        // Generated from https://github.com/anemoi-hash/anemoi-hash/
        let mut input = [
            [Felt::zero(); 4],
            [Felt::one(); 4],
            [Felt::zero(), Felt::zero(), Felt::one(), Felt::one()],
            [Felt::one(), Felt::one(), Felt::zero(), Felt::zero()],
            [MontFp!("242475460862146019984247712491556183609012165484879309674157224793127668725392553558146236482211413278648787034885"
                ),
                MontFp!("225489246611150086807448289750586871358038145143915909583599853215766644251824156663811060085754591401764291724759"
                ),
                MontFp!("30871598071895394022203135771134027967631006893886170572352249395356698540717963260109951017571830068872768528307"
                ),
                MontFp!("169757309232843259702270710618285925471519614658479907224669276247842622794724585703361357209853776013784693796742"),],[MontFp!("88154931957553540376512352469273217868657080446658338372535811725371253836722889713768752159498786759695427459374"
                ),
                MontFp!("95585150228591517342973481107381801848481580805130938053350548110704042763367748816464116698730423158131699641554"
                ),
                MontFp!("254478139574324859267303191750640573148336504125622960456442010087837703571476797042494469590132216734729479498901"
                ),
                MontFp!("130537160588414833216038018364155137706143739937346935973330116860700935920747220700170810824344363937366222479719"),],[MontFp!("156577981752072191498684489733244887778625899520951138121949047724963332609428809865129415716634137414098041571198"
                ),
                MontFp!("229349006075091258241159208791179397668578863362905027188303538945121406847921580479828005032159206448210847728342"
                ),
                MontFp!("235489287390628755424242101457249605335759107750132883793549885756852876475858680958836514773257853490843502109570"
                ),
                MontFp!("55038293050049480740662965076637648625835002099129886101143779294639286651595507372933604378093450268875111337402"),],[MontFp!("223511797627187465250932900586494653547458755259795550715654013871303968614629108041504733151823260469310045496458"
                ),
                MontFp!("103633183185188205250026457757795021952645242280054602408062518370444498834127504354939201847407945116986733278267"
                ),
                MontFp!("141862700545101354088948161992793760625895936919068688959492947458678783257932931622345028770427937711421088569532"
                ),
                MontFp!("56741918263573977472654814001293812885036472982293216684136548676237140130333856464556544020850557056141729960615"),],[MontFp!("178547623234417101426344022576178641442647538236320606630865801541083127113317631644216176683120121421218178269196"
                ),
                MontFp!("173084915898672937854328135475892725833496924763072834930509831463565931204696605567275582523867124661636689162188"
                ),
                MontFp!("222606588826661320434927868054593513471859224161871294171572298447899398714131299718698555883297095153183720238462"
                ),
                MontFp!("75691938171829823207063316772165470317532378454907828212378435377819615374693769625592993264850107264282482945325"),],[MontFp!("179349167670092751068607093601508640313197733431144868526099795167101564638398778932589484921948176416301906257047"
                ),
                MontFp!("79850225783995488941956991221105408027622093983231034581489580288288312541117165995778794484018433725337501547651"
                ),
                MontFp!("79674626965208643545329104364813449547399853355959131431816086433358783433287630308062867005599270509300138316328"
                ),
                MontFp!("207212814126449023155756182324898843562319086423237261152711302936090133660234076682523940468042008342749444378515"),],];

        let output = [
[MontFp!("34488590135062545868087031159319137804852468367321954738651235022229395779778776369995851751943114683258709527757"
                ),
                MontFp!("34488590135062545868087031159319137804852468367321954738651235022229395779778776369995851751943114683258709527757"),Felt::zero(),Felt::zero(),],[MontFp!("22421587733773004428941416064670070049380684225745603942931744991828811999604202704747517426704305501497113204495"
                ),
                MontFp!("22421587733773004428941416064670070049380684225745603942931744991828811999604202704747517426704305501497113204495"
                ),
                MontFp!("35100315566570170733149551489349276622307135424268575122052037927847002802325620032793599804427260707856609187629"
                ),
                MontFp!("35100315566570170733149551489349276622307135424268575122052037927847002802325620032793599804427260707856609187629"),],[MontFp!("202558602263566318131643800652419726645194525740297977929133933131347972453654409557175672915498236741806441721312"
                ),
                MontFp!("202558602263566318131643800652419726645194525740297977929133933131347972453654409557175672915498236741806441721312"
                ),
                MontFp!("61175793463368953076827834167708903085151301277604448500868993247542667587861806962357930104272623662398813530876"
                ),
                MontFp!("61175793463368953076827834167708903085151301277604448500868993247542667587861806962357930104272623662398813530876"),],[MontFp!("34488590135062545868087031159319137804852468367321954738651235022229395779778776369995851751943114683258709527773"
                ),
                MontFp!("34488590135062545868087031159319137804852468367321954738651235022229395779778776369995851751943114683258709527773"
                ),
                MontFp!("258664426012969094010652733694893533536393512754914660539884262666720468348340822774968888139573360124440321458176"
                ),
                MontFp!("258664426012969094010652733694893533536393512754914660539884262666720468348340822774968888139573360124440321458176"),],[MontFp!("229812802832362022247240796751279434291919645368326686439757700557611659111498760180756700224848854704197485406855"
                ),
                MontFp!("30325534863129685133843435754046888865274102745973548848045173967202005649297107174053597270056238136100907608767"
                ),
                MontFp!("1547993506732830233865155825945385354603768846893806547122022510016069194871356215236580304487319155413729051453"
                ),
                MontFp!("49519768984581409873264659986549721669251279385441680215519660731364077434881282276874281293230340509337822873275"),],[MontFp!("119325067083917854468132303042335106765336166811765942724200532389366486982022056268452346278483905404036955507771"
                ),
                MontFp!("258621643097554861474872974841737051783184409938208126040824809224264039063164456892301065541652084539088684040118"
                ),
                MontFp!("244120836838442797626403032917858243531680578531819842884695711676944135649727179252994836031543404412206087417011"
                ),
                MontFp!("201362938385566501865263353575612054491315510044819307842872106518297399288345750017415505036782680218442417470987"),],[MontFp!("258503288823094454717852049933736494887062755156032230157312925134465297495047551325595166877231631253221011419964"
                ),
                MontFp!("67287798994105286241805873342386881010545674752925543236413398567980731961712765982733666282747749855590752149233"
                ),
                MontFp!("223125470874811804477559389534390818981837455743348846679537757068559153637741066359152237580666459206680080256674"
                ),
                MontFp!("192522426559852433073400796254325263185254788908749789835234842362806716093105181453671284819070373763526404718401"),],[MontFp!("244580092094935955613216792529800287794619819508075276551575046866283364289312425276214426168817701992027397070391"
                ),
                MontFp!("229855302891362614399276911076502398402628982314624066579633948775770952545235658134033802148079882878147604864880"
                ),
                MontFp!("66161499109131612140296763335297923158998808748315563759398297364717075809197090821448923838180400641080693008780"
                ),
                MontFp!("183528432379418117500397630305650473411653959036284113729335699420880068201694110880946339154442987579625802866037"),],[MontFp!("63170084270424374104911167083386780690917534101214261841771452016325009498931745032896813451016450884318757648046"
                ),
                MontFp!("37478698933968633134870661765206067091092365587468495910524035269937006479285175010514765012019489393524487142636"
                ),
                MontFp!("45034662977384357560067108142962937713919876496201807153487869933924442494377772493037729225830701466010835889874"
                ),
                MontFp!("153228453646866826113465688182160482441899826288007991751632863350918085275231521680370268223528013361032970134959"),],[MontFp!("12035982372945512244464799121943535296345534586506313158959176434871753009101832560480233963266018420541406788539"
                ),
                MontFp!("227101162928603699019801247927190978855353869315618491177140331662191802357423246677003174338901312959110254763570"
                ),
                MontFp!("102169167283158581301880287255476077499351150554443773138509958087071127726873332105754906974940643648408853104578"
                ),
                MontFp!("93990671407508368121065689805626553721461707822443869526114348111186745020212188253372646485853214983441795218532"),],];

        for i in input.iter_mut() {
            AnemoiBls12_377_4_3::sbox_layer(i);
        }

        for (&i, o) in input.iter().zip(output) {
            assert_eq!(i, o);
        }
    }
}
