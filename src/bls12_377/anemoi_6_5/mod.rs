use super::{mul_by_generator, sbox, BigInteger384, Felt};
use crate::{Jive, Sponge};
use ark_ff::{Field, One, Zero};
use unroll::unroll_for_loops;

/// Digest for Anemoi
mod digest;
/// Sponge for Anemoi
mod hasher;
/// MDS matrix for Anemoi
mod mds;
/// Round constants for Anemoi
mod round_constants;

pub use digest::AnemoiDigest;
pub use hasher::AnemoiHash;

// ANEMOI CONSTANTS
// ================================================================================================

/// Function state is set to 6 field elements or 288 bytes.
/// 1 element of the state is reserved for capacity.
pub const STATE_WIDTH: usize = 6;
/// 5 elements of the state are reserved for rate.
pub const RATE_WIDTH: usize = 5;

/// The state is divided into two even-length rows.
pub const NUM_COLUMNS: usize = 3;

/// One element (48-bytes) is returned as digest.
pub const DIGEST_SIZE: usize = 1;

/// The number of rounds is set to 10 to provide 128-bit security level.
pub const NUM_HASH_ROUNDS: usize = 10;

// HELPER FUNCTIONS
// ================================================================================================

#[inline(always)]
/// Applies exponentiation of the current hash
/// state elements with the Anemoi S-Box.
pub(crate) fn apply_sbox(state: &mut [Felt; STATE_WIDTH]) {
    let mut x: [Felt; NUM_COLUMNS] = state[..NUM_COLUMNS].try_into().unwrap();
    let mut y: [Felt; NUM_COLUMNS] = state[NUM_COLUMNS..].try_into().unwrap();

    x.iter_mut().enumerate().for_each(|(i, t)| {
        let y2 = y[i].square();
        *t -= mul_by_generator(&y2);
    });

    let mut x_alpha_inv = x;
    x_alpha_inv
        .iter_mut()
        .for_each(|t| *t = sbox::exp_inv_alpha(t));

    y.iter_mut()
        .enumerate()
        .for_each(|(i, t)| *t -= x_alpha_inv[i]);

    x.iter_mut().enumerate().for_each(|(i, t)| {
        let y2 = y[i].square();
        *t += mul_by_generator(&y2) + sbox::DELTA;
    });

    state[..NUM_COLUMNS].copy_from_slice(&x);
    state[NUM_COLUMNS..].copy_from_slice(&y);
}

#[inline(always)]
/// Applies matrix-vector multiplication of the current
/// hash state with the Anemoi MDS matrix.
pub(crate) fn apply_mds(state: &mut [Felt; STATE_WIDTH]) {
    apply_mds_internal(&mut state[..NUM_COLUMNS]);
    state[NUM_COLUMNS..].rotate_left(1);
    apply_mds_internal(&mut state[NUM_COLUMNS..]);
}

#[inline(always)]
fn apply_mds_internal(state: &mut [Felt]) {
    let tmp = state[0] + mul_by_generator(&state[2]);
    state[2] += state[1];
    state[2] += mul_by_generator(&state[0]);

    state[0] = tmp + state[2];
    state[1] += tmp;
}

// ANEMOI PERMUTATION
// ================================================================================================

/// Applies an Anemoi permutation to the provided state
#[inline(always)]
#[unroll_for_loops]
pub(crate) fn apply_permutation(state: &mut [Felt; STATE_WIDTH]) {
    for i in 0..NUM_HASH_ROUNDS {
        apply_round(state, i);
    }

    apply_mds(state)
}

/// Applies an Anemoi round to the provided state
#[inline(always)]
#[unroll_for_loops]
pub(crate) fn apply_round(state: &mut [Felt; STATE_WIDTH], step: usize) {
    // determine which round constants to use
    let c = &round_constants::C[step % NUM_HASH_ROUNDS];
    let d = &round_constants::D[step % NUM_HASH_ROUNDS];

    for i in 0..NUM_COLUMNS {
        state[i] += c[i];
        state[NUM_COLUMNS + i] += d[i];
    }

    apply_mds(state);
    apply_sbox(state);
}

#[cfg(test)]
mod tests {
    use super::*;

    fn apply_naive_mds(state: &mut [Felt; STATE_WIDTH]) {
        let x: [Felt; NUM_COLUMNS] = state[..NUM_COLUMNS].try_into().unwrap();
        let mut y: [Felt; NUM_COLUMNS] = [Felt::zero(); NUM_COLUMNS];
        y[0..NUM_COLUMNS - 1].copy_from_slice(&state[NUM_COLUMNS + 1..]);
        y[NUM_COLUMNS - 1] = state[NUM_COLUMNS];

        let mut result = [Felt::zero(); STATE_WIDTH];
        for (i, r) in result.iter_mut().enumerate().take(NUM_COLUMNS) {
            for (j, s) in x.into_iter().enumerate().take(NUM_COLUMNS) {
                *r += s * mds::MDS[i * NUM_COLUMNS + j];
            }
        }
        for (i, r) in result.iter_mut().enumerate().skip(NUM_COLUMNS) {
            for (j, s) in y.into_iter().enumerate() {
                *r += s * mds::MDS[(i - NUM_COLUMNS) * NUM_COLUMNS + j];
            }
        }

        state.copy_from_slice(&result);
    }

    #[test]
    fn test_sbox() {
        // Generated from https://github.com/vesselinux/anemoi-hash/
        let mut input = [
            [Felt::zero(); 6],
            [Felt::one(); 6],
            [
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
            ],
            [
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
            ],
            [
                Felt::new(BigInteger384([
                    0xbff0a200dd96a33b,
                    0x5cb9fcda3cf3e14d,
                    0xccdbfc583ba4b9ff,
                    0x6c38a99ed897019e,
                    0xeffa9cc21f646d38,
                    0x005dedf5d86d5c7d,
                ])),
                Felt::new(BigInteger384([
                    0xbfbc4b5daa0e6757,
                    0xbf965fd25305d35f,
                    0x2ff2289dbd9f2498,
                    0x13259c5019c50a5f,
                    0xdfcfdd7799c70353,
                    0x0160af1e306f7ab1,
                ])),
                Felt::new(BigInteger384([
                    0x40e2c5a19f990c5d,
                    0x4550664bf0466680,
                    0x304965f3c25c19e8,
                    0xd0e45828b43afc4f,
                    0xdcc5ff91157311fc,
                    0x004c94b4b6919e3e,
                ])),
                Felt::new(BigInteger384([
                    0x106c353cf84bd58e,
                    0xe2e1bb213a49102c,
                    0x914a4f8bc8a87bd6,
                    0xda6bf2df65a525f4,
                    0x7a625b6b12b30689,
                    0x00f827374f974cb2,
                ])),
                Felt::new(BigInteger384([
                    0x36f3f120ae1f433e,
                    0x028a875c20f7ce3f,
                    0xfcaba4adfa2ed699,
                    0xe012c1c1be5df2db,
                    0x0af0c22fedadfed6,
                    0x0024fe079c3ed428,
                ])),
                Felt::new(BigInteger384([
                    0xf614ee079f3d5e1d,
                    0xed2d53a3f430748e,
                    0xf108397b54e68c6c,
                    0x6aee67068d254299,
                    0x36008e84963a6424,
                    0x011e046b974567d8,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0xf6e6c98aea1205de,
                    0xb5d9da0d1108ac73,
                    0x2a32ee27c5f54239,
                    0x930ee6c7adee98e3,
                    0xda4e6615bdb1eadf,
                    0x0087f9e80ebed66b,
                ])),
                Felt::new(BigInteger384([
                    0x4553a8d58e9b8201,
                    0x78d3fde95f4fc1f2,
                    0xea76448112701249,
                    0xb7e6cdc07a1205b4,
                    0x03f2830a91d2280f,
                    0x006536ca61b57b9f,
                ])),
                Felt::new(BigInteger384([
                    0x9e714c564688dd8a,
                    0x55daae247f361f2b,
                    0xa7bab2460695254f,
                    0xad5d0ec8c5863984,
                    0xe6bc6418657be71a,
                    0x005a06b90e19a7a3,
                ])),
                Felt::new(BigInteger384([
                    0x457b987d2b8ceb7b,
                    0x9ae3707e4284aad5,
                    0x9bcdc7a014c54a22,
                    0x87abe3473f046426,
                    0x586ee38c6f9714d2,
                    0x004d30378adf3c03,
                ])),
                Felt::new(BigInteger384([
                    0x5e5f0d009ac1bbb6,
                    0xe91e166f1279c1f4,
                    0x71b86e3712eb1276,
                    0x6dffb454319b1cb4,
                    0xd9187b8328577c24,
                    0x00deecc0416f81ce,
                ])),
                Felt::new(BigInteger384([
                    0x1e8960ff0cc0778c,
                    0xaa7755debb4adf1c,
                    0x08657a0bcbe92955,
                    0xfced5bc5a107ff6a,
                    0xe6a565263e42d94c,
                    0x01a363bf24b9fb7e,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0x533ef507a2d81be3,
                    0x55985ad7785cd72f,
                    0x7a26932f81db0d30,
                    0x5928a9786fb15ea4,
                    0x2af0dd5b83e80278,
                    0x016b75df2d95dad2,
                ])),
                Felt::new(BigInteger384([
                    0x4bd00d7aaa050da8,
                    0xb1dbf72239438239,
                    0xc319793a71b0f108,
                    0x1907ab6715346758,
                    0xb3569549997d304b,
                    0x00d4985220584a5c,
                ])),
                Felt::new(BigInteger384([
                    0xab8715603d53eefb,
                    0xfaf00b39d36ac048,
                    0xff5169bf6a4cc59c,
                    0xc8ef7ec79ae607ec,
                    0x6f637d22a42009bd,
                    0x001c43b9ec6ee2b2,
                ])),
                Felt::new(BigInteger384([
                    0xdd5da92c3bb200b6,
                    0x819240f0b2cbbbdc,
                    0x5474f709c189fe0e,
                    0x2e40eb10718d1fa2,
                    0x4ca24202cacef12c,
                    0x00f8213198575bad,
                ])),
                Felt::new(BigInteger384([
                    0x5f92a6cca6d65872,
                    0xba69b55b3c408220,
                    0x79d211a69d3f48ec,
                    0x51c06566c69da415,
                    0xfadbaf133af197b8,
                    0x01194bcdc3289a30,
                ])),
                Felt::new(BigInteger384([
                    0x86e8d4c4ed53893c,
                    0x2d65a63292ddca8c,
                    0x58093b714286bed6,
                    0x0ba90a292d26d2f5,
                    0xd0c5a612d363c096,
                    0x01a7ce9805c57c09,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0xc54fa9e8c302be7b,
                    0x4343276a2d3ad306,
                    0xee12b87d580e810c,
                    0x0088e394a7ad5a55,
                    0x284bebe6453a2eaf,
                    0x006685d33bd37678,
                ])),
                Felt::new(BigInteger384([
                    0x04f78501aa7278d2,
                    0x0a2fb522fb42e7f0,
                    0xcf900258579a679c,
                    0x7ce20cd41d42fb68,
                    0x21f8b60dc038f812,
                    0x00c31c1d719c048b,
                ])),
                Felt::new(BigInteger384([
                    0xfa283fa0e8e7da37,
                    0x533d01adceb4e9da,
                    0x66520535a47cfd59,
                    0x3561434182f9e7c4,
                    0x0295cb4b6e631351,
                    0x0012ddff1aa338a1,
                ])),
                Felt::new(BigInteger384([
                    0xc332b845ea98c2df,
                    0xb968aa4adf7e35ad,
                    0xbfb381f29a296864,
                    0x49b0e597c73bc52c,
                    0xdc28557b9a067b2d,
                    0x004f824b1dbe4299,
                ])),
                Felt::new(BigInteger384([
                    0x1d6156b23add5366,
                    0xcbaa4630048ba43c,
                    0xbaf4b1e374c611a6,
                    0x43d40fc7b3d2975a,
                    0xc7bde993c5cf917e,
                    0x0186852430d098bc,
                ])),
                Felt::new(BigInteger384([
                    0xce34c2467f82a257,
                    0x81f5dd3cb7300f63,
                    0xc41cd5b2dfeaaef9,
                    0x7f8764fcb56941c9,
                    0x90be889fe1c1b627,
                    0x003afc84c5ebed0e,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0x10f5e42f7cce1332,
                    0x90a92edb1e7ce9c8,
                    0x267982c0d52609d1,
                    0x0cbc9a2e9d5c0bbb,
                    0x1d8c3ac406f25735,
                    0x0138afe064e3f8f6,
                ])),
                Felt::new(BigInteger384([
                    0xd78bf60db6e9d4fb,
                    0x226ca0c6156197eb,
                    0xa690ae40ea5b943f,
                    0x8826cf1c97c177df,
                    0x27a3360df552f694,
                    0x0081697502abd84c,
                ])),
                Felt::new(BigInteger384([
                    0x6bd72103f0d463e3,
                    0xd91a166f0550312e,
                    0xc4e12fde6eb34078,
                    0xa1b3e6ec071a0f55,
                    0x0d3254072fe576a5,
                    0x01057e36b300f3fe,
                ])),
                Felt::new(BigInteger384([
                    0xb87ad49d2d1be776,
                    0x5f52a591fffd6bff,
                    0xc9ada9fd632bb06e,
                    0x8f57bf616a43a5e9,
                    0x1ce2a9895c53a618,
                    0x0153b0b1b7981093,
                ])),
                Felt::new(BigInteger384([
                    0x51858493dfcf9a10,
                    0x9e410fec02391991,
                    0xf6b974508fd70ff3,
                    0xf2c7098ea77fc6f5,
                    0x982b871206a67bb2,
                    0x00de3d7810004fd6,
                ])),
                Felt::new(BigInteger384([
                    0x83b70f29dc2e3812,
                    0xa34157802212d179,
                    0xbf5b39a919e1b175,
                    0x6838543c1a7f1227,
                    0xcfee43bacc42bda1,
                    0x00139effc4d83770,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0xa2a3959bfdf2b579,
                    0xc38afaf99682da50,
                    0xe0722b694ece37f0,
                    0x11963eca1793d7ec,
                    0xf840ece6df345e6b,
                    0x00b1aa411a60db0c,
                ])),
                Felt::new(BigInteger384([
                    0x163b972181950e90,
                    0x856f02326d5aa601,
                    0x483a0e3194afb183,
                    0x2dcd932a72b3c1c0,
                    0x62f422538890ba02,
                    0x00f4c4a01d981c4f,
                ])),
                Felt::new(BigInteger384([
                    0x056cc3b80692e8ad,
                    0x6a0d4a773c64437b,
                    0xeb26639ae094c787,
                    0x4a5ac0e4e3ae80d5,
                    0x41ca5728fe080c19,
                    0x010ad38ecd2e4a25,
                ])),
                Felt::new(BigInteger384([
                    0x02f24def72fd00ac,
                    0xcfaaae92a3e4d223,
                    0x305e80cbf1ac7960,
                    0x11eef1758aee18b8,
                    0xab85a39caf32b901,
                    0x003730938466cd55,
                ])),
                Felt::new(BigInteger384([
                    0x491ea109e49c6f8d,
                    0xee819a829746aeac,
                    0xaba556746e6d9b69,
                    0x6699138f535d1a4e,
                    0xd556d7f5213b016a,
                    0x006f308e90b93ad6,
                ])),
                Felt::new(BigInteger384([
                    0xb4f7ab09cae57c99,
                    0xbb3748a83d3566f3,
                    0xed598c8c99a2e895,
                    0xb51bbd1d79537703,
                    0xfcb7a3e9fe383897,
                    0x004acee0a3ddc34b,
                ])),
            ],
        ];

        let output = [
            [
                Felt::new(BigInteger384([
                    0x56dcddddddddddd4,
                    0x2db2015f37777772,
                    0x8a5a595c4be8b110,
                    0x2041bbb36e056126,
                    0x7e422da67ad9b5fd,
                    0x007c276e8cf025e2,
                ])),
                Felt::new(BigInteger384([
                    0x56dcddddddddddd4,
                    0x2db2015f37777772,
                    0x8a5a595c4be8b110,
                    0x2041bbb36e056126,
                    0x7e422da67ad9b5fd,
                    0x007c276e8cf025e2,
                ])),
                Felt::new(BigInteger384([
                    0x56dcddddddddddd4,
                    0x2db2015f37777772,
                    0x8a5a595c4be8b110,
                    0x2041bbb36e056126,
                    0x7e422da67ad9b5fd,
                    0x007c276e8cf025e2,
                ])),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
            ],
            [
                Felt::new(BigInteger384([
                    0x59b3fa50b6287770,
                    0x8d8cc2314dc632d6,
                    0x29b1a14daf4e27f8,
                    0xedb8547b775eb818,
                    0xd8e661a68b195234,
                    0x0105b860faad5b24,
                ])),
                Felt::new(BigInteger384([
                    0x59b3fa50b6287770,
                    0x8d8cc2314dc632d6,
                    0x29b1a14daf4e27f8,
                    0xedb8547b775eb818,
                    0xd8e661a68b195234,
                    0x0105b860faad5b24,
                ])),
                Felt::new(BigInteger384([
                    0x59b3fa50b6287770,
                    0x8d8cc2314dc632d6,
                    0x29b1a14daf4e27f8,
                    0xedb8547b775eb818,
                    0xd8e661a68b195234,
                    0x0105b860faad5b24,
                ])),
                Felt::new(BigInteger384([
                    0xa578190a443f6866,
                    0xba8dc4fbbf9b29b6,
                    0x7eb0b8ad3adf4bee,
                    0x878939a768b75022,
                    0x5a0c806ddc201082,
                    0x00b44682633de315,
                ])),
                Felt::new(BigInteger384([
                    0xa578190a443f6866,
                    0xba8dc4fbbf9b29b6,
                    0x7eb0b8ad3adf4bee,
                    0x878939a768b75022,
                    0x5a0c806ddc201082,
                    0x00b44682633de315,
                ])),
                Felt::new(BigInteger384([
                    0xa578190a443f6866,
                    0xba8dc4fbbf9b29b6,
                    0x7eb0b8ad3adf4bee,
                    0x878939a768b75022,
                    0x5a0c806ddc201082,
                    0x00b44682633de315,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0x3f83be968f6712f4,
                    0x7a14ed2c157a3e9f,
                    0x13379f76f22125ab,
                    0xd2b0fd505a8223b8,
                    0x90580d58fcb34c3f,
                    0x0073a0b34fa4fca9,
                ])),
                Felt::new(BigInteger384([
                    0x3f83be968f6712f4,
                    0x7a14ed2c157a3e9f,
                    0x13379f76f22125ab,
                    0xd2b0fd505a8223b8,
                    0x90580d58fcb34c3f,
                    0x0073a0b34fa4fca9,
                ])),
                Felt::new(BigInteger384([
                    0x3f83be968f6712f4,
                    0x7a14ed2c157a3e9f,
                    0x13379f76f22125ab,
                    0xd2b0fd505a8223b8,
                    0x90580d58fcb34c3f,
                    0x0073a0b34fa4fca9,
                ])),
                Felt::new(BigInteger384([
                    0x6af47e2abade4fc8,
                    0x1a826133f52d710b,
                    0x6c3926ec49ea6ba8,
                    0xbfd567223db99dfb,
                    0xca056d88e9e47a82,
                    0x0036eb7a315a0db0,
                ])),
                Felt::new(BigInteger384([
                    0x6af47e2abade4fc8,
                    0x1a826133f52d710b,
                    0x6c3926ec49ea6ba8,
                    0xbfd567223db99dfb,
                    0xca056d88e9e47a82,
                    0x0036eb7a315a0db0,
                ])),
                Felt::new(BigInteger384([
                    0x6af47e2abade4fc8,
                    0x1a826133f52d710b,
                    0x6c3926ec49ea6ba8,
                    0xbfd567223db99dfb,
                    0xca056d88e9e47a82,
                    0x0036eb7a315a0db0,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0xea911dddddddd44f,
                    0xce8327424777727f,
                    0xe774a906518e4834,
                    0x527cf56b51022fb4,
                    0x6e646cdc5f7b965d,
                    0x00eb6a2e45f61af1,
                ])),
                Felt::new(BigInteger384([
                    0xea911dddddddd44f,
                    0xce8327424777727f,
                    0xe774a906518e4834,
                    0x527cf56b51022fb4,
                    0x6e646cdc5f7b965d,
                    0x00eb6a2e45f61af1,
                ])),
                Felt::new(BigInteger384([
                    0xea911dddddddd44f,
                    0xce8327424777727f,
                    0xe774a906518e4834,
                    0x527cf56b51022fb4,
                    0x6e646cdc5f7b965d,
                    0x00eb6a2e45f61af1,
                ])),
                Felt::new(BigInteger384([
                    0x823ac00000000099,
                    0xc5cabdc0b000004f,
                    0x7f75ae862f8c080d,
                    0x9ed4423b9278b089,
                    0x79467000ec64c452,
                    0x0120d3e434c71c50,
                ])),
                Felt::new(BigInteger384([
                    0x823ac00000000099,
                    0xc5cabdc0b000004f,
                    0x7f75ae862f8c080d,
                    0x9ed4423b9278b089,
                    0x79467000ec64c452,
                    0x0120d3e434c71c50,
                ])),
                Felt::new(BigInteger384([
                    0x823ac00000000099,
                    0xc5cabdc0b000004f,
                    0x7f75ae862f8c080d,
                    0x9ed4423b9278b089,
                    0x79467000ec64c452,
                    0x0120d3e434c71c50,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0xc2d508f0d85983c9,
                    0xcf0a5fe333a52afd,
                    0xa58e21ca99b8eb58,
                    0x3040884749a36558,
                    0x0f4c1efda0c91cb3,
                    0x0044d0a1e553eab4,
                ])),
                Felt::new(BigInteger384([
                    0xcad48dfab4083cef,
                    0x4f22ba3787e858a9,
                    0xad7230d4c6d6eae0,
                    0x5ea5c7975b8e0757,
                    0xc8e997aadb2b2495,
                    0x0116e5178399be74,
                ])),
                Felt::new(BigInteger384([
                    0xfa70ae38243db58d,
                    0xe77316b01d985adc,
                    0xe507a0e322fceb1c,
                    0xe3c87e8b1324a26c,
                    0x435f3f4b44a71900,
                    0x00a6dec44c862fa3,
                ])),
                Felt::new(BigInteger384([
                    0xb57ee5a6951c4e78,
                    0x31417d699ff460f4,
                    0x8fc2338832c90063,
                    0xf781552929f924f4,
                    0x2922cabd3e399d32,
                    0x0134dd1195e78a2e,
                ])),
                Felt::new(BigInteger384([
                    0x246832c9e285b4f1,
                    0x467ea7e141af211a,
                    0x4318aa3ba383b38c,
                    0xe79dd0ad202fe501,
                    0x92e7587596d35152,
                    0x01577e8dedbdda19,
                ])),
                Felt::new(BigInteger384([
                    0xb715dfe093154912,
                    0x37ff463dbbd62f23,
                    0x3bf69370927a61ba,
                    0x3f9f7c2104454652,
                    0xa8f530a5dc01fd57,
                    0x0194c76683539263,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0x75df37ceafbc0e50,
                    0xb524c58bdd0f458b,
                    0xa3505b77bd414fa9,
                    0x1d54abfb32c93c0a,
                    0x7ff63c45501cc7bd,
                    0x00cbe4304eff2f81,
                ])),
                Felt::new(BigInteger384([
                    0xf1b27c3ad5ed1acb,
                    0xff157a875c2a2927,
                    0x284f29c18a388674,
                    0x20f199ef9f7c4828,
                    0x8760dd3b91c8efb9,
                    0x0060c761813ed53d,
                ])),
                Felt::new(BigInteger384([
                    0x8f85487c1896aa47,
                    0x710fd15d5cebdfae,
                    0x0b9788f46e0a77cf,
                    0x032c0119a5427aba,
                    0x7308932027317683,
                    0x007508d8db73641f,
                ])),
                Felt::new(BigInteger384([
                    0x80c2bb8b4ccd8fd0,
                    0xac37ca97f9d1d673,
                    0xc39ddc407c7b0530,
                    0xa87372f872ab63b2,
                    0x03f3f3ed81d228e1,
                    0x017096a7a351429b,
                ])),
                Felt::new(BigInteger384([
                    0xdfece593e0feac67,
                    0x331174a249310a2f,
                    0x58984f193cbce8f4,
                    0xace9e88340a6e280,
                    0x65bb8d80d1da7eb2,
                    0x017f2184563586f0,
                ])),
                Felt::new(BigInteger384([
                    0xc0ddc802ce279c92,
                    0x4510864336f6fc3e,
                    0x9d1f391afe30a08e,
                    0xe9590490c13acbac,
                    0x3b7349ee6d989a94,
                    0x013aa58094eff186,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0xb5b358128a7d34bd,
                    0x693b3d3d16eb1331,
                    0x70150b78b90b5f92,
                    0x29eb234185fde165,
                    0x6454d9e370fde6c1,
                    0x00191569ffb6bfbb,
                ])),
                Felt::new(BigInteger384([
                    0x65f71cfee6ac2ffe,
                    0x76a27d3f911b2b68,
                    0x3a0ad45b4e02ce16,
                    0xb95c0ab216039507,
                    0x792d86dbffd449c3,
                    0x0056140fb1cf6c47,
                ])),
                Felt::new(BigInteger384([
                    0xcf06b467cdf84656,
                    0xfe0dd3a167569c7e,
                    0x464ab98d9ae43cc1,
                    0x863f7babe8c6cd6b,
                    0xd673ec17930e2fda,
                    0x00de7e25df5c65d2,
                ])),
                Felt::new(BigInteger384([
                    0x0783a57ddf2ea67b,
                    0xcb739cf483b1574a,
                    0x82ad3b24584c33da,
                    0x219ac5999d089dfb,
                    0x7b24a32676648780,
                    0x0029624b54db6a0d,
                ])),
                Felt::new(BigInteger384([
                    0xbf78c6c4a92532d4,
                    0x3da17f34f95a2e96,
                    0x21a26a9082716024,
                    0x2ed70d000c837ff5,
                    0x4b69860100149893,
                    0x002e81859769dc6f,
                ])),
                Felt::new(BigInteger384([
                    0x10ec4503dd4506f3,
                    0xe66296331f487e4e,
                    0x1942a9108c4e91fc,
                    0xfc5b98ce7723641d,
                    0xaaca49361860f3a8,
                    0x002529acf0e8e04e,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0x9faadc51c0351671,
                    0x7f1cc5fd78eb1a5e,
                    0xb3754e79bb9276be,
                    0x91de7d4911e49d59,
                    0xd0e2bb1fb6335d3e,
                    0x009649a5327d6e2d,
                ])),
                Felt::new(BigInteger384([
                    0xd43308b8ba35cb31,
                    0x3825377d0a856de7,
                    0xe5cbb76c9f60e8d2,
                    0x6561ff108c5949a3,
                    0x7fc8b97523024b68,
                    0x0182e62da7009fc9,
                ])),
                Felt::new(BigInteger384([
                    0xda660cde257f86a6,
                    0x245ac1de681a16ea,
                    0xb2080e3ea1b83f9d,
                    0xc2557274b1e0b921,
                    0x5f162369442a6e25,
                    0x006b62b44ddfb8e9,
                ])),
                Felt::new(BigInteger384([
                    0xd052b488ec60c28c,
                    0xa615d40840a04b64,
                    0x452f23867412ed83,
                    0x609b9ddb7be0a184,
                    0xb95c245d0cdd89c2,
                    0x0061efc01a284964,
                ])),
                Felt::new(BigInteger384([
                    0x6aca4a9db9fcc687,
                    0x7e707e590de7fe53,
                    0x00f2f508dff9906e,
                    0x0af9a6a6624c3365,
                    0xfc918aa78810b38f,
                    0x0030514726002a4c,
                ])),
                Felt::new(BigInteger384([
                    0xd3b882cd1a01d8d7,
                    0x447464bd945ad426,
                    0x5df9578914b2f667,
                    0x39c37417b0d9304a,
                    0x4326da49fde1e2b0,
                    0x01a101af554629cf,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0x213603b45feb8380,
                    0x947c77030710d743,
                    0x276fa414c65f32fb,
                    0x5115b5bf315c40a0,
                    0xd7ac5cbd14ab6f15,
                    0x0071811ad832a534,
                ])),
                Felt::new(BigInteger384([
                    0x87936d7e7186dd65,
                    0x44ff16eff0e934c6,
                    0x6504a8b41b4da088,
                    0x30cae7ff9bef92ad,
                    0x149eb9c2f491ed12,
                    0x01899cedaedd8df5,
                ])),
                Felt::new(BigInteger384([
                    0x200adb47ab006d2a,
                    0x4a12b4a94cc1fcc4,
                    0xa213034acae6921a,
                    0xf00fe9019ade525f,
                    0x12700d02e89e8fbc,
                    0x00b768f3f5d993c3,
                ])),
                Felt::new(BigInteger384([
                    0x9f479ceb95f904ba,
                    0x92b8b2990290140f,
                    0x1a8160cab4d18ddf,
                    0xc0dfa27ab1304928,
                    0x934a58ff9c2ee424,
                    0x0136f359e7dc4887,
                ])),
                Felt::new(BigInteger384([
                    0xf40cd94a82fcf9f7,
                    0x26e2b06095f2df1d,
                    0x2846e698f2922c76,
                    0xab61083368685a8a,
                    0x680d71e85d05a5fe,
                    0x00c4454aee2b7585,
                ])),
                Felt::new(BigInteger384([
                    0x0125e311ca6d9b17,
                    0x8b262d0956483873,
                    0x900b9e3290f9b0c0,
                    0xfad367fabf4cf6a2,
                    0xdde7a49ae945793d,
                    0x01a5f3640d99af98,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0xb643a7c71a6f27ed,
                    0x4d7775d68f89c912,
                    0x676b07cfe170b9af,
                    0x093717043d4b525d,
                    0x4a35e91710d5d9da,
                    0x01a82ca8e62e72ba,
                ])),
                Felt::new(BigInteger384([
                    0xda50eef4659eb2c6,
                    0xc56db7e1ca26db00,
                    0xe0e4ea75c42d699e,
                    0xc5360af4a2842010,
                    0x7f43c8741ba65e30,
                    0x011d4bd353de1a1e,
                ])),
                Felt::new(BigInteger384([
                    0x32655fdd1d9f1d69,
                    0x534f20729ed97927,
                    0x291de28b87917531,
                    0xb8ba5bcba202a02d,
                    0x2c931e175c2eb6f3,
                    0x0013c2df8ca4dd3c,
                ])),
                Felt::new(BigInteger384([
                    0x560f6eef3d7b5385,
                    0x793a3ce7f7e9a564,
                    0x6d19308b23aae8e1,
                    0x0544798b9068b9dc,
                    0xf18feab1abd29422,
                    0x01007f2199aa6c7b,
                ])),
                Felt::new(BigInteger384([
                    0x169788404524f7f9,
                    0x9251562b6b6d3e42,
                    0xe8756f2902ece71f,
                    0x9db46e3aef1abcc3,
                    0x83457c789dfa9e67,
                    0x013400b2ea021782,
                ])),
                Felt::new(BigInteger384([
                    0xfc4b9edebba1e3cd,
                    0x3e7ba5fa40a5d47f,
                    0x14e648631a1ac123,
                    0x7af1252ab1dfe3f4,
                    0x8e0e2631117884fb,
                    0x00fcc74e5d9a12f7,
                ])),
            ],
        ];

        for i in input.iter_mut() {
            apply_sbox(i);
        }

        for (&i, o) in input.iter().zip(output) {
            assert_eq!(i, o);
        }
    }

    #[test]
    fn test_mds() {
        // Generated from https://github.com/vesselinux/anemoi-hash/
        let mut input = [
            [Felt::zero(); 6],
            [Felt::one(); 6],
            [
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
            ],
            [
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
            ],
            [
                Felt::new(BigInteger384([
                    0xe01e41ad6758fd85,
                    0x34eb08e54b21c175,
                    0xff17587757769e74,
                    0x1822f9fcf3ef02f9,
                    0x739f4aebb394a0e6,
                    0x0131104178e57cbd,
                ])),
                Felt::new(BigInteger384([
                    0xf6bcddd604e2f498,
                    0x3398a54878e1c06f,
                    0x352457ec6fd1a407,
                    0x862ed9887a3bad05,
                    0x7f63402e79805b61,
                    0x014e43997deec435,
                ])),
                Felt::new(BigInteger384([
                    0x86ece07971adac8e,
                    0xaecbfd78d6f606b0,
                    0xb4ac62b3319978ba,
                    0x5495a957d9e824cc,
                    0x3d57e5080caa7cf5,
                    0x01a2f91853b98859,
                ])),
                Felt::new(BigInteger384([
                    0x9eb012d7b842804d,
                    0x8ecbd281a0d2ceb8,
                    0xdc7ab85a94c903ea,
                    0x1b2540ae079d0935,
                    0x2a09e818b4092778,
                    0x00d0e24c931dcf67,
                ])),
                Felt::new(BigInteger384([
                    0x238bdb5a20720306,
                    0xe5c32954a112f320,
                    0x610b2f4a74d52d4b,
                    0xb5c7dbe033d24f37,
                    0xa4d609c375b07fd5,
                    0x00f6bad32844e8b1,
                ])),
                Felt::new(BigInteger384([
                    0x762b2559a4414fe6,
                    0xacbbba52262e4103,
                    0x6842dc1d17a9bae5,
                    0x9843b66286658160,
                    0xe1b2db730c4d486d,
                    0x00cc0c2a84f0c160,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0x629d86bfb0ede147,
                    0xdb934f438bc40368,
                    0x2df51edb597edbfe,
                    0x66fc2b39b5972072,
                    0x2f72c444c9392e71,
                    0x0010d06c9e99f9bd,
                ])),
                Felt::new(BigInteger384([
                    0x559d9c9b9efc0d47,
                    0x9268eb1efe348ff9,
                    0xf919deab5be1eef7,
                    0xe3fba1091429b87a,
                    0x8c0d4b00f00218f2,
                    0x0054d8ad37e35310,
                ])),
                Felt::new(BigInteger384([
                    0xbe12823d3aec5290,
                    0x37d6e21e34c1e073,
                    0xedc3ceffb63d9569,
                    0x9f2476118f9df62f,
                    0xd41abadebd1989bd,
                    0x0198c704076ba021,
                ])),
                Felt::new(BigInteger384([
                    0xaf72ebb11c484e2e,
                    0xfa4bdfb182397dfc,
                    0x41dadadb147812e8,
                    0x3a2744444f283f1c,
                    0x6d83b0dc94eb36ca,
                    0x00ddeb22108f66cd,
                ])),
                Felt::new(BigInteger384([
                    0x8cfae740fbac4ed8,
                    0xc1fc7dcbe36cd4a7,
                    0x2bbae4ecab27592b,
                    0x8ca0dfd9be148214,
                    0xe792187682991a16,
                    0x0093de5ea7f90ada,
                ])),
                Felt::new(BigInteger384([
                    0x03510ace4c4e7e81,
                    0xa7eb2d549691cd68,
                    0x3f8989c2652d4b89,
                    0x8d46b78127e65ae7,
                    0x2a328ca8956a1f8e,
                    0x00d1ff9d03711e79,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0x2899b262d208d168,
                    0x5584eb16ccc6c595,
                    0x35a1ccaababef72c,
                    0xc933e66dd938470a,
                    0xca66997bb5bda674,
                    0x01aa39f67a483c55,
                ])),
                Felt::new(BigInteger384([
                    0x06b1bd3a19719ff9,
                    0xd7d06d4d5512b0a4,
                    0xc7d22edbc1e6f900,
                    0x89660dee4051ba2c,
                    0x6619aad14156e9ca,
                    0x008c834c3078dcf1,
                ])),
                Felt::new(BigInteger384([
                    0xd90d6aacd086d135,
                    0x64f09aa0e35a3cfe,
                    0x78ed7f5b0c26f715,
                    0xda5760cf932cd727,
                    0x997552a372e27bcc,
                    0x001d536295d748e6,
                ])),
                Felt::new(BigInteger384([
                    0x438bbcf4ef0c77dc,
                    0x156d4a7001dd3046,
                    0x8509aa1a0570bd8e,
                    0x4a36bd9c96c3e8b0,
                    0xfcae584f26cc4ef4,
                    0x00719ec5c61536bc,
                ])),
                Felt::new(BigInteger384([
                    0xaef43be005c67908,
                    0x1be0708baeb8ecc2,
                    0x403373e8dcd7c7a7,
                    0x8d7ed5b88acbaae8,
                    0xec92f5f1d023e677,
                    0x005e26dbe0a0e542,
                ])),
                Felt::new(BigInteger384([
                    0x56f92eb26137b14b,
                    0x9c215cf869031b0e,
                    0x1593368517c379bd,
                    0x650aa0ecd6d1c9da,
                    0x2d83cb1f0312c843,
                    0x009bbc5f7cb6ec95,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0x3c70cf02fa8ec267,
                    0x8b548abdb71bf311,
                    0x6aea7da894125c23,
                    0x10bee07ee5e95a5d,
                    0xf2c9fdf2a1d20c37,
                    0x01803425430a4577,
                ])),
                Felt::new(BigInteger384([
                    0x5a85ab54ac901ea2,
                    0xe6503b5dca97f74e,
                    0xf8e7195191609c74,
                    0x7f743c73d77c690d,
                    0x29f69220295b03e0,
                    0x012bfed498e2ded1,
                ])),
                Felt::new(BigInteger384([
                    0x181dba48a85fcc81,
                    0xb97e053928814a47,
                    0xa9d4af037f7f4aec,
                    0x06203188c5288de5,
                    0xb808b43758d95bac,
                    0x01797904f74f7707,
                ])),
                Felt::new(BigInteger384([
                    0x039325690dafffef,
                    0x543e6bb0a1ec164a,
                    0x432068ac41c9da7e,
                    0x8dd80fb42206d59b,
                    0x87049c9a7c134e37,
                    0x015eed88cc57dc58,
                ])),
                Felt::new(BigInteger384([
                    0xd0bfa11ff75ba2d6,
                    0xc3db824974c7e3b4,
                    0x3c9f28106887f413,
                    0xab560e18b1e5247d,
                    0x2ebf5e6c44894a89,
                    0x01583bcb85b55b8a,
                ])),
                Felt::new(BigInteger384([
                    0x9bbf76a201f82047,
                    0x95a19215d78fc544,
                    0xf69f31597fa6fc5c,
                    0x26d1a60c42586c98,
                    0x1b488805944a0b53,
                    0x010aff8af0a22df4,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0x6dfe7db6ef19eaa1,
                    0x7ab24c5208f50b08,
                    0x69569e3a19559e72,
                    0xc72a00112ebac867,
                    0x5490c73eb370e95f,
                    0x002fcad72eeea465,
                ])),
                Felt::new(BigInteger384([
                    0x9263dfbba5ccde21,
                    0x79e7b9c9d0a23f27,
                    0x06e1bec1cf40f1ac,
                    0x32ac03d5eeb32ac0,
                    0x9464b1025a034d3e,
                    0x00a9d9bc3e5acb2b,
                ])),
                Felt::new(BigInteger384([
                    0x924a98c5cdf11dad,
                    0x5986dee3919b2658,
                    0x6f25bd280b08d232,
                    0xea5e5d6ff0ae70f0,
                    0x6b4fe2f1493868ef,
                    0x0027b7d4c6b63e17,
                ])),
                Felt::new(BigInteger384([
                    0x7d464b6dde2e5316,
                    0x2c275cf3859b1efd,
                    0xd61c3a2274e7d194,
                    0x13941542ceef0721,
                    0x04bd8ede4ef4451b,
                    0x0033be26625114cd,
                ])),
                Felt::new(BigInteger384([
                    0x9f96730900f2bca9,
                    0x988b8d5ce87eca26,
                    0xcdc0429af9af7278,
                    0x2909637d4f6ae408,
                    0xa041078cd883936f,
                    0x00c9ab007a2551cb,
                ])),
                Felt::new(BigInteger384([
                    0x498ceb280d051837,
                    0xfb37fbaecaf91fef,
                    0xb83cbf03c3b42975,
                    0xb0c4d8c14c3be4f3,
                    0x3f79437d528881b3,
                    0x003f6075b885c99b,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0xe80318929c4733ee,
                    0x10fea6650b5cf97a,
                    0xa2359a45f47c1e5f,
                    0x70ef87202cc41d3b,
                    0x3740e2d25a6aaeaf,
                    0x013a608972d256c0,
                ])),
                Felt::new(BigInteger384([
                    0xe5a523c77e8c5725,
                    0xad46d30294d1654b,
                    0x1cf73a2aecba64d4,
                    0xfb4de15d7364a4c8,
                    0xb7f396ca74c2e69a,
                    0x00e3b86c393d90f6,
                ])),
                Felt::new(BigInteger384([
                    0xaf028d926717b934,
                    0xd88f3d11b48cc1d7,
                    0xa13e0d78b5b01954,
                    0x182575cbea20cbac,
                    0xec4b3e98e121da08,
                    0x008fbc8acc67642f,
                ])),
                Felt::new(BigInteger384([
                    0x7014265da233199b,
                    0x511a47b2ee8da957,
                    0x2f9acdf74b63b4df,
                    0x9027fb686fce30ce,
                    0xe816a36ea3711c45,
                    0x018a6e7324d4dd49,
                ])),
                Felt::new(BigInteger384([
                    0xa07f19fc105c645a,
                    0x86fbc7bc85acc160,
                    0x9dc010a4139478c9,
                    0xdbe9f8b316a5662c,
                    0x39522f488f9e8b38,
                    0x01075164b490e091,
                ])),
                Felt::new(BigInteger384([
                    0x89dc8d501bb7b501,
                    0x9d8d7f549f214650,
                    0x48cc1db9dfc3eb3b,
                    0x914b9bf71ce85327,
                    0xb34344ad5f43b87e,
                    0x00331efc7fa39840,
                ])),
            ],
        ];

        let mut input2 = input;

        let output = [
            [Felt::zero(); 6],
            [
                Felt::new(BigInteger384([
                    0x2a367fffffffec5e,
                    0x92e2eb499ffff5cc,
                    0x59b252fd95c86e3b,
                    0xdfc50b2734760022,
                    0x2d39142b498045a8,
                    0x016bebe15509deb8,
                ])),
                Felt::new(BigInteger384([
                    0x96823ffffffff5e3,
                    0xf211c5668ffffabe,
                    0xfc9803539022d716,
                    0xad89d16f51793193,
                    0x3d16d4f564de6548,
                    0x00fca9219c03e9a9,
                ])),
                Felt::new(BigInteger384([
                    0x96823ffffffff5e3,
                    0xf211c5668ffffabe,
                    0xfc9803539022d716,
                    0xad89d16f51793193,
                    0x3d16d4f564de6548,
                    0x00fca9219c03e9a9,
                ])),
                Felt::new(BigInteger384([
                    0x2a367fffffffec5e,
                    0x92e2eb499ffff5cc,
                    0x59b252fd95c86e3b,
                    0xdfc50b2734760022,
                    0x2d39142b498045a8,
                    0x016bebe15509deb8,
                ])),
                Felt::new(BigInteger384([
                    0x96823ffffffff5e3,
                    0xf211c5668ffffabe,
                    0xfc9803539022d716,
                    0xad89d16f51793193,
                    0x3d16d4f564de6548,
                    0x00fca9219c03e9a9,
                ])),
                Felt::new(BigInteger384([
                    0x96823ffffffff5e3,
                    0xf211c5668ffffabe,
                    0xfc9803539022d716,
                    0xad89d16f51793193,
                    0x3d16d4f564de6548,
                    0x00fca9219c03e9a9,
                ])),
            ],
            [
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::new(BigInteger384([
                    0x2a367fffffffec5e,
                    0x92e2eb499ffff5cc,
                    0x59b252fd95c86e3b,
                    0xdfc50b2734760022,
                    0x2d39142b498045a8,
                    0x016bebe15509deb8,
                ])),
                Felt::new(BigInteger384([
                    0x96823ffffffff5e3,
                    0xf211c5668ffffabe,
                    0xfc9803539022d716,
                    0xad89d16f51793193,
                    0x3d16d4f564de6548,
                    0x00fca9219c03e9a9,
                ])),
                Felt::new(BigInteger384([
                    0x96823ffffffff5e3,
                    0xf211c5668ffffabe,
                    0xfc9803539022d716,
                    0xad89d16f51793193,
                    0x3d16d4f564de6548,
                    0x00fca9219c03e9a9,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0x2a367fffffffec5e,
                    0x92e2eb499ffff5cc,
                    0x59b252fd95c86e3b,
                    0xdfc50b2734760022,
                    0x2d39142b498045a8,
                    0x016bebe15509deb8,
                ])),
                Felt::new(BigInteger384([
                    0x96823ffffffff5e3,
                    0xf211c5668ffffabe,
                    0xfc9803539022d716,
                    0xad89d16f51793193,
                    0x3d16d4f564de6548,
                    0x00fca9219c03e9a9,
                ])),
                Felt::new(BigInteger384([
                    0x96823ffffffff5e3,
                    0xf211c5668ffffabe,
                    0xfc9803539022d716,
                    0xad89d16f51793193,
                    0x3d16d4f564de6548,
                    0x00fca9219c03e9a9,
                ])),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
            ],
            [
                Felt::new(BigInteger384([
                    0x5f82c043954d95ad,
                    0x00d634f98a5e42c8,
                    0x2db4af8c61d87ef3,
                    0x900c12343dd51958,
                    0xa69ca41f086f7fdc,
                    0x012eb3d1c6164cdd,
                ])),
                Felt::new(BigInteger384([
                    0x6e3046a115690e5f,
                    0x35c1b3ff5c6de635,
                    0xdb1f55e80eb1d56a,
                    0xf0e9207b23739f0b,
                    0x27789a8c20fdbaf5,
                    0x002847e662622f81,
                ])),
                Felt::new(BigInteger384([
                    0x6306977884c77be5,
                    0xe7a1c8fe76d21d02,
                    0x68c64f6108ef058f,
                    0x0b2ef14e93a813c2,
                    0x384c4400f450d70d,
                    0x00a6753ec9ddd0a7,
                ])),
                Felt::new(BigInteger384([
                    0xc45548772f898505,
                    0x6dea462f148a5e86,
                    0x3277d14256ef064b,
                    0xeac506232d14bbb3,
                    0xa5c6976e7131e05d,
                    0x00b3ff7ea7062356,
                ])),
                Felt::new(BigInteger384([
                    0xbdc21b579098d767,
                    0x38154f1db39b50f0,
                    0xbce3c73873fbe2ef,
                    0x14238cdd24c2be46,
                    0xcb4550a5a97cce74,
                    0x008e37498dcc49c7,
                ])),
                Felt::new(BigInteger384([
                    0x7cbe52794331fd84,
                    0xe290b163871d4e99,
                    0xddd6e626fa9cde41,
                    0x6ee52fa88eb77ecc,
                    0xbc34223bd4025a57,
                    0x00f1d45f9e2a9aef,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0x10122c6a5c9f4aa7,
                    0x58562cf80692cdb3,
                    0xc5729960b7148577,
                    0xa3d8168d5829e9aa,
                    0x6134e1328b190831,
                    0x000aab561bebe254,
                ])),
                Felt::new(BigInteger384([
                    0x94d644f1c3c2c4f0,
                    0x70f4606d0154ba22,
                    0x6438bfe6367a9c1f,
                    0x3032cc00269b33e8,
                    0x51d6b1ccdce85845,
                    0x00d22280f904c1f2,
                ])),
                Felt::new(BigInteger384([
                    0x55e2441437d892ff,
                    0x90d614ee3372a38a,
                    0x79471a559685204f,
                    0x71c3c58946ad81cc,
                    0x61a680270ad4121a,
                    0x013b9bc8728f845d,
                ])),
                Felt::new(BigInteger384([
                    0x83b3b9efcb984ed3,
                    0x29d1eb7050f6f7a4,
                    0x679627a232a21cd4,
                    0x8be10e17ee4b5c1a,
                    0xa454d1541cdd2c5f,
                    0x006767d33f314c27,
                ])),
                Felt::new(BigInteger384([
                    0xafc1c16ff0376203,
                    0x5bfedc659b5d03d9,
                    0x4f7c30077313805b,
                    0xb11dc7c381adf32a,
                    0x4aa3d4086cc125a5,
                    0x00f4d2c9e5a8a807,
                ])),
                Felt::new(BigInteger384([
                    0xd743034e27af6b51,
                    0x75be3c5f4c2bc132,
                    0x57a3815d24bbe802,
                    0x6809fdd59483c3d7,
                    0x83e389f445862648,
                    0x004494a65cf9c299,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0x4b8ece34426bc9b8,
                    0xf76797412722d9db,
                    0xa29d6a0cd5a8151a,
                    0x05ca08a1f65d50c6,
                    0x79ed0afc94a330f8,
                    0x00737a359e5b1120,
                ])),
                Felt::new(BigInteger384([
                    0xdd032fbd2360b37a,
                    0xe957ad4914230926,
                    0xd577ad7cbedbda6d,
                    0xe972ec9fb7407568,
                    0xa1ea105fd9173ec9,
                    0x00922b7d42d43cf4,
                ])),
                Felt::new(BigInteger384([
                    0x753d5bb1387cb637,
                    0xe5e0574568128158,
                    0x94f7eb6bd8b333ad,
                    0xa5bd29f07f6e958a,
                    0x3e1ca56dfce2dbf8,
                    0x006dd2048bffb11d,
                ])),
                Felt::new(BigInteger384([
                    0x56b2bc01ae66bf83,
                    0xf8a22291f264eb99,
                    0x71ca05356c018d0f,
                    0x0f4d06a6e82266ed,
                    0x8fc0812b0d0bd528,
                    0x0026444929f0253d,
                ])),
                Felt::new(BigInteger384([
                    0xe6fa7cec68b93033,
                    0x9d3bb50373b1dbec,
                    0xa58a19355e113cb7,
                    0xe3332b063343c8dd,
                    0xcf61d6b266aa2a1e,
                    0x00e947b99981c33f,
                ])),
                Felt::new(BigInteger384([
                    0x4bba2dc7a6e5409c,
                    0x0e9327cb17b62abb,
                    0x00c684b4dfbd1216,
                    0xab4756808ca57b79,
                    0xb41d7b581615bc87,
                    0x0186f33524ea5f7d,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0x9170800edb790d05,
                    0x972faa12546bccc4,
                    0xc347c4aab76de576,
                    0xf772ac676cd7b608,
                    0x62720df385cc365f,
                    0x000a37878d2bbc33,
                ])),
                Felt::new(BigInteger384([
                    0xba39e49984bbdc8a,
                    0x0d67faba41474482,
                    0xa5f8799271666c76,
                    0x7e2e18ac3d5f020c,
                    0x0e08cecb0f176df0,
                    0x01431a6f0cce30e6,
                ])),
                Felt::new(BigInteger384([
                    0xb6c506ca034d4f1e,
                    0x872347fa0dbc7f90,
                    0x3529c69991715d75,
                    0x12dbaa2207ea3099,
                    0x449ad7090cb1158b,
                    0x01a1563331057b09,
                ])),
                Felt::new(BigInteger384([
                    0x5e085f3252b24c7d,
                    0xc018f8ca62cf6524,
                    0xcde0444b3fd2957b,
                    0x1229602b68341197,
                    0x5589a2e695b22766,
                    0x00cba9b1a771f447,
                ])),
                Felt::new(BigInteger384([
                    0xe0ac88e9c6a3c211,
                    0x1d91a742592cf748,
                    0x8fc87f15508a15d6,
                    0xce0b8e5be63216ea,
                    0x224dc8b999c4331d,
                    0x011a30cb3a7b96c2,
                ])),
                Felt::new(BigInteger384([
                    0x191b4cea8e06aab3,
                    0x3828e39de1323320,
                    0x34b6f68f6eef7c02,
                    0x6aef77dbc45a6746,
                    0x4e8462329037ff9b,
                    0x00bc78715d988b79,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0x07db0787767d62fe,
                    0x78585556e9a55536,
                    0x31cd4e54e70c23f9,
                    0xfcc94e0ee2678590,
                    0x3fbe42c0deb49687,
                    0x011755a95159c037,
                ])),
                Felt::new(BigInteger384([
                    0x0db89109a60785e4,
                    0x1c75b82d31ae8960,
                    0xd47b1024d4119912,
                    0x9b3aa38336b17dae,
                    0x6c68bea3eb211371,
                    0x017f2fc4fa320205,
                ])),
                Felt::new(BigInteger384([
                    0x8c8656397642bb3b,
                    0xd5ca56f388990afd,
                    0x6433fcf1e23b7c93,
                    0x943aae619a6932a1,
                    0x67ba351f4d96d054,
                    0x0041ffa09582895d,
                ])),
                Felt::new(BigInteger384([
                    0x6a0a1295ff16141e,
                    0x7700594ffc97b22c,
                    0xdf76172d22d4e241,
                    0x8f62bb38293ce795,
                    0x974f766bf85a7743,
                    0x00f5e66ca9fe9ae4,
                ])),
                Felt::new(BigInteger384([
                    0x363049a112aeb328,
                    0xfbfb40c8278ebaef,
                    0xd3bda54422e6539c,
                    0xcb35c742b9be0cd9,
                    0x9a5f9e8ff2198f42,
                    0x00b4bb29c5e13194,
                ])),
                Felt::new(BigInteger384([
                    0x7d66b41cf96c792d,
                    0x763d1436a002172c,
                    0xc3f530ecc3a2b81a,
                    0x74f1ccb6bbbabfaf,
                    0x3c691b5958c969b4,
                    0x00808bb89ca332eb,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0x806ac617b47b2934,
                    0xbe63d8e7636d1a6c,
                    0x460830ea34e01811,
                    0xd04d36fbd16ce6cb,
                    0xc6ca4bb6f6d59526,
                    0x00f3ab0898c32061,
                ])),
                Felt::new(BigInteger384([
                    0xf09a07ee25376519,
                    0xe465ddd8146dba66,
                    0x781b51652a504f2b,
                    0x399e33be52563bc6,
                    0x223b020f7461a461,
                    0x0074c77317806105,
                ])),
                Felt::new(BigInteger384([
                    0x7575e1f10dd01b40,
                    0x8744ce11e3d0c551,
                    0xeae419aff74a2dba,
                    0x91fce49af27b4fcc,
                    0x5c82e071f736d760,
                    0x01629c01ba805053,
                ])),
                Felt::new(BigInteger384([
                    0x1a3e92eb44af9439,
                    0xf5ddb7e762c7f1c5,
                    0x37a8d2f65e6805c6,
                    0xdf266ee76d27ed69,
                    0x3447e616611f52da,
                    0x00f9a5e7db85dff0,
                ])),
                Felt::new(BigInteger384([
                    0x750f66c8ad129962,
                    0xa27460d27f1af3c9,
                    0xff4ee13f31ae0d19,
                    0x71a5647eb33b8394,
                    0xaeaeb6eb91b0ea8f,
                    0x00cfb94b0fe6834f,
                ])),
                Felt::new(BigInteger384([
                    0x2f0bb972b354afd8,
                    0xf0f6d66982ce444c,
                    0x81260f710c7de3e8,
                    0xfecca65fd6d4bcfb,
                    0x38dc73d82eb220c9,
                    0x005d0b994b42f4e1,
                ])),
            ],
        ];

        for i in input.iter_mut() {
            apply_mds(i);
        }
        for i in input2.iter_mut() {
            apply_naive_mds(i);
        }

        for (index, (&i_1, i_2)) in input.iter().zip(input2).enumerate() {
            assert_eq!(output[index], i_1);
            assert_eq!(output[index], i_2);
        }
    }
}
