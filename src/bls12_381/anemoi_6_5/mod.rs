use super::{mul_by_generator, sbox, BigInteger384, Felt};
use crate::{Jive, Sponge};
use ark_ff::{Field, One, Zero};
use unroll::unroll_for_loops;

/// Digest for Anemoi
mod digest;
/// Sponge for Anemoi
mod hasher;
/// MDS matrix for Anemoi
mod mds;
/// Round constants for Anemoi
mod round_constants;

pub use digest::AnemoiDigest;
pub use hasher::AnemoiHash;

// ANEMOI CONSTANTS
// ================================================================================================

/// Function state is set to 6 field elements or 288 bytes.
/// 1 element of the state is reserved for capacity.
pub const STATE_WIDTH: usize = 6;
/// 5 elements of the state are reserved for rate.
pub const RATE_WIDTH: usize = 5;

/// The state is divided into two even-length rows.
pub const NUM_COLUMNS: usize = 3;

/// One element (48-bytes) is returned as digest.
pub const DIGEST_SIZE: usize = 1;

/// The number of rounds is set to 10 to provide 128-bit security level.
pub const NUM_HASH_ROUNDS: usize = 10;

// HELPER FUNCTIONS
// ================================================================================================

#[inline(always)]
/// Applies exponentiation of the current hash
/// state elements with the Anemoi S-Box.
pub(crate) fn apply_sbox(state: &mut [Felt; STATE_WIDTH]) {
    let mut x: [Felt; NUM_COLUMNS] = state[..NUM_COLUMNS].try_into().unwrap();
    let mut y: [Felt; NUM_COLUMNS] = state[NUM_COLUMNS..].try_into().unwrap();

    x.iter_mut().enumerate().for_each(|(i, t)| {
        let y2 = y[i].square();
        *t -= mul_by_generator(&y2);
    });

    let mut x_alpha_inv = x;
    x_alpha_inv
        .iter_mut()
        .for_each(|t| *t = sbox::exp_inv_alpha(t));

    y.iter_mut()
        .enumerate()
        .for_each(|(i, t)| *t -= x_alpha_inv[i]);

    x.iter_mut().enumerate().for_each(|(i, t)| {
        let y2 = y[i].square();
        *t += mul_by_generator(&y2) + sbox::DELTA;
    });

    state[..NUM_COLUMNS].copy_from_slice(&x);
    state[NUM_COLUMNS..].copy_from_slice(&y);
}

#[inline(always)]
/// Applies matrix-vector multiplication of the current
/// hash state with the Anemoi MDS matrix.
pub(crate) fn apply_mds(state: &mut [Felt; STATE_WIDTH]) {
    apply_mds_internal(&mut state[..NUM_COLUMNS]);
    state[NUM_COLUMNS..].rotate_left(1);
    apply_mds_internal(&mut state[NUM_COLUMNS..]);
}

#[inline(always)]
fn apply_mds_internal(state: &mut [Felt]) {
    let tmp = state[0] + mul_by_generator(&state[2]);
    state[2] += state[1];
    state[2] += mul_by_generator(&state[0]);

    state[0] = tmp + state[2];
    state[1] += tmp;
}

// ANEMOI PERMUTATION
// ================================================================================================

/// Applies an Anemoi permutation to the provided state
#[inline(always)]
#[unroll_for_loops]
pub(crate) fn apply_permutation(state: &mut [Felt; STATE_WIDTH]) {
    for i in 0..NUM_HASH_ROUNDS {
        apply_round(state, i);
    }

    apply_mds(state)
}

/// Applies an Anemoi round to the provided state
#[inline(always)]
#[unroll_for_loops]
pub(crate) fn apply_round(state: &mut [Felt; STATE_WIDTH], step: usize) {
    // determine which round constants to use
    let c = &round_constants::C[step % NUM_HASH_ROUNDS];
    let d = &round_constants::D[step % NUM_HASH_ROUNDS];

    for i in 0..NUM_COLUMNS {
        state[i] += c[i];
        state[NUM_COLUMNS + i] += d[i];
    }

    apply_mds(state);
    apply_sbox(state);
}

#[cfg(test)]
mod tests {
    use super::*;

    fn apply_naive_mds(state: &mut [Felt; STATE_WIDTH]) {
        let x: [Felt; NUM_COLUMNS] = state[..NUM_COLUMNS].try_into().unwrap();
        let mut y: [Felt; NUM_COLUMNS] = [Felt::zero(); NUM_COLUMNS];
        y[0..NUM_COLUMNS - 1].copy_from_slice(&state[NUM_COLUMNS + 1..]);
        y[NUM_COLUMNS - 1] = state[NUM_COLUMNS];

        let mut result = [Felt::zero(); STATE_WIDTH];
        for (i, r) in result.iter_mut().enumerate().take(NUM_COLUMNS) {
            for (j, s) in x.into_iter().enumerate().take(NUM_COLUMNS) {
                *r += s * mds::MDS[i * NUM_COLUMNS + j];
            }
        }
        for (i, r) in result.iter_mut().enumerate().skip(NUM_COLUMNS) {
            for (j, s) in y.into_iter().enumerate() {
                *r += s * mds::MDS[(i - NUM_COLUMNS) * NUM_COLUMNS + j];
            }
        }

        state.copy_from_slice(&result);
    }

    #[test]
    fn test_sbox() {
        // Generated from https://github.com/Nashtare/anemoi-hash/
        let mut input = [
            [Felt::zero(); 6],
            [Felt::one(); 6],
            [
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
            ],
            [
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
            ],
            [
                Felt::new(BigInteger384([
                    0x563ac35ef02d3f03,
                    0x2d0607afc3f647ef,
                    0x0c9cdb0e74c52937,
                    0xd5ac7c510b99cbf3,
                    0xddc1628e1f069305,
                    0x07e52766f1b90f0f,
                ])),
                Felt::new(BigInteger384([
                    0x558ec80d4273b849,
                    0xd1efd057ece462c9,
                    0x069f6c91e904f07f,
                    0x1cd4db654d1b9bb0,
                    0xcd8a5869d8182fda,
                    0x001923c9cf266711,
                ])),
                Felt::new(BigInteger384([
                    0x08f55864efc57841,
                    0xa14a51fb325f1b89,
                    0x2942fe78427a4f5a,
                    0x5621a998d6852dd1,
                    0xedd49609b04a74af,
                    0x1266f451155b0ccf,
                ])),
                Felt::new(BigInteger384([
                    0x6686c6b919db640a,
                    0xdc0ae7b3151d3a98,
                    0x762c5cfc3642cc30,
                    0xb56f91e9ba11a24a,
                    0xaf1dbee871cd4651,
                    0x0587f93d8c2eebb8,
                ])),
                Felt::new(BigInteger384([
                    0x58ebcc50f3697227,
                    0x0a9c4867b3647e03,
                    0x35fb27c03e2c010f,
                    0xc1057f065ada2868,
                    0xe4145233a8798f50,
                    0x0742c8011a380e01,
                ])),
                Felt::new(BigInteger384([
                    0x743b93715ae5c5fa,
                    0xe5c84ebb440bcee6,
                    0x87acf1bcdba5900a,
                    0x6315c04fbb8fa04c,
                    0xa65efb51acdf8648,
                    0x06ceb04a0563ef42,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0x22257ee2a27b509e,
                    0xf6d34888d3126651,
                    0xd2977dac7d4114d2,
                    0x685f4b65584f4002,
                    0xc596f0eb3a9d8281,
                    0x0120caadf4176872,
                ])),
                Felt::new(BigInteger384([
                    0x57e1624ccf1050d1,
                    0xca78ce89fe0d9f95,
                    0x7f485d01f841c04e,
                    0xf277ae38a94a35ed,
                    0xadf4184f829b6cda,
                    0x018066b8b9a61729,
                ])),
                Felt::new(BigInteger384([
                    0x28979c91695d5b46,
                    0xb5a0b1583c885b83,
                    0xf5da9b2e4e90e218,
                    0x5657c0a17c9cfcc6,
                    0x04cc15c3e0dd5bd5,
                    0x04d4675955bd35e6,
                ])),
                Felt::new(BigInteger384([
                    0xacd8c8c0748a89c1,
                    0x927e5bb701a7e218,
                    0x87d08cfc831107ad,
                    0x3feccd3e4507c44e,
                    0x39eb03cbf9f0aed2,
                    0x0de55d6dec40c9d6,
                ])),
                Felt::new(BigInteger384([
                    0x1833171c7ab4b7f5,
                    0x602356e9a2bed570,
                    0xbd6202894fda9e0b,
                    0x6a1e79eb0c9c2941,
                    0x323252cdf907d759,
                    0x0058e512c09c0ae4,
                ])),
                Felt::new(BigInteger384([
                    0xab591e647e1d3da3,
                    0x77bf92ac4e9c25b0,
                    0xd74ca9afb25bb85c,
                    0xf175a82fa672b9d7,
                    0x72470362414de14d,
                    0x14e4f098f576e249,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0x6a085cc68c5160b3,
                    0x2723b5baafd29f80,
                    0xdb45d33db2ff3308,
                    0x41f2cd74dfa41060,
                    0x24a958ffb99ce2e7,
                    0x0d35ddf2eed70916,
                ])),
                Felt::new(BigInteger384([
                    0xd7ad1ff0269bb796,
                    0x6743626900058a92,
                    0x0432a92436b93855,
                    0x908609687183cde8,
                    0xa8771d9bb274a4ae,
                    0x0db8b688bb32dad8,
                ])),
                Felt::new(BigInteger384([
                    0x4d56ba8b64d65520,
                    0xa961b74fbcabed0a,
                    0x257d084417714622,
                    0xcb72ab016b68746c,
                    0xed5e990ed3907a01,
                    0x143136155bd5b9f9,
                ])),
                Felt::new(BigInteger384([
                    0x154bb720b6e2192e,
                    0xa8ce187dd7e0ffd8,
                    0x4a76938b7889096c,
                    0x36a8650bf9723359,
                    0x74c57bb57ff8121f,
                    0x0e65d3be8f2a2e99,
                ])),
                Felt::new(BigInteger384([
                    0x67be8b3ccad4257b,
                    0xe3a4203e0eba4e4b,
                    0x0d51812402672031,
                    0x5380e16e7f630e11,
                    0xa139cbc7bbbe96eb,
                    0x1732ae4c2cc27930,
                ])),
                Felt::new(BigInteger384([
                    0x0806107bb612876a,
                    0xde2085cb1216d7ce,
                    0x209e9943facb66a5,
                    0xdc06a17d5442d71d,
                    0x4153475a8cab786d,
                    0x05bbc58635620819,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0x74ad684e3aefb3f1,
                    0x2d4d25b34595d2f3,
                    0x3c465fc367d49cfa,
                    0xebe468491b558d66,
                    0x30ededa1228d8f7e,
                    0x1792be9dbb4d4c5d,
                ])),
                Felt::new(BigInteger384([
                    0x36074110f4ca083b,
                    0x7204d6526500eeb6,
                    0xd3892b0705b1dd95,
                    0x0cfc420c45d947c1,
                    0x4d850860150e937a,
                    0x098e5b4ca7821144,
                ])),
                Felt::new(BigInteger384([
                    0xb2cad6e0e98e99b9,
                    0xc1ddad45223e9f09,
                    0xb6e01bae4f3e80a3,
                    0xa80849baa67d9f00,
                    0x7d545be36d20a224,
                    0x08d46daeacbbc563,
                ])),
                Felt::new(BigInteger384([
                    0x49f7c20d48b07300,
                    0x73d81713d55ca0cb,
                    0x545cc60aacc9c802,
                    0x88452304c81011e0,
                    0x75d81286ce9ffc1b,
                    0x04e23f59ad65d31c,
                ])),
                Felt::new(BigInteger384([
                    0xa3663cc58a3d298a,
                    0x9a31695c365790f2,
                    0xc048aa311b8f761e,
                    0x8b828259e9fe4e4e,
                    0x345298d6e2b005d9,
                    0x0a71eff35fb2e414,
                ])),
                Felt::new(BigInteger384([
                    0x1f658074efb99db1,
                    0xeebaa2c06bdc133b,
                    0xa0a61739f6c9fa14,
                    0x7287aaec7dbf6a59,
                    0x9616cdc3fa1ea7d3,
                    0x0c9ed65bb7b2ef36,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0x3e8e76051c10bd29,
                    0x0f9c4366b3fea533,
                    0xe9903e772670dbce,
                    0x9b7d72d21e05240f,
                    0x11db5e3b43ddaf90,
                    0x041a35dbdb884f72,
                ])),
                Felt::new(BigInteger384([
                    0x4aaa0cf65ee221fd,
                    0xea67d872ea9e438a,
                    0xd6edb017ddfb742f,
                    0x64ba5b494bba1c3f,
                    0x314128641041088b,
                    0x10614c351edd16e1,
                ])),
                Felt::new(BigInteger384([
                    0x31d288023795a2e7,
                    0xdd0c766fe33e35b6,
                    0x436a508e8e3ff4ec,
                    0xb050c468ba2c2cd6,
                    0x9b825297a7fd1c62,
                    0x076d49bbe774bc69,
                ])),
                Felt::new(BigInteger384([
                    0x060f3cd1db16cd74,
                    0x25b1fab8fd8da43e,
                    0x2d815f175dfcf61c,
                    0x1cb52c7095e9c5d0,
                    0x99cd64f78a560f4a,
                    0x0bb6636574de5a36,
                ])),
                Felt::new(BigInteger384([
                    0x412fe8e523bd5e4c,
                    0x77c209ad388bbd9c,
                    0x71cec589b22be382,
                    0xb12774123d7decb4,
                    0x5707d331ca01b7bf,
                    0x19a620e43d48415a,
                ])),
                Felt::new(BigInteger384([
                    0x67b5e0feda522998,
                    0x7be80d41d40c0256,
                    0xcfeb089619741d39,
                    0x48743728ab8c08a6,
                    0x05f7c1eb704d2439,
                    0x0d2dd33bfc04bb50,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0xf31bccdd843d16f6,
                    0xad2181b41bec87f5,
                    0xddb34cbe3dfc8caa,
                    0x12329a1a065edaee,
                    0xda44d8e782fbb5d3,
                    0x0e962c483de8092e,
                ])),
                Felt::new(BigInteger384([
                    0xb837d4cf10c2bdf8,
                    0x6cd7bddaafdc2e0a,
                    0xcbc0411d1699dde3,
                    0x8e0aed11b9787b86,
                    0xfcd6bb05e83fb7f9,
                    0x06f71d8ca7d8166e,
                ])),
                Felt::new(BigInteger384([
                    0x963ac22280103d66,
                    0x693534188c6ef454,
                    0x155b618ed48f3096,
                    0xfeec79d1a0c764b3,
                    0x74adf32b97e4fde4,
                    0x043aadb14525f31c,
                ])),
                Felt::new(BigInteger384([
                    0x281c1d39dcba1583,
                    0x045ddf1a64b57473,
                    0x4374146f110dc061,
                    0xb99752f83e097d4b,
                    0xbc4a34d1b493bc53,
                    0x008fe7562fb7d706,
                ])),
                Felt::new(BigInteger384([
                    0xa9073d803e7da22c,
                    0x50e138403f3afef5,
                    0x0ac05936d24fd242,
                    0x41e9be9b2872ac4b,
                    0x408c400edd622802,
                    0x0e0048a4a89728f6,
                ])),
                Felt::new(BigInteger384([
                    0x5e975db03dd26e3d,
                    0xc08a4f418d8ad2a8,
                    0x148a51376d573b97,
                    0x04b4bcc0033b66ac,
                    0xcf8caeed02d3f1c9,
                    0x073f9ff1fdd66909,
                ])),
            ],
        ];

        let output = [
            [
                Felt::new(BigInteger384([
                    0x1804000000015554,
                    0x855000053ab00001,
                    0x633cb57c253c276f,
                    0x6e22d1ec31ebb502,
                    0xd3916126f2d14ca2,
                    0x17fbb8571a006596,
                ])),
                Felt::new(BigInteger384([
                    0x1804000000015554,
                    0x855000053ab00001,
                    0x633cb57c253c276f,
                    0x6e22d1ec31ebb502,
                    0xd3916126f2d14ca2,
                    0x17fbb8571a006596,
                ])),
                Felt::new(BigInteger384([
                    0x1804000000015554,
                    0x855000053ab00001,
                    0x633cb57c253c276f,
                    0x6e22d1ec31ebb502,
                    0xd3916126f2d14ca2,
                    0x17fbb8571a006596,
                ])),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
            ],
            [
                Felt::new(BigInteger384([
                    0xf64900000018553d,
                    0x40f4005f6f0c0013,
                    0x9313f019a789cfb3,
                    0x59fb77168f0da76b,
                    0x951d2d06cf6bb694,
                    0x15b1e4359a873e00,
                ])),
                Felt::new(BigInteger384([
                    0xf64900000018553d,
                    0x40f4005f6f0c0013,
                    0x9313f019a789cfb3,
                    0x59fb77168f0da76b,
                    0x951d2d06cf6bb694,
                    0x15b1e4359a873e00,
                ])),
                Felt::new(BigInteger384([
                    0xf64900000018553d,
                    0x40f4005f6f0c0013,
                    0x9313f019a789cfb3,
                    0x59fb77168f0da76b,
                    0x951d2d06cf6bb694,
                    0x15b1e4359a873e00,
                ])),
                Felt::new(BigInteger384([
                    0x321300000006554f,
                    0xb93c0018d6c40005,
                    0x57605e0db0ddbb51,
                    0x8b256521ed1f9bcb,
                    0x6cf28d7901622c03,
                    0x11ebab9dbb81e28c,
                ])),
                Felt::new(BigInteger384([
                    0x321300000006554f,
                    0xb93c0018d6c40005,
                    0x57605e0db0ddbb51,
                    0x8b256521ed1f9bcb,
                    0x6cf28d7901622c03,
                    0x11ebab9dbb81e28c,
                ])),
                Felt::new(BigInteger384([
                    0x321300000006554f,
                    0xb93c0018d6c40005,
                    0x57605e0db0ddbb51,
                    0x8b256521ed1f9bcb,
                    0x6cf28d7901622c03,
                    0x11ebab9dbb81e28c,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0x221a96dee879506e,
                    0xf474857d61fd8d8e,
                    0x0cb62c7142732926,
                    0xdab2c2b279e8e05a,
                    0x66bfd291dacd2598,
                    0x14a7b8b22c4d8158,
                ])),
                Felt::new(BigInteger384([
                    0x221a96dee879506e,
                    0xf474857d61fd8d8e,
                    0x0cb62c7142732926,
                    0xdab2c2b279e8e05a,
                    0x66bfd291dacd2598,
                    0x14a7b8b22c4d8158,
                ])),
                Felt::new(BigInteger384([
                    0x221a96dee879506e,
                    0xf474857d61fd8d8e,
                    0x0cb62c7142732926,
                    0xdab2c2b279e8e05a,
                    0x66bfd291dacd2598,
                    0x14a7b8b22c4d8158,
                ])),
                Felt::new(BigInteger384([
                    0x8501827008bb463c,
                    0xe000d5f0f9385e8d,
                    0x651c1aea973d56a5,
                    0xc16f501811680aeb,
                    0xbd0d7da3633e27ed,
                    0x100d54ca211c6624,
                ])),
                Felt::new(BigInteger384([
                    0x8501827008bb463c,
                    0xe000d5f0f9385e8d,
                    0x651c1aea973d56a5,
                    0xc16f501811680aeb,
                    0xbd0d7da3633e27ed,
                    0x100d54ca211c6624,
                ])),
                Felt::new(BigInteger384([
                    0x8501827008bb463c,
                    0xe000d5f0f9385e8d,
                    0x651c1aea973d56a5,
                    0xc16f501811680aeb,
                    0xbd0d7da3633e27ed,
                    0x100d54ca211c6624,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0x4c220000000b554a,
                    0xed28002c72d80009,
                    0x4b84069f3c7f4f33,
                    0xa827f857a8538294,
                    0x0653b9cb0ff30b64,
                    0x0bdb9ee45d035f82,
                ])),
                Felt::new(BigInteger384([
                    0x4c220000000b554a,
                    0xed28002c72d80009,
                    0x4b84069f3c7f4f33,
                    0xa827f857a8538294,
                    0x0653b9cb0ff30b64,
                    0x0bdb9ee45d035f82,
                ])),
                Felt::new(BigInteger384([
                    0x4c220000000b554a,
                    0xed28002c72d80009,
                    0x4b84069f3c7f4f33,
                    0xa827f857a8538294,
                    0x0653b9cb0ff30b64,
                    0x0bdb9ee45d035f82,
                ])),
                Felt::new(BigInteger384([
                    0x43f5fffffffcaaae,
                    0x32b7fff2ed47fffd,
                    0x07e83a49a2e99d69,
                    0xeca8f3318332bb7a,
                    0xef148d1ea0f4c069,
                    0x040ab3263eff0206,
                ])),
                Felt::new(BigInteger384([
                    0x43f5fffffffcaaae,
                    0x32b7fff2ed47fffd,
                    0x07e83a49a2e99d69,
                    0xeca8f3318332bb7a,
                    0xef148d1ea0f4c069,
                    0x040ab3263eff0206,
                ])),
                Felt::new(BigInteger384([
                    0x43f5fffffffcaaae,
                    0x32b7fff2ed47fffd,
                    0x07e83a49a2e99d69,
                    0xeca8f3318332bb7a,
                    0xef148d1ea0f4c069,
                    0x040ab3263eff0206,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0x0133ebe3fae693d3,
                    0xbdbfaaa58acd76c4,
                    0x90215d15854015f6,
                    0xb95d0e489d2afabe,
                    0x84c5d52786bcc459,
                    0x0a94c4354662febd,
                ])),
                Felt::new(BigInteger384([
                    0x8806c2121094a515,
                    0x8145798c3d41bb2e,
                    0xd3af6f27da460012,
                    0xf1278c767c2e297e,
                    0x0dae330e472a3f73,
                    0x0a338847fabd57ad,
                ])),
                Felt::new(BigInteger384([
                    0x4e2d38b895e70a0b,
                    0x3526014ca7e9d64c,
                    0x67b3f23732917bff,
                    0x7fbcaf79151a3c66,
                    0xbc7dae81c432fc9d,
                    0x07d9b35d09ba5e51,
                ])),
                Felt::new(BigInteger384([
                    0x7307f69cfa4771d1,
                    0xd831836ae0027002,
                    0xf45d263e10597b66,
                    0x4bc29b1de9953d5c,
                    0x70a08ea85c0dffcc,
                    0x16c941b574ffa0b8,
                ])),
                Felt::new(BigInteger384([
                    0x73971f56f47c58d7,
                    0xacc86d58b368ce5e,
                    0x2d2d5cb841867d6b,
                    0x25247d778e9f1966,
                    0x6f59d7c7c591e8d6,
                    0x101a4447c5288a0a,
                ])),
                Felt::new(BigInteger384([
                    0x18315037ae8b58ca,
                    0x94f06069dbf4726a,
                    0x4805306121a8b7df,
                    0x5bf29877824272f8,
                    0x079a8eccc23456a2,
                    0x10978cf31f8c257e,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0xb244bc2c91dae6b7,
                    0x9946ae9a6463abc3,
                    0x3531504a9c9f1c45,
                    0xbcdbba461a93cbd4,
                    0x83f0706c7b02d737,
                    0x140598f866dd8e7f,
                ])),
                Felt::new(BigInteger384([
                    0xf42768533c41b208,
                    0x9f5913a0f425432e,
                    0x748767d794229cec,
                    0xa4325a576ed4a2bf,
                    0xd22b4013529f13e4,
                    0x0c55d79fcc90af48,
                ])),
                Felt::new(BigInteger384([
                    0xc7a0a4143db1db5a,
                    0x7d8d7222b94b175f,
                    0x0e22cbfc72238f22,
                    0xc6cbcb8055b261f8,
                    0x6c47a5ecfd00f75d,
                    0x067ec4c3146449ad,
                ])),
                Felt::new(BigInteger384([
                    0x4911fd620b2ddf6e,
                    0xe939e76f0902d90f,
                    0xf5c065115625de90,
                    0xc43a731e5ee1a8a5,
                    0xacbe077138183dfd,
                    0x0c927bf6a3441e5f,
                ])),
                Felt::new(BigInteger384([
                    0xd55c15fbcb3b639a,
                    0x77b36d3aedfc5d26,
                    0xb38ffbb9d4c08aee,
                    0xfef3e85d221fa73d,
                    0x6d0f778c8ebac785,
                    0x1748103ba88f6ae3,
                ])),
                Felt::new(BigInteger384([
                    0x3c3053c1c86ca33f,
                    0xd95afea8292e4384,
                    0xc0fce93a3b2bead6,
                    0xe76192faeb16a446,
                    0x8103d13196d838a0,
                    0x0e0942dd447322f9,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0x2f580bdef8bbf83f,
                    0xa194e0c0aafda077,
                    0xcfd36eb984183f06,
                    0xf520791991d51009,
                    0xddd91f1a48d59773,
                    0x003fe31077deddc2,
                ])),
                Felt::new(BigInteger384([
                    0x81640c8aa9916873,
                    0x867c3ed29069aebf,
                    0x36b2f1113b2e2f01,
                    0xd8fbbccea7b98f63,
                    0x9cbbd1b896e1dd50,
                    0x134170d84647fc84,
                ])),
                Felt::new(BigInteger384([
                    0xa604232616362dd6,
                    0x582f23270da12eda,
                    0xe3f824787bec8690,
                    0x7ea00be3640e5b3d,
                    0x2443695126500060,
                    0x13188958b0547383,
                ])),
                Felt::new(BigInteger384([
                    0x86f201d72f64fa2e,
                    0x83b40c56c81b15a5,
                    0x0d8dc5c30ea3a0e9,
                    0xe4a5eb7bb12d1eca,
                    0xccea033e1567e9e2,
                    0x09c648e5861160b2,
                ])),
                Felt::new(BigInteger384([
                    0xc390bc46872e845a,
                    0xcb687c6032f55f1a,
                    0x954b61ecbda43666,
                    0x37c833e5eee005eb,
                    0xd42b63dcd5fc4363,
                    0x0d0c373533502c64,
                ])),
                Felt::new(BigInteger384([
                    0xd7ca057270871a2c,
                    0x2157b764e3a5a7a8,
                    0xa90551b840a0cbe9,
                    0xe43be53a1cfbc31a,
                    0x51694772ace68602,
                    0x07e78f33e1622dac,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0xfcb7fcf33ea164c9,
                    0xa37da2447edd6f10,
                    0x1a9ee6db344f95f4,
                    0x94ba03850bd350f8,
                    0xd6688b05d82305cd,
                    0x0f07cc5c37391e76,
                ])),
                Felt::new(BigInteger384([
                    0x3e33ffc52824c9c5,
                    0xba5a5af061984297,
                    0xb1fb083cbd5c6f5d,
                    0xc90beb9620978d4a,
                    0x45cdede5590b3231,
                    0x12cf47bc596c498b,
                ])),
                Felt::new(BigInteger384([
                    0xa4995a4894f331a1,
                    0x3840045a5de9e27b,
                    0x715201422c14540d,
                    0xf56ebf86cd15e70f,
                    0x0d85c8a959a73356,
                    0x0d06ba0619f3b172,
                ])),
                Felt::new(BigInteger384([
                    0xc046ea22aea07935,
                    0x732280ae4037059f,
                    0x29670e870e15df61,
                    0xe5837d3610f5c97e,
                    0x108e35fc14cf8080,
                    0x1664648b8685d82e,
                ])),
                Felt::new(BigInteger384([
                    0xb015292686507517,
                    0x810162ee7c84c8f2,
                    0x9f4e0c6f0e1f4b25,
                    0xf692b20a6fde5685,
                    0xe97285212c188cfa,
                    0x051dd9a881b7886a,
                ])),
                Felt::new(BigInteger384([
                    0x52dfe86c1a8a3ab2,
                    0x3e323e134e759030,
                    0x7495cd2aa24447af,
                    0xc5df2112ebe55db5,
                    0xc3224598be203298,
                    0x0165e64c109d2cc5,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0xd6d4586be458c7f9,
                    0xd3ec2c93ac3e18a4,
                    0xef0476482403ed66,
                    0x9fd823765ed0c584,
                    0x92e71e2c7f730167,
                    0x0928d7cb714e59b7,
                ])),
                Felt::new(BigInteger384([
                    0xe9278c8729e036be,
                    0xa9ee8c2dd2eb4b0e,
                    0xad511170602aa9ab,
                    0x88766329d538002c,
                    0x38a132a901b73526,
                    0x08220b268edfc085,
                ])),
                Felt::new(BigInteger384([
                    0xfc4b131d1c46f7d1,
                    0x4b60bc830e991b01,
                    0x861c4c591f5601e9,
                    0x7c2ec4bcd55ac1d7,
                    0x38b48b428668f051,
                    0x0f64f2c7f5df3994,
                ])),
                Felt::new(BigInteger384([
                    0x3c8c9def8ae9be76,
                    0x085e8fed06587e2a,
                    0x6aae6b5635ad87d7,
                    0x292aa25f8bfec407,
                    0xfeffd2631b1e8792,
                    0x1033b26112dffb9b,
                ])),
                Felt::new(BigInteger384([
                    0xb487ec7d558e07cf,
                    0xdcd8d1f518788ab2,
                    0xee376c7a3235e161,
                    0x328b5f2cdf6b275f,
                    0xf6790cdd9d04da07,
                    0x0a785585243c7c2e,
                ])),
                Felt::new(BigInteger384([
                    0x969567bba94d1a43,
                    0x5d97d91cb322befe,
                    0xe802ce7734de4a83,
                    0x38a78abfce69dcf5,
                    0xd397f1ed04fd6247,
                    0x15600b5611cea001,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0x2baa5141235603da,
                    0x2d9a6adace930537,
                    0x4eb989e64d3add7c,
                    0x4daa0e6c2c4f7785,
                    0x72c8334df37ccf7f,
                    0x1962d52872f833b4,
                ])),
                Felt::new(BigInteger384([
                    0x9daa9452dad1480e,
                    0xb8889a615912c137,
                    0x52c676b0c0764d54,
                    0x99a0022f2152ef16,
                    0xb2411c0d7ce3d66d,
                    0x15d6baed7cb267c6,
                ])),
                Felt::new(BigInteger384([
                    0x774664e0d42cac6b,
                    0xbe7a3f60f1a718dc,
                    0x5675fb33479466cd,
                    0x8f13c3babefff5b6,
                    0x3dc1b7cf47830e13,
                    0x046cf353bb4c9598,
                ])),
                Felt::new(BigInteger384([
                    0x7305e5080690a857,
                    0x60e4ce361052099c,
                    0x639a8e8ab903a05b,
                    0x49fc1561e10a415c,
                    0x212288ae2934f28f,
                    0x032a92f3447ff0c2,
                ])),
                Felt::new(BigInteger384([
                    0x368931ce06babf19,
                    0xe39e7c3bb177514c,
                    0x871e84331a23a20c,
                    0xd52af00929f3259c,
                    0xde54b93ccddcd64f,
                    0x048abd2a3dde99a2,
                ])),
                Felt::new(BigInteger384([
                    0x6e23eb50cba32407,
                    0xdb98c2ecb51a218a,
                    0x1a9bd733dbea2fa4,
                    0x6ebc6d0e425d505e,
                    0x953894db2013e783,
                    0x02905871d27f1761,
                ])),
            ],
        ];

        for i in input.iter_mut() {
            apply_sbox(i);
        }

        for (&i, o) in input.iter().zip(output) {
            assert_eq!(i, o);
        }
    }

    #[test]
    fn test_mds() {
        // Generated from https://github.com/Nashtare/anemoi-hash/
        let mut input = [
            [Felt::zero(); 6],
            [Felt::one(); 6],
            [
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
            ],
            [
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
            ],
            [
                Felt::new(BigInteger384([
                    0x2a19847ba37b60f4,
                    0xbffb84f6f263ca9f,
                    0x34cc215f12d16edf,
                    0x853273f61c8f2a7a,
                    0xf5839184816fdecb,
                    0x04894fc97320af88,
                ])),
                Felt::new(BigInteger384([
                    0x5ee59704580e77ed,
                    0xdb662d1ea9e203e0,
                    0x9e9825378342ecad,
                    0x664792b48f58c5da,
                    0x14cf3b313433a669,
                    0x0fc407a22ba325df,
                ])),
                Felt::new(BigInteger384([
                    0x47addddd1363c120,
                    0x83d2f80bf834e307,
                    0xcbdb08df5469b6fc,
                    0x2435636a997cebc9,
                    0xd5ca835ebb2ab8ed,
                    0x0e3ddfade4c18a0d,
                ])),
                Felt::new(BigInteger384([
                    0x734089a7f448e318,
                    0x96208d5b645d0f7d,
                    0xd489d99c1caac6b6,
                    0x79cc02997a6852fd,
                    0x0da59b516163c2b1,
                    0x042012841051ecf1,
                ])),
                Felt::new(BigInteger384([
                    0xd99c85b9a2ad59a1,
                    0x49c285c89229bd46,
                    0x52e583bb9f502c81,
                    0x0064a753e3622fb1,
                    0xe65243ec86cc9464,
                    0x0be3accdcab84cef,
                ])),
                Felt::new(BigInteger384([
                    0x43fac000cbc4d1d5,
                    0xa12c65587e73bee0,
                    0xf7b9d006fbf8e488,
                    0xe7ab9fe98221aa8b,
                    0x71be07b120f26ffb,
                    0x1658e263d49c479f,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0x5c84cd7293180103,
                    0xf2adf72d154b3047,
                    0xa01ec37aea1761b9,
                    0x6527756825b6ade5,
                    0x7e96f541f316179b,
                    0x081b4854fe2c9317,
                ])),
                Felt::new(BigInteger384([
                    0x2208be6a824a5095,
                    0x9f15cd57c6beeeff,
                    0x6b9d4ffca830feab,
                    0xc97d7e8e3738579e,
                    0x57b6d5aa13cb9223,
                    0x00dab81d7a2ef274,
                ])),
                Felt::new(BigInteger384([
                    0x36a9eee21a59c950,
                    0xbd96f5180dd958bc,
                    0xb5ae13b605ef245a,
                    0xde1c9b90f67895b5,
                    0x8b90d8c9661bee28,
                    0x1865cc5048a0ac5f,
                ])),
                Felt::new(BigInteger384([
                    0x72503e022aaf0484,
                    0xfbfc61e11d62ef73,
                    0xf0f642760a4d9c5a,
                    0x523217a63beff7ad,
                    0x71c36ef11d66e443,
                    0x0bc88a37711c88fd,
                ])),
                Felt::new(BigInteger384([
                    0xfbeda7c13ef6f7fb,
                    0x8108f0db97e5f8ee,
                    0x8864350a025e3631,
                    0xf64c8b7c5cc10f54,
                    0x7ac089536c184460,
                    0x017f052663536e46,
                ])),
                Felt::new(BigInteger384([
                    0xeae590679661ac37,
                    0x801b62cffcf76aff,
                    0xec0f2ad49abaea3c,
                    0xc220dd2389d9cf95,
                    0x35c8805ce94e49c5,
                    0x08e7d97123fc860b,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0xb818dadccc9950a9,
                    0xa2118b9f24fa8b9b,
                    0x14b26c41424d306f,
                    0xf01ec70543758a4b,
                    0x72492f511395ce48,
                    0x0b6709f7bde45bb0,
                ])),
                Felt::new(BigInteger384([
                    0x33efbc2b2d6a871b,
                    0xd4d578dfa9ac4f4d,
                    0x884f8015b42df2cf,
                    0xa9c026b9b28f6617,
                    0x02822568eeee1aa9,
                    0x1043bcc98e16d4a5,
                ])),
                Felt::new(BigInteger384([
                    0xb8c78477773db9ea,
                    0x222d8a78a8a7bc28,
                    0xef24a2cf660a3e40,
                    0x639f990f7142fd4c,
                    0xa2e86027cb35de48,
                    0x04ec6c85385e9ab4,
                ])),
                Felt::new(BigInteger384([
                    0x9bf70b43a1a1e254,
                    0x26b90645a3c2b459,
                    0xc545278c2c58c773,
                    0x6ffff5f5f385ef3d,
                    0xfe450e93da99647c,
                    0x0ce94fa475382414,
                ])),
                Felt::new(BigInteger384([
                    0x29a41cec7cbe4fe2,
                    0x39ff3fb17aefc4e1,
                    0xb3e50cd18ba84f70,
                    0x3567e09d8ae789be,
                    0xf762b3fade47397a,
                    0x135b03847c8d3988,
                ])),
                Felt::new(BigInteger384([
                    0xf8e7d2dac97938e3,
                    0xb653b26ad2f85d81,
                    0x4de6f82cae8b1e6b,
                    0x60e81bba7ff294a4,
                    0x16da72c5b70974c8,
                    0x0ea4c9ddc400e437,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0xccfa24fe0df6913a,
                    0xc053e01344d9d702,
                    0x94f5357bdcc2bbd0,
                    0x4ff228c1940264a5,
                    0x20bc77af1e97aa2c,
                    0x0d15086ba4b048b4,
                ])),
                Felt::new(BigInteger384([
                    0xd6afd2ce3655d628,
                    0x4d03229ee4b9864b,
                    0x0c74fd519bcff479,
                    0xd690ad1fc30f5002,
                    0xbae56a50bdb40159,
                    0x074bd2dd86f1d5cd,
                ])),
                Felt::new(BigInteger384([
                    0x852bea27a23c63eb,
                    0xae2732df4a84b3b0,
                    0xf0dcd04507ff9938,
                    0x21f343be78c71558,
                    0x7e1ceb22f2d9a56f,
                    0x174a1913ae64c5f0,
                ])),
                Felt::new(BigInteger384([
                    0x5cfd610d132c978b,
                    0x05a5cc131785e7dd,
                    0xe468458725fec699,
                    0x6b8574966ddc0d9f,
                    0xff21eb608a0863c1,
                    0x0c23389a4e1e5581,
                ])),
                Felt::new(BigInteger384([
                    0xf7f65d9b2923e12e,
                    0x83f4d5f853cc32f9,
                    0xf2eb85cb434dcd80,
                    0x0a7157cc23f2d496,
                    0x3239d6c144f35375,
                    0x12a203394514594e,
                ])),
                Felt::new(BigInteger384([
                    0x19644c9b42dfdf7b,
                    0x1541700b1c3d9b1f,
                    0xb4fd39369f58893f,
                    0x22ee83b8a4962a61,
                    0xe9ad8f5aeaa44c3a,
                    0x165081cdc2c0811f,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0xc1a0b78ee6fd44ce,
                    0x90cfd470167de3e9,
                    0xe7cca6a2a99bcab5,
                    0xe4073c93d3df55f4,
                    0x0dcd52e55f2502c5,
                    0x04cc241316b249f2,
                ])),
                Felt::new(BigInteger384([
                    0xc4a1cd8f7145bbf3,
                    0xa8ee7d39d4a07221,
                    0xc658a9419631f3e5,
                    0xbc7a2fd22b12c1e9,
                    0xe437074e6d752887,
                    0x16bd9a3beded7c18,
                ])),
                Felt::new(BigInteger384([
                    0xa27c6654ef2e17f8,
                    0xef8b1e463c8efaaa,
                    0xdc26aa07a90a0fa2,
                    0x66cacf2439642b29,
                    0x4ae5a344ce0c9612,
                    0x0db870356ffa56d4,
                ])),
                Felt::new(BigInteger384([
                    0xfbab37ad473a5315,
                    0xa4e138df09557172,
                    0xc3743c28cb1753c8,
                    0x3d7ecc3c3fa9a9ef,
                    0x1bb759222a7998a6,
                    0x0117ff8b9ad4278c,
                ])),
                Felt::new(BigInteger384([
                    0x3ebec0d69c46ce57,
                    0xccd843572595c75e,
                    0x44f381a021c2718f,
                    0x978bbda7a2153f16,
                    0x55b2f34e09defe33,
                    0x198c0d66f3055614,
                ])),
                Felt::new(BigInteger384([
                    0xd4c9afa03de3a76a,
                    0xf37fefbd81b08116,
                    0xb082ea46b4154cd0,
                    0x8a591a7c0eb54776,
                    0x5ce093dae18e7f74,
                    0x055af3a02775b6d4,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0x2b8b2d016b984cd9,
                    0x271313e5721262cb,
                    0x7af98c6830cc58bc,
                    0x388590e3d31c622e,
                    0x01e60ca7b9166fc5,
                    0x171e5aa91ba88f22,
                ])),
                Felt::new(BigInteger384([
                    0x688c1c7e790a174d,
                    0x8e53a0766925cbbc,
                    0x7c616f6fc5dce1cd,
                    0x8d6332b6fc8fdeb6,
                    0x48866be212f2adab,
                    0x0254f59eb6f10d1f,
                ])),
                Felt::new(BigInteger384([
                    0x7537eaa045a77fdc,
                    0x106c0afa44a7c4bb,
                    0x3fd861a8b00aeb01,
                    0xa493429884b9ecbd,
                    0x001cadf2bbcc9c42,
                    0x179e2690b6585ed4,
                ])),
                Felt::new(BigInteger384([
                    0xa42f996246653ea6,
                    0xc7ca30ec69f53c06,
                    0x29acc1d3910bc3a1,
                    0xc66111871875f628,
                    0x4840c9c4b80de23e,
                    0x00625159a29b530e,
                ])),
                Felt::new(BigInteger384([
                    0x6518592fa50a8a48,
                    0xe36a81834406f7b6,
                    0x63e0e5481174c118,
                    0xbb14afad89f5c5e7,
                    0xc3f39599dfdbdb25,
                    0x01ab6c0c7b098bb4,
                ])),
                Felt::new(BigInteger384([
                    0x2877ed1f08e14895,
                    0x97c3a93d71de9d4d,
                    0x63f30f3f61fa11e2,
                    0xa2c9657c10211bab,
                    0x6031d7fa9501939f,
                    0x0975fbbd63c9e75f,
                ])),
            ],
        ];

        let mut input2 = input;

        let output = [
            [Felt::zero(); 6],
            [
                Felt::new(BigInteger384([
                    0x984400000016aa94,
                    0xda500058e5b00012,
                    0x97080d3e78fe9e67,
                    0x504ff0af50a70528,
                    0x0ca773961fe616c9,
                    0x17b73dc8ba06bf04,
                ])),
                Felt::new(BigInteger384([
                    0xaa270000000cfff3,
                    0x53cc0032fc34000a,
                    0x478fe97a6b0a807f,
                    0xb1d37ebee6ba24d7,
                    0x8ec9733bbf78ab2f,
                    0x09d645513d83de7e,
                ])),
                Felt::new(BigInteger384([
                    0xaa270000000cfff3,
                    0x53cc0032fc34000a,
                    0x478fe97a6b0a807f,
                    0xb1d37ebee6ba24d7,
                    0x8ec9733bbf78ab2f,
                    0x09d645513d83de7e,
                ])),
                Felt::new(BigInteger384([
                    0x984400000016aa94,
                    0xda500058e5b00012,
                    0x97080d3e78fe9e67,
                    0x504ff0af50a70528,
                    0x0ca773961fe616c9,
                    0x17b73dc8ba06bf04,
                ])),
                Felt::new(BigInteger384([
                    0xaa270000000cfff3,
                    0x53cc0032fc34000a,
                    0x478fe97a6b0a807f,
                    0xb1d37ebee6ba24d7,
                    0x8ec9733bbf78ab2f,
                    0x09d645513d83de7e,
                ])),
                Felt::new(BigInteger384([
                    0xaa270000000cfff3,
                    0x53cc0032fc34000a,
                    0x478fe97a6b0a807f,
                    0xb1d37ebee6ba24d7,
                    0x8ec9733bbf78ab2f,
                    0x09d645513d83de7e,
                ])),
            ],
            [
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::new(BigInteger384([
                    0x984400000016aa94,
                    0xda500058e5b00012,
                    0x97080d3e78fe9e67,
                    0x504ff0af50a70528,
                    0x0ca773961fe616c9,
                    0x17b73dc8ba06bf04,
                ])),
                Felt::new(BigInteger384([
                    0xaa270000000cfff3,
                    0x53cc0032fc34000a,
                    0x478fe97a6b0a807f,
                    0xb1d37ebee6ba24d7,
                    0x8ec9733bbf78ab2f,
                    0x09d645513d83de7e,
                ])),
                Felt::new(BigInteger384([
                    0xaa270000000cfff3,
                    0x53cc0032fc34000a,
                    0x478fe97a6b0a807f,
                    0xb1d37ebee6ba24d7,
                    0x8ec9733bbf78ab2f,
                    0x09d645513d83de7e,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0x984400000016aa94,
                    0xda500058e5b00012,
                    0x97080d3e78fe9e67,
                    0x504ff0af50a70528,
                    0x0ca773961fe616c9,
                    0x17b73dc8ba06bf04,
                ])),
                Felt::new(BigInteger384([
                    0xaa270000000cfff3,
                    0x53cc0032fc34000a,
                    0x478fe97a6b0a807f,
                    0xb1d37ebee6ba24d7,
                    0x8ec9733bbf78ab2f,
                    0x09d645513d83de7e,
                ])),
                Felt::new(BigInteger384([
                    0xaa270000000cfff3,
                    0x53cc0032fc34000a,
                    0x478fe97a6b0a807f,
                    0xb1d37ebee6ba24d7,
                    0x8ec9733bbf78ab2f,
                    0x09d645513d83de7e,
                ])),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
            ],
            [
                Felt::new(BigInteger384([
                    0x403dbe0e7cac88d3,
                    0x6979a42a07040cd4,
                    0xd22bfeb0cb9271fa,
                    0x999081ccca72e327,
                    0xe0822a6e636c13e4,
                    0x14177233c04a056e,
                ])),
                Felt::new(BigInteger384([
                    0x5e5bd73a2251b076,
                    0x845ba22edb5b948e,
                    0x03e985b44836d362,
                    0xcf6d81faeb5cb529,
                    0x6acc2bbce8ad4a37,
                    0x16c804dd2ec702e9,
                ])),
                Felt::new(BigInteger384([
                    0x40c77dd8b269504a,
                    0xc0842f19d58a7c26,
                    0x6cda9e34069e8b45,
                    0x306a92866e6ef3d9,
                    0x8a8539e2aef27016,
                    0x0d1374f8bd262864,
                ])),
                Felt::new(BigInteger384([
                    0xb693ee2590a832aa,
                    0x037d9ec6ff60252d,
                    0x9fa642cc4287d1e8,
                    0x8d4f06a7b4770d1a,
                    0xb76e55fe52ec1b8d,
                    0x1261fc84f2bb280d,
                ])),
                Felt::new(BigInteger384([
                    0x4a19590a570446fb,
                    0xf88405d928039b22,
                    0x8c823459ddeda852,
                    0x773100eb66cf6d79,
                    0x283fda8a273adceb,
                    0x107ba24f867887d7,
                ])),
                Felt::new(BigInteger384([
                    0xb075551c0568bd84,
                    0xac25fe4655d048eb,
                    0x0addde7960930e1d,
                    0xfdc9a5a5cfc94a2d,
                    0x00ec83254ca3ae9d,
                    0x183f3c9940dee7d6,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0xad97f3688aa0af8d,
                    0x53e0922b1c308a0a,
                    0x37715dac9431ae7d,
                    0x65e3ceeab136ea32,
                    0x94db48a9557e9cea,
                    0x145ac04ea216fd0a,
                ])),
                Felt::new(BigInteger384([
                    0x77e369a14a168ee2,
                    0xcf99aeb79514d0bf,
                    0xa8b695a1b0c4bcd2,
                    0x21ef940e62d60b70,
                    0x57382d124c822c62,
                    0x05bf753e969d1116,
                ])),
                Felt::new(BigInteger384([
                    0x57bd4831c2d47140,
                    0x235cb0cb4ddaa84a,
                    0xfa5818078b9df056,
                    0x0d71b96a8599365f,
                    0x9559f1411cc802ac,
                    0x0f76032d85a8de68,
                ])),
                Felt::new(BigInteger384([
                    0x7ba041b1d353f709,
                    0xd87f5b076b7e2427,
                    0xf0edbeb3ca0d6bbd,
                    0x37257b066067d1dd,
                    0xb038c174428016db,
                    0x16bd75a067cc853c,
                ])),
                Felt::new(BigInteger384([
                    0x1174b42d2ab7028f,
                    0xda71176f1e4f42d6,
                    0xef2f1229bb0362ff,
                    0xf85a4c676af5bb86,
                    0x48f43fdc4ce8a9d5,
                    0x07f6e11c30091fb2,
                ])),
                Felt::new(BigInteger384([
                    0x55111dec3efea0b1,
                    0x7e29a6684a264c51,
                    0xedcdd75ea9c4f2fa,
                    0x00ec0bc27f4be5ec,
                    0x9d0d01f4dee5b6cb,
                    0x17ae6df55bbfeb95,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0x1292da27f8f0517e,
                    0xe43abb29afeb269b,
                    0xc5730805bfd25296,
                    0xdc0cafede9aed760,
                    0xabdf846704b9c6ae,
                    0x0d3bfc6bfddfea9f,
                ])),
                Felt::new(BigInteger384([
                    0xa3989ff6e87fa0ed,
                    0x9c9619716ea2533a,
                    0x141a5f54cbdea99b,
                    0xfca6d458e505d83d,
                    0x6f806d5355a3f8ab,
                    0x0b828de183387f24,
                ])),
                Felt::new(BigInteger384([
                    0xa2e9f65c3ddb37ac,
                    0x1c7a1a97eaf522ad,
                    0x39a828c6a8219bcb,
                    0x8926024eb738653b,
                    0x3ee13c7c9e03e8ac,
                    0x11fd2b5408be4020,
                ])),
                Felt::new(BigInteger384([
                    0x61bd4b6b249b24d9,
                    0x5dcc845569bfc933,
                    0x1ca24ac1fbca8a85,
                    0xbf4271612d26b49c,
                    0xcb631b98d47c9b4e,
                    0x076d7bafb35162a7,
                ])),
                Felt::new(BigInteger384([
                    0xe67c064e897bf817,
                    0x006cfeaa32c58b16,
                    0xbdf4aed4a583107a,
                    0xad61513a0adbd75f,
                    0x748ff47bc3ec1d8c,
                    0x07d048d6b7fe98b5,
                ])),
                Felt::new(BigInteger384([
                    0x742917f7649865a5,
                    0x13b3381609f29b9e,
                    0xac94941a04d29877,
                    0x72c93be1a23d71e0,
                    0x6dad99e2c799f28a,
                    0x0e41fcb6bf53ae29,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0xe526003f46f00aeb,
                    0x1dc45b7bcd852666,
                    0x0127c4106f531b05,
                    0x9a63c48c1b577300,
                    0x6b02f3ede4d93cce,
                    0x0c64efb29a316752,
                ])),
                Felt::new(BigInteger384([
                    0x3a03cc1b88c5d9e2,
                    0x2c4d68735bf4c4b0,
                    0xb4c22e159b2ff673,
                    0xa17ac6546195b9da,
                    0x41a468d93b679cb5,
                    0x0ef2e99c156bdd2e,
                ])),
                Felt::new(BigInteger384([
                    0x81d206f1f4800731,
                    0x3e7a15a75649e802,
                    0x58da934c6ff3190b,
                    0xcf79ab577cd10927,
                    0xe443f5656725a172,
                    0x04bdd8f40bb75ff1,
                ])),
                Felt::new(BigInteger384([
                    0x30438893f7d29efa,
                    0x3761563298e3eba6,
                    0x9e3550aa007a6cfb,
                    0xf2f5bacc8bee8608,
                    0x515236e74a68be7f,
                    0x0a9bed9f9658f327,
                ])),
                Felt::new(BigInteger384([
                    0x57576c50925d9a69,
                    0x6729de2c3c6d9dd4,
                    0xa257a4ce4141f7a9,
                    0x3b7c2da7bd36f4b9,
                    0x83f3ed70bd110d83,
                    0x0d36d2673111b83d,
                ])),
                Felt::new(BigInteger384([
                    0xf25068dea854e40c,
                    0xe578e81178b3e8f0,
                    0xb0dae5125e90fe90,
                    0xda6810dd734dbbb0,
                    0xb70bd8d177fbfd36,
                    0x13b59d062807bc09,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0xc2fc273af3c8d244,
                    0xcdfb5560b9cb0ddf,
                    0xdca0235daa10a082,
                    0x6f8a706b784e0d07,
                    0x0cfcf2aa2b26ec8a,
                    0x00482156d573aa9d,
                ])),
                Felt::new(BigInteger384([
                    0x573d51c8369fdb5b,
                    0xdb7c8e3901944b61,
                    0x9810feb1a47ff198,
                    0xa52873a48ab048b3,
                    0xf1985150e21bfdc3,
                    0x02f87ae57194a67e,
                ])),
                Felt::new(BigInteger384([
                    0x3060a3022e6eb2dc,
                    0x9b6d44618cd734a0,
                    0x0ae7cded9bc2a2cf,
                    0x86dc2c9918b0863e,
                    0xff9ba8a7b680174e,
                    0x140d40ad51cc8036,
                ])),
                Felt::new(BigInteger384([
                    0x560a992be8680bad,
                    0xeca86463fa762b8b,
                    0x9427abbe968fba6d,
                    0xdc12d598d962ca4a,
                    0xcfcc8208b4b53d7b,
                    0x0743e4b924827be6,
                ])),
                Felt::new(BigInteger384([
                    0x50dfdfd1689f7140,
                    0xeb6ea4d4089d2b5b,
                    0x152e119775556fcd,
                    0x386b25173c98c7ad,
                    0x9ee691b6fd15021d,
                    0x0715ee3416a37566,
                ])),
                Felt::new(BigInteger384([
                    0xd9f468fabdac41d7,
                    0xf4b9af4d73898146,
                    0x2f7c846dd54f9770,
                    0x2e00cafdab7f4a14,
                    0x8dc6842c992ebad3,
                    0x0588ea253554bd54,
                ])),
            ],
            [
                Felt::new(BigInteger384([
                    0xa8da63638ccb2815,
                    0x9b74fd1c16b04251,
                    0xa8e31c7d96edde50,
                    0x2e59339342796dbc,
                    0xd70455222121718e,
                    0x0c851fb90d7455fd,
                ])),
                Felt::new(BigInteger384([
                    0x0a891ec06ff20e88,
                    0x98e6ca5301dfb7ff,
                    0xa8aa19e7695d2443,
                    0x4620b1c1f215f4e0,
                    0xb46e8502bd0afc47,
                    0x14ad7994cc4a8cb4,
                ])),
                Felt::new(BigInteger384([
                    0xc0dc612195e2db85,
                    0xaf8dd33e2f4a560e,
                    0xe3cb44a6ea1e91fe,
                    0xda13000d40786a51,
                    0xb637e3b7ba54cfc9,
                    0x142dadad319abd02,
                ])),
                Felt::new(BigInteger384([
                    0x444fc4d4cb30a35f,
                    0x9961c08c7bd33884,
                    0x0c9c0492497ba012,
                    0x272aa919f7644fda,
                    0x84cef6165cbecbcd,
                    0x0f9f33efbcb883a8,
                ])),
                Felt::new(BigInteger384([
                    0xd5ef79133ab65029,
                    0x0ac28c9989d00d10,
                    0x1b2d782e95865a3f,
                    0xeaa03837cb02cde3,
                    0xb4a7011de4f93342,
                    0x0be60a7d240a1930,
                ])),
                Felt::new(BigInteger384([
                    0x96d838e0995b9bcb,
                    0x2662dd3063e1c8c0,
                    0x55619ba315ef57b6,
                    0xdf53d65e3c829da2,
                    0x3059ccf30cc72c29,
                    0x0d2f252ffc7851d7,
                ])),
            ],
        ];

        for i in input.iter_mut() {
            apply_mds(i);
        }
        for i in input2.iter_mut() {
            apply_naive_mds(i);
        }

        for (index, (&i_1, i_2)) in input.iter().zip(input2).enumerate() {
            assert_eq!(output[index], i_1);
            assert_eq!(output[index], i_2);
        }
    }
}
