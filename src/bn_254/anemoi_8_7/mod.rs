//! Implementation of the Anemoi permutation

use super::{mul_by_generator, sbox, BigInteger256, Felt};
use crate::{Jive, Sponge};
use ark_ff::{Field, One, Zero};
use unroll::unroll_for_loops;

/// Digest for Anemoi
mod digest;
/// Sponge for Anemoi
mod hasher;
/// MDS matrix for Anemoi
mod mds;
/// Round constants for Anemoi
mod round_constants;

pub use digest::AnemoiDigest;
pub use hasher::AnemoiHash;

// ANEMOI CONSTANTS
// ================================================================================================

/// Function state is set to 8 field elements or 256 bytes.
/// 1 element of the state is reserved for capacity.
pub const STATE_WIDTH: usize = 8;
/// 7 elements of the state are reserved for rate.
pub const RATE_WIDTH: usize = 7;

/// The state is divided into two even-length rows.
pub const NUM_COLUMNS: usize = 4;

/// 1 element (32-bytes) is returned as digest.
pub const DIGEST_SIZE: usize = 1;

/// The number of rounds is set to 10 to provide 128-bit security level.
pub const NUM_HASH_ROUNDS: usize = 10;

// HELPER FUNCTIONS
// ================================================================================================

#[inline(always)]
/// Applies exponentiation of the current hash
/// state elements with the Anemoi S-Box.
pub(crate) fn apply_sbox(state: &mut [Felt; STATE_WIDTH]) {
    let mut x: [Felt; NUM_COLUMNS] = state[..NUM_COLUMNS].try_into().unwrap();
    let mut y: [Felt; NUM_COLUMNS] = state[NUM_COLUMNS..].try_into().unwrap();

    x.iter_mut().enumerate().for_each(|(i, t)| {
        let y2 = y[i].square();
        *t -= mul_by_generator(&y2);
    });

    let mut x_alpha_inv = x;
    x_alpha_inv
        .iter_mut()
        .for_each(|t| *t = sbox::exp_inv_alpha(t));

    y.iter_mut()
        .enumerate()
        .for_each(|(i, t)| *t -= x_alpha_inv[i]);

    x.iter_mut().enumerate().for_each(|(i, t)| {
        let y2 = y[i].square();
        *t += mul_by_generator(&y2) + sbox::DELTA;
    });

    state[..NUM_COLUMNS].copy_from_slice(&x);
    state[NUM_COLUMNS..].copy_from_slice(&y);
}

#[inline(always)]
/// Applies matrix-vector multiplication of the current
/// hash state with the Anemoi MDS matrix.
pub(crate) fn apply_mds(state: &mut [Felt; STATE_WIDTH]) {
    apply_mds_internal(&mut state[..NUM_COLUMNS]);
    state[NUM_COLUMNS..].rotate_left(1);
    apply_mds_internal(&mut state[NUM_COLUMNS..]);
}

#[inline(always)]
fn apply_mds_internal(state: &mut [Felt]) {
    state[0] += state[1];
    state[2] += state[3];
    state[3] += mul_by_generator(&state[0]);
    state[1] = mul_by_generator(&(state[1] + state[2]));
    state[0] += state[1];
    state[2] += mul_by_generator(&state[3]);
    state[1] += state[2];
    state[3] += state[0];
}

// ANEMOI PERMUTATION
// ================================================================================================

/// Applies an Anemoi permutation to the provided state
#[inline(always)]
#[unroll_for_loops]
pub(crate) fn apply_permutation(state: &mut [Felt; STATE_WIDTH]) {
    for i in 0..NUM_HASH_ROUNDS {
        apply_round(state, i);
    }

    apply_mds(state)
}

/// Applies an Anemoi round to the provided state
#[inline(always)]
#[unroll_for_loops]
pub(crate) fn apply_round(state: &mut [Felt; STATE_WIDTH], step: usize) {
    // determine which round constants to use
    let c = &round_constants::C[step % NUM_HASH_ROUNDS];
    let d = &round_constants::D[step % NUM_HASH_ROUNDS];

    for i in 0..NUM_COLUMNS {
        state[i] += c[i];
        state[NUM_COLUMNS + i] += d[i];
    }

    apply_mds(state);
    apply_sbox(state);
}

#[cfg(test)]
mod tests {
    use super::*;

    fn apply_naive_mds(state: &mut [Felt; STATE_WIDTH]) {
        let x: [Felt; NUM_COLUMNS] = state[..NUM_COLUMNS].try_into().unwrap();
        let mut y: [Felt; NUM_COLUMNS] = [Felt::zero(); NUM_COLUMNS];
        y[0..NUM_COLUMNS - 1].copy_from_slice(&state[NUM_COLUMNS + 1..]);
        y[NUM_COLUMNS - 1] = state[NUM_COLUMNS];

        let mut result = [Felt::zero(); STATE_WIDTH];
        for (i, r) in result.iter_mut().enumerate().take(NUM_COLUMNS) {
            for (j, s) in x.into_iter().enumerate().take(NUM_COLUMNS) {
                *r += s * mds::MDS[i * NUM_COLUMNS + j];
            }
        }
        for (i, r) in result.iter_mut().enumerate().skip(NUM_COLUMNS) {
            for (j, s) in y.into_iter().enumerate() {
                *r += s * mds::MDS[(i - NUM_COLUMNS) * NUM_COLUMNS + j];
            }
        }

        state.copy_from_slice(&result);
    }

    #[test]
    fn test_sbox() {
        // Generated from https://github.com/vesselinux/anemoi-hash/
        let mut input = [
            [Felt::zero(); 8],
            [Felt::one(); 8],
            [
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
            ],
            [
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
            ],
            [
                Felt::new(BigInteger256([
                    0xc38d9831b5eeb362,
                    0xf28287b5d87903cb,
                    0x77122e1fe1932210,
                    0x10c0327efec2d4f2,
                ])),
                Felt::new(BigInteger256([
                    0xc92786ef36401706,
                    0x8a20ae63b18a9722,
                    0xa46e3aa52866746b,
                    0x171f04f750b92aa6,
                ])),
                Felt::new(BigInteger256([
                    0x2d312b9e86f6bae5,
                    0x3a9e35f9614de537,
                    0x128115a30ce0c590,
                    0x1be3a7d280b37f1f,
                ])),
                Felt::new(BigInteger256([
                    0xd92d3e1aed9658ff,
                    0x9964b78be5fae7f1,
                    0xa394d8a524c600d6,
                    0x27960dc4807ecb2d,
                ])),
                Felt::new(BigInteger256([
                    0x88f3041bebe1fa74,
                    0x12b8bbbfbb0d3763,
                    0x520756c78f2defe4,
                    0x2bb7b22ad62d6a5e,
                ])),
                Felt::new(BigInteger256([
                    0x1b0f7700f726dccd,
                    0x494fd0f88e76d7eb,
                    0xb5d482ef66239d2d,
                    0x26448d6cc5892362,
                ])),
                Felt::new(BigInteger256([
                    0xc8fc6075a579d3b4,
                    0x85b62e39af8496c9,
                    0x234d2e6d1eb1069f,
                    0x0589074fe43e93af,
                ])),
                Felt::new(BigInteger256([
                    0xf0376e38ca159db2,
                    0x04bd2d2c5e772bc5,
                    0x594d3e4d73d0a728,
                    0x11e688e51cfa90ab,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x683f1c2eed3e07cf,
                    0xd90b6126e8c30b86,
                    0xccd4909e4153c0d7,
                    0x06129889fd7e072b,
                ])),
                Felt::new(BigInteger256([
                    0x4bed6fcdfb669a95,
                    0x49e54b190087de07,
                    0x30df47a280a6928d,
                    0x226610b553f0267b,
                ])),
                Felt::new(BigInteger256([
                    0x228fbbe669c86fb3,
                    0xa15efec84b623e81,
                    0x13a65b4016040532,
                    0x0962f47d40b6fbc2,
                ])),
                Felt::new(BigInteger256([
                    0x688574dd58beef29,
                    0x70c21dad35fabb76,
                    0xf8d3846d9bde6b82,
                    0x08a47c417740e154,
                ])),
                Felt::new(BigInteger256([
                    0x7a32e4e689c3e705,
                    0x3c7bd29abf39cdd2,
                    0x6f6e6268ffbe4698,
                    0x21149997c027ffda,
                ])),
                Felt::new(BigInteger256([
                    0xa0c2e88678c6da4b,
                    0xbaba2c0f8089f2aa,
                    0xc025b491c9323f13,
                    0x03ae67e7de3d4421,
                ])),
                Felt::new(BigInteger256([
                    0x9892bdf8973ab717,
                    0xaf4c74ef127aa9ac,
                    0x7f598725c70f17d4,
                    0x2b7b47082c400627,
                ])),
                Felt::new(BigInteger256([
                    0x6d490a670bc35538,
                    0xfcfed09671ef9bcd,
                    0xd56582e7ea069ad5,
                    0x149b1e06921daa16,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xb06ffc19bbba9175,
                    0x99b30ad67973350c,
                    0xedce21ee38c781db,
                    0x0df1061dd7b13323,
                ])),
                Felt::new(BigInteger256([
                    0x32204270adba3c2c,
                    0x0aa7df189e472aeb,
                    0x310973fa13943b5c,
                    0x0df3c9a35443e651,
                ])),
                Felt::new(BigInteger256([
                    0x09dc52918faf3a21,
                    0x2c6eb8a9ba623290,
                    0xe157ac1c45378cb2,
                    0x14d066f7927e131c,
                ])),
                Felt::new(BigInteger256([
                    0x324c6fd059b4e731,
                    0x0d19e030ab2f95af,
                    0x10bf5c06feb63544,
                    0x1374a4e73800853e,
                ])),
                Felt::new(BigInteger256([
                    0x90083a2ccf594917,
                    0x36fbd47dcdbf2f2a,
                    0xe69cfb8cd265a0ca,
                    0x036b972e43613d96,
                ])),
                Felt::new(BigInteger256([
                    0xb739c2c0b0d4046e,
                    0xa444ddf8e161d502,
                    0xfe36b44d1c742c9f,
                    0x2bb419b32dff978a,
                ])),
                Felt::new(BigInteger256([
                    0x48b20d459d0fffe8,
                    0xcf722170c5659dd3,
                    0x3114721760577450,
                    0x2e445b29fbb1f913,
                ])),
                Felt::new(BigInteger256([
                    0x7cebe444a9759bcb,
                    0xea5efeefdba4df64,
                    0xfb2d34da42680456,
                    0x13c257d02dc67042,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xab2b529ae17a5387,
                    0xab660015b450093a,
                    0xd3037b219ac7b884,
                    0x0e00505ae9f495cd,
                ])),
                Felt::new(BigInteger256([
                    0xcd913917b51d0883,
                    0x9ee007dfb3294bed,
                    0x01a97f52ea00ceeb,
                    0x02ff163da57cbab5,
                ])),
                Felt::new(BigInteger256([
                    0xfe9d856e5f70172b,
                    0x9463eaa0f670a8a8,
                    0xd97708a70b37fed0,
                    0x0fcc1b424b8665cb,
                ])),
                Felt::new(BigInteger256([
                    0xb8f8da2a94fec87f,
                    0x540bda039ce5ecb5,
                    0xd40640a7b3a1b538,
                    0x18bb00781cdbb578,
                ])),
                Felt::new(BigInteger256([
                    0x6a116a8f68e0efcc,
                    0xb3ed6b3954d1986f,
                    0xdbc108c49e543c5e,
                    0x032f5d08e39452e4,
                ])),
                Felt::new(BigInteger256([
                    0x29c227e3c77e5860,
                    0x46aa75bc5271b948,
                    0x61bbab35d80a76b0,
                    0x00d22ce56e117d5a,
                ])),
                Felt::new(BigInteger256([
                    0xa3b8181fe099eae5,
                    0xb05ca4cf12e44f34,
                    0xdca44eb3c721714a,
                    0x0eb7874594b7d1a0,
                ])),
                Felt::new(BigInteger256([
                    0x106b0b8be7d19475,
                    0x88e14a3bd4e1ee0c,
                    0xcdb7d43cffbce290,
                    0x13981d6fc2370621,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xe167c40dff42f062,
                    0xd6750fb310ac1cd6,
                    0x1ee52cc6d0d5761a,
                    0x29813e4eb2831310,
                ])),
                Felt::new(BigInteger256([
                    0x5b97a27655e20a6f,
                    0x0252bae80d5a8ec1,
                    0x432bc2ce925f71f2,
                    0x11b15d3fe1ab8a2a,
                ])),
                Felt::new(BigInteger256([
                    0xf3ad8fb20d966eaf,
                    0x51e37bf8ce6f6bb7,
                    0x704966def7ef76fb,
                    0x2d1e7ed3e9158201,
                ])),
                Felt::new(BigInteger256([
                    0xd04298ba2ebb3dec,
                    0x5249ac27a2994c4f,
                    0xef2b62c63ed34fa4,
                    0x1c4b7380fae47a20,
                ])),
                Felt::new(BigInteger256([
                    0x543bc68baf3b7bf5,
                    0x5383ec0f0706d87c,
                    0x3683d43567d9f1c3,
                    0x0c088948f81b577c,
                ])),
                Felt::new(BigInteger256([
                    0x925966a1d9ec5892,
                    0x295b860e4eb39395,
                    0x0d4fd44e656835ad,
                    0x2ebb8e2fe4374d48,
                ])),
                Felt::new(BigInteger256([
                    0xc5ca2f075cc4bf58,
                    0x24cd79d1ee918c4e,
                    0x992dee0b8ba6db96,
                    0x2e5c6ffe7f02c084,
                ])),
                Felt::new(BigInteger256([
                    0xcd7166346f7956a5,
                    0xb81a5f7812f09896,
                    0x65ded0c123b59809,
                    0x29a4afc594a44512,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xaab8e35021a31409,
                    0x18778898e281aa82,
                    0xb7612d981b207dc7,
                    0x2ced508d522589c8,
                ])),
                Felt::new(BigInteger256([
                    0xf1dad144a023a459,
                    0xf2a8b5d86ac61014,
                    0x4a77a29934078a02,
                    0x241f2adb434735b6,
                ])),
                Felt::new(BigInteger256([
                    0x4bea7516be848c0d,
                    0x095febb177e180f5,
                    0xffb6cea9ecff4d5d,
                    0x29aed9b370c3b0d4,
                ])),
                Felt::new(BigInteger256([
                    0xef292d09fdb8be98,
                    0x9e2540682bfbd69b,
                    0xba871da2d150b240,
                    0x06b13affb24db92a,
                ])),
                Felt::new(BigInteger256([
                    0x30e5adcc28f75a5a,
                    0x7cefad37caddc29c,
                    0x86a593f676f96cce,
                    0x27f2d850457ddb0a,
                ])),
                Felt::new(BigInteger256([
                    0x08ecfd5c3d78bb26,
                    0xa95d0d2712c82c49,
                    0xf424d70db1585b7a,
                    0x19555b8a7fca25e8,
                ])),
                Felt::new(BigInteger256([
                    0x873c9d2ce3268aed,
                    0x9158c8d1b38d9c9a,
                    0x9a119005caa1d49c,
                    0x2835053d46191da1,
                ])),
                Felt::new(BigInteger256([
                    0xd80feca69819bad5,
                    0x7e9f4d3a7fc89767,
                    0xa59eed3796803246,
                    0x2beb14ba08220588,
                ])),
            ],
        ];

        let output = [
            [
                Felt::new(BigInteger256([
                    0xafd49a8c34aeae4c,
                    0xe0a8c73e1f684743,
                    0xb4ea4db753538a2d,
                    0x14cf9766d3bdd51d,
                ])),
                Felt::new(BigInteger256([
                    0xafd49a8c34aeae4c,
                    0xe0a8c73e1f684743,
                    0xb4ea4db753538a2d,
                    0x14cf9766d3bdd51d,
                ])),
                Felt::new(BigInteger256([
                    0xafd49a8c34aeae4c,
                    0xe0a8c73e1f684743,
                    0xb4ea4db753538a2d,
                    0x14cf9766d3bdd51d,
                ])),
                Felt::new(BigInteger256([
                    0xafd49a8c34aeae4c,
                    0xe0a8c73e1f684743,
                    0xb4ea4db753538a2d,
                    0x14cf9766d3bdd51d,
                ])),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
            ],
            [
                Felt::new(BigInteger256([
                    0xbebb490c2e6f962f,
                    0x465ac2ad04e364b4,
                    0xff4b8beb7ecbd2f7,
                    0x1daa245477c958e5,
                ])),
                Felt::new(BigInteger256([
                    0xbebb490c2e6f962f,
                    0x465ac2ad04e364b4,
                    0xff4b8beb7ecbd2f7,
                    0x1daa245477c958e5,
                ])),
                Felt::new(BigInteger256([
                    0xbebb490c2e6f962f,
                    0x465ac2ad04e364b4,
                    0xff4b8beb7ecbd2f7,
                    0x1daa245477c958e5,
                ])),
                Felt::new(BigInteger256([
                    0xbebb490c2e6f962f,
                    0x465ac2ad04e364b4,
                    0xff4b8beb7ecbd2f7,
                    0x1daa245477c958e5,
                ])),
                Felt::new(BigInteger256([
                    0xe07a0c33042f6fc0,
                    0xfbc9e1489023576a,
                    0xd40daa7093c5a810,
                    0x01eb281368a433ca,
                ])),
                Felt::new(BigInteger256([
                    0xe07a0c33042f6fc0,
                    0xfbc9e1489023576a,
                    0xd40daa7093c5a810,
                    0x01eb281368a433ca,
                ])),
                Felt::new(BigInteger256([
                    0xe07a0c33042f6fc0,
                    0xfbc9e1489023576a,
                    0xd40daa7093c5a810,
                    0x01eb281368a433ca,
                ])),
                Felt::new(BigInteger256([
                    0xe07a0c33042f6fc0,
                    0xfbc9e1489023576a,
                    0xd40daa7093c5a810,
                    0x01eb281368a433ca,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x9221c13bf351088f,
                    0x7ba14974192568d6,
                    0x764d83e12590a30c,
                    0x1efdfa43167d3d99,
                ])),
                Felt::new(BigInteger256([
                    0x9221c13bf351088f,
                    0x7ba14974192568d6,
                    0x764d83e12590a30c,
                    0x1efdfa43167d3d99,
                ])),
                Felt::new(BigInteger256([
                    0x9221c13bf351088f,
                    0x7ba14974192568d6,
                    0x764d83e12590a30c,
                    0x1efdfa43167d3d99,
                ])),
                Felt::new(BigInteger256([
                    0x9221c13bf351088f,
                    0x7ba14974192568d6,
                    0x764d83e12590a30c,
                    0x1efdfa43167d3d99,
                ])),
                Felt::new(BigInteger256([
                    0xa8fad3571dcabf05,
                    0x20a54df8cdb610bd,
                    0xb562a9b2221bf6a7,
                    0x113c1d95ad2f3ee3,
                ])),
                Felt::new(BigInteger256([
                    0xa8fad3571dcabf05,
                    0x20a54df8cdb610bd,
                    0xb562a9b2221bf6a7,
                    0x113c1d95ad2f3ee3,
                ])),
                Felt::new(BigInteger256([
                    0xa8fad3571dcabf05,
                    0x20a54df8cdb610bd,
                    0xb562a9b2221bf6a7,
                    0x113c1d95ad2f3ee3,
                ])),
                Felt::new(BigInteger256([
                    0xa8fad3571dcabf05,
                    0x20a54df8cdb610bd,
                    0xb562a9b2221bf6a7,
                    0x113c1d95ad2f3ee3,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xc1291cac726de779,
                    0x730b09508e12a9ad,
                    0x965495beb3b74a80,
                    0x1c9527fa5aabb1b1,
                ])),
                Felt::new(BigInteger256([
                    0xc1291cac726de779,
                    0x730b09508e12a9ad,
                    0x965495beb3b74a80,
                    0x1c9527fa5aabb1b1,
                ])),
                Felt::new(BigInteger256([
                    0xc1291cac726de779,
                    0x730b09508e12a9ad,
                    0x965495beb3b74a80,
                    0x1c9527fa5aabb1b1,
                ])),
                Felt::new(BigInteger256([
                    0xc1291cac726de779,
                    0x730b09508e12a9ad,
                    0x965495beb3b74a80,
                    0x1c9527fa5aabb1b1,
                ])),
                Felt::new(BigInteger256([
                    0x68c3488912edefaa,
                    0x8d087f6872aabf4f,
                    0x51e1a24709081231,
                    0x2259d6b14729c0fa,
                ])),
                Felt::new(BigInteger256([
                    0x68c3488912edefaa,
                    0x8d087f6872aabf4f,
                    0x51e1a24709081231,
                    0x2259d6b14729c0fa,
                ])),
                Felt::new(BigInteger256([
                    0x68c3488912edefaa,
                    0x8d087f6872aabf4f,
                    0x51e1a24709081231,
                    0x2259d6b14729c0fa,
                ])),
                Felt::new(BigInteger256([
                    0x68c3488912edefaa,
                    0x8d087f6872aabf4f,
                    0x51e1a24709081231,
                    0x2259d6b14729c0fa,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x9831e4e6b30bc309,
                    0x7fcdae2c35190e8e,
                    0xb8407cfea1f419a6,
                    0x2d7b410d62fb3875,
                ])),
                Felt::new(BigInteger256([
                    0xc611b43d34ef2cc9,
                    0x6a778ade48ef635f,
                    0x00c1ccbb8db65cba,
                    0x2d7ddac75e73b610,
                ])),
                Felt::new(BigInteger256([
                    0x009ba9fa7f866214,
                    0x5daf53e390248800,
                    0x372399ba3e2f99e7,
                    0x0810220be0d49745,
                ])),
                Felt::new(BigInteger256([
                    0x0f57237a42204f44,
                    0x0533a1938b010296,
                    0x18534a8ab9f12a7d,
                    0x245181ccfb8dcf4f,
                ])),
                Felt::new(BigInteger256([
                    0x6ded7aec7b0da43a,
                    0x505e1a4d916393c2,
                    0xbb40bcd8d1467897,
                    0x2a2f6edfdbd97519,
                ])),
                Felt::new(BigInteger256([
                    0xcc848c107ea255d9,
                    0x20720b4457a1ab8d,
                    0x45fd9ae60f781f58,
                    0x040de28450ca817b,
                ])),
                Felt::new(BigInteger256([
                    0xb66d63dc1d864bdf,
                    0xb9dfdf637365ed64,
                    0x011bb6b3216cc0bf,
                    0x01328bc1078a232e,
                ])),
                Felt::new(BigInteger256([
                    0x67d277ed7c958261,
                    0xf4079634837bb85c,
                    0x166699eacb3fd3de,
                    0x26466f85756927d7,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x273ec8f6d6e5ba0e,
                    0xaf91ea42656eb268,
                    0xf9f29b516fe2170e,
                    0x07d2d23031eb1d35,
                ])),
                Felt::new(BigInteger256([
                    0x81ba20101782c1e6,
                    0x90cc638bb797e96a,
                    0xf829499e204c5838,
                    0x27b4f9cc99eb141e,
                ])),
                Felt::new(BigInteger256([
                    0xa4b0522d46d2df43,
                    0xf1e3e5e83ed804c3,
                    0xe5739d6f8747156d,
                    0x29d26fde67689be1,
                ])),
                Felt::new(BigInteger256([
                    0x14c5d72289ff6b3a,
                    0xb5707052c59f1e51,
                    0x103c1a700ffcfd95,
                    0x1769c9e9ec9ea37c,
                ])),
                Felt::new(BigInteger256([
                    0x60f99fb4d96ad5c9,
                    0x1a54ea76f3daa2f9,
                    0x7950a2ce340b24ab,
                    0x1237d180d3f2624e,
                ])),
                Felt::new(BigInteger256([
                    0xe8ce0e0086c6a71c,
                    0x3133a0e75121014f,
                    0x04e0bf2da84dbe5c,
                    0x000143de565bcd8f,
                ])),
                Felt::new(BigInteger256([
                    0x68f8781d1cde4599,
                    0x15ed540d1aca230e,
                    0xd8dc918611689c12,
                    0x0e135f0869d0cec0,
                ])),
                Felt::new(BigInteger256([
                    0x6f992f17a12e5f9a,
                    0x70bd7873aa6ffd92,
                    0xd6031e755a364e45,
                    0x1dff9ba4c12c1562,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xe3a784d95e128799,
                    0xdbc94f4301ea65f6,
                    0x017d2514d74bd1b0,
                    0x2bdf5b1abe40e8cb,
                ])),
                Felt::new(BigInteger256([
                    0x798d49149ac9208a,
                    0xa9eb907bd52906e3,
                    0x4b12550fa89b8e83,
                    0x2b687f7d7e2a5588,
                ])),
                Felt::new(BigInteger256([
                    0x5d434ef7ec59f309,
                    0x72fae1725dfcbcec,
                    0x127da5833028d3f4,
                    0x11e345e5b742c4a9,
                ])),
                Felt::new(BigInteger256([
                    0xf19026287b90b1bd,
                    0x217dde452f81afd0,
                    0x8dc1c30dc99924e1,
                    0x08fa439f9c4b9a11,
                ])),
                Felt::new(BigInteger256([
                    0x97ac0e73c42e07f8,
                    0x67172a0b98975e0a,
                    0xa43eccdb519d4e9d,
                    0x2eb83539fe5fbef8,
                ])),
                Felt::new(BigInteger256([
                    0x0f0eaf28a0954d60,
                    0x7e135dc55743d222,
                    0x44ab754ed3854b4d,
                    0x28df51da8cf5621e,
                ])),
                Felt::new(BigInteger256([
                    0xc730272cb09d2271,
                    0x4400374e2ac99d63,
                    0x1b42d469d1a6db93,
                    0x0c0b79b4161b23e4,
                ])),
                Felt::new(BigInteger256([
                    0x68699a67eaf9f741,
                    0xac68fef884adfcf8,
                    0xc3e625c6b6cc01eb,
                    0x0265701f4816a5bc,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x4b1d36f5bc402afa,
                    0x9a83c41995ed1c09,
                    0x28335fb5741b43e6,
                    0x0e73cd624d38ddf8,
                ])),
                Felt::new(BigInteger256([
                    0xb93443c099470267,
                    0x35f44ad5b5c7c447,
                    0x9cba3f29d05811a1,
                    0x06bca6dc6ad4dc59,
                ])),
                Felt::new(BigInteger256([
                    0xd49f6516c8b00a56,
                    0x1ad59631f263403d,
                    0x257c2d957063d6ae,
                    0x2ba478a055d6ef08,
                ])),
                Felt::new(BigInteger256([
                    0xef268acb224c2448,
                    0x6b0c3af23f4fe52d,
                    0x03159b3d44feb724,
                    0x1cecbca024762dcd,
                ])),
                Felt::new(BigInteger256([
                    0xbc592b704053cee0,
                    0x17b6a7e864623c74,
                    0x94672524414ba612,
                    0x0b22b1bc5dcc7c79,
                ])),
                Felt::new(BigInteger256([
                    0x756a66e1845fe2f2,
                    0x22a970fa965a7c83,
                    0x46e952da2780aae0,
                    0x2a0e38eb701da0f7,
                ])),
                Felt::new(BigInteger256([
                    0x7e191a857e5c735e,
                    0xd726995dbe23abce,
                    0xb06a77d5bcb36d6e,
                    0x28f72a2693b60b88,
                ])),
                Felt::new(BigInteger256([
                    0x9110d8cbe615756e,
                    0x4fe28677ce7b4f1c,
                    0x1579d83f203a58b7,
                    0x215f109f8847afbb,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xa460c66f429e2f26,
                    0x58b3b701498e7a35,
                    0xc393c08509fea595,
                    0x04d5444dfb99f9bd,
                ])),
                Felt::new(BigInteger256([
                    0xc30c8cf16869b6de,
                    0x2694ddd349d1140a,
                    0xaf86ca606651617b,
                    0x18c2e1b4b3ea5560,
                ])),
                Felt::new(BigInteger256([
                    0x64a9a79c5f9ee189,
                    0x992b491b35593190,
                    0x695521e275ebb4bf,
                    0x0541d2da947c1aee,
                ])),
                Felt::new(BigInteger256([
                    0x8eb5222ccef2ecea,
                    0x09c7157c00b68643,
                    0x2a4ff07a8b816adb,
                    0x0f4b1af1a2900289,
                ])),
                Felt::new(BigInteger256([
                    0x91896dab463ba4aa,
                    0x24ebc5f93abef445,
                    0xb47b6102779a2323,
                    0x17a515633c04f84a,
                ])),
                Felt::new(BigInteger256([
                    0xcee6a5f68d2f52e8,
                    0x55534914a04ad9fc,
                    0xa077df0286516c50,
                    0x08048728eeae0054,
                ])),
                Felt::new(BigInteger256([
                    0x797eddecdacac0cf,
                    0x79f5758ff1082129,
                    0x5d13de7915ebb99a,
                    0x217f1bf0b18e8652,
                ])),
                Felt::new(BigInteger256([
                    0x41c8a623887ce6eb,
                    0x94b9ec9b231b3040,
                    0x746c15f7a33d6afe,
                    0x1f4642ab4974175e,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xd530e22d2822edb2,
                    0x03946ad2aa0f2eff,
                    0x5e9d3eb75aba38bf,
                    0x04e268ac393d456d,
                ])),
                Felt::new(BigInteger256([
                    0xeded38a8924157c4,
                    0x006f7e3d9383f66f,
                    0x0a131f7baa1c3da7,
                    0x0b1a84805c3656b2,
                ])),
                Felt::new(BigInteger256([
                    0x6d60604d07df0aab,
                    0x7a86c76a0a611633,
                    0x85be755c079b76ac,
                    0x0d5ba702ab80b5c3,
                ])),
                Felt::new(BigInteger256([
                    0x538a79c9e3965163,
                    0x40e1f72b4cb8a3f8,
                    0x6627eb420574956b,
                    0x1633a8eec0af9f6f,
                ])),
                Felt::new(BigInteger256([
                    0x6ed913d5a563e15e,
                    0x27d5be41a1b09119,
                    0x7e759c36f3d52ca4,
                    0x2eada9fa9e788559,
                ])),
                Felt::new(BigInteger256([
                    0x725fc8584d047be9,
                    0x2893b7dd0acf4c9e,
                    0xe02bfbac00a108b0,
                    0x253c2ba357b70c2f,
                ])),
                Felt::new(BigInteger256([
                    0x71043e4cb9af40a2,
                    0x93ed71d87de53c79,
                    0x950a5fba4496597f,
                    0x10b8dfdaf2a3d1d0,
                ])),
                Felt::new(BigInteger256([
                    0x7fdb4601402212b6,
                    0xf3ce333cc42f2765,
                    0xf42304f80cedd9ec,
                    0x2e5cc0f4d3694afa,
                ])),
            ],
        ];

        for i in input.iter_mut() {
            apply_sbox(i);
        }

        for (&i, o) in input.iter().zip(output) {
            assert_eq!(i, o);
        }
    }

    #[test]
    fn test_mds() {
        // Generated from https://github.com/vesselinux/anemoi-hash/
        let mut input = [
            [Felt::zero(); 8],
            [Felt::one(); 8],
            [
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
            ],
            [
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
            ],
            [
                Felt::new(BigInteger256([
                    0xc48e0a8677121b8e,
                    0x410aa4060dfea118,
                    0x5645a20f4b58c8f8,
                    0x2b3a082ce16e65a9,
                ])),
                Felt::new(BigInteger256([
                    0x53efbc2f2b64c76f,
                    0xb4be02cae43ec777,
                    0x6f786e1d750a79ab,
                    0x04cf602cd073d6a4,
                ])),
                Felt::new(BigInteger256([
                    0x3a1c2294e4f00fd0,
                    0xd27e5ef5cfbb9f42,
                    0x7e771bf51a92b432,
                    0x28af6c6a771885a8,
                ])),
                Felt::new(BigInteger256([
                    0xa33fa3477507e4c3,
                    0xd989cb7897909b83,
                    0x58204000a90fdefc,
                    0x2822404a6d3be41a,
                ])),
                Felt::new(BigInteger256([
                    0xd8dddf2bb2127625,
                    0xb962ea517ab18de5,
                    0xcc41440c2973b8f6,
                    0x1cf9e5870fe07625,
                ])),
                Felt::new(BigInteger256([
                    0x94b1eb3581074972,
                    0xdac34d080a17c0c0,
                    0xc4d63ed33574f846,
                    0x106cfc3684282e2b,
                ])),
                Felt::new(BigInteger256([
                    0x980f8b44c144a486,
                    0x15aff6b9247cf8f0,
                    0x0134aa185729f5a4,
                    0x01f87d5b207ad4e6,
                ])),
                Felt::new(BigInteger256([
                    0x35f25e621307483c,
                    0xa89341a88e3e4947,
                    0x0f4e0a89e82e83d0,
                    0x1c98fd79d02d26e6,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x954a37864a170aec,
                    0xeb315216290f6094,
                    0x039dd3f5f55d9b5e,
                    0x0de4a328dfe243fe,
                ])),
                Felt::new(BigInteger256([
                    0xab96934b878ca288,
                    0xe1eeb52fc257aeff,
                    0x970bf14c020c3614,
                    0x166c09831f78ecb7,
                ])),
                Felt::new(BigInteger256([
                    0x76f84a12618eaa33,
                    0x9055599958801b2b,
                    0x1ae56b92a4b03fc1,
                    0x1e014602b3d5d078,
                ])),
                Felt::new(BigInteger256([
                    0x76eba7f97838bb50,
                    0x187609d5b894357d,
                    0xefa9eb996b843cc9,
                    0x0eea088eae13c11e,
                ])),
                Felt::new(BigInteger256([
                    0x6210e8b4c3b0f897,
                    0x422c8cd6788dffbe,
                    0x6fd9e3e8c9ac141e,
                    0x214d2b838ee3011c,
                ])),
                Felt::new(BigInteger256([
                    0xb55f88c2209d70ed,
                    0xe29fa924b7ccc752,
                    0xed60880541029ed9,
                    0x01f99625ce9e1a64,
                ])),
                Felt::new(BigInteger256([
                    0x577a4d6d94c93767,
                    0x106f22a52520aa54,
                    0xaacc9a58cc990bac,
                    0x047ad2e506bac0b8,
                ])),
                Felt::new(BigInteger256([
                    0xbfa7b18ac06c1a94,
                    0xb03b9611563ebb58,
                    0x619a157adf964003,
                    0x0722af4b514f23a0,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x9cd3e1812bdb56a0,
                    0x7dc845e41418d6f0,
                    0x8e6194a0ffcb1bfd,
                    0x13fec10bcdd55c51,
                ])),
                Felt::new(BigInteger256([
                    0xf09db20d5d441c4b,
                    0x482c1ee6dfdac94f,
                    0x590673850023ec52,
                    0x1e6897674908fc8c,
                ])),
                Felt::new(BigInteger256([
                    0x01ae6e561f61e1cb,
                    0xc2bda9decb3ce655,
                    0xf25fcb9881a696ff,
                    0x08f5c40e94a3e2af,
                ])),
                Felt::new(BigInteger256([
                    0xa68e927ab2566e0f,
                    0xb4e8d67905316375,
                    0x29974c78daeaa24c,
                    0x2133e4cc111db85d,
                ])),
                Felt::new(BigInteger256([
                    0x7fac218d1e4ed179,
                    0x4d9ea3a3bef0ed70,
                    0xf801d354591a5f36,
                    0x0ab140a50e37355f,
                ])),
                Felt::new(BigInteger256([
                    0x710be0ba1004da20,
                    0x32a2066223a07fe0,
                    0x7c7c8fd803266e96,
                    0x24091b4ba0d8dfe8,
                ])),
                Felt::new(BigInteger256([
                    0x12e489a71e4bea66,
                    0x0741c9e29549b687,
                    0xd526754677c7d93f,
                    0x01fe0413d565aa27,
                ])),
                Felt::new(BigInteger256([
                    0x3037ccb7cf31d052,
                    0xa3df587f5df3745f,
                    0x2d89515f4c9d0a51,
                    0x2cde8456ede99fde,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x3aa2e4f9e4d9ca29,
                    0xa3532134f830cd90,
                    0x9f699f65035991d2,
                    0x2c2b3d5a2a9600a0,
                ])),
                Felt::new(BigInteger256([
                    0x3a3a3bd5a0f443ed,
                    0x0f670ad7d46b86aa,
                    0x5c29a3f1b621b1e0,
                    0x2bf0fa738963fdc7,
                ])),
                Felt::new(BigInteger256([
                    0x8b29f40bb623d998,
                    0x440b0dbd010174ff,
                    0x7916bbcf5ea8afbe,
                    0x0ef90fef6b56741b,
                ])),
                Felt::new(BigInteger256([
                    0x95a55bfff96eba4a,
                    0xddb19e68260fc22b,
                    0x8ca9364f37b08da7,
                    0x0f85e279ff4f0bb5,
                ])),
                Felt::new(BigInteger256([
                    0x3004e567547f23cb,
                    0xe4fbd2ffee270c44,
                    0xf09498612d1480c5,
                    0x07c418ae5ef1a8bf,
                ])),
                Felt::new(BigInteger256([
                    0x48a21397295ff434,
                    0xffbf664a06ccaa70,
                    0xdbee27f23dca7788,
                    0x1f29a36d24be7ad1,
                ])),
                Felt::new(BigInteger256([
                    0x90d647114dfac413,
                    0x9f3736c16f5e22c9,
                    0x358b42b32f4d4866,
                    0x2d842f81097584a4,
                ])),
                Felt::new(BigInteger256([
                    0x49b99bea0ec9a2cb,
                    0x9f6ed629225d674e,
                    0x9d28efc147f23650,
                    0x1d433c6b89079c96,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xfb9545525dc24e59,
                    0x43e567d4db3bf4e6,
                    0xe6eb99e0d4cf1c0a,
                    0x2516b9ad3630876f,
                ])),
                Felt::new(BigInteger256([
                    0x2201be67c3d836df,
                    0x5d0c8b524c7f0143,
                    0x4e3c51ce1d135141,
                    0x23820aa831c103b4,
                ])),
                Felt::new(BigInteger256([
                    0xe173dc62b9020402,
                    0xc95a27026162adb8,
                    0x5b6fdcca75278b83,
                    0x2036fe7814c860e8,
                ])),
                Felt::new(BigInteger256([
                    0xba109f78f78f39c6,
                    0xa79d71790456e267,
                    0x1bfbde3566db412a,
                    0x2b40a87986aec070,
                ])),
                Felt::new(BigInteger256([
                    0xecaab8639c2dd8a6,
                    0x8fca3bb20f04c164,
                    0x5951c1075459c86d,
                    0x017c1ac31f9336a7,
                ])),
                Felt::new(BigInteger256([
                    0xa00780f27d57be40,
                    0x8341c13e0176a656,
                    0xe75171f3c7fb4896,
                    0x2f41b2e7cbb94b64,
                ])),
                Felt::new(BigInteger256([
                    0x4193147c3efed61a,
                    0xff26a25cc0c2bea8,
                    0xc61ff391977a9c1d,
                    0x24bcb12f1b631037,
                ])),
                Felt::new(BigInteger256([
                    0x738db8d400136a92,
                    0x17c4925c3b975b27,
                    0x49a18c7221aea009,
                    0x023f90b09d5947a5,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xd9de67f14c2ed7d7,
                    0xac6fc29b7f03b6e8,
                    0xe768eb0c211fe7ac,
                    0x2dfed0da7ee14ecb,
                ])),
                Felt::new(BigInteger256([
                    0xda0e58d6fa2af9b1,
                    0x35d611e0422a8331,
                    0x3c5f258fca0f1d6c,
                    0x2c4301fcdbd73e87,
                ])),
                Felt::new(BigInteger256([
                    0x47a55e3478c15f4c,
                    0xa70dea912fb7125f,
                    0xfc2eee58d9b673da,
                    0x029b76715336eac2,
                ])),
                Felt::new(BigInteger256([
                    0x599aa11751c897fb,
                    0x2f6f2ca7565ab44a,
                    0x32641c74f5085875,
                    0x21e047245bc1e1c6,
                ])),
                Felt::new(BigInteger256([
                    0x735cc7ad2e55afae,
                    0x33f019a28f26be3a,
                    0x7d446b8b350438b6,
                    0x086cfe4b4b787be3,
                ])),
                Felt::new(BigInteger256([
                    0x449d16cee0d3e83a,
                    0x9c5859f9766070ae,
                    0x1ba32b03143b83f6,
                    0x106a2d5277b89f2b,
                ])),
                Felt::new(BigInteger256([
                    0x6b86bc4f0a1a718b,
                    0x9445ee3756303537,
                    0x7bc228b87619e881,
                    0x0ba3a9168ecea9f4,
                ])),
                Felt::new(BigInteger256([
                    0x1eac3a63345cfd3f,
                    0x8d4836edf7c5daa2,
                    0x0f0873b18eaa8e0c,
                    0x223f190dd2245d11,
                ])),
            ],
        ];

        let mut input2 = input;

        let output = [
            [Felt::zero(); 8],
            [
                Felt::new(BigInteger256([
                    0x60a042d2f3ae9dea,
                    0xacaddb0e56381c00,
                    0x3dd034a6a8b1facb,
                    0x094639f8fac1b68c,
                ])),
                Felt::new(BigInteger256([
                    0x4e8384eb157ccc21,
                    0xfb90a6020ce148c3,
                    0x5301fa84819caa36,
                    0x0dc83629563d4475,
                ])),
                Felt::new(BigInteger256([
                    0x949dc933acec4971,
                    0x63d4a145a237433e,
                    0xe20f0cbcc9dd3bc3,
                    0x2096ebb38f8b4c47,
                ])),
                Felt::new(BigInteger256([
                    0xafec0385a99e02a7,
                    0xc6f9740a3dc5d596,
                    0x9a362145f1003544,
                    0x0ac6e35e6e959084,
                ])),
                Felt::new(BigInteger256([
                    0x60a042d2f3ae9dea,
                    0xacaddb0e56381c00,
                    0x3dd034a6a8b1facb,
                    0x094639f8fac1b68c,
                ])),
                Felt::new(BigInteger256([
                    0x4e8384eb157ccc21,
                    0xfb90a6020ce148c3,
                    0x5301fa84819caa36,
                    0x0dc83629563d4475,
                ])),
                Felt::new(BigInteger256([
                    0x949dc933acec4971,
                    0x63d4a145a237433e,
                    0xe20f0cbcc9dd3bc3,
                    0x2096ebb38f8b4c47,
                ])),
                Felt::new(BigInteger256([
                    0xafec0385a99e02a7,
                    0xc6f9740a3dc5d596,
                    0x9a362145f1003544,
                    0x0ac6e35e6e959084,
                ])),
            ],
            [
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::new(BigInteger256([
                    0x60a042d2f3ae9dea,
                    0xacaddb0e56381c00,
                    0x3dd034a6a8b1facb,
                    0x094639f8fac1b68c,
                ])),
                Felt::new(BigInteger256([
                    0x4e8384eb157ccc21,
                    0xfb90a6020ce148c3,
                    0x5301fa84819caa36,
                    0x0dc83629563d4475,
                ])),
                Felt::new(BigInteger256([
                    0x949dc933acec4971,
                    0x63d4a145a237433e,
                    0xe20f0cbcc9dd3bc3,
                    0x2096ebb38f8b4c47,
                ])),
                Felt::new(BigInteger256([
                    0xafec0385a99e02a7,
                    0xc6f9740a3dc5d596,
                    0x9a362145f1003544,
                    0x0ac6e35e6e959084,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x60a042d2f3ae9dea,
                    0xacaddb0e56381c00,
                    0x3dd034a6a8b1facb,
                    0x094639f8fac1b68c,
                ])),
                Felt::new(BigInteger256([
                    0x4e8384eb157ccc21,
                    0xfb90a6020ce148c3,
                    0x5301fa84819caa36,
                    0x0dc83629563d4475,
                ])),
                Felt::new(BigInteger256([
                    0x949dc933acec4971,
                    0x63d4a145a237433e,
                    0xe20f0cbcc9dd3bc3,
                    0x2096ebb38f8b4c47,
                ])),
                Felt::new(BigInteger256([
                    0xafec0385a99e02a7,
                    0xc6f9740a3dc5d596,
                    0x9a362145f1003544,
                    0x0ac6e35e6e959084,
                ])),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
            ],
            [
                Felt::new(BigInteger256([
                    0x439d044f1f9f2759,
                    0x8b12af146233aff8,
                    0x460bcc1f61625704,
                    0x0e92b84d89113c89,
                ])),
                Felt::new(BigInteger256([
                    0xfd1f589cc68a02c9,
                    0x57ec73a33cc7832a,
                    0xaf3124ef113e77e7,
                    0x1362bb4cb5d7b314,
                ])),
                Felt::new(BigInteger256([
                    0x95df8eec70e4c126,
                    0x2b2100ce645f7135,
                    0x76932345eebe0b29,
                    0x04751ce5fd7712af,
                ])),
                Felt::new(BigInteger256([
                    0x3fd3cb5c1a17bff7,
                    0xe7f0c4ba2eb55af7,
                    0x0e2525cc45969c76,
                    0x053ff7d9872d54e6,
                ])),
                Felt::new(BigInteger256([
                    0x30dea09673732191,
                    0xf96001951513ffd5,
                    0x7b15bc1cc0fe23b6,
                    0x037660da2175d840,
                ])),
                Felt::new(BigInteger256([
                    0xc790e6f04e35c277,
                    0x7e108b2490138eed,
                    0x99de7becaaeae888,
                    0x04c8ea4c0f132f51,
                ])),
                Felt::new(BigInteger256([
                    0xc373bcd41d0e8ede,
                    0x7523cd50a99448c9,
                    0xe4d3a8bb768bb2bc,
                    0x13b8030392405a22,
                ])),
                Felt::new(BigInteger256([
                    0x53e0571a13ec6457,
                    0xec9b4c98b311f041,
                    0xe12775350ecd4e10,
                    0x273c64a33e0db771,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x1cce2a7c93abd079,
                    0x0f48a6dcc3e3e459,
                    0x9e3a87d0282687dc,
                    0x2cc57b1dfebc2afa,
                ])),
                Felt::new(BigInteger256([
                    0x95770a4c9f52e954,
                    0xae6b0d71165efdb2,
                    0x8a939e242a2b8373,
                    0x25d1d5245c2d844d,
                ])),
                Felt::new(BigInteger256([
                    0xb989aaa1dd4ac64f,
                    0x6c426dda3de228ed,
                    0x8702db95f96ecd0b,
                    0x1d5d06b25ccc8a08,
                ])),
                Felt::new(BigInteger256([
                    0xa1fa8ea6f7589c50,
                    0xc89a86d00557e8eb,
                    0x34f0f20bf5642fe7,
                    0x17749e58074c9dbd,
                ])),
                Felt::new(BigInteger256([
                    0x003175094f1f8d7c,
                    0xcc91c74de7d20ccf,
                    0x9c4e52266c2b1934,
                    0x2c6bd540c7bc4b2a,
                ])),
                Felt::new(BigInteger256([
                    0xbe694a896790d7f0,
                    0xbff044c265ed2a24,
                    0x9d77f35ad9499c6a,
                    0x2ad541257a97cb82,
                ])),
                Felt::new(BigInteger256([
                    0xcb11abafcdd7f2c8,
                    0xe66d493e5b088efc,
                    0x9956c3927aba2dbb,
                    0x04ddd4ef88345b75,
                ])),
                Felt::new(BigInteger256([
                    0x108ec81f820a8481,
                    0xb8e7e25f2644cc68,
                    0x640f11bc5ba77c29,
                    0x004d9eff14469d4c,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x2b5eefb6dba3c4f7,
                    0x0fe52daffa95e4ce,
                    0xaccf4e588e87bf58,
                    0x1a2890fa7d45fed9,
                ])),
                Felt::new(BigInteger256([
                    0x9d6e3f70bffc1449,
                    0x5359c38afd51a6ec,
                    0x95598e2ceac25603,
                    0x26d94ce26031a822,
                ])),
                Felt::new(BigInteger256([
                    0xc360573194fac4f6,
                    0x71e790148e3d97d1,
                    0x17a20243daa8469d,
                    0x0eb3c5e8189861fd,
                ])),
                Felt::new(BigInteger256([
                    0x89c00c81c76496ab,
                    0xb8a5884439dafed0,
                    0xab5d9c69633a191d,
                    0x110145544e384129,
                ])),
                Felt::new(BigInteger256([
                    0xdbc7a1c9efc273fd,
                    0xc61d78102dad5536,
                    0x6076bc32cd66aeb3,
                    0x111f40c3660b879b,
                ])),
                Felt::new(BigInteger256([
                    0x492ee708e6cdc42b,
                    0xb38a8cb90b27de2a,
                    0x389d562349d4b19b,
                    0x15d94f1335394c2e,
                ])),
                Felt::new(BigInteger256([
                    0xf157afa0255c14b4,
                    0x2750e4ed9664bf5a,
                    0x29c99f0ef75c4abd,
                    0x2ac12daf456c4ea3,
                ])),
                Felt::new(BigInteger256([
                    0x6f03ea4ce809987a,
                    0x9264b75f467950c3,
                    0xdcc11375944934ae,
                    0x2d1d42a1149b1ad8,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x1d367bea6474a5d9,
                    0xb91cd19b4c67ce6b,
                    0xcf6e634095e3ff53,
                    0x151227b348ecb636,
                ])),
                Felt::new(BigInteger256([
                    0xe3d62504a6f404d9,
                    0x91a91048c36e4518,
                    0xd2bfb79a87137d6d,
                    0x1cbf98ca3e3549cc,
                ])),
                Felt::new(BigInteger256([
                    0xff5c3dd2efd06fcf,
                    0xf3c50028db31005a,
                    0x469451fa2929696e,
                    0x2f655a71c810f1d4,
                ])),
                Felt::new(BigInteger256([
                    0xa8aff1cfdc5f9abb,
                    0x21f474c165a1cdf6,
                    0xfcefc14cf0fe45e2,
                    0x0a92dae51cfffc29,
                ])),
                Felt::new(BigInteger256([
                    0x90736b4778376898,
                    0x7cd3bd628327d0fe,
                    0x097228df510bac35,
                    0x21f68a0dbb569c6c,
                ])),
                Felt::new(BigInteger256([
                    0x1c3bc8d2bcfd82e5,
                    0x5ed2f3f3593ebf73,
                    0xe054ff55a0fb0ffc,
                    0x1e3c765be10e156a,
                ])),
                Felt::new(BigInteger256([
                    0x29202c1ce3a3d54d,
                    0xe974690ae3cff121,
                    0x300bfb653b85cb58,
                    0x188f70c972b9d84b,
                ])),
                Felt::new(BigInteger256([
                    0x203ea435f855c2d5,
                    0x492c52adc996502e,
                    0x94e1a4a03de0b2f6,
                    0x1dce93483eec22bd,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x752551cdbaeef8f5,
                    0x4ef30a04fad655eb,
                    0xc39de464d11a042e,
                    0x1263658bc60cf8fc,
                ])),
                Felt::new(BigInteger256([
                    0x698b0877d732395f,
                    0x463be70e244f95c0,
                    0xb3383c1458ac78e0,
                    0x1e1e41672202b22b,
                ])),
                Felt::new(BigInteger256([
                    0xd5dc2e4d6560c85b,
                    0x00b9659ee8c26b71,
                    0x6c71fda7f7f389a0,
                    0x23ef51bde2b5a429,
                ])),
                Felt::new(BigInteger256([
                    0x5b584002dcdcd000,
                    0xe3df401c6c25260f,
                    0xe58029168615d367,
                    0x2578d2c71e983a08,
                ])),
                Felt::new(BigInteger256([
                    0xd67af62eec22eb34,
                    0x18830a96428ecc67,
                    0x076a11cc81f990fc,
                    0x0bd64033eb448683,
                ])),
                Felt::new(BigInteger256([
                    0xbfc092c768cc814c,
                    0x399fd49d15cb4160,
                    0x0d79fe8bdbaba341,
                    0x0e7d125fef16c363,
                ])),
                Felt::new(BigInteger256([
                    0x8ebfa5f060832d2b,
                    0x0c03c3102d040f6a,
                    0xfb310c8e37a69e9c,
                    0x2640e7d009bcf852,
                ])),
                Felt::new(BigInteger256([
                    0x3b52b26c82e38e85,
                    0x39ff5c418e06c807,
                    0xcf7ea6d36d2e4db3,
                    0x1757fefd5a34af2f,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xbd1480a7818ab4c6,
                    0x7a36d05da738585d,
                    0x12bcff6dac90b01b,
                    0x2a243addb3feed8a,
                ])),
                Felt::new(BigInteger256([
                    0xd0408fe03b733140,
                    0x4a169330e1cbcecd,
                    0x0117fda498c877fd,
                    0x1f41e08776848710,
                ])),
                Felt::new(BigInteger256([
                    0x8af843ea27c550bb,
                    0x1aa42cbd934fe5fd,
                    0x59d2c91c55e5749d,
                    0x1efb2a0e3c0c86af,
                ])),
                Felt::new(BigInteger256([
                    0x8d918f77baf5d468,
                    0x2bed907e6601311b,
                    0xa64765b8d89cad4c,
                    0x080bd563f78f1625,
                ])),
                Felt::new(BigInteger256([
                    0xf47169f7a7debd58,
                    0x6a94c4d42a91b079,
                    0x86a19a77b32b712c,
                    0x2dd02c5f6834f15d,
                ])),
                Felt::new(BigInteger256([
                    0xf8ec1375da1757cd,
                    0xbf87246a50ccf3e3,
                    0xf404b7eb5f8a33a1,
                    0x2fd81b31554bc5fe,
                ])),
                Felt::new(BigInteger256([
                    0xb49e7c9c1d26f43a,
                    0x8590a7c6f2cbe94f,
                    0x04c8712f36b42eed,
                    0x1e15c53af39e1dc1,
                ])),
                Felt::new(BigInteger256([
                    0xfff892d0e6057fc7,
                    0x015ce1e64e86cb4a,
                    0x597575c8842d3e90,
                    0x299e110004e0084c,
                ])),
            ],
        ];

        for i in input.iter_mut() {
            apply_mds(i);
        }
        for i in input2.iter_mut() {
            apply_naive_mds(i);
        }

        for (index, (&i_1, i_2)) in input.iter().zip(input2).enumerate() {
            assert_eq!(output[index], i_1);
            assert_eq!(output[index], i_2);
        }
    }
}
