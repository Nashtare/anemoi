use super::{sbox, BigInteger256, Felt};
use crate::{Jive, Sponge};
use ark_ff::{Field, One, Zero};
use unroll::unroll_for_loops;

/// Digest for Anemoi
mod digest;
/// Sponge for Anemoi
mod hasher;
/// MDS matrix for Anemoi
mod mds;
/// Round constants for Anemoi
mod round_constants;

pub use digest::AnemoiDigest;
pub use hasher::AnemoiHash;

// ANEMOI CONSTANTS
// ================================================================================================

/// Function state is set to 8 field elements or 256 bytes.
/// 1 element of the state is reserved for capacity.
pub const STATE_WIDTH: usize = 8;
/// 7 elements of the state are reserved for rate.
pub const RATE_WIDTH: usize = 7;

/// The state is divided into two even-length rows.
pub const NUM_COLUMNS: usize = 4;

/// 2 elements (64-bytes) are returned as digest.
pub const DIGEST_SIZE: usize = 2;

/// The number of rounds is set to 14 to provide 256-bit security level.
pub const NUM_HASH_ROUNDS: usize = 14;

// HELPER FUNCTIONS
// ================================================================================================

#[inline(always)]
/// Applies exponentiation of the current hash
/// state elements with the Anemoi S-Box.
pub(crate) fn apply_sbox(state: &mut [Felt; STATE_WIDTH]) {
    let mut x: [Felt; NUM_COLUMNS] = state[..NUM_COLUMNS].try_into().unwrap();
    let mut y: [Felt; NUM_COLUMNS] = state[NUM_COLUMNS..].try_into().unwrap();

    x.iter_mut().enumerate().for_each(|(i, t)| {
        let y2 = y[i].square();
        *t -= y2.double() + y2
    });

    let mut x_alpha_inv = x;
    x_alpha_inv
        .iter_mut()
        .for_each(|t| *t = sbox::exp_inv_alpha(t));

    y.iter_mut()
        .enumerate()
        .for_each(|(i, t)| *t -= x_alpha_inv[i]);

    x.iter_mut().enumerate().for_each(|(i, t)| {
        let y2 = y[i].square();
        *t += y2.double() + y2 + sbox::DELTA
    });

    state[..NUM_COLUMNS].copy_from_slice(&x);
    state[NUM_COLUMNS..].copy_from_slice(&y);
}

#[inline(always)]
/// Applies matrix-vector multiplication of the current
/// hash state with the Anemoi MDS matrix.
pub(crate) fn apply_mds(state: &mut [Felt; STATE_WIDTH]) {
    let x: [Felt; NUM_COLUMNS] = [state[0], state[1], state[2], state[3]];
    let y: [Felt; NUM_COLUMNS] = [state[5], state[6], state[7], state[4]];

    let sum_coeffs = x[0] + x[1] + x[2] + x[3];
    state[0] = sum_coeffs + x[2] + x[3].double();
    state[1] = sum_coeffs + x[3] + x[0].double();
    state[2] = sum_coeffs + x[0] + x[1].double();
    state[3] = sum_coeffs + x[1] + x[2].double();

    let sum_coeffs = y[0] + y[1] + y[2] + y[3];
    state[4] = sum_coeffs + y[2] + y[3].double();
    state[5] = sum_coeffs + y[3] + y[0].double();
    state[6] = sum_coeffs + y[0] + y[1].double();
    state[7] = sum_coeffs + y[1] + y[2].double();
}

// ANEMOI PERMUTATION
// ================================================================================================

/// Applies Anemoi permutation to the provided state.
#[inline(always)]
#[unroll_for_loops]
pub(crate) fn apply_permutation(state: &mut [Felt; STATE_WIDTH]) {
    for i in 0..NUM_HASH_ROUNDS {
        apply_round(state, i);
    }

    apply_mds(state)
}

/// Anemoi round function;
/// implementation based on algorithm 3 of <https://eprint.iacr.org/2020/1143.pdf>
#[inline(always)]
#[unroll_for_loops]
pub(crate) fn apply_round(state: &mut [Felt; STATE_WIDTH], step: usize) {
    // determine which round constants to use
    let c = &round_constants::C[step % NUM_HASH_ROUNDS];
    let d = &round_constants::D[step % NUM_HASH_ROUNDS];

    for i in 0..NUM_COLUMNS {
        state[i] += c[i];
        state[NUM_COLUMNS + i] += d[i];
    }

    apply_mds(state);
    apply_sbox(state);
}

#[cfg(test)]
mod tests {
    use super::*;

    fn apply_naive_mds(state: &mut [Felt; STATE_WIDTH]) {
        let x: [Felt; NUM_COLUMNS] = state[..NUM_COLUMNS].try_into().unwrap();
        let mut y: [Felt; NUM_COLUMNS] = [Felt::zero(); NUM_COLUMNS];
        y[0..NUM_COLUMNS - 1].copy_from_slice(&state[NUM_COLUMNS + 1..]);
        y[NUM_COLUMNS - 1] = state[NUM_COLUMNS];

        let mut result = [Felt::zero(); STATE_WIDTH];
        for (i, r) in result.iter_mut().enumerate().take(NUM_COLUMNS) {
            for (j, s) in x.into_iter().enumerate().take(NUM_COLUMNS) {
                *r += s * mds::MDS[i * NUM_COLUMNS + j];
            }
        }
        for (i, r) in result.iter_mut().enumerate().skip(NUM_COLUMNS) {
            for (j, s) in y.into_iter().enumerate() {
                *r += s * mds::MDS[(i - NUM_COLUMNS) * NUM_COLUMNS + j];
            }
        }

        state.copy_from_slice(&result);
    }

    #[test]
    fn test_sbox() {
        // Generated from https://github.com/Nashtare/anemoi-hash/
        let mut input = [
            [Felt::zero(); 8],
            [Felt::one(); 8],
            [
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
            ],
            [
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
            ],
            [
                Felt::new(BigInteger256([
                    0x2e695b6017515388,
                    0xbdfed53ea60da483,
                    0x72cdcf54cb982845,
                    0x009fb4372b1cc4c5,
                ])),
                Felt::new(BigInteger256([
                    0xd00227842b985882,
                    0x7fc1eb6df34f2205,
                    0xab0a6c5e9ff5e9e2,
                    0x2e5102b7c9a9685e,
                ])),
                Felt::new(BigInteger256([
                    0x44dd59b598ba544a,
                    0x47b54a2170e033fb,
                    0x3b605b2f8706c34c,
                    0x0cb238286772de8a,
                ])),
                Felt::new(BigInteger256([
                    0xdc3fbd888996ca4a,
                    0xefbfbaaf569b6de2,
                    0x8453331283c84f21,
                    0x14a90a5fdc9a78c0,
                ])),
                Felt::new(BigInteger256([
                    0x989d23c949bedc2b,
                    0xe816b2906e98736c,
                    0x9638f9d4d6324890,
                    0x1d27a988d0afe007,
                ])),
                Felt::new(BigInteger256([
                    0x5ca1dccdb8c33076,
                    0xf39751e950257e7a,
                    0x84ec6f9dd2d8dc79,
                    0x20a19964680e3736,
                ])),
                Felt::new(BigInteger256([
                    0x47c67d6bf889def6,
                    0xf300b84db6c2b389,
                    0x6ac849dbf95502a6,
                    0x2a1ab4e0da5a4885,
                ])),
                Felt::new(BigInteger256([
                    0x33baa23d0dcb07a9,
                    0x8a89413c083e4623,
                    0x613de74d4fe751d6,
                    0x035a7d78ebf0a94d,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xaebd34e47f529b29,
                    0xe89b1fda72d3a93d,
                    0x014b4607cf05252d,
                    0x12a632605fdf5373,
                ])),
                Felt::new(BigInteger256([
                    0x6af54dee7832a2f5,
                    0xdf027a1ab5b57d7a,
                    0xc2ffdd1cb9b4b8c2,
                    0x207c27462f8ed7e6,
                ])),
                Felt::new(BigInteger256([
                    0xa493418087c732f1,
                    0xc725ee21db0bdcc1,
                    0x72ffe3b4fd66c646,
                    0x0e9eec25931aa3d2,
                ])),
                Felt::new(BigInteger256([
                    0xba7c9ff43fc8bab5,
                    0x6b493064424e408a,
                    0x3439a10c55ad0cc1,
                    0x211267ee0f30632a,
                ])),
                Felt::new(BigInteger256([
                    0x826725ed8056bf40,
                    0x894e69e96158041a,
                    0xd47e11f2dcb7b047,
                    0x1364cab963504017,
                ])),
                Felt::new(BigInteger256([
                    0x390c64568a826970,
                    0x8b137490df8a0575,
                    0x504be268872c80eb,
                    0x1c9e97d2cfd64eae,
                ])),
                Felt::new(BigInteger256([
                    0xab4b47ebc0345ed6,
                    0x8e03eb8cf356d145,
                    0xb91ac33649b93b78,
                    0x22272962c5bc5e8f,
                ])),
                Felt::new(BigInteger256([
                    0x5f810a979d53f540,
                    0x514619dff02c1237,
                    0xf8873e095d55df92,
                    0x07986484aab4be05,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xd65b6fc177c63248,
                    0xe3baeaee585b199f,
                    0x1db8d7865d3a5b19,
                    0x0d054c8625d9fbaa,
                ])),
                Felt::new(BigInteger256([
                    0x936159bcdc75b11d,
                    0x066cc7d7db1b1aab,
                    0x3d300c3b118f5639,
                    0x1dcc497f00ecf418,
                ])),
                Felt::new(BigInteger256([
                    0x70c8536c0b43656f,
                    0x5d88bc127d16f210,
                    0xf767a53c5d91529f,
                    0x20d55107254d5fc4,
                ])),
                Felt::new(BigInteger256([
                    0x56ed818cfabf0cb9,
                    0xc0855c9bc60cf51c,
                    0x5b35e117b83c7cf0,
                    0x17c4a94d82d68299,
                ])),
                Felt::new(BigInteger256([
                    0x8e2fe8b8856a0548,
                    0x3e30ec4ece6bbfa6,
                    0xf94494cac98db21b,
                    0x2dbbe6285de68eb9,
                ])),
                Felt::new(BigInteger256([
                    0x13a5457fa60ec329,
                    0x3495904cfcbae1f1,
                    0x296fe781f6118b2e,
                    0x21792487a1f38183,
                ])),
                Felt::new(BigInteger256([
                    0xa6f784a8e3e8fd04,
                    0x37ecb788dc91a489,
                    0xc9aca57cfcab3f80,
                    0x176e394d0371a7a6,
                ])),
                Felt::new(BigInteger256([
                    0xdf25869fde917b8d,
                    0xb8e607f8d4c0dd9a,
                    0x25726dc877903479,
                    0x0534e3d378b03400,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xd610447098f60bb4,
                    0xd0d3e86a407a44e3,
                    0xc876acc47533f5ce,
                    0x19905e4dae9ee9aa,
                ])),
                Felt::new(BigInteger256([
                    0x2b7dcbec933fc7b6,
                    0x3ed7079893b084d1,
                    0xebbcaf277a4b5c51,
                    0x23ec633c2d34e459,
                ])),
                Felt::new(BigInteger256([
                    0xd5e0eda3a06cbf25,
                    0xcea66af5aea945eb,
                    0xb0e57e217b2b7703,
                    0x15650f73d2d0811b,
                ])),
                Felt::new(BigInteger256([
                    0xf20fdeca41d69d68,
                    0xd9c11016e0ae87da,
                    0x90b00884f62a1719,
                    0x020d5591d5c253a6,
                ])),
                Felt::new(BigInteger256([
                    0x48f63c813bc0b5b0,
                    0x7f7ad26628a72454,
                    0x89ded0dffe484dd4,
                    0x2357b5877621fda2,
                ])),
                Felt::new(BigInteger256([
                    0x620c27a6c3134005,
                    0x0faa53c4b43c2873,
                    0x7e68e838ceb0de27,
                    0x0df354970add30c9,
                ])),
                Felt::new(BigInteger256([
                    0x52d4f6a0abfc2e72,
                    0xcbe43c54bd91acb2,
                    0xb60988ab94eafe57,
                    0x0ac13164976a1326,
                ])),
                Felt::new(BigInteger256([
                    0x7c03579d3adc6a86,
                    0xd0e550e3c3e7ad77,
                    0x9688e73fbab974f6,
                    0x138139e4a216b66a,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xef83ebc61444c87a,
                    0xe740b1a38077c8f8,
                    0x52c7fe9722b1c379,
                    0x2d71ceadab90f0d3,
                ])),
                Felt::new(BigInteger256([
                    0xca8e5e1da40e281b,
                    0xacc29df16c7905af,
                    0x849071085cdcad90,
                    0x24d63289ae7747dc,
                ])),
                Felt::new(BigInteger256([
                    0xb8038159b290f1b7,
                    0x4e30d32c02f418d8,
                    0x071363bc4da9a566,
                    0x110db50c305d8ffa,
                ])),
                Felt::new(BigInteger256([
                    0x9d8aef8e04fab460,
                    0x72f360bcde48bb24,
                    0x7b64006d1775b58e,
                    0x01a1763a931d4304,
                ])),
                Felt::new(BigInteger256([
                    0x87931419c20d5467,
                    0x8076844e1f0dc515,
                    0x6b79475a07a49a69,
                    0x1759b2f4e10a488e,
                ])),
                Felt::new(BigInteger256([
                    0x981bfd51ccfb10dc,
                    0x618c23a7843a76d1,
                    0xee479b4a70dfeac7,
                    0x200e8e5116604cf2,
                ])),
                Felt::new(BigInteger256([
                    0x9fce76bea0f70f77,
                    0xd929c74e820cb08e,
                    0x538a1fccacd70be2,
                    0x2d711eafc21969bf,
                ])),
                Felt::new(BigInteger256([
                    0xe58b82d59bdf72bb,
                    0x709a96db4f7a7938,
                    0xa70bc4810bbc00ee,
                    0x2073dc5d2707a4e6,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xd26be80f6e590028,
                    0xf498e9a8c015d2d0,
                    0x6669388a4c7429ce,
                    0x15c59a8e5125ac59,
                ])),
                Felt::new(BigInteger256([
                    0x7d5be96efab00315,
                    0x5f724bb56b4fa1bd,
                    0xcbe3571e91dae6a8,
                    0x284cac3333677c9c,
                ])),
                Felt::new(BigInteger256([
                    0x22ffd183b604a2ad,
                    0x73169686fd2a8042,
                    0xfe8b10b50ed2faf5,
                    0x02a12369468e4b1b,
                ])),
                Felt::new(BigInteger256([
                    0xe926040a3cb2a38e,
                    0xa875ebb350e0a630,
                    0x605c3852b769ab0a,
                    0x1353e8d60ff95f62,
                ])),
                Felt::new(BigInteger256([
                    0xa1f5b7053dd03ce3,
                    0x6844b09ea8887e4c,
                    0x9ce57da16a7373a5,
                    0x2a28b91a4c22aebf,
                ])),
                Felt::new(BigInteger256([
                    0xf12ab36f8d4c6ba7,
                    0x6bc3732b75f33da5,
                    0xefb94df981b2578e,
                    0x0566b4300ad47092,
                ])),
                Felt::new(BigInteger256([
                    0x41d71dd8e3c0d85f,
                    0x224902936f6fe834,
                    0x0c95a3a77de980d1,
                    0x07ad78d603c9b966,
                ])),
                Felt::new(BigInteger256([
                    0x1d767a7526f422b0,
                    0xc21c88d2ae2fa1b9,
                    0xfac84c58af21eec4,
                    0x24a51f0e50c39dbc,
                ])),
            ],
        ];

        let output = [
            [
                Felt::new(BigInteger256([
                    0xafd49a8c34aeae4c,
                    0xe0a8c73e1f684743,
                    0xb4ea4db753538a2d,
                    0x14cf9766d3bdd51d,
                ])),
                Felt::new(BigInteger256([
                    0xafd49a8c34aeae4c,
                    0xe0a8c73e1f684743,
                    0xb4ea4db753538a2d,
                    0x14cf9766d3bdd51d,
                ])),
                Felt::new(BigInteger256([
                    0xafd49a8c34aeae4c,
                    0xe0a8c73e1f684743,
                    0xb4ea4db753538a2d,
                    0x14cf9766d3bdd51d,
                ])),
                Felt::new(BigInteger256([
                    0xafd49a8c34aeae4c,
                    0xe0a8c73e1f684743,
                    0xb4ea4db753538a2d,
                    0x14cf9766d3bdd51d,
                ])),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
            ],
            [
                Felt::new(BigInteger256([
                    0xbebb490c2e6f962f,
                    0x465ac2ad04e364b4,
                    0xff4b8beb7ecbd2f7,
                    0x1daa245477c958e5,
                ])),
                Felt::new(BigInteger256([
                    0xbebb490c2e6f962f,
                    0x465ac2ad04e364b4,
                    0xff4b8beb7ecbd2f7,
                    0x1daa245477c958e5,
                ])),
                Felt::new(BigInteger256([
                    0xbebb490c2e6f962f,
                    0x465ac2ad04e364b4,
                    0xff4b8beb7ecbd2f7,
                    0x1daa245477c958e5,
                ])),
                Felt::new(BigInteger256([
                    0xbebb490c2e6f962f,
                    0x465ac2ad04e364b4,
                    0xff4b8beb7ecbd2f7,
                    0x1daa245477c958e5,
                ])),
                Felt::new(BigInteger256([
                    0xe07a0c33042f6fc0,
                    0xfbc9e1489023576a,
                    0xd40daa7093c5a810,
                    0x01eb281368a433ca,
                ])),
                Felt::new(BigInteger256([
                    0xe07a0c33042f6fc0,
                    0xfbc9e1489023576a,
                    0xd40daa7093c5a810,
                    0x01eb281368a433ca,
                ])),
                Felt::new(BigInteger256([
                    0xe07a0c33042f6fc0,
                    0xfbc9e1489023576a,
                    0xd40daa7093c5a810,
                    0x01eb281368a433ca,
                ])),
                Felt::new(BigInteger256([
                    0xe07a0c33042f6fc0,
                    0xfbc9e1489023576a,
                    0xd40daa7093c5a810,
                    0x01eb281368a433ca,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x9221c13bf351088f,
                    0x7ba14974192568d6,
                    0x764d83e12590a30c,
                    0x1efdfa43167d3d99,
                ])),
                Felt::new(BigInteger256([
                    0x9221c13bf351088f,
                    0x7ba14974192568d6,
                    0x764d83e12590a30c,
                    0x1efdfa43167d3d99,
                ])),
                Felt::new(BigInteger256([
                    0x9221c13bf351088f,
                    0x7ba14974192568d6,
                    0x764d83e12590a30c,
                    0x1efdfa43167d3d99,
                ])),
                Felt::new(BigInteger256([
                    0x9221c13bf351088f,
                    0x7ba14974192568d6,
                    0x764d83e12590a30c,
                    0x1efdfa43167d3d99,
                ])),
                Felt::new(BigInteger256([
                    0xa8fad3571dcabf05,
                    0x20a54df8cdb610bd,
                    0xb562a9b2221bf6a7,
                    0x113c1d95ad2f3ee3,
                ])),
                Felt::new(BigInteger256([
                    0xa8fad3571dcabf05,
                    0x20a54df8cdb610bd,
                    0xb562a9b2221bf6a7,
                    0x113c1d95ad2f3ee3,
                ])),
                Felt::new(BigInteger256([
                    0xa8fad3571dcabf05,
                    0x20a54df8cdb610bd,
                    0xb562a9b2221bf6a7,
                    0x113c1d95ad2f3ee3,
                ])),
                Felt::new(BigInteger256([
                    0xa8fad3571dcabf05,
                    0x20a54df8cdb610bd,
                    0xb562a9b2221bf6a7,
                    0x113c1d95ad2f3ee3,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xc1291cac726de779,
                    0x730b09508e12a9ad,
                    0x965495beb3b74a80,
                    0x1c9527fa5aabb1b1,
                ])),
                Felt::new(BigInteger256([
                    0xc1291cac726de779,
                    0x730b09508e12a9ad,
                    0x965495beb3b74a80,
                    0x1c9527fa5aabb1b1,
                ])),
                Felt::new(BigInteger256([
                    0xc1291cac726de779,
                    0x730b09508e12a9ad,
                    0x965495beb3b74a80,
                    0x1c9527fa5aabb1b1,
                ])),
                Felt::new(BigInteger256([
                    0xc1291cac726de779,
                    0x730b09508e12a9ad,
                    0x965495beb3b74a80,
                    0x1c9527fa5aabb1b1,
                ])),
                Felt::new(BigInteger256([
                    0x68c3488912edefaa,
                    0x8d087f6872aabf4f,
                    0x51e1a24709081231,
                    0x2259d6b14729c0fa,
                ])),
                Felt::new(BigInteger256([
                    0x68c3488912edefaa,
                    0x8d087f6872aabf4f,
                    0x51e1a24709081231,
                    0x2259d6b14729c0fa,
                ])),
                Felt::new(BigInteger256([
                    0x68c3488912edefaa,
                    0x8d087f6872aabf4f,
                    0x51e1a24709081231,
                    0x2259d6b14729c0fa,
                ])),
                Felt::new(BigInteger256([
                    0x68c3488912edefaa,
                    0x8d087f6872aabf4f,
                    0x51e1a24709081231,
                    0x2259d6b14729c0fa,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xa043d51a3b3302b4,
                    0xe6e04ce59b64d6bb,
                    0xbf46770ce098fe4f,
                    0x1484dfb5c17748f1,
                ])),
                Felt::new(BigInteger256([
                    0xec469f5d7daf3edf,
                    0x40280d293b4c7ebf,
                    0xee5a67a049b3b716,
                    0x25ccb33ae92ad0b2,
                ])),
                Felt::new(BigInteger256([
                    0x54aaf10e16b355af,
                    0xa640e782b18f3aa2,
                    0xa1e0dbe02d2dff7b,
                    0x025f38143e043b15,
                ])),
                Felt::new(BigInteger256([
                    0x2c20852131a058ab,
                    0xdaefceae01ac9930,
                    0x9da1554d550d3fa5,
                    0x0d2daef55e71569a,
                ])),
                Felt::new(BigInteger256([
                    0x3f22ad0cd63e3f72,
                    0xd2187aaff3591d7f,
                    0x9a1c22ba4557c95e,
                    0x002766500e14402e,
                ])),
                Felt::new(BigInteger256([
                    0xba52b2e02ff596a1,
                    0xdafce2197da8f78c,
                    0xa4909334fc3130d4,
                    0x17ffb20c5c01c839,
                ])),
                Felt::new(BigInteger256([
                    0x67bbd4959cc34ccf,
                    0xda5d700d25fe3ffc,
                    0x90ffaa6e0014ffd5,
                    0x20778777b3b6ffdc,
                ])),
                Felt::new(BigInteger256([
                    0x9d0849d71c6bd88c,
                    0x33b9b03268ee5072,
                    0xc45415ca1ea74b8e,
                    0x03444c286ef4aab5,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xfd1d430909c000d1,
                    0xe8ac70eec93810a8,
                    0x008b02fbe3c219bb,
                    0x094883c71ae89326,
                ])),
                Felt::new(BigInteger256([
                    0x15aef6679fccf6df,
                    0x8ad706b69f73f681,
                    0x6124336911aadba8,
                    0x17a8a0b6b45d3095,
                ])),
                Felt::new(BigInteger256([
                    0x09c7e3bb57827e38,
                    0x741507a842798c98,
                    0xc85e5b2daa5f4d87,
                    0x2bc14d6fd4d8b396,
                ])),
                Felt::new(BigInteger256([
                    0xbb2904ecb20de0db,
                    0x6558dac7d88c3d23,
                    0x95f6c4ef034838db,
                    0x08e003ee82e148c1,
                ])),
                Felt::new(BigInteger256([
                    0x208ad7f4502aff0f,
                    0xa8e259412c6dd969,
                    0x77c6377ba1372e75,
                    0x168344e88100c067,
                ])),
                Felt::new(BigInteger256([
                    0xc925b19569ada841,
                    0x2fdc4f624e25a13a,
                    0xc353bc83d591917f,
                    0x29edd92c9bbc9cb3,
                ])),
                Felt::new(BigInteger256([
                    0x8d717f7a2660b859,
                    0x26d14fb1c16c5ccc,
                    0x73e29ccf4c0231a6,
                    0x1b77a61fe56e6269,
                ])),
                Felt::new(BigInteger256([
                    0xe54aaaa283c90806,
                    0x20c0399d61581646,
                    0xe360e34580c826c7,
                    0x158a64a3c8aa7a3c,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xa8597f121b5512eb,
                    0xb3339b5879b7e58c,
                    0x7d99d32f8a15f4e6,
                    0x0cd877716255bc62,
                ])),
                Felt::new(BigInteger256([
                    0x1be80231922fc6d2,
                    0x25c1b9f529e06cc3,
                    0x46cef28b17e62fb8,
                    0x1d4609adf49dde05,
                ])),
                Felt::new(BigInteger256([
                    0xe1bd73f20c692d66,
                    0x66c109321948834f,
                    0x1751cbfb832a1a3b,
                    0x2d43b33282e02a2d,
                ])),
                Felt::new(BigInteger256([
                    0x322d6f9ec2596375,
                    0xb32af241bca3d93d,
                    0x20e6dea6236b3c28,
                    0x0b1bfc58c2943560,
                ])),
                Felt::new(BigInteger256([
                    0x44a1e6d40b1ee57b,
                    0x970f8c5b0bff7382,
                    0x0e97af437ab8b655,
                    0x234f463403bfe63f,
                ])),
                Felt::new(BigInteger256([
                    0xe3c3b034261f7acc,
                    0xe9b5fa81033be3f4,
                    0x54681fbc63838a19,
                    0x20905bce66d2c86b,
                ])),
                Felt::new(BigInteger256([
                    0x8920bc4fd9ee0957,
                    0xc23865616ea06eaa,
                    0xee99165d34317b7e,
                    0x0ff375eaca45e54f,
                ])),
                Felt::new(BigInteger256([
                    0xa54452e4c686d14b,
                    0xd0c9e66e62f91659,
                    0xbebfa9c5fc72df0d,
                    0x1471b79fb8f7de8b,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x5f08cf8aa6b41d9e,
                    0x791fe8384abb28ca,
                    0xc020a0bad3435590,
                    0x2f0693181419ead0,
                ])),
                Felt::new(BigInteger256([
                    0xe5b22c4210e44441,
                    0x283a2527699798fa,
                    0x39609ae2f8fba949,
                    0x056a3e696592bac0,
                ])),
                Felt::new(BigInteger256([
                    0xf953c82e8b13fd58,
                    0x4fa55224f17966e6,
                    0x3070c95860686086,
                    0x0ae29dbb19c83672,
                ])),
                Felt::new(BigInteger256([
                    0x7da80c8370f081c2,
                    0x3ba7aae710eb6053,
                    0xf7d52b56a12e61c9,
                    0x1d1abdcacdd36536,
                ])),
                Felt::new(BigInteger256([
                    0xf10447e22c4a1d9e,
                    0x10e04a690af68b32,
                    0xa3dc311d2b883668,
                    0x1b92311fa962152c,
                ])),
                Felt::new(BigInteger256([
                    0x46c2da4a5cffe055,
                    0xb217af52723a2bdc,
                    0x34fe235c0848095c,
                    0x2a1bd3f7eb4327a9,
                ])),
                Felt::new(BigInteger256([
                    0xaf254163784b4ee9,
                    0x95fd9d7fdc4dcb1d,
                    0x0f885e79f22ab87c,
                    0x2e93e2abdf252b97,
                ])),
                Felt::new(BigInteger256([
                    0xaea13d9b7ad1f75b,
                    0xbc190d9d0a27618c,
                    0xa14d735ec231963f,
                    0x14d8299d5c34f057,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x25ef93f56736020d,
                    0xc8479a34c17d0bd8,
                    0x054ab2353be31f1a,
                    0x077da659a0c91573,
                ])),
                Felt::new(BigInteger256([
                    0xff0ba674e3108ebf,
                    0xb438529307d3d1ff,
                    0xcf49caf7db730640,
                    0x0430a0edac9b06de,
                ])),
                Felt::new(BigInteger256([
                    0x65cbc69d107f4ad9,
                    0xd0a1836b8b48de6d,
                    0xa7e13425cf626da5,
                    0x240dc9bdbf525e51,
                ])),
                Felt::new(BigInteger256([
                    0x771a1b609213647c,
                    0x9834d30af4a8bf42,
                    0xfd66e9b9d9b92848,
                    0x293a8644800618db,
                ])),
                Felt::new(BigInteger256([
                    0x57baa533261d8580,
                    0x43a0f2cde7cc08f4,
                    0xf14dea953f8f4851,
                    0x2cfbfb496e37ca01,
                ])),
                Felt::new(BigInteger256([
                    0x8932142c006fcc6b,
                    0x3f07a95953cc7426,
                    0x5d8aa3d3598e0cd0,
                    0x1748616b98db7219,
                ])),
                Felt::new(BigInteger256([
                    0xb8757b416121cb26,
                    0xb7aba0384794e402,
                    0xfa4bf1f214a08ed1,
                    0x16d383281ccbbaf4,
                ])),
                Felt::new(BigInteger256([
                    0x2a7473210d16c0eb,
                    0x8c633f85edeba619,
                    0x46b814fbed61de46,
                    0x145f70260ed3b729,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xad18b5b0299344bd,
                    0x009c1379b2797038,
                    0x4587e89d50741cd7,
                    0x00083e95fb91412a,
                ])),
                Felt::new(BigInteger256([
                    0x70edcc6b59d8140a,
                    0x29f091dc8deb6826,
                    0xbbe0ab6514f97b2a,
                    0x14c26c1bc052cc20,
                ])),
                Felt::new(BigInteger256([
                    0x6010a594b5511dfd,
                    0x7731ccb25a1912e3,
                    0x9d46177f497da486,
                    0x24531408da1d9baa,
                ])),
                Felt::new(BigInteger256([
                    0x6e1577790d358973,
                    0xf777d9f9a320f030,
                    0x6997caa874a4e68c,
                    0x2918cbbc2be7c0b3,
                ])),
                Felt::new(BigInteger256([
                    0x3cdf478f9e727d9a,
                    0xd8cdd48bef2cb912,
                    0x42acb588603924e9,
                    0x2070d8695e8bda34,
                ])),
                Felt::new(BigInteger256([
                    0x0c078ebdb8278fc5,
                    0x696086a24138fd92,
                    0x82acff19a052f660,
                    0x0a39e25a3e61f4b6,
                ])),
                Felt::new(BigInteger256([
                    0xfb1f22e6bee80c42,
                    0xebe8bfd08b613fea,
                    0xb0298dd64ef74d4f,
                    0x0924ae2df5c377eb,
                ])),
                Felt::new(BigInteger256([
                    0x07bc65b0d73098bc,
                    0x9e0cd0ce4bb8d7a8,
                    0x409cb711b36ec391,
                    0x1d4bd3ba5028e430,
                ])),
            ],
        ];

        for i in input.iter_mut() {
            apply_sbox(i);
        }

        for (&i, o) in input.iter().zip(output) {
            assert_eq!(i, o);
        }
    }

    #[test]
    fn test_mds() {
        // Generated from https://github.com/Nashtare/anemoi-hash/
        let mut input = [
            [Felt::zero(); 8],
            [Felt::one(); 8],
            [
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
            ],
            [
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
            ],
            [
                Felt::new(BigInteger256([
                    0xdd3fef712f72c987,
                    0xd3ef0218495aeea4,
                    0xff204046546ec086,
                    0x08f9a4d2272edc76,
                ])),
                Felt::new(BigInteger256([
                    0xbe8ce4815e46bed7,
                    0x6a29bd389abcdc25,
                    0x103cd029ac9d2a3c,
                    0x00d1825701f3fa77,
                ])),
                Felt::new(BigInteger256([
                    0x60aeacc773844b2c,
                    0xeedc313dceb491ad,
                    0x3565b2e718e29639,
                    0x1ecef885addb214c,
                ])),
                Felt::new(BigInteger256([
                    0x06698c3dd50d155b,
                    0xffb51419b16f74c8,
                    0x8cab3e8606716b0d,
                    0x0475f2184ad8dcc6,
                ])),
                Felt::new(BigInteger256([
                    0x63b6821972633936,
                    0x319a802cb6f6b141,
                    0x2277eb475609a8be,
                    0x0a881edd1e4d6c55,
                ])),
                Felt::new(BigInteger256([
                    0x62c5f7107bbbf392,
                    0x2bfc07eeebb3c85f,
                    0x7e0d632ac826ece6,
                    0x2b9585dc4f4462c0,
                ])),
                Felt::new(BigInteger256([
                    0x4c1753011ebe1f04,
                    0xa3dbd9206532a06b,
                    0x225a79f56dafb798,
                    0x049d2bd92e05622b,
                ])),
                Felt::new(BigInteger256([
                    0xfb880f801a77bf1e,
                    0xbb5c791854a9ab9d,
                    0x7116dfebf5b2f661,
                    0x1f2fd3cfa9dd8f7b,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xdbbef199b77cd3a2,
                    0x06d94ff04d9449c2,
                    0x87850c68c9b4c3ba,
                    0x13a7b9e1b251d93e,
                ])),
                Felt::new(BigInteger256([
                    0x6b45f94b99597a2e,
                    0x969a164c84c6ab37,
                    0x146563b5a98954a6,
                    0x224eb37975b9350d,
                ])),
                Felt::new(BigInteger256([
                    0xd05a8581b499ae4c,
                    0x4f39f77d6834a18d,
                    0xf92f61240276c889,
                    0x227bef8ce9a0fc61,
                ])),
                Felt::new(BigInteger256([
                    0xd570bd265e982902,
                    0x2c79d5ed88831ef8,
                    0xe50bd44d61c10424,
                    0x27329aa864374595,
                ])),
                Felt::new(BigInteger256([
                    0x9ec8b62e8e956f06,
                    0xe54b7bfddd6a3d10,
                    0xe1bc6c0b132f900c,
                    0x1d02fba027a7256e,
                ])),
                Felt::new(BigInteger256([
                    0x3e677d7a23870808,
                    0xdf6e4626ac5c33b6,
                    0x2d327270b55a57be,
                    0x0e374c5c02632fab,
                ])),
                Felt::new(BigInteger256([
                    0xbc5ca1a67e0df185,
                    0xac48559eca92ac58,
                    0x233001c5ea9223b5,
                    0x11845d5267e62c1f,
                ])),
                Felt::new(BigInteger256([
                    0x4da112f3b773b71e,
                    0x0364fff60a0b854f,
                    0x6f8315723ebe28d0,
                    0x1195e0eb83ed9f83,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x15cb16b401147dfa,
                    0x83160dafd35b19d0,
                    0xcaa287713e1f0b73,
                    0x22cf6d6386004365,
                ])),
                Felt::new(BigInteger256([
                    0xa115b7efea2facfe,
                    0x5c72f543204c238c,
                    0xc2fc51b05c2efdd8,
                    0x18172eade7ff5b51,
                ])),
                Felt::new(BigInteger256([
                    0x03f331ec5895e820,
                    0x0a5eddd192a206cc,
                    0x7c17e2fd9b33a93a,
                    0x1db6ed0edad31964,
                ])),
                Felt::new(BigInteger256([
                    0x5e9598a02fa4252f,
                    0xf8681d91fef5aa5e,
                    0x1e57fa37fc1c4d94,
                    0x06ceee12dd326954,
                ])),
                Felt::new(BigInteger256([
                    0x1648793e4d005595,
                    0x4c545f20701293d3,
                    0x8ff588b670f6694f,
                    0x04e440919baab8fd,
                ])),
                Felt::new(BigInteger256([
                    0x2a0488b7e9a6c665,
                    0x09de54695d68526b,
                    0x41e0c76b5942802b,
                    0x02cf1aab0b4d32db,
                ])),
                Felt::new(BigInteger256([
                    0xdb52660549a8c268,
                    0xc7287611443b972f,
                    0x77dc15b0dabe60a1,
                    0x1ea79480f216a465,
                ])),
                Felt::new(BigInteger256([
                    0xeb72063a4cfba65b,
                    0x513e6fa6cbde9200,
                    0x92c95dd36b7f979f,
                    0x29f44d9cd4672835,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xb01fd35762c81637,
                    0x7e13de94984eae4c,
                    0x4648c594aa524db3,
                    0x1046f57a35b6a2ee,
                ])),
                Felt::new(BigInteger256([
                    0xf98cb69165fe19da,
                    0xce950151b4703cea,
                    0xf5125c418eb447b4,
                    0x14a591312b74bfdf,
                ])),
                Felt::new(BigInteger256([
                    0xf2f79c65fc27dc67,
                    0xf5b7c4d05bf0a0ad,
                    0x2df6688ffe37ce83,
                    0x11127783911705b5,
                ])),
                Felt::new(BigInteger256([
                    0xa9831711320be405,
                    0xba1a0cd0942f20ea,
                    0x00ee8b89e440e389,
                    0x0379abd561070b17,
                ])),
                Felt::new(BigInteger256([
                    0xa2abf4d05452e86d,
                    0x972a7fadfe67f028,
                    0x2c875ff978381455,
                    0x0fd6856c2830a2f3,
                ])),
                Felt::new(BigInteger256([
                    0xb5a2012ab445c5c7,
                    0x537a78bd51a365e1,
                    0x191d9c59d2d49d35,
                    0x2fa32fa70ffb6e8c,
                ])),
                Felt::new(BigInteger256([
                    0xfb6a68e505ffa5ac,
                    0xc251826ab00dd0e7,
                    0xa6009cce28fd38da,
                    0x13eeff35d148c7fc,
                ])),
                Felt::new(BigInteger256([
                    0x5c18e1127804b52e,
                    0x80a5152e65ec0c94,
                    0x05d7b0985b6aeb47,
                    0x137189de88fb77a6,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x7fc5bc8a1a1db36a,
                    0xab44eb57f9d7715c,
                    0xb11772ac408b2499,
                    0x03207f3c5c1a8e6c,
                ])),
                Felt::new(BigInteger256([
                    0xebf1aeec73487655,
                    0xfd8010d5a52eab45,
                    0xf67f956a12c15d14,
                    0x1f65f167de04afb5,
                ])),
                Felt::new(BigInteger256([
                    0x7594d29c6ae2301f,
                    0x26da60dc1915fe30,
                    0x089453516ae5ecb3,
                    0x1def12e6f036b44f,
                ])),
                Felt::new(BigInteger256([
                    0x43beef3909879e25,
                    0xa131ebdc8df27433,
                    0x68bbb093facf45b4,
                    0x06a710d2e0b25979,
                ])),
                Felt::new(BigInteger256([
                    0x839284b3f04c3ba4,
                    0x10562682a36f6a76,
                    0xcf2f3c4dd52d3aed,
                    0x13f13a3abccaabfe,
                ])),
                Felt::new(BigInteger256([
                    0xdaa1e8a2dfa7233c,
                    0x1750d107826bf873,
                    0x1a3769531c8a44e2,
                    0x022ea388512bd2d6,
                ])),
                Felt::new(BigInteger256([
                    0x3e2b5ee9253d20c6,
                    0x3fa449ef8344e589,
                    0x06d45e3f04724da9,
                    0x1826f6905e667a7c,
                ])),
                Felt::new(BigInteger256([
                    0x1f5636ff30b2ba0c,
                    0x819ca39b5636ffe7,
                    0x220733ebe7dbb788,
                    0x1cdc07d011a90e4d,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x314af81154d61b53,
                    0x9a7270f70027f775,
                    0x86d5df34fb1e50eb,
                    0x2372eba2d215d636,
                ])),
                Felt::new(BigInteger256([
                    0x3cb5df1660dfdd08,
                    0xd210c5f84bb9337a,
                    0x7a11ffee4753f7e0,
                    0x2cdd4516d2796a23,
                ])),
                Felt::new(BigInteger256([
                    0x7f36d4eca87a8caa,
                    0xc70c73df9ca61509,
                    0xf423feb21f600b3c,
                    0x189c230cef196846,
                ])),
                Felt::new(BigInteger256([
                    0x8c1099a73842f801,
                    0xea8797f921d99662,
                    0x6c1cd3d88c440be0,
                    0x2093e34e5ae5c484,
                ])),
                Felt::new(BigInteger256([
                    0x338e0374b2a38ef1,
                    0xc7178d7aabba7a44,
                    0x40afda51b7d389b5,
                    0x016e9e692c4fecee,
                ])),
                Felt::new(BigInteger256([
                    0x08ec8a33f8fb5ec0,
                    0x7f9b8fc2a77a8460,
                    0x246dfae31b681778,
                    0x190210824b3b664c,
                ])),
                Felt::new(BigInteger256([
                    0x0c1f2aaefe629a4a,
                    0x79629b24d9c932e5,
                    0xa11ecbc897d1b594,
                    0x13c3a1abb57cf497,
                ])),
                Felt::new(BigInteger256([
                    0x1a1e2b135f1ed3a3,
                    0x536d257b30cc6684,
                    0x2bbd4c3856495983,
                    0x01ac9896a00bc30c,
                ])),
            ],
        ];

        let mut input2 = input;

        let output = [
            [Felt::zero(); 8],
            [
                Felt::new(BigInteger256([
                    0x4f4bc0b2b5ef64bd,
                    0x1a4b98fbe78db996,
                    0x5c65ec9f484e3a79,
                    0x0180a96573d3d9f8,
                ])),
                Felt::new(BigInteger256([
                    0x4f4bc0b2b5ef64bd,
                    0x1a4b98fbe78db996,
                    0x5c65ec9f484e3a79,
                    0x0180a96573d3d9f8,
                ])),
                Felt::new(BigInteger256([
                    0x4f4bc0b2b5ef64bd,
                    0x1a4b98fbe78db996,
                    0x5c65ec9f484e3a79,
                    0x0180a96573d3d9f8,
                ])),
                Felt::new(BigInteger256([
                    0x4f4bc0b2b5ef64bd,
                    0x1a4b98fbe78db996,
                    0x5c65ec9f484e3a79,
                    0x0180a96573d3d9f8,
                ])),
                Felt::new(BigInteger256([
                    0x4f4bc0b2b5ef64bd,
                    0x1a4b98fbe78db996,
                    0x5c65ec9f484e3a79,
                    0x0180a96573d3d9f8,
                ])),
                Felt::new(BigInteger256([
                    0x4f4bc0b2b5ef64bd,
                    0x1a4b98fbe78db996,
                    0x5c65ec9f484e3a79,
                    0x0180a96573d3d9f8,
                ])),
                Felt::new(BigInteger256([
                    0x4f4bc0b2b5ef64bd,
                    0x1a4b98fbe78db996,
                    0x5c65ec9f484e3a79,
                    0x0180a96573d3d9f8,
                ])),
                Felt::new(BigInteger256([
                    0x4f4bc0b2b5ef64bd,
                    0x1a4b98fbe78db996,
                    0x5c65ec9f484e3a79,
                    0x0180a96573d3d9f8,
                ])),
            ],
            [
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::new(BigInteger256([
                    0x4f4bc0b2b5ef64bd,
                    0x1a4b98fbe78db996,
                    0x5c65ec9f484e3a79,
                    0x0180a96573d3d9f8,
                ])),
                Felt::new(BigInteger256([
                    0x4f4bc0b2b5ef64bd,
                    0x1a4b98fbe78db996,
                    0x5c65ec9f484e3a79,
                    0x0180a96573d3d9f8,
                ])),
                Felt::new(BigInteger256([
                    0x4f4bc0b2b5ef64bd,
                    0x1a4b98fbe78db996,
                    0x5c65ec9f484e3a79,
                    0x0180a96573d3d9f8,
                ])),
                Felt::new(BigInteger256([
                    0x4f4bc0b2b5ef64bd,
                    0x1a4b98fbe78db996,
                    0x5c65ec9f484e3a79,
                    0x0180a96573d3d9f8,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x4f4bc0b2b5ef64bd,
                    0x1a4b98fbe78db996,
                    0x5c65ec9f484e3a79,
                    0x0180a96573d3d9f8,
                ])),
                Felt::new(BigInteger256([
                    0x4f4bc0b2b5ef64bd,
                    0x1a4b98fbe78db996,
                    0x5c65ec9f484e3a79,
                    0x0180a96573d3d9f8,
                ])),
                Felt::new(BigInteger256([
                    0x4f4bc0b2b5ef64bd,
                    0x1a4b98fbe78db996,
                    0x5c65ec9f484e3a79,
                    0x0180a96573d3d9f8,
                ])),
                Felt::new(BigInteger256([
                    0x4f4bc0b2b5ef64bd,
                    0x1a4b98fbe78db996,
                    0x5c65ec9f484e3a79,
                    0x0180a96573d3d9f8,
                ])),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
            ],
            [
                Felt::new(BigInteger256([
                    0x344646241b6c6180,
                    0x836ef3882d5d81f0,
                    0x67d9ec19c4a40003,
                    0x2466a00a84320fb0,
                ])),
                Felt::new(BigInteger256([
                    0x87adec0131c09407,
                    0x3cbbb2613fef58c4,
                    0xa4097b394e2d7fc9,
                    0x1314ff10d9dbca8b,
                ])),
                Felt::new(BigInteger256([
                    0x211e3954e9ce32d3,
                    0x3d6b16a07a9eada3,
                    0x38b79cc04c87a8ad,
                    0x07486cd46bbc063c,
                ])),
                Felt::new(BigInteger256([
                    0x0a8e32da6aa04386,
                    0x45894f39cb7e3ba6,
                    0xdbd5ac67fbbf9200,
                    0x0ab6e843bd1dd1bc,
                ])),
                Felt::new(BigInteger256([
                    0x58cfd730759941e6,
                    0xac5d7ea34e3a3eb0,
                    0x795cd3612056dac1,
                    0x2d6219066989e88e,
                ])),
                Felt::new(BigInteger256([
                    0x82fca7a107b9336f,
                    0x7fdd2aaab18fa802,
                    0x299888cce366bd10,
                    0x2a70e39f5eb61215,
                ])),
                Felt::new(BigInteger256([
                    0x90cf60902f9341f6,
                    0x017fbf6141bc39c5,
                    0x861873fc2216eefb,
                    0x2df1e50b2e60a77f,
                ])),
                Felt::new(BigInteger256([
                    0x9ce1a967f18bb055,
                    0x10df65f131b75da9,
                    0x0f8e10fd5624dee2,
                    0x0bba8c8223a06161,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x7789fd0073de3052,
                    0x634f2cba9a866acb,
                    0x5c2b987497695469,
                    0x2ef4e2a2a32c572a,
                ])),
                Felt::new(BigInteger256([
                    0x893c9d8bcfa60048,
                    0xf54dff3044f73dca,
                    0x8cfa7bd4c69b0f2f,
                    0x0c95cc30b9f7c7af,
                ])),
                Felt::new(BigInteger256([
                    0xae98e162ec43f800,
                    0xef2f05eb786d2b7d,
                    0x49346289ee37f09e,
                    0x1658de998ee112f5,
                ])),
                Felt::new(BigInteger256([
                    0x0849018104a106c8,
                    0xf02f8ea9767b799f,
                    0x9fa8b4b37fe76950,
                    0x255a50583a17fd6d,
                ])),
                Felt::new(BigInteger256([
                    0xbdfec34f32c5bd06,
                    0x7bdecff6e9ef4237,
                    0xabad1218d2737422,
                    0x08c3730d45852aa0,
                ])),
                Felt::new(BigInteger256([
                    0x8a8481380c47a439,
                    0xe98c4ae1c3a3b1d1,
                    0x6d22bb336cbbc320,
                    0x26fd7dac7fe8652e,
                ])),
                Felt::new(BigInteger256([
                    0x260d90dc56471035,
                    0x7d6333facf0299bc,
                    0xa493e043795622c0,
                    0x1ecbf05525aa6852,
                ])),
                Felt::new(BigInteger256([
                    0xc68b97a3239984e4,
                    0xf87698216c2ac44b,
                    0x333796f156e5f8eb,
                    0x223c087dc33c4b8f,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x6246e42f7a627037,
                    0xae7c422944e8b4f5,
                    0x70360257c20793c3,
                    0x29f8a381f8d9cd29,
                ])),
                Felt::new(BigInteger256([
                    0xef33baf41bd46195,
                    0x1a5ff793f1956cdd,
                    0xb2baee4e25745b7e,
                    0x1aad54b46ba33112,
                ])),
                Felt::new(BigInteger256([
                    0xbcfe7b7fbf7b1868,
                    0x57c7b6d85fdcefc8,
                    0x4fb91005a396fe26,
                    0x213d5699d86f3afc,
                ])),
                Felt::new(BigInteger256([
                    0x0e0410b48562bdb0,
                    0x8cfc6f889179c004,
                    0xba49fcdf3fb0474e,
                    0x21c494a62015cf0d,
                ])),
                Felt::new(BigInteger256([
                    0xa6d34ebf034ddbb4,
                    0x297df206b8b533fb,
                    0x1e8fa7795ae09b3e,
                    0x23436f34b6cf1251,
                ])),
                Felt::new(BigInteger256([
                    0x35426ccd151c69d5,
                    0x372936a3a0067d8b,
                    0x37e2957cb270f303,
                    0x2a6d64cf3e8936fe,
                ])),
                Felt::new(BigInteger256([
                    0x6f79aaca9949d564,
                    0xd7c604aaf290fb1f,
                    0x9d742b061c33726e,
                    0x2fa4e4219a8cf3c6,
                ])),
                Felt::new(BigInteger256([
                    0xc8c5b0544ef79ebf,
                    0x7a39445b17c6a06b,
                    0x98a97e23bc2f1025,
                    0x014e334983942c9d,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x50047bd17ebc97a7,
                    0xcee5256758bbc4c6,
                    0xe1c34fdd60b784af,
                    0x211a2abfc53cef53,
                ])),
                Felt::new(BigInteger256([
                    0x13c96f09161903a9,
                    0x1b3b10ef99395fc7,
                    0x3f6fe6ecd2e36e09,
                    0x2d1bf25b3e8c2464,
                ])),
                Felt::new(BigInteger256([
                    0x711f65ac74c43fda,
                    0xe8b5bd9c6d2a3fd8,
                    0x2a0d089ae03773d7,
                    0x124224fb1d8655f5,
                ])),
                Felt::new(BigInteger256([
                    0xad62148fa44dc897,
                    0x877c6756d84c95fc,
                    0x4a9eb7e4a3a07b77,
                    0x0f7a8d56de88fe91,
                ])),
                Felt::new(BigInteger256([
                    0x9ce066611dd09741,
                    0x161164da8f6bc0c4,
                    0x2772e92196cbe087,
                    0x08cbe785c8382e31,
                ])),
                Felt::new(BigInteger256([
                    0xcd3f06bce18787ed,
                    0x0db556e765ecc53d,
                    0x6efecb8ce750c2f7,
                    0x1465e91655d15086,
                ])),
                Felt::new(BigInteger256([
                    0xa7e66ea2bd6b2258,
                    0x3f34cde2de6edb90,
                    0x2dab4e8c6fbfdb7f,
                    0x2d2e80e1a1686f2a,
                ])),
                Felt::new(BigInteger256([
                    0xaf0bc6b7f32f2141,
                    0x2ab2fd17a895bdef,
                    0x7a3c76952ac3dbfe,
                    0x107f65c1d21b27ed,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xa9dcc62ccec769de,
                    0xab0cac58aa25e082,
                    0x8252350816837b77,
                    0x11912c04fa4072d9,
                ])),
                Felt::new(BigInteger256([
                    0x2c3509826715ffb5,
                    0xd10ba0e15f3e1b65,
                    0x2b815c31b365eaa0,
                    0x23a05536c2be2214,
                ])),
                Felt::new(BigInteger256([
                    0x04732f8151849d89,
                    0xe81380c6b95fc1d4,
                    0x465d1e0f1c0ce21e,
                    0x2840598460c8f970,
                ])),
                Felt::new(BigInteger256([
                    0x47c4dd2cc165d6c1,
                    0xf581dbbfe413d705,
                    0xf79e76e51d0ae178,
                    0x1133c03b25e583c1,
                ])),
                Felt::new(BigInteger256([
                    0x69f02b7886347078,
                    0x5c2e0092cb898814,
                    0x620758e66d3901a8,
                    0x2f18bb8346e12d95,
                ])),
                Felt::new(BigInteger256([
                    0x7c4b410b2483c140,
                    0xf8dcd883d6bb0e9e,
                    0xa53fbb52e94498f6,
                    0x02a8c0891ac518f5,
                ])),
                Felt::new(BigInteger256([
                    0x9a6d91869f0aa3ec,
                    0x507e74d8b76976c6,
                    0xc981d2300071b47a,
                    0x1cd6cfe6c99b8f18,
                ])),
                Felt::new(BigInteger256([
                    0x842c2be2230ed6bb,
                    0x65413686f5b4ce0a,
                    0x34342cbf2dab38a2,
                    0x0bd4f6fb5c29be37,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x201e1d9b4d800496,
                    0x5c2d3c5448f2edf5,
                    0x4c4541371ff92172,
                    0x21b2e6f30eacddce,
                ])),
                Felt::new(BigInteger256([
                    0x776c9f2a166eb691,
                    0xdf7e12698ac33173,
                    0xf9b02d166a91ac2b,
                    0x2f68b7dd68d95d6f,
                ])),
                Felt::new(BigInteger256([
                    0xf75c3f8772986006,
                    0x67242ad897c24002,
                    0x4291342ef055e6c3,
                    0x14b824a6ff9ef6d2,
                ])),
                Felt::new(BigInteger256([
                    0xc3e99e4fe6547e46,
                    0x203b4639ed9f09b3,
                    0xe24198266e250cce,
                    0x2604887a1a74272f,
                ])),
                Felt::new(BigInteger256([
                    0xa7d18950f5094fdc,
                    0x5d9db3bc7d9a288c,
                    0x26c6a85b05c5c4d7,
                    0x04067023e48e079d,
                ])),
                Felt::new(BigInteger256([
                    0x2fdde319fcc0ad81,
                    0xaaceb5ba879685f7,
                    0x4ae531e0acf7b831,
                    0x028b0bb5cd778411,
                ])),
                Felt::new(BigInteger256([
                    0x0ba1aacf4de6f464,
                    0x56e0cec6e7f3ed1d,
                    0x2804f43d095f822c,
                    0x0fa1a021c0e61a06,
                ])),
                Felt::new(BigInteger256([
                    0x66f2d829ed439fe7,
                    0x9c3e596730bacd6d,
                    0x72430bb88439c083,
                    0x16996d93e176e564,
                ])),
            ],
        ];

        for i in input.iter_mut() {
            apply_mds(i);
        }
        for i in input2.iter_mut() {
            apply_naive_mds(i);
        }

        for (index, (&i_1, i_2)) in input.iter().zip(input2).enumerate() {
            assert_eq!(output[index], i_1);
            assert_eq!(output[index], i_2);
        }
    }
}
