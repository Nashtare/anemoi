use super::{mul_by_generator, sbox, BigInteger256, Felt};
use crate::{Jive, Sponge};
use ark_ff::{Field, One, Zero};
use unroll::unroll_for_loops;

/// Digest for Anemoi
mod digest;
/// Sponge for Anemoi
mod hasher;
/// MDS matrix for Anemoi
mod mds;
/// Round constants for Anemoi
mod round_constants;

pub use digest::AnemoiDigest;
pub use hasher::AnemoiHash;

// ANEMOI CONSTANTS
// ================================================================================================

/// Function state is set to 8 field elements or 256 bytes.
/// 1 element of the state is reserved for capacity.
pub const STATE_WIDTH: usize = 8;
/// 7 elements of the state are reserved for rate.
pub const RATE_WIDTH: usize = 7;

/// The state is divided into two even-length rows.
pub const NUM_COLUMNS: usize = 4;

/// 2 elements (64-bytes) are returned as digest.
pub const DIGEST_SIZE: usize = 2;

/// The number of rounds is set to 14 to provide 256-bit security level.
pub const NUM_HASH_ROUNDS: usize = 14;

// HELPER FUNCTIONS
// ================================================================================================

#[inline(always)]
/// Applies exponentiation of the current hash
/// state elements with the Anemoi S-Box.
pub(crate) fn apply_sbox(state: &mut [Felt; STATE_WIDTH]) {
    let mut x: [Felt; NUM_COLUMNS] = state[..NUM_COLUMNS].try_into().unwrap();
    let mut y: [Felt; NUM_COLUMNS] = state[NUM_COLUMNS..].try_into().unwrap();

    x.iter_mut().enumerate().for_each(|(i, t)| {
        let y2 = y[i].square();
        *t -= y2.double() + y2
    });

    let mut x_alpha_inv = x;
    x_alpha_inv
        .iter_mut()
        .for_each(|t| *t = sbox::exp_inv_alpha(t));

    y.iter_mut()
        .enumerate()
        .for_each(|(i, t)| *t -= x_alpha_inv[i]);

    x.iter_mut().enumerate().for_each(|(i, t)| {
        let y2 = y[i].square();
        *t += y2.double() + y2 + sbox::DELTA
    });

    state[..NUM_COLUMNS].copy_from_slice(&x);
    state[NUM_COLUMNS..].copy_from_slice(&y);
}

#[inline(always)]
/// Applies matrix-vector multiplication of the current
/// hash state with the Anemoi MDS matrix.
pub(crate) fn apply_mds(state: &mut [Felt; STATE_WIDTH]) {
    let x: [Felt; NUM_COLUMNS] = [state[0], state[1], state[2], state[3]];
    let y: [Felt; NUM_COLUMNS] = [state[5], state[6], state[7], state[4]];

    let g_x0 = mul_by_generator(&x[0]);
    let g_x1 = mul_by_generator(&x[1]);
    let g_x2 = mul_by_generator(&x[2]);
    let g_x3 = mul_by_generator(&x[3]);
    let g_squared_x0 = mul_by_generator(&g_x0);
    let g_squared_x1 = mul_by_generator(&g_x1);

    state[0] = x[0] + x[1] + g_x1 + g_x2 + g_x3;
    state[2] = g_squared_x0 + g_squared_x1 + x[2] + x[3] + g_x3;
    state[1] = state[2] + g_x1 + g_x2 + g_x3;
    state[3] = state[0] + g_x0 + g_x1 + x[3];

    let g_y0 = mul_by_generator(&y[0]);
    let g_y1 = mul_by_generator(&y[1]);
    let g_y2 = mul_by_generator(&y[2]);
    let g_y3 = mul_by_generator(&y[3]);
    let g_squared_y0 = mul_by_generator(&g_y0);
    let g_squared_y1 = mul_by_generator(&g_y1);

    state[4] = y[0] + y[1] + g_y1 + g_y2 + g_y3;
    state[6] = g_squared_y0 + g_squared_y1 + y[2] + y[3] + g_y3;
    state[5] = state[6] + g_y1 + g_y2 + g_y3;
    state[7] = state[4] + g_y0 + g_y1 + y[3];
}

// ANEMOI PERMUTATION
// ================================================================================================

/// Applies Anemoi permutation to the provided state.
#[inline(always)]
#[unroll_for_loops]
pub(crate) fn apply_permutation(state: &mut [Felt; STATE_WIDTH]) {
    for i in 0..NUM_HASH_ROUNDS {
        apply_round(state, i);
    }

    apply_mds(state)
}

/// Anemoi round function;
/// implementation based on algorithm 3 of <https://eprint.iacr.org/2020/1143.pdf>
#[inline(always)]
#[unroll_for_loops]
pub(crate) fn apply_round(state: &mut [Felt; STATE_WIDTH], step: usize) {
    // determine which round constants to use
    let c = &round_constants::C[step % NUM_HASH_ROUNDS];
    let d = &round_constants::D[step % NUM_HASH_ROUNDS];

    for i in 0..NUM_COLUMNS {
        state[i] += c[i];
        state[NUM_COLUMNS + i] += d[i];
    }

    apply_mds(state);
    apply_sbox(state);
}

#[cfg(test)]
mod tests {
    use super::*;

    fn apply_naive_mds(state: &mut [Felt; STATE_WIDTH]) {
        let x: [Felt; NUM_COLUMNS] = state[..NUM_COLUMNS].try_into().unwrap();
        let mut y: [Felt; NUM_COLUMNS] = [Felt::zero(); NUM_COLUMNS];
        y[0..NUM_COLUMNS - 1].copy_from_slice(&state[NUM_COLUMNS + 1..]);
        y[NUM_COLUMNS - 1] = state[NUM_COLUMNS];

        let mut result = [Felt::zero(); STATE_WIDTH];
        for (i, r) in result.iter_mut().enumerate().take(NUM_COLUMNS) {
            for (j, s) in x.into_iter().enumerate().take(NUM_COLUMNS) {
                *r += s * mds::MDS[i * NUM_COLUMNS + j];
            }
        }
        for (i, r) in result.iter_mut().enumerate().skip(NUM_COLUMNS) {
            for (j, s) in y.into_iter().enumerate() {
                *r += s * mds::MDS[(i - NUM_COLUMNS) * NUM_COLUMNS + j];
            }
        }

        state.copy_from_slice(&result);
    }

    #[test]
    fn test_sbox() {
        // Generated from https://github.com/Nashtare/anemoi-hash/
        let mut input = [
            [Felt::zero(); 8],
            [Felt::one(); 8],
            [
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
            ],
            [
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
            ],
            [
                Felt::new(BigInteger256([
                    0x2e695b6017515388,
                    0xbdfed53ea60da483,
                    0x72cdcf54cb982845,
                    0x009fb4372b1cc4c5,
                ])),
                Felt::new(BigInteger256([
                    0xd00227842b985882,
                    0x7fc1eb6df34f2205,
                    0xab0a6c5e9ff5e9e2,
                    0x2e5102b7c9a9685e,
                ])),
                Felt::new(BigInteger256([
                    0x44dd59b598ba544a,
                    0x47b54a2170e033fb,
                    0x3b605b2f8706c34c,
                    0x0cb238286772de8a,
                ])),
                Felt::new(BigInteger256([
                    0xdc3fbd888996ca4a,
                    0xefbfbaaf569b6de2,
                    0x8453331283c84f21,
                    0x14a90a5fdc9a78c0,
                ])),
                Felt::new(BigInteger256([
                    0x989d23c949bedc2b,
                    0xe816b2906e98736c,
                    0x9638f9d4d6324890,
                    0x1d27a988d0afe007,
                ])),
                Felt::new(BigInteger256([
                    0x5ca1dccdb8c33076,
                    0xf39751e950257e7a,
                    0x84ec6f9dd2d8dc79,
                    0x20a19964680e3736,
                ])),
                Felt::new(BigInteger256([
                    0x47c67d6bf889def6,
                    0xf300b84db6c2b389,
                    0x6ac849dbf95502a6,
                    0x2a1ab4e0da5a4885,
                ])),
                Felt::new(BigInteger256([
                    0x33baa23d0dcb07a9,
                    0x8a89413c083e4623,
                    0x613de74d4fe751d6,
                    0x035a7d78ebf0a94d,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xaebd34e47f529b29,
                    0xe89b1fda72d3a93d,
                    0x014b4607cf05252d,
                    0x12a632605fdf5373,
                ])),
                Felt::new(BigInteger256([
                    0x6af54dee7832a2f5,
                    0xdf027a1ab5b57d7a,
                    0xc2ffdd1cb9b4b8c2,
                    0x207c27462f8ed7e6,
                ])),
                Felt::new(BigInteger256([
                    0xa493418087c732f1,
                    0xc725ee21db0bdcc1,
                    0x72ffe3b4fd66c646,
                    0x0e9eec25931aa3d2,
                ])),
                Felt::new(BigInteger256([
                    0xba7c9ff43fc8bab5,
                    0x6b493064424e408a,
                    0x3439a10c55ad0cc1,
                    0x211267ee0f30632a,
                ])),
                Felt::new(BigInteger256([
                    0x826725ed8056bf40,
                    0x894e69e96158041a,
                    0xd47e11f2dcb7b047,
                    0x1364cab963504017,
                ])),
                Felt::new(BigInteger256([
                    0x390c64568a826970,
                    0x8b137490df8a0575,
                    0x504be268872c80eb,
                    0x1c9e97d2cfd64eae,
                ])),
                Felt::new(BigInteger256([
                    0xab4b47ebc0345ed6,
                    0x8e03eb8cf356d145,
                    0xb91ac33649b93b78,
                    0x22272962c5bc5e8f,
                ])),
                Felt::new(BigInteger256([
                    0x5f810a979d53f540,
                    0x514619dff02c1237,
                    0xf8873e095d55df92,
                    0x07986484aab4be05,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xd65b6fc177c63248,
                    0xe3baeaee585b199f,
                    0x1db8d7865d3a5b19,
                    0x0d054c8625d9fbaa,
                ])),
                Felt::new(BigInteger256([
                    0x936159bcdc75b11d,
                    0x066cc7d7db1b1aab,
                    0x3d300c3b118f5639,
                    0x1dcc497f00ecf418,
                ])),
                Felt::new(BigInteger256([
                    0x70c8536c0b43656f,
                    0x5d88bc127d16f210,
                    0xf767a53c5d91529f,
                    0x20d55107254d5fc4,
                ])),
                Felt::new(BigInteger256([
                    0x56ed818cfabf0cb9,
                    0xc0855c9bc60cf51c,
                    0x5b35e117b83c7cf0,
                    0x17c4a94d82d68299,
                ])),
                Felt::new(BigInteger256([
                    0x8e2fe8b8856a0548,
                    0x3e30ec4ece6bbfa6,
                    0xf94494cac98db21b,
                    0x2dbbe6285de68eb9,
                ])),
                Felt::new(BigInteger256([
                    0x13a5457fa60ec329,
                    0x3495904cfcbae1f1,
                    0x296fe781f6118b2e,
                    0x21792487a1f38183,
                ])),
                Felt::new(BigInteger256([
                    0xa6f784a8e3e8fd04,
                    0x37ecb788dc91a489,
                    0xc9aca57cfcab3f80,
                    0x176e394d0371a7a6,
                ])),
                Felt::new(BigInteger256([
                    0xdf25869fde917b8d,
                    0xb8e607f8d4c0dd9a,
                    0x25726dc877903479,
                    0x0534e3d378b03400,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xd610447098f60bb4,
                    0xd0d3e86a407a44e3,
                    0xc876acc47533f5ce,
                    0x19905e4dae9ee9aa,
                ])),
                Felt::new(BigInteger256([
                    0x2b7dcbec933fc7b6,
                    0x3ed7079893b084d1,
                    0xebbcaf277a4b5c51,
                    0x23ec633c2d34e459,
                ])),
                Felt::new(BigInteger256([
                    0xd5e0eda3a06cbf25,
                    0xcea66af5aea945eb,
                    0xb0e57e217b2b7703,
                    0x15650f73d2d0811b,
                ])),
                Felt::new(BigInteger256([
                    0xf20fdeca41d69d68,
                    0xd9c11016e0ae87da,
                    0x90b00884f62a1719,
                    0x020d5591d5c253a6,
                ])),
                Felt::new(BigInteger256([
                    0x48f63c813bc0b5b0,
                    0x7f7ad26628a72454,
                    0x89ded0dffe484dd4,
                    0x2357b5877621fda2,
                ])),
                Felt::new(BigInteger256([
                    0x620c27a6c3134005,
                    0x0faa53c4b43c2873,
                    0x7e68e838ceb0de27,
                    0x0df354970add30c9,
                ])),
                Felt::new(BigInteger256([
                    0x52d4f6a0abfc2e72,
                    0xcbe43c54bd91acb2,
                    0xb60988ab94eafe57,
                    0x0ac13164976a1326,
                ])),
                Felt::new(BigInteger256([
                    0x7c03579d3adc6a86,
                    0xd0e550e3c3e7ad77,
                    0x9688e73fbab974f6,
                    0x138139e4a216b66a,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xef83ebc61444c87a,
                    0xe740b1a38077c8f8,
                    0x52c7fe9722b1c379,
                    0x2d71ceadab90f0d3,
                ])),
                Felt::new(BigInteger256([
                    0xca8e5e1da40e281b,
                    0xacc29df16c7905af,
                    0x849071085cdcad90,
                    0x24d63289ae7747dc,
                ])),
                Felt::new(BigInteger256([
                    0xb8038159b290f1b7,
                    0x4e30d32c02f418d8,
                    0x071363bc4da9a566,
                    0x110db50c305d8ffa,
                ])),
                Felt::new(BigInteger256([
                    0x9d8aef8e04fab460,
                    0x72f360bcde48bb24,
                    0x7b64006d1775b58e,
                    0x01a1763a931d4304,
                ])),
                Felt::new(BigInteger256([
                    0x87931419c20d5467,
                    0x8076844e1f0dc515,
                    0x6b79475a07a49a69,
                    0x1759b2f4e10a488e,
                ])),
                Felt::new(BigInteger256([
                    0x981bfd51ccfb10dc,
                    0x618c23a7843a76d1,
                    0xee479b4a70dfeac7,
                    0x200e8e5116604cf2,
                ])),
                Felt::new(BigInteger256([
                    0x9fce76bea0f70f77,
                    0xd929c74e820cb08e,
                    0x538a1fccacd70be2,
                    0x2d711eafc21969bf,
                ])),
                Felt::new(BigInteger256([
                    0xe58b82d59bdf72bb,
                    0x709a96db4f7a7938,
                    0xa70bc4810bbc00ee,
                    0x2073dc5d2707a4e6,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xd26be80f6e590028,
                    0xf498e9a8c015d2d0,
                    0x6669388a4c7429ce,
                    0x15c59a8e5125ac59,
                ])),
                Felt::new(BigInteger256([
                    0x7d5be96efab00315,
                    0x5f724bb56b4fa1bd,
                    0xcbe3571e91dae6a8,
                    0x284cac3333677c9c,
                ])),
                Felt::new(BigInteger256([
                    0x22ffd183b604a2ad,
                    0x73169686fd2a8042,
                    0xfe8b10b50ed2faf5,
                    0x02a12369468e4b1b,
                ])),
                Felt::new(BigInteger256([
                    0xe926040a3cb2a38e,
                    0xa875ebb350e0a630,
                    0x605c3852b769ab0a,
                    0x1353e8d60ff95f62,
                ])),
                Felt::new(BigInteger256([
                    0xa1f5b7053dd03ce3,
                    0x6844b09ea8887e4c,
                    0x9ce57da16a7373a5,
                    0x2a28b91a4c22aebf,
                ])),
                Felt::new(BigInteger256([
                    0xf12ab36f8d4c6ba7,
                    0x6bc3732b75f33da5,
                    0xefb94df981b2578e,
                    0x0566b4300ad47092,
                ])),
                Felt::new(BigInteger256([
                    0x41d71dd8e3c0d85f,
                    0x224902936f6fe834,
                    0x0c95a3a77de980d1,
                    0x07ad78d603c9b966,
                ])),
                Felt::new(BigInteger256([
                    0x1d767a7526f422b0,
                    0xc21c88d2ae2fa1b9,
                    0xfac84c58af21eec4,
                    0x24a51f0e50c39dbc,
                ])),
            ],
        ];

        let output = [
            [
                Felt::new(BigInteger256([
                    0xafd49a8c34aeae4c,
                    0xe0a8c73e1f684743,
                    0xb4ea4db753538a2d,
                    0x14cf9766d3bdd51d,
                ])),
                Felt::new(BigInteger256([
                    0xafd49a8c34aeae4c,
                    0xe0a8c73e1f684743,
                    0xb4ea4db753538a2d,
                    0x14cf9766d3bdd51d,
                ])),
                Felt::new(BigInteger256([
                    0xafd49a8c34aeae4c,
                    0xe0a8c73e1f684743,
                    0xb4ea4db753538a2d,
                    0x14cf9766d3bdd51d,
                ])),
                Felt::new(BigInteger256([
                    0xafd49a8c34aeae4c,
                    0xe0a8c73e1f684743,
                    0xb4ea4db753538a2d,
                    0x14cf9766d3bdd51d,
                ])),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
            ],
            [
                Felt::new(BigInteger256([
                    0xbebb490c2e6f962f,
                    0x465ac2ad04e364b4,
                    0xff4b8beb7ecbd2f7,
                    0x1daa245477c958e5,
                ])),
                Felt::new(BigInteger256([
                    0xbebb490c2e6f962f,
                    0x465ac2ad04e364b4,
                    0xff4b8beb7ecbd2f7,
                    0x1daa245477c958e5,
                ])),
                Felt::new(BigInteger256([
                    0xbebb490c2e6f962f,
                    0x465ac2ad04e364b4,
                    0xff4b8beb7ecbd2f7,
                    0x1daa245477c958e5,
                ])),
                Felt::new(BigInteger256([
                    0xbebb490c2e6f962f,
                    0x465ac2ad04e364b4,
                    0xff4b8beb7ecbd2f7,
                    0x1daa245477c958e5,
                ])),
                Felt::new(BigInteger256([
                    0xe07a0c33042f6fc0,
                    0xfbc9e1489023576a,
                    0xd40daa7093c5a810,
                    0x01eb281368a433ca,
                ])),
                Felt::new(BigInteger256([
                    0xe07a0c33042f6fc0,
                    0xfbc9e1489023576a,
                    0xd40daa7093c5a810,
                    0x01eb281368a433ca,
                ])),
                Felt::new(BigInteger256([
                    0xe07a0c33042f6fc0,
                    0xfbc9e1489023576a,
                    0xd40daa7093c5a810,
                    0x01eb281368a433ca,
                ])),
                Felt::new(BigInteger256([
                    0xe07a0c33042f6fc0,
                    0xfbc9e1489023576a,
                    0xd40daa7093c5a810,
                    0x01eb281368a433ca,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x9221c13bf351088f,
                    0x7ba14974192568d6,
                    0x764d83e12590a30c,
                    0x1efdfa43167d3d99,
                ])),
                Felt::new(BigInteger256([
                    0x9221c13bf351088f,
                    0x7ba14974192568d6,
                    0x764d83e12590a30c,
                    0x1efdfa43167d3d99,
                ])),
                Felt::new(BigInteger256([
                    0x9221c13bf351088f,
                    0x7ba14974192568d6,
                    0x764d83e12590a30c,
                    0x1efdfa43167d3d99,
                ])),
                Felt::new(BigInteger256([
                    0x9221c13bf351088f,
                    0x7ba14974192568d6,
                    0x764d83e12590a30c,
                    0x1efdfa43167d3d99,
                ])),
                Felt::new(BigInteger256([
                    0xa8fad3571dcabf05,
                    0x20a54df8cdb610bd,
                    0xb562a9b2221bf6a7,
                    0x113c1d95ad2f3ee3,
                ])),
                Felt::new(BigInteger256([
                    0xa8fad3571dcabf05,
                    0x20a54df8cdb610bd,
                    0xb562a9b2221bf6a7,
                    0x113c1d95ad2f3ee3,
                ])),
                Felt::new(BigInteger256([
                    0xa8fad3571dcabf05,
                    0x20a54df8cdb610bd,
                    0xb562a9b2221bf6a7,
                    0x113c1d95ad2f3ee3,
                ])),
                Felt::new(BigInteger256([
                    0xa8fad3571dcabf05,
                    0x20a54df8cdb610bd,
                    0xb562a9b2221bf6a7,
                    0x113c1d95ad2f3ee3,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xc1291cac726de779,
                    0x730b09508e12a9ad,
                    0x965495beb3b74a80,
                    0x1c9527fa5aabb1b1,
                ])),
                Felt::new(BigInteger256([
                    0xc1291cac726de779,
                    0x730b09508e12a9ad,
                    0x965495beb3b74a80,
                    0x1c9527fa5aabb1b1,
                ])),
                Felt::new(BigInteger256([
                    0xc1291cac726de779,
                    0x730b09508e12a9ad,
                    0x965495beb3b74a80,
                    0x1c9527fa5aabb1b1,
                ])),
                Felt::new(BigInteger256([
                    0xc1291cac726de779,
                    0x730b09508e12a9ad,
                    0x965495beb3b74a80,
                    0x1c9527fa5aabb1b1,
                ])),
                Felt::new(BigInteger256([
                    0x68c3488912edefaa,
                    0x8d087f6872aabf4f,
                    0x51e1a24709081231,
                    0x2259d6b14729c0fa,
                ])),
                Felt::new(BigInteger256([
                    0x68c3488912edefaa,
                    0x8d087f6872aabf4f,
                    0x51e1a24709081231,
                    0x2259d6b14729c0fa,
                ])),
                Felt::new(BigInteger256([
                    0x68c3488912edefaa,
                    0x8d087f6872aabf4f,
                    0x51e1a24709081231,
                    0x2259d6b14729c0fa,
                ])),
                Felt::new(BigInteger256([
                    0x68c3488912edefaa,
                    0x8d087f6872aabf4f,
                    0x51e1a24709081231,
                    0x2259d6b14729c0fa,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xa043d51a3b3302b4,
                    0xe6e04ce59b64d6bb,
                    0xbf46770ce098fe4f,
                    0x1484dfb5c17748f1,
                ])),
                Felt::new(BigInteger256([
                    0xec469f5d7daf3edf,
                    0x40280d293b4c7ebf,
                    0xee5a67a049b3b716,
                    0x25ccb33ae92ad0b2,
                ])),
                Felt::new(BigInteger256([
                    0x54aaf10e16b355af,
                    0xa640e782b18f3aa2,
                    0xa1e0dbe02d2dff7b,
                    0x025f38143e043b15,
                ])),
                Felt::new(BigInteger256([
                    0x2c20852131a058ab,
                    0xdaefceae01ac9930,
                    0x9da1554d550d3fa5,
                    0x0d2daef55e71569a,
                ])),
                Felt::new(BigInteger256([
                    0x3f22ad0cd63e3f72,
                    0xd2187aaff3591d7f,
                    0x9a1c22ba4557c95e,
                    0x002766500e14402e,
                ])),
                Felt::new(BigInteger256([
                    0xba52b2e02ff596a1,
                    0xdafce2197da8f78c,
                    0xa4909334fc3130d4,
                    0x17ffb20c5c01c839,
                ])),
                Felt::new(BigInteger256([
                    0x67bbd4959cc34ccf,
                    0xda5d700d25fe3ffc,
                    0x90ffaa6e0014ffd5,
                    0x20778777b3b6ffdc,
                ])),
                Felt::new(BigInteger256([
                    0x9d0849d71c6bd88c,
                    0x33b9b03268ee5072,
                    0xc45415ca1ea74b8e,
                    0x03444c286ef4aab5,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xfd1d430909c000d1,
                    0xe8ac70eec93810a8,
                    0x008b02fbe3c219bb,
                    0x094883c71ae89326,
                ])),
                Felt::new(BigInteger256([
                    0x15aef6679fccf6df,
                    0x8ad706b69f73f681,
                    0x6124336911aadba8,
                    0x17a8a0b6b45d3095,
                ])),
                Felt::new(BigInteger256([
                    0x09c7e3bb57827e38,
                    0x741507a842798c98,
                    0xc85e5b2daa5f4d87,
                    0x2bc14d6fd4d8b396,
                ])),
                Felt::new(BigInteger256([
                    0xbb2904ecb20de0db,
                    0x6558dac7d88c3d23,
                    0x95f6c4ef034838db,
                    0x08e003ee82e148c1,
                ])),
                Felt::new(BigInteger256([
                    0x208ad7f4502aff0f,
                    0xa8e259412c6dd969,
                    0x77c6377ba1372e75,
                    0x168344e88100c067,
                ])),
                Felt::new(BigInteger256([
                    0xc925b19569ada841,
                    0x2fdc4f624e25a13a,
                    0xc353bc83d591917f,
                    0x29edd92c9bbc9cb3,
                ])),
                Felt::new(BigInteger256([
                    0x8d717f7a2660b859,
                    0x26d14fb1c16c5ccc,
                    0x73e29ccf4c0231a6,
                    0x1b77a61fe56e6269,
                ])),
                Felt::new(BigInteger256([
                    0xe54aaaa283c90806,
                    0x20c0399d61581646,
                    0xe360e34580c826c7,
                    0x158a64a3c8aa7a3c,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xa8597f121b5512eb,
                    0xb3339b5879b7e58c,
                    0x7d99d32f8a15f4e6,
                    0x0cd877716255bc62,
                ])),
                Felt::new(BigInteger256([
                    0x1be80231922fc6d2,
                    0x25c1b9f529e06cc3,
                    0x46cef28b17e62fb8,
                    0x1d4609adf49dde05,
                ])),
                Felt::new(BigInteger256([
                    0xe1bd73f20c692d66,
                    0x66c109321948834f,
                    0x1751cbfb832a1a3b,
                    0x2d43b33282e02a2d,
                ])),
                Felt::new(BigInteger256([
                    0x322d6f9ec2596375,
                    0xb32af241bca3d93d,
                    0x20e6dea6236b3c28,
                    0x0b1bfc58c2943560,
                ])),
                Felt::new(BigInteger256([
                    0x44a1e6d40b1ee57b,
                    0x970f8c5b0bff7382,
                    0x0e97af437ab8b655,
                    0x234f463403bfe63f,
                ])),
                Felt::new(BigInteger256([
                    0xe3c3b034261f7acc,
                    0xe9b5fa81033be3f4,
                    0x54681fbc63838a19,
                    0x20905bce66d2c86b,
                ])),
                Felt::new(BigInteger256([
                    0x8920bc4fd9ee0957,
                    0xc23865616ea06eaa,
                    0xee99165d34317b7e,
                    0x0ff375eaca45e54f,
                ])),
                Felt::new(BigInteger256([
                    0xa54452e4c686d14b,
                    0xd0c9e66e62f91659,
                    0xbebfa9c5fc72df0d,
                    0x1471b79fb8f7de8b,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x5f08cf8aa6b41d9e,
                    0x791fe8384abb28ca,
                    0xc020a0bad3435590,
                    0x2f0693181419ead0,
                ])),
                Felt::new(BigInteger256([
                    0xe5b22c4210e44441,
                    0x283a2527699798fa,
                    0x39609ae2f8fba949,
                    0x056a3e696592bac0,
                ])),
                Felt::new(BigInteger256([
                    0xf953c82e8b13fd58,
                    0x4fa55224f17966e6,
                    0x3070c95860686086,
                    0x0ae29dbb19c83672,
                ])),
                Felt::new(BigInteger256([
                    0x7da80c8370f081c2,
                    0x3ba7aae710eb6053,
                    0xf7d52b56a12e61c9,
                    0x1d1abdcacdd36536,
                ])),
                Felt::new(BigInteger256([
                    0xf10447e22c4a1d9e,
                    0x10e04a690af68b32,
                    0xa3dc311d2b883668,
                    0x1b92311fa962152c,
                ])),
                Felt::new(BigInteger256([
                    0x46c2da4a5cffe055,
                    0xb217af52723a2bdc,
                    0x34fe235c0848095c,
                    0x2a1bd3f7eb4327a9,
                ])),
                Felt::new(BigInteger256([
                    0xaf254163784b4ee9,
                    0x95fd9d7fdc4dcb1d,
                    0x0f885e79f22ab87c,
                    0x2e93e2abdf252b97,
                ])),
                Felt::new(BigInteger256([
                    0xaea13d9b7ad1f75b,
                    0xbc190d9d0a27618c,
                    0xa14d735ec231963f,
                    0x14d8299d5c34f057,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x25ef93f56736020d,
                    0xc8479a34c17d0bd8,
                    0x054ab2353be31f1a,
                    0x077da659a0c91573,
                ])),
                Felt::new(BigInteger256([
                    0xff0ba674e3108ebf,
                    0xb438529307d3d1ff,
                    0xcf49caf7db730640,
                    0x0430a0edac9b06de,
                ])),
                Felt::new(BigInteger256([
                    0x65cbc69d107f4ad9,
                    0xd0a1836b8b48de6d,
                    0xa7e13425cf626da5,
                    0x240dc9bdbf525e51,
                ])),
                Felt::new(BigInteger256([
                    0x771a1b609213647c,
                    0x9834d30af4a8bf42,
                    0xfd66e9b9d9b92848,
                    0x293a8644800618db,
                ])),
                Felt::new(BigInteger256([
                    0x57baa533261d8580,
                    0x43a0f2cde7cc08f4,
                    0xf14dea953f8f4851,
                    0x2cfbfb496e37ca01,
                ])),
                Felt::new(BigInteger256([
                    0x8932142c006fcc6b,
                    0x3f07a95953cc7426,
                    0x5d8aa3d3598e0cd0,
                    0x1748616b98db7219,
                ])),
                Felt::new(BigInteger256([
                    0xb8757b416121cb26,
                    0xb7aba0384794e402,
                    0xfa4bf1f214a08ed1,
                    0x16d383281ccbbaf4,
                ])),
                Felt::new(BigInteger256([
                    0x2a7473210d16c0eb,
                    0x8c633f85edeba619,
                    0x46b814fbed61de46,
                    0x145f70260ed3b729,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xad18b5b0299344bd,
                    0x009c1379b2797038,
                    0x4587e89d50741cd7,
                    0x00083e95fb91412a,
                ])),
                Felt::new(BigInteger256([
                    0x70edcc6b59d8140a,
                    0x29f091dc8deb6826,
                    0xbbe0ab6514f97b2a,
                    0x14c26c1bc052cc20,
                ])),
                Felt::new(BigInteger256([
                    0x6010a594b5511dfd,
                    0x7731ccb25a1912e3,
                    0x9d46177f497da486,
                    0x24531408da1d9baa,
                ])),
                Felt::new(BigInteger256([
                    0x6e1577790d358973,
                    0xf777d9f9a320f030,
                    0x6997caa874a4e68c,
                    0x2918cbbc2be7c0b3,
                ])),
                Felt::new(BigInteger256([
                    0x3cdf478f9e727d9a,
                    0xd8cdd48bef2cb912,
                    0x42acb588603924e9,
                    0x2070d8695e8bda34,
                ])),
                Felt::new(BigInteger256([
                    0x0c078ebdb8278fc5,
                    0x696086a24138fd92,
                    0x82acff19a052f660,
                    0x0a39e25a3e61f4b6,
                ])),
                Felt::new(BigInteger256([
                    0xfb1f22e6bee80c42,
                    0xebe8bfd08b613fea,
                    0xb0298dd64ef74d4f,
                    0x0924ae2df5c377eb,
                ])),
                Felt::new(BigInteger256([
                    0x07bc65b0d73098bc,
                    0x9e0cd0ce4bb8d7a8,
                    0x409cb711b36ec391,
                    0x1d4bd3ba5028e430,
                ])),
            ],
        ];

        for i in input.iter_mut() {
            apply_sbox(i);
        }

        for (&i, o) in input.iter().zip(output) {
            assert_eq!(i, o);
        }
    }

    #[test]
    fn test_mds() {
        // Generated from https://github.com/Nashtare/anemoi-hash/
        let mut input = [
            [Felt::zero(); 8],
            [Felt::one(); 8],
            [
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
            ],
            [
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
            ],
            [
                Felt::new(BigInteger256([
                    0xde987b6ea64ea4fa,
                    0x9cbd37d028b2c4f8,
                    0x8a0135033f6e0e69,
                    0x17b0bca47647a365,
                ])),
                Felt::new(BigInteger256([
                    0xf451115d280685c1,
                    0x145160c185cb6cc9,
                    0xd0ec63c2a40c9962,
                    0x013ec03e0e23fd31,
                ])),
                Felt::new(BigInteger256([
                    0xa5daee4ffb513251,
                    0x1573fb003180a6b4,
                    0x9012ffd0edcba8d2,
                    0x0341c2ee3d48a688,
                ])),
                Felt::new(BigInteger256([
                    0x93bfa1171e34d4be,
                    0x57ab01d575538d28,
                    0x334adea899b5e59f,
                    0x142c53ef635fb7c5,
                ])),
                Felt::new(BigInteger256([
                    0xf5f76ed32238010c,
                    0x3508cc5f8005a040,
                    0x6c4a9c1c716885a4,
                    0x2eaf11ddc0002c55,
                ])),
                Felt::new(BigInteger256([
                    0x853254a36696b8a9,
                    0x70e0edb48df5765c,
                    0x37294b08348d9722,
                    0x14d71e2382af0668,
                ])),
                Felt::new(BigInteger256([
                    0xc81b60b2419541ba,
                    0x988e93f8afb2a681,
                    0x5fd72b0fd9a0af3f,
                    0x1bab562a87b4736d,
                ])),
                Felt::new(BigInteger256([
                    0x7c4a148066f142cb,
                    0x397c4173df63e33f,
                    0x5cb530ffab14b271,
                    0x0e18a49c9dabf847,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x8d9b71e32236588c,
                    0x6f393542bc32edaa,
                    0x6256d7371dca9fa0,
                    0x0630f3307ada9ed7,
                ])),
                Felt::new(BigInteger256([
                    0xe59d5496cfeef988,
                    0x6390efc5d8708811,
                    0x568c13f3a9ec953d,
                    0x16a7e7f59ff1b4ff,
                ])),
                Felt::new(BigInteger256([
                    0xc31a77524114986d,
                    0xb05d7a30f1ad057c,
                    0x847c67c06aaef3e2,
                    0x235cfa9dd63cb28a,
                ])),
                Felt::new(BigInteger256([
                    0x13b3a2a244e3fa27,
                    0x3114e121482a9ca0,
                    0x44550d0a576f5196,
                    0x2235b1251e77e330,
                ])),
                Felt::new(BigInteger256([
                    0x74bd36e0a31c043b,
                    0x8c7e9439d76a0d8a,
                    0x0a292eb1090d15ee,
                    0x00f0ab021f166f6e,
                ])),
                Felt::new(BigInteger256([
                    0x377b2c269f06b939,
                    0xfedd90df9e4027ca,
                    0x9acfb2f69b2fc751,
                    0x25751d72fee866fc,
                ])),
                Felt::new(BigInteger256([
                    0x7624a541840848d9,
                    0xb34284c8998dfcd8,
                    0xe1ef730e0260eec5,
                    0x10c6ab81f500115b,
                ])),
                Felt::new(BigInteger256([
                    0x2d0583d1cf156bd5,
                    0x788232b28e8f28ff,
                    0x326b7da75ac5e5b6,
                    0x2aaa1fd8b3f9a788,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x66fd0290aeb8d305,
                    0xffadc328be4e0321,
                    0x52713e9b8a3562e4,
                    0x102f4b0591d8050d,
                ])),
                Felt::new(BigInteger256([
                    0x5c6907ccb42f091d,
                    0x31133b6260a4cbf0,
                    0x877a4aed908ee835,
                    0x1edeffe4dc3e84fd,
                ])),
                Felt::new(BigInteger256([
                    0x29773d72334144cc,
                    0x7e998e9ab22c2e57,
                    0xeba8e01f5f29abf2,
                    0x19f4db01114f239e,
                ])),
                Felt::new(BigInteger256([
                    0x3b1cc342cf32c6f4,
                    0x5a51dae8c9e36c3f,
                    0x2ecfdfbb8b5b2aa2,
                    0x25729002cc454701,
                ])),
                Felt::new(BigInteger256([
                    0xe50bf345ec2a838d,
                    0x892c6a2b5ca09394,
                    0xb16f9813d22a8e17,
                    0x01678eb559154a2b,
                ])),
                Felt::new(BigInteger256([
                    0xb0b2bc046cc0705d,
                    0x4e387f6b304a155d,
                    0x63aefb1e321be424,
                    0x186a0be754265d0f,
                ])),
                Felt::new(BigInteger256([
                    0xf2e23042da00d3fb,
                    0xe504bb771b587a42,
                    0xd7ad5e0628ee5a8d,
                    0x2b2f67429f21bebb,
                ])),
                Felt::new(BigInteger256([
                    0xd8f6fa3f6759fe47,
                    0x9a2ed0c1e8911ddb,
                    0xa3f49ed79695035e,
                    0x0fa75a1ec24daadb,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xbed5b8c00441ece3,
                    0xc6ab656aceaa79fe,
                    0xc4e686e308808ed4,
                    0x1f40606de9750ff4,
                ])),
                Felt::new(BigInteger256([
                    0xc8f49675b16db2d5,
                    0xc67bdf2f98c8ebe5,
                    0xac56417e6a9236cb,
                    0x0018439a5ef37b79,
                ])),
                Felt::new(BigInteger256([
                    0x82fbef37d95ca0df,
                    0x99f5f5feb2472621,
                    0xcccbf83ef3dfc884,
                    0x2253e9ce73599cb3,
                ])),
                Felt::new(BigInteger256([
                    0x33760d75c74acdca,
                    0x070e0bb27d4607f5,
                    0x85286370736e05c0,
                    0x1e69131a710ca760,
                ])),
                Felt::new(BigInteger256([
                    0x354f588de29751ce,
                    0x19dd69ad17c0f468,
                    0xa22f676bcbfe63b7,
                    0x2e5adff45bce88f0,
                ])),
                Felt::new(BigInteger256([
                    0xa5e94806aaa95e69,
                    0x9dbd2507efe7f1f0,
                    0xa341c2ea78ef0055,
                    0x2702de25015fdc96,
                ])),
                Felt::new(BigInteger256([
                    0x33776e856b986327,
                    0x818a7d9abfc6355d,
                    0xca7b3561e75d4a25,
                    0x1177ef83aa902c39,
                ])),
                Felt::new(BigInteger256([
                    0x8735af099a75edd2,
                    0x48a5b66655eaf3eb,
                    0x41f37c493418fdf5,
                    0x21d8690dc5d1e7f3,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x9a2d957f399ba75b,
                    0x83582274967317fd,
                    0x39cde602d71f3457,
                    0x0d823a8b670db618,
                ])),
                Felt::new(BigInteger256([
                    0x1e79004de9059e40,
                    0x954287af6f0ad3f4,
                    0xdceef5025917061a,
                    0x0e83763c92b34f7c,
                ])),
                Felt::new(BigInteger256([
                    0x67dce295ec681365,
                    0x6dab5b62f2e1e61c,
                    0x7ceff045fdd14a99,
                    0x2916af6c00c6c7c6,
                ])),
                Felt::new(BigInteger256([
                    0x0351273eb135208f,
                    0x07cd93e0b946d5f8,
                    0x9a5d95a1b50c18a9,
                    0x2bcb0a61a34db6da,
                ])),
                Felt::new(BigInteger256([
                    0xd87cda23c8cbb7c8,
                    0x88a8e8d7a8e23493,
                    0x875eb5170dbdf237,
                    0x265ff17963850e22,
                ])),
                Felt::new(BigInteger256([
                    0x1014ecf9e2cf78d5,
                    0x5dec68d1e45deb97,
                    0x969577a6cf4e6482,
                    0x0ead3229b7dc11d8,
                ])),
                Felt::new(BigInteger256([
                    0xf276863186773302,
                    0x13503dcf5c3fc0c7,
                    0x06d509d359cc26c8,
                    0x1b9fae0dc7a321eb,
                ])),
                Felt::new(BigInteger256([
                    0xde28210fef3d5f77,
                    0x7be416598786fb3f,
                    0x504d4adf87ef412e,
                    0x0fe25b015f556a42,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x288475db97298874,
                    0xd52ef05fe032e954,
                    0x2fc869aeca2c75de,
                    0x20d2854bc5f4bc98,
                ])),
                Felt::new(BigInteger256([
                    0xb6a26aacce561b37,
                    0xc6c949ee729d1e53,
                    0xe64d06bef9baf8cf,
                    0x246ef266c12722f8,
                ])),
                Felt::new(BigInteger256([
                    0x9cd8fa7023bec713,
                    0xc50417def3770584,
                    0xd6522bd962a38743,
                    0x0a9264496c8ef3ee,
                ])),
                Felt::new(BigInteger256([
                    0x6af007bc788e19a6,
                    0x30913297a2c21ceb,
                    0x59853abe2aa216fe,
                    0x2fffc26d4d392f3b,
                ])),
                Felt::new(BigInteger256([
                    0x5307a7be46bcab85,
                    0xde457ad4434ee112,
                    0x6cddb39d3b896797,
                    0x289c178171e12bd9,
                ])),
                Felt::new(BigInteger256([
                    0x1f2ce2676217e4db,
                    0x1ecfb066f3bad8a2,
                    0x47ca59412d4fe71f,
                    0x1f1067a3b7a916ab,
                ])),
                Felt::new(BigInteger256([
                    0xbbd2a47fec1659a6,
                    0x7973ebbb7a019d48,
                    0x4a10fd9dcce566f8,
                    0x2704186d6a2589b0,
                ])),
                Felt::new(BigInteger256([
                    0xc6d07e9aca32506e,
                    0x078697e76eadacdf,
                    0x1ae9d507d9bfce10,
                    0x1a857dbad54bfe37,
                ])),
            ],
        ];

        let mut input2 = input;

        let output = [
            [Felt::zero(); 8],
            [
                Felt::new(BigInteger256([
                    0x60a042d2f3ae9dea,
                    0xacaddb0e56381c00,
                    0x3dd034a6a8b1facb,
                    0x094639f8fac1b68c,
                ])),
                Felt::new(BigInteger256([
                    0x4e8384eb157ccc21,
                    0xfb90a6020ce148c3,
                    0x5301fa84819caa36,
                    0x0dc83629563d4475,
                ])),
                Felt::new(BigInteger256([
                    0x949dc933acec4971,
                    0x63d4a145a237433e,
                    0xe20f0cbcc9dd3bc3,
                    0x2096ebb38f8b4c47,
                ])),
                Felt::new(BigInteger256([
                    0xafec0385a99e02a7,
                    0xc6f9740a3dc5d596,
                    0x9a362145f1003544,
                    0x0ac6e35e6e959084,
                ])),
                Felt::new(BigInteger256([
                    0x60a042d2f3ae9dea,
                    0xacaddb0e56381c00,
                    0x3dd034a6a8b1facb,
                    0x094639f8fac1b68c,
                ])),
                Felt::new(BigInteger256([
                    0x4e8384eb157ccc21,
                    0xfb90a6020ce148c3,
                    0x5301fa84819caa36,
                    0x0dc83629563d4475,
                ])),
                Felt::new(BigInteger256([
                    0x949dc933acec4971,
                    0x63d4a145a237433e,
                    0xe20f0cbcc9dd3bc3,
                    0x2096ebb38f8b4c47,
                ])),
                Felt::new(BigInteger256([
                    0xafec0385a99e02a7,
                    0xc6f9740a3dc5d596,
                    0x9a362145f1003544,
                    0x0ac6e35e6e959084,
                ])),
            ],
            [
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::new(BigInteger256([
                    0x60a042d2f3ae9dea,
                    0xacaddb0e56381c00,
                    0x3dd034a6a8b1facb,
                    0x094639f8fac1b68c,
                ])),
                Felt::new(BigInteger256([
                    0x4e8384eb157ccc21,
                    0xfb90a6020ce148c3,
                    0x5301fa84819caa36,
                    0x0dc83629563d4475,
                ])),
                Felt::new(BigInteger256([
                    0x949dc933acec4971,
                    0x63d4a145a237433e,
                    0xe20f0cbcc9dd3bc3,
                    0x2096ebb38f8b4c47,
                ])),
                Felt::new(BigInteger256([
                    0xafec0385a99e02a7,
                    0xc6f9740a3dc5d596,
                    0x9a362145f1003544,
                    0x0ac6e35e6e959084,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x60a042d2f3ae9dea,
                    0xacaddb0e56381c00,
                    0x3dd034a6a8b1facb,
                    0x094639f8fac1b68c,
                ])),
                Felt::new(BigInteger256([
                    0x4e8384eb157ccc21,
                    0xfb90a6020ce148c3,
                    0x5301fa84819caa36,
                    0x0dc83629563d4475,
                ])),
                Felt::new(BigInteger256([
                    0x949dc933acec4971,
                    0x63d4a145a237433e,
                    0xe20f0cbcc9dd3bc3,
                    0x2096ebb38f8b4c47,
                ])),
                Felt::new(BigInteger256([
                    0xafec0385a99e02a7,
                    0xc6f9740a3dc5d596,
                    0x9a362145f1003544,
                    0x0ac6e35e6e959084,
                ])),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
            ],
            [
                Felt::new(BigInteger256([
                    0xe46b56eae200d69d,
                    0x065cdc3463797e9d,
                    0xa72bd40d63226e8b,
                    0x022d654fce6d72c2,
                ])),
                Felt::new(BigInteger256([
                    0x43ee73838e5dbf5b,
                    0x0d6a8e40d400f349,
                    0x4245b81f4c143264,
                    0x2ba6d6d15699dc4a,
                ])),
                Felt::new(BigInteger256([
                    0xf64c1d4da2351632,
                    0x209ae00cb693dbe0,
                    0x3db737214aeb1347,
                    0x12049ff12b6669f5,
                ])),
                Felt::new(BigInteger256([
                    0x78a68637ba3b30fe,
                    0x4230d29c13640bf4,
                    0x7a9ef19aa4459ad2,
                    0x005f9300fcaccbfa,
                ])),
                Felt::new(BigInteger256([
                    0x93a118ddf5799b6c,
                    0x91a1e7a8f851db95,
                    0xbfa3bc54e77fea2f,
                    0x1781c38b735b80f9,
                ])),
                Felt::new(BigInteger256([
                    0x80b0024600ced62b,
                    0xd0ac6933dfb7a82c,
                    0xe1c3c9f8b798c1de,
                    0x1fb6a4acd5d0774e,
                ])),
                Felt::new(BigInteger256([
                    0xfe3c12a6db0437db,
                    0xb0f898a6bc9c1ee7,
                    0x00d03e055cc5c5b3,
                    0x085306fc8ba6d001,
                ])),
                Felt::new(BigInteger256([
                    0x80ff7756ae419685,
                    0x84f38eca8f88a83c,
                    0x0faea3df7d6de183,
                    0x1626f887cdbf9a29,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x3fb7c992e0ee06be,
                    0x14cb86e858d134f9,
                    0xc519e31f02cfb2cf,
                    0x0f2ebf9e9195730a,
                ])),
                Felt::new(BigInteger256([
                    0x0a629e8702d52e2f,
                    0x63c25957ccb60670,
                    0x5f7faaaafcead10c,
                    0x1f06e46aae874fbe,
                ])),
                Felt::new(BigInteger256([
                    0x3de39b6e140c7985,
                    0x21c0f77808884733,
                    0x5348b2b6c1d2531b,
                    0x2cb0fff237be308a,
                ])),
                Felt::new(BigInteger256([
                    0x34d4a7754b47fc93,
                    0x8f3c02008e029db4,
                    0xc377263cae61f243,
                    0x272665503e0f116b,
                ])),
                Felt::new(BigInteger256([
                    0x04d3c0e8a3c837b1,
                    0x7ce44e81949c9494,
                    0xf70a6d5dca2713e1,
                    0x29cef23fc75270a7,
                ])),
                Felt::new(BigInteger256([
                    0x18873299a2e3e03c,
                    0xcd5355af2ad32f4e,
                    0x04f11ccd26998e67,
                    0x262ef54bcaf9570b,
                ])),
                Felt::new(BigInteger256([
                    0x8532b70249adad56,
                    0x6b0db2446592f4cf,
                    0xd2558fbd7881d840,
                    0x02377d8e165dbe91,
                ])),
                Felt::new(BigInteger256([
                    0x91ee3ba64e1d4d06,
                    0xc1bd796e71a9e5d1,
                    0x962ff742a5e0eaa0,
                    0x0be1be553d5bc878,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x9d99db5973e32b0f,
                    0xc1b46dd442654356,
                    0x6de3079b82f77546,
                    0x2787b4f3546597e9,
                ])),
                Felt::new(BigInteger256([
                    0xfd2de7afd5528d67,
                    0x158c5d9a2e601c99,
                    0x40646e63d3a00031,
                    0x0b0579f0792aa5ef,
                ])),
                Felt::new(BigInteger256([
                    0x22fa16b3c4573e7a,
                    0x8498ee510aeda855,
                    0xac6cf0516b6cd604,
                    0x128c0fe792db9810,
                ])),
                Felt::new(BigInteger256([
                    0x32668d5909d9914d,
                    0x50439a18c759f296,
                    0x49346d18589a1fc1,
                    0x1893ebe9e627fc64,
                ])),
                Felt::new(BigInteger256([
                    0x89a1892d94e05362,
                    0x56d6093863081df9,
                    0x28ffbb68888d48ea,
                    0x065edb2fbcde1644,
                ])),
                Felt::new(BigInteger256([
                    0x7e09adc3958fa090,
                    0x2d10c57a9e4c531c,
                    0x822284daaf8fae33,
                    0x2420aa83d09fe65d,
                ])),
                Felt::new(BigInteger256([
                    0x1fbbf8af967696f8,
                    0xda752201b6032fa9,
                    0x23de97297f09f33f,
                    0x0092a59844a6ab91,
                ])),
                Felt::new(BigInteger256([
                    0x68ea10edf35aaedb,
                    0x1bb479c500c9363b,
                    0xab43480f65d131a2,
                    0x110189976b05332a,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x157bd84449fb0f16,
                    0x65a13cf71eae89a5,
                    0x8adb8910e2ad735b,
                    0x20472bc68daf4971,
                ])),
                Felt::new(BigInteger256([
                    0x877d8a33519afd5e,
                    0x317cc77655a8dfc8,
                    0x7b5cdeb2af4f649a,
                    0x037dc0371dc13da3,
                ])),
                Felt::new(BigInteger256([
                    0xf9cc0124bd4f8e00,
                    0x5902cf199e6dbc07,
                    0x61be1e033fb4b6df,
                    0x028f3878d87a7fa0,
                ])),
                Felt::new(BigInteger256([
                    0x2bef2f16a8ddc433,
                    0x4da0d6c498f963a0,
                    0x3ac974822acfc0e4,
                    0x0b8d3fa13460b2a0,
                ])),
                Felt::new(BigInteger256([
                    0x04724442e4c7bcf4,
                    0xa6e691b35ce7f684,
                    0x6f655b938c20e361,
                    0x0abe5215e8267f05,
                ])),
                Felt::new(BigInteger256([
                    0xe22360a4e4d3249c,
                    0x082b2fefd90ee2c5,
                    0x939a67f3dd82eeee,
                    0x045c5df22bfc0ef6,
                ])),
                Felt::new(BigInteger256([
                    0x7af146d73dd02bf1,
                    0xe90ad64dc3634902,
                    0xd9a1bef6302cfda9,
                    0x01b48b120e93f897,
                ])),
                Felt::new(BigInteger256([
                    0xd5619019a8305e56,
                    0xc0953902e1ec36a0,
                    0x798a950a72fec513,
                    0x20f86138c2fea1c0,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xecd86baba39bcc8d,
                    0xabc48f94e46ddcbb,
                    0xa190a97c4b0b6457,
                    0x23db6a3556eeaef4,
                ])),
                Felt::new(BigInteger256([
                    0x0a09acd7cd7da787,
                    0xa9eecc7e3c5a5b4f,
                    0xc30b55081132c9db,
                    0x28c5075dc835dd56,
                ])),
                Felt::new(BigInteger256([
                    0xd5d7d6f94c832095,
                    0x16c4e70d5d6a6a84,
                    0x38378690f65d9ff6,
                    0x20ef4df06b0833f7,
                ])),
                Felt::new(BigInteger256([
                    0x65bbb00d333dc618,
                    0x36dde22d74d916e1,
                    0x5733ff0a0c36233e,
                    0x128a9b9643ea9611,
                ])),
                Felt::new(BigInteger256([
                    0xd13b3ae8ea569837,
                    0xc34d48cbdc5f896f,
                    0x9f5c42476fffe000,
                    0x2dfd4792b8ffe1e2,
                ])),
                Felt::new(BigInteger256([
                    0x904c58e7f9995379,
                    0x692aa34e8f7905e5,
                    0x0d056e7ce72c785b,
                    0x15770b45f5414101,
                ])),
                Felt::new(BigInteger256([
                    0xc19c912a78896719,
                    0x171a0123f3b728d4,
                    0x0b13adafa04723a5,
                    0x11c6a3eabbc092e2,
                ])),
                Felt::new(BigInteger256([
                    0xc0d83e338d025e68,
                    0x41a67b41a55398eb,
                    0x1db964f2f30812a1,
                    0x11b29fe7163c0aa9,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x75855274b9fdaa8a,
                    0xac8a0d8392364016,
                    0x4e50d073ce5fc954,
                    0x0f869de6cf8e50d6,
                ])),
                Felt::new(BigInteger256([
                    0x316d3ac33c9f1e64,
                    0x32ff83ae888b1841,
                    0x6eaf55026432f48a,
                    0x2e4330be77f89bc9,
                ])),
                Felt::new(BigInteger256([
                    0x22cdb0a937271cf7,
                    0xf36adb5678414ab8,
                    0xc5d3698f56b7e928,
                    0x03356da46d22ea30,
                ])),
                Felt::new(BigInteger256([
                    0x51473f582899bcce,
                    0xbb7cda2f232f7f37,
                    0x5084ffeabd31728a,
                    0x1d553f2d4c22fdf4,
                ])),
                Felt::new(BigInteger256([
                    0x7afb86bb81565514,
                    0xf9f842fcae28a331,
                    0x44e2bbf394b6610b,
                    0x016315772c39ba50,
                ])),
                Felt::new(BigInteger256([
                    0xdffea633289a7075,
                    0x5c1c68c3794aa56a,
                    0xd56a00b697b210bc,
                    0x191c5905a5970857,
                ])),
                Felt::new(BigInteger256([
                    0x03e21a481cf55c9b,
                    0x62e65757d06cad97,
                    0x6a1255eb7bafa56a,
                    0x2d69752cb9fa4e39,
                ])),
                Felt::new(BigInteger256([
                    0x325f06bd782cc9b9,
                    0xab817d613073f142,
                    0xcdc1179d3758f916,
                    0x0a4724ed9d8ea66b,
                ])),
            ],
        ];

        for i in input.iter_mut() {
            apply_mds(i);
        }
        for i in input2.iter_mut() {
            apply_naive_mds(i);
        }

        for (index, (&i_1, i_2)) in input.iter().zip(input2).enumerate() {
            assert_eq!(output[index], i_1);
            assert_eq!(output[index], i_2);
        }
    }
}
