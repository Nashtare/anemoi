//! Implementation of the Anemoi permutation

use super::{sbox, Felt, MontFp};
use crate::{Anemoi, Jive, Sponge};
use ark_ff::{One, Zero};
/// Digest for Anemoi
mod digest;
/// Sponge for Anemoi
mod hasher;
/// Round constants for Anemoi
mod round_constants;

pub use digest::AnemoiDigest;

// ANEMOI CONSTANTS
// ================================================================================================

/// Function state is set to 4 field elements or 128 bytes.
/// 1 element of the state is reserved for capacity.
pub const STATE_WIDTH: usize = 4;
/// 3 elements of the state are reserved for rate.
pub const RATE_WIDTH: usize = 3;

/// The state is divided into two even-length rows.
pub const NUM_COLUMNS: usize = 2;

/// One element (32-bytes) is returned as digest.
pub const DIGEST_SIZE: usize = 1;

/// The number of rounds is set to 14 to provide 128-bit security level.
pub const NUM_HASH_ROUNDS: usize = 14;

// ANEMOI INSTANTIATION
// ================================================================================================

/// An Anemoi instantiation over BN_254 basefield with 2 columns and rate 3.
#[derive(Debug, Clone)]
pub struct AnemoiBn254_4_3;

impl<'a> Anemoi<'a, Felt> for AnemoiBn254_4_3 {
    const NUM_COLUMNS: usize = NUM_COLUMNS;
    const NUM_ROUNDS: usize = NUM_HASH_ROUNDS;

    const WIDTH: usize = STATE_WIDTH;
    const RATE: usize = RATE_WIDTH;
    const OUTPUT_SIZE: usize = DIGEST_SIZE;

    const ARK_C: &'a [Felt] = &round_constants::C;
    const ARK_D: &'a [Felt] = &round_constants::D;

    const GROUP_GENERATOR: u32 = sbox::BETA;

    const ALPHA: u32 = sbox::ALPHA;
    const INV_ALPHA: Felt = sbox::INV_ALPHA;
    const BETA: u32 = sbox::BETA;
    const DELTA: Felt = sbox::DELTA;

    fn exp_by_inv_alpha(x: Felt) -> Felt {
        sbox::exp_by_inv_alpha(&x)
    }
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_sbox() {
        // Generated from https://github.com/anemoi-hash/anemoi-hash/
        let mut input = [
            [Felt::zero(); 4],
            [Felt::one(); 4],
            [Felt::zero(), Felt::zero(), Felt::one(), Felt::one()],
            [Felt::one(), Felt::one(), Felt::zero(), Felt::zero()],
            [
                MontFp!(
                    "4583325051765336897712867113260034915968442474759787446129492344202082226069"
                ),
                MontFp!(
                    "14899260699566952680044152129883975446464286723954772893263943273380301557100"
                ),
                MontFp!(
                    "21177856090698828525735066562177798000897729518522210191140352817723374710248"
                ),
                MontFp!(
                    "17925242276404687924173954789654577781898510180442066363107119102981533345287"
                ),
            ],
            [
                MontFp!(
                    "21275647797069041581505448953433277535959678638527686070146586384102687128786"
                ),
                MontFp!(
                    "8157645310830966683376620252902333023632152065625961339012705090033918518406"
                ),
                MontFp!(
                    "8213773352002593053247889000662887531737467156654530328995131653356207810123"
                ),
                MontFp!(
                    "14648763085348172510907519478989870032955674262686047400489341346510162434204"
                ),
            ],
            [
                MontFp!(
                    "18294707662964594396017997510302304463205812732975333360356405577946529163247"
                ),
                MontFp!(
                    "2439814359920377823239320044390870421058611491124938589889444411795790230063"
                ),
                MontFp!(
                    "747727734505676840543609284619216555693208311183144262340900438074298638977"
                ),
                MontFp!(
                    "16995529045654954276700792423439504348596505366534236572994845670952295928585"
                ),
            ],
            [
                MontFp!(
                    "10536569214924316823017929068758584391821794880823125415354625422943779098086"
                ),
                MontFp!(
                    "639468380048393991594446803053436357104239087387432420899421012879174807098"
                ),
                MontFp!(
                    "1873282551962286623656519593144349440126220372394195153091367933010662137319"
                ),
                MontFp!(
                    "17685127326002640333980162876853014309519153588061630505039365383109239458937"
                ),
            ],
            [
                MontFp!(
                    "7638645467735387636302875438151729198506770672191177614846974907277549603471"
                ),
                MontFp!(
                    "14596235235423092146852560335977593865415581039647731941089166676863964980319"
                ),
                MontFp!(
                    "5116610971636081974660796712004914979938446423968547176345052662558304593822"
                ),
                MontFp!(
                    "1407617127949392521646699920117541248944218943783740838194889238953537042000"
                ),
            ],
            [
                MontFp!(
                    "18494094024729633659894792284588002506295282610397852570499417339957018167321"
                ),
                MontFp!(
                    "11971630037052380736677475321686714539193451624065656190383802826412982952551"
                ),
                MontFp!(
                    "9924402655796168439510236646395268100587934946641821885994401888822279975292"
                ),
                MontFp!(
                    "10479024599328571761198721620022603336143288439989594065096799592133658925326"
                ),
            ],
        ];

        let output = [
            [
                MontFp!(
                    "14592161914559516814830937163504850059130874104865215775126025263096817472389"
                ),
                MontFp!(
                    "14592161914559516814830937163504850059130874104865215775126025263096817472389"
                ),
                Felt::zero(),
                Felt::zero(),
            ],
            [
                MontFp!(
                    "17996719371234841169161410606729290168301197702344199238128514626101631218585"
                ),
                MontFp!(
                    "17996719371234841169161410606729290168301197702344199238128514626101631218585"
                ),
                MontFp!(
                    "21545190135371267395740182509034156671351839434575279208720937555061390978409"
                ),
                MontFp!(
                    "21545190135371267395740182509034156671351839434575279208720937555061390978409"
                ),
            ],
            [
                MontFp!(
                    "1930371117197560939648169063786210033268527574553565215067823407828254316129"
                ),
                MontFp!(
                    "1930371117197560939648169063786210033268527574553565215067823407828254316129"
                ),
                MontFp!(
                    "16568070555881000392443170152882554620064457026586610130358418531353270763752"
                ),
                MontFp!(
                    "16568070555881000392443170152882554620064457026586610130358418531353270763752"
                ),
            ],
            [
                MontFp!(
                    "14592161914559516814830937163504850059130874104865215775126025263096817472393"
                ),
                MontFp!(
                    "14592161914559516814830937163504850059130874104865215775126025263096817472393"
                ),
                MontFp!(
                    "21888242871839275222246405745257275088696311157297823662689037894645226208582"
                ),
                MontFp!(
                    "21888242871839275222246405745257275088696311157297823662689037894645226208582"
                ),
            ],
            [
                MontFp!(
                    "8735506930312227671144409747070555942041507184389674242120449750406471087239"
                ),
                MontFp!(
                    "93186998256408242625898943131889506535337173890430173748916656418485456158"
                ),
                MontFp!(
                    "2589690625330036736317424373406558909641847716292658265527077710276228229754"
                ),
                MontFp!(
                    "168261932401928302762597498230030665846391346188013796383606727587881346766"
                ),
            ],
            [
                MontFp!(
                    "3056850211856972255880522181254982484384413979673148823338129478854506429307"
                ),
                MontFp!(
                    "10095714477244726726747025934037127911620746749954440682694891960492236693874"
                ),
                MontFp!(
                    "3502514228124328869273576251585584775717188513108970966067254204600412041157"
                ),
                MontFp!(
                    "3982533853815383804113027549390982324247160967963612856352167812161299896908"
                ),
            ],
            [
                MontFp!(
                    "7169821579778742377940046139976180842868089284798257964005996461627863369680"
                ),
                MontFp!(
                    "12120981316940401844853183254619377349368201586200888802461764879405471369996"
                ),
                MontFp!(
                    "244313205229741650460983250207513732857086359224666786374539884363304899360"
                ),
                MontFp!(
                    "1968075214586692585959427977021288880006720241012888671151526794754690002574"
                ),
            ],
            [
                MontFp!(
                    "7029066727593308832957860155322486028269095515116197536669371837412769636176"
                ),
                MontFp!(
                    "17797046025727736644542260489548501814635272245951182719303807311483048603941"
                ),
                MontFp!(
                    "3955620081802321333980679494115853162588811934089185652923898944740658248966"
                ),
                MontFp!(
                    "21713136204308364167565266184191974339995586388718254651939364815949721588198"
                ),
            ],
            [
                MontFp!(
                    "17813482519117180107683229412737481709760409082215626634677674737835595628905"
                ),
                MontFp!(
                    "13547022924239329002083783650698959362350411809815370713942566939591378937533"
                ),
                MontFp!(
                    "8756821429284743008458123596036566695831683050768235481952587424848337878941"
                ),
                MontFp!(
                    "8837734043176772066390683334574970824993515274248296820417691604807182349906"
                ),
            ],
            [
                MontFp!(
                    "20110307488964047750622646399346549810928643618187367074369651215015998551954"
                ),
                MontFp!(
                    "21503425944318411152619753138043267682545298040735210095760454196384619078926"
                ),
                MontFp!(
                    "11218675273594707373792069487173834868680152829597441937922025751161370864004"
                ),
                MontFp!(
                    "18919222943421815035089266406166936606637716661937958709234450402249131327110"
                ),
            ],
        ];

        for i in input.iter_mut() {
            AnemoiBn254_4_3::sbox_layer(i);
        }

        for (&i, o) in input.iter().zip(output) {
            assert_eq!(i, o);
        }
    }
}
