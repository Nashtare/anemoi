use super::{mul_by_generator, sbox, BigInteger256, Felt};
use crate::{Jive, Sponge};
use ark_ff::{Field, One, Zero};
use unroll::unroll_for_loops;

/// Digest for Anemoi
mod digest;
/// Sponge for Anemoi
mod hasher;
/// MDS matrix for Anemoi
mod mds;
/// Round constants for Anemoi
mod round_constants;

pub use digest::AnemoiDigest;
pub use hasher::AnemoiHash;

// ANEMOI CONSTANTS
// ================================================================================================

/// Function state is set to 8 field elements or 256 bytes.
/// 1 element of the state is reserved for capacity.
pub const STATE_WIDTH: usize = 8;
/// 7 elements of the state are reserved for rate.
pub const RATE_WIDTH: usize = 7;

/// The state is divided into two even-length rows.
pub const NUM_COLUMNS: usize = 4;

/// 1 element (32-bytes) is returned as digest.
pub const DIGEST_SIZE: usize = 1;

/// The number of rounds is set to 10 to provide 128-bit security level.
pub const NUM_HASH_ROUNDS: usize = 10;

// HELPER FUNCTIONS
// ================================================================================================

#[inline(always)]
/// Applies exponentiation of the current hash
/// state elements with the Anemoi S-Box.
pub(crate) fn apply_sbox(state: &mut [Felt; STATE_WIDTH]) {
    let mut x: [Felt; NUM_COLUMNS] = state[..NUM_COLUMNS].try_into().unwrap();
    let mut y: [Felt; NUM_COLUMNS] = state[NUM_COLUMNS..].try_into().unwrap();

    x.iter_mut().enumerate().for_each(|(i, t)| {
        let y2 = y[i].square();
        *t -= mul_by_generator(&y2);
    });

    let mut x_alpha_inv = x;
    x_alpha_inv
        .iter_mut()
        .for_each(|t| *t = sbox::exp_inv_alpha(t));

    y.iter_mut()
        .enumerate()
        .for_each(|(i, t)| *t -= x_alpha_inv[i]);

    x.iter_mut().enumerate().for_each(|(i, t)| {
        let y2 = y[i].square();
        *t += mul_by_generator(&y2) + sbox::DELTA;
    });

    state[..NUM_COLUMNS].copy_from_slice(&x);
    state[NUM_COLUMNS..].copy_from_slice(&y);
}

#[inline(always)]
/// Applies matrix-vector multiplication of the current
/// hash state with the Anemoi MDS matrix.
pub(crate) fn apply_mds(state: &mut [Felt; STATE_WIDTH]) {
    let y: [Felt; NUM_COLUMNS] = state[NUM_COLUMNS..].try_into().unwrap();
    apply_mds_internal(&mut state[..NUM_COLUMNS]);
    state[NUM_COLUMNS..].copy_from_slice(&[y[1], y[2], y[3], y[0]]);
    apply_mds_internal(&mut state[NUM_COLUMNS..]);
}

#[inline(always)]
fn apply_mds_internal(state: &mut [Felt]) {
    state[0] += state[1];
    state[2] += state[3];
    state[3] += mul_by_generator(&state[0]);
    state[1] = mul_by_generator(&(state[1] + state[2]));
    state[0] += state[1];
    state[2] += mul_by_generator(&state[3]);
    state[1] += state[2];
    state[3] += state[0];
}

// ANEMOI PERMUTATION
// ================================================================================================

/// Applies an Anemoi permutation to the provided state
#[inline(always)]
#[unroll_for_loops]
pub(crate) fn apply_permutation(state: &mut [Felt; STATE_WIDTH]) {
    for i in 0..NUM_HASH_ROUNDS {
        apply_round(state, i);
    }

    apply_mds(state)
}

/// Applies an Anemoi round to the provided state
#[inline(always)]
#[unroll_for_loops]
pub(crate) fn apply_round(state: &mut [Felt; STATE_WIDTH], step: usize) {
    // determine which round constants to use
    let c = &round_constants::C[step % NUM_HASH_ROUNDS];
    let d = &round_constants::D[step % NUM_HASH_ROUNDS];

    for i in 0..NUM_COLUMNS {
        state[i] += c[i];
        state[NUM_COLUMNS + i] += d[i];
    }

    apply_mds(state);
    apply_sbox(state);
}

#[cfg(test)]
mod tests {
    use super::*;

    fn apply_naive_mds(state: &mut [Felt; STATE_WIDTH]) {
        let x: [Felt; NUM_COLUMNS] = state[..NUM_COLUMNS].try_into().unwrap();
        let mut y: [Felt; NUM_COLUMNS] = [Felt::zero(); NUM_COLUMNS];
        y[0..NUM_COLUMNS - 1].copy_from_slice(&state[NUM_COLUMNS + 1..]);
        y[NUM_COLUMNS - 1] = state[NUM_COLUMNS];

        let mut result = [Felt::zero(); STATE_WIDTH];
        for (i, r) in result.iter_mut().enumerate().take(NUM_COLUMNS) {
            for (j, s) in x.into_iter().enumerate().take(NUM_COLUMNS) {
                *r += s * mds::MDS[i * NUM_COLUMNS + j];
            }
        }
        for (i, r) in result.iter_mut().enumerate().skip(NUM_COLUMNS) {
            for (j, s) in y.into_iter().enumerate() {
                *r += s * mds::MDS[(i - NUM_COLUMNS) * NUM_COLUMNS + j];
            }
        }

        state.copy_from_slice(&result);
    }

    #[test]
    fn test_sbox() {
        // Generated from https://github.com/Nashtare/anemoi-hash/
        let mut input = [
            [Felt::zero(); 8],
            [Felt::one(); 8],
            [
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
            ],
            [
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
            ],
            [
                Felt::new(BigInteger256([
                    0x384922d92ada32c1,
                    0xa26ab12f5f0798c7,
                    0x77a6bf2bcefef19d,
                    0x221d3ce2be531d3e,
                ])),
                Felt::new(BigInteger256([
                    0x17c1207196ed69a2,
                    0xe80fbe9841f43c43,
                    0x0ba6bcf1c0f8f4a7,
                    0x13a0cd4995245dad,
                ])),
                Felt::new(BigInteger256([
                    0xe2759edbe766a811,
                    0x8b2656aae53f73de,
                    0x80760f4ba89c7b76,
                    0x09a14f7c492a1871,
                ])),
                Felt::new(BigInteger256([
                    0x39b0565169c78f0d,
                    0xa23bb42dbd5596c0,
                    0xfb30e58e8ad5a774,
                    0x351866b9791ba3ae,
                ])),
                Felt::new(BigInteger256([
                    0xb79e7404a1866421,
                    0xaa10bc118058d7d8,
                    0x0ae13b57951bc0b6,
                    0x3cf6725c256d7359,
                ])),
                Felt::new(BigInteger256([
                    0x7e9c317eebe61752,
                    0xe63f7d823464b6c6,
                    0x167d8e1045815923,
                    0x3a7969176a175e98,
                ])),
                Felt::new(BigInteger256([
                    0xff873f1a1872f871,
                    0x9cc96ecedbd5db56,
                    0x2eb782e4244970d4,
                    0x35b1e0aa5924f29b,
                ])),
                Felt::new(BigInteger256([
                    0x650b7b321d90c16e,
                    0xd6f4d1e3bbc83c87,
                    0xc8009132cf823cf8,
                    0x1e5ec7cf01866c97,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x4a5fc417180cc2d2,
                    0x22b19d06ae3820d6,
                    0xa0c0c2b8994fd854,
                    0x1480a25cbe868812,
                ])),
                Felt::new(BigInteger256([
                    0xb41f9b7c1f6d1ff0,
                    0x7f04483563b8db19,
                    0xd2e2ea62cf769db1,
                    0x334a0889720730b3,
                ])),
                Felt::new(BigInteger256([
                    0xff8f26e3e8ceb103,
                    0xbbe8a02ed5ce0f99,
                    0x99c26c4f44f34e06,
                    0x3bd7eb2c51fa4ee4,
                ])),
                Felt::new(BigInteger256([
                    0x7260e0cf37cbd371,
                    0x06f62b3f7329133f,
                    0xe10627d6a935667e,
                    0x2ec24c5eee793aeb,
                ])),
                Felt::new(BigInteger256([
                    0x837768b30c029710,
                    0x2fb5afc7596b8343,
                    0x6c796168d5d49940,
                    0x2c90f574265d4bcf,
                ])),
                Felt::new(BigInteger256([
                    0x45dd505942d26202,
                    0x6f54cff23bdfdf2d,
                    0xa320fb7c2ae0e23b,
                    0x0a3d44d0cb999d7a,
                ])),
                Felt::new(BigInteger256([
                    0xa4c7a9898abf40f5,
                    0x760f4bd02cf89b6d,
                    0xeefe9dfffe2e100e,
                    0x0d6f75e584e00a9e,
                ])),
                Felt::new(BigInteger256([
                    0x989e773c3f61bdf3,
                    0x9164831c604f0009,
                    0x32f0b3f60403fdd4,
                    0x18a8955091b4c5e3,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xf39ba693f985cd18,
                    0x6ac48e67e1e79806,
                    0x5252da3017895c58,
                    0x1e7cd09c33d49ec8,
                ])),
                Felt::new(BigInteger256([
                    0x29ffa4c47841774b,
                    0xe241990e75b00a79,
                    0x17aae68b9d5a991d,
                    0x322658155bcc7653,
                ])),
                Felt::new(BigInteger256([
                    0xb892eca97a671c4b,
                    0x38fdf07b3e248b96,
                    0xacaa6ec36df87dba,
                    0x299808c62c11115e,
                ])),
                Felt::new(BigInteger256([
                    0x4c6ce9d575899e26,
                    0x3636c7fbbd9789e2,
                    0xe7c01bab370ec07c,
                    0x3c70866cdb8da269,
                ])),
                Felt::new(BigInteger256([
                    0x92e5699be6e69ba0,
                    0x9f50a42b7fc379da,
                    0x8fee6b7d83c2d185,
                    0x1d7dab89f0c778e7,
                ])),
                Felt::new(BigInteger256([
                    0xafc5eb4ab694ecfc,
                    0xb3c73e4a6fd42de8,
                    0x58b07fc30eb81eef,
                    0x34086abcd263c911,
                ])),
                Felt::new(BigInteger256([
                    0xe83dfdae95de93b6,
                    0xa2baf7771ab2cf29,
                    0x501e2096be5d72e3,
                    0x2407571d58caa422,
                ])),
                Felt::new(BigInteger256([
                    0x768fa4e6586c323a,
                    0x3d6fb3e380545f5e,
                    0xa0c8d7a75134440f,
                    0x27eee714e1faa098,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x3376debcece1aaa7,
                    0xa953743754422dca,
                    0x8e1dd795036d8b5b,
                    0x1fcb64fb3fd0d8f3,
                ])),
                Felt::new(BigInteger256([
                    0xbef2b81573a061b1,
                    0xead40adfe459983e,
                    0xccc82e69d6a9a204,
                    0x2e77cc99dc27d854,
                ])),
                Felt::new(BigInteger256([
                    0xf874851e47af0995,
                    0x96c3ba8b36133299,
                    0x8adff4cba8954185,
                    0x18fb64302d1fd801,
                ])),
                Felt::new(BigInteger256([
                    0xfd3f49cecc2990b8,
                    0x732e9078b4b3ad2d,
                    0x21be82208c382711,
                    0x03ed619fb2e5ee00,
                ])),
                Felt::new(BigInteger256([
                    0xc826f400947beb89,
                    0xea69b76c64d5e5a3,
                    0xeb0dd378e1e73173,
                    0x2bdee2c3ae8e827a,
                ])),
                Felt::new(BigInteger256([
                    0x82637f1ee6982faa,
                    0xb8715db08eba2a47,
                    0x4aec19601727ea0c,
                    0x1ebeca7e8f5ebec6,
                ])),
                Felt::new(BigInteger256([
                    0xad5215f54df3f32f,
                    0x03ca897c12a5fc63,
                    0xf66b37f21920bb9c,
                    0x033dd7122250cd12,
                ])),
                Felt::new(BigInteger256([
                    0x44cb787ab5db4313,
                    0xf2c5a14a84552870,
                    0xc151488521e13bc6,
                    0x2c3a561d172f3116,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x467168decd23d704,
                    0x74792bd7f7752d5d,
                    0xfd69fbe8804dc8fd,
                    0x3e289e13c722340c,
                ])),
                Felt::new(BigInteger256([
                    0xc30b35b1817d1fd9,
                    0x2b317e4b8a0d7fe1,
                    0x4996a08661fb7c23,
                    0x250a076b90371b76,
                ])),
                Felt::new(BigInteger256([
                    0x2719ddd5df1e29a5,
                    0x6dafc8d866031783,
                    0xf9e1d7e56e61b491,
                    0x0a562cf8a405ecad,
                ])),
                Felt::new(BigInteger256([
                    0x3efc801f3907e0c7,
                    0x488f891a908dff9a,
                    0x07b46c6081576697,
                    0x0926e48c9d201ebb,
                ])),
                Felt::new(BigInteger256([
                    0x08dbcffac7b1c390,
                    0x4f8c727fa841a2a8,
                    0x2780a53e5bbe01d7,
                    0x1fab7d49921b557b,
                ])),
                Felt::new(BigInteger256([
                    0x5d2e66d7aee748bf,
                    0x9ac23bf3949c688b,
                    0x48460e194b85aa53,
                    0x3c8bf452b28fb528,
                ])),
                Felt::new(BigInteger256([
                    0x43b59895281d0440,
                    0x8b83df837c431330,
                    0x589a90d551dde21f,
                    0x36262f07e0fd5879,
                ])),
                Felt::new(BigInteger256([
                    0x68c47cb2494ee1c7,
                    0xecc5adba3a0aae57,
                    0xc59de34ca3cf4af1,
                    0x2ff8af16043019ce,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xbdbb588d069b39e1,
                    0x11bf69a277ec8a8c,
                    0x048021406a2e76e3,
                    0x0b6cc6bfff3ca7ea,
                ])),
                Felt::new(BigInteger256([
                    0xa97cb81bc6b6e580,
                    0xf1af2217a2ea2a5a,
                    0xfe4977e9cad98f7a,
                    0x3b3a29e23eb10186,
                ])),
                Felt::new(BigInteger256([
                    0x9c8c1e56d8087d41,
                    0xfcdea569aa182159,
                    0x793e059f0279ff1f,
                    0x0d10d6e149ddac7a,
                ])),
                Felt::new(BigInteger256([
                    0xdf140e39679520df,
                    0x9995304376d0af61,
                    0xd74afecb14d5f719,
                    0x1c319da49b08fee8,
                ])),
                Felt::new(BigInteger256([
                    0xf7d484b643e133fd,
                    0x6f81abb553d0e964,
                    0x85c77631cc34a4a6,
                    0x19b1f1657463eb16,
                ])),
                Felt::new(BigInteger256([
                    0xdeb6f58d7107114a,
                    0x46c15e693174eba3,
                    0x7f80b8d28db8b348,
                    0x1b1ad0853285345a,
                ])),
                Felt::new(BigInteger256([
                    0x0a27638fdac923c1,
                    0xfe9a391018eb0173,
                    0xa5e3679a83b59b99,
                    0x14e8888229dcedc2,
                ])),
                Felt::new(BigInteger256([
                    0x43982a3d4bb1d910,
                    0x0ed0832c68efec51,
                    0x1f718009582f2524,
                    0x1f73f2d8d79a2786,
                ])),
            ],
        ];

        let output = [
            [
                Felt::new(BigInteger256([
                    0x123bd95299999999,
                    0xb83c0a9bfa40677b,
                    0xcccccccccccccccc,
                    0x0ccccccccccccccc,
                ])),
                Felt::new(BigInteger256([
                    0x123bd95299999999,
                    0xb83c0a9bfa40677b,
                    0xcccccccccccccccc,
                    0x0ccccccccccccccc,
                ])),
                Felt::new(BigInteger256([
                    0x123bd95299999999,
                    0xb83c0a9bfa40677b,
                    0xcccccccccccccccc,
                    0x0ccccccccccccccc,
                ])),
                Felt::new(BigInteger256([
                    0x123bd95299999999,
                    0xb83c0a9bfa40677b,
                    0xcccccccccccccccc,
                    0x0ccccccccccccccc,
                ])),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
            ],
            [
                Felt::new(BigInteger256([
                    0xa942fcc6b6fc9019,
                    0xe30fee4001297b6b,
                    0xc81bbbb990652d5f,
                    0x151360a4ca1bade9,
                ])),
                Felt::new(BigInteger256([
                    0xa942fcc6b6fc9019,
                    0xe30fee4001297b6b,
                    0xc81bbbb990652d5f,
                    0x151360a4ca1bade9,
                ])),
                Felt::new(BigInteger256([
                    0xa942fcc6b6fc9019,
                    0xe30fee4001297b6b,
                    0xc81bbbb990652d5f,
                    0x151360a4ca1bade9,
                ])),
                Felt::new(BigInteger256([
                    0xa942fcc6b6fc9019,
                    0xe30fee4001297b6b,
                    0xc81bbbb990652d5f,
                    0x151360a4ca1bade9,
                ])),
                Felt::new(BigInteger256([
                    0xc1f5f40ca5f0c922,
                    0x8ed096798f9a2565,
                    0x343bf2efffdc45e4,
                    0x136f8d515fc00212,
                ])),
                Felt::new(BigInteger256([
                    0xc1f5f40ca5f0c922,
                    0x8ed096798f9a2565,
                    0x343bf2efffdc45e4,
                    0x136f8d515fc00212,
                ])),
                Felt::new(BigInteger256([
                    0xc1f5f40ca5f0c922,
                    0x8ed096798f9a2565,
                    0x343bf2efffdc45e4,
                    0x136f8d515fc00212,
                ])),
                Felt::new(BigInteger256([
                    0xc1f5f40ca5f0c922,
                    0x8ed096798f9a2565,
                    0x343bf2efffdc45e4,
                    0x136f8d515fc00212,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x2daf6d68ef718427,
                    0x5061c937d5b3a764,
                    0xf8541bb755f5c730,
                    0x24e19c62db751b35,
                ])),
                Felt::new(BigInteger256([
                    0x2daf6d68ef718427,
                    0x5061c937d5b3a764,
                    0xf8541bb755f5c730,
                    0x24e19c62db751b35,
                ])),
                Felt::new(BigInteger256([
                    0x2daf6d68ef718427,
                    0x5061c937d5b3a764,
                    0xf8541bb755f5c730,
                    0x24e19c62db751b35,
                ])),
                Felt::new(BigInteger256([
                    0x2daf6d68ef718427,
                    0x5061c937d5b3a764,
                    0xf8541bb755f5c730,
                    0x24e19c62db751b35,
                ])),
                Felt::new(BigInteger256([
                    0xffc6f91ea63fca57,
                    0x291c6ce7a87d6cc6,
                    0x0dde5b4ffa4ac0ea,
                    0x0d38cb1a91ae29c0,
                ])),
                Felt::new(BigInteger256([
                    0xffc6f91ea63fca57,
                    0x291c6ce7a87d6cc6,
                    0x0dde5b4ffa4ac0ea,
                    0x0d38cb1a91ae29c0,
                ])),
                Felt::new(BigInteger256([
                    0xffc6f91ea63fca57,
                    0x291c6ce7a87d6cc6,
                    0x0dde5b4ffa4ac0ea,
                    0x0d38cb1a91ae29c0,
                ])),
                Felt::new(BigInteger256([
                    0xffc6f91ea63fca57,
                    0x291c6ce7a87d6cc6,
                    0x0dde5b4ffa4ac0ea,
                    0x0d38cb1a91ae29c0,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xeb95ce3a99999981,
                    0x819db2fb145092b5,
                    0xccccccccccccccc9,
                    0x0ccccccccccccccc,
                ])),
                Felt::new(BigInteger256([
                    0xeb95ce3a99999981,
                    0x819db2fb145092b5,
                    0xccccccccccccccc9,
                    0x0ccccccccccccccc,
                ])),
                Felt::new(BigInteger256([
                    0xeb95ce3a99999981,
                    0x819db2fb145092b5,
                    0xccccccccccccccc9,
                    0x0ccccccccccccccc,
                ])),
                Felt::new(BigInteger256([
                    0xeb95ce3a99999981,
                    0x819db2fb145092b5,
                    0xccccccccccccccc9,
                    0x0ccccccccccccccc,
                ])),
                Felt::new(BigInteger256([
                    0x311bac8400000004,
                    0x891a63f02652a376,
                    0x0000000000000000,
                    0x0000000000000000,
                ])),
                Felt::new(BigInteger256([
                    0x311bac8400000004,
                    0x891a63f02652a376,
                    0x0000000000000000,
                    0x0000000000000000,
                ])),
                Felt::new(BigInteger256([
                    0x311bac8400000004,
                    0x891a63f02652a376,
                    0x0000000000000000,
                    0x0000000000000000,
                ])),
                Felt::new(BigInteger256([
                    0x311bac8400000004,
                    0x891a63f02652a376,
                    0x0000000000000000,
                    0x0000000000000000,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x920c87d5ebc8ff41,
                    0x01e84b374934f304,
                    0xd37915fbeda73846,
                    0x20ee5eb246f1b2c8,
                ])),
                Felt::new(BigInteger256([
                    0xfc843fd83a06a2bc,
                    0x9b9d5f908d0b3b5f,
                    0xd001591cc460c33d,
                    0x2238ea9caff968d0,
                ])),
                Felt::new(BigInteger256([
                    0x4bb181decc2313f0,
                    0xcd826f798448efe8,
                    0x8f04382b8c87117e,
                    0x30582681cb54e461,
                ])),
                Felt::new(BigInteger256([
                    0xc9497781db6a0513,
                    0xc67cf7c1cf501f53,
                    0xdd51a2701de9625d,
                    0x0e7bb1e583a8dfae,
                ])),
                Felt::new(BigInteger256([
                    0x5fa60d5e20c38a96,
                    0x2e5214becec814bf,
                    0x90731ed79045cff8,
                    0x026a6c70939a919e,
                ])),
                Felt::new(BigInteger256([
                    0x4eea1df31e8275f7,
                    0x123ee034705713fa,
                    0xe7da3cbd7cda80cb,
                    0x36b9b51551be1326,
                ])),
                Felt::new(BigInteger256([
                    0x7ebb85e972707eb0,
                    0x9a3052844bd7177f,
                    0xe198faa66f9c3ceb,
                    0x39b59631516e0425,
                ])),
                Felt::new(BigInteger256([
                    0x4a9c053932a97faf,
                    0xe5f752e490f8b5dd,
                    0x5d70d843a3972cc2,
                    0x0c42f5fdc50fbafd,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x7b60f951c139625a,
                    0xfd02915914c2a60f,
                    0x57522ccac145c115,
                    0x0fce868bb2059fb3,
                ])),
                Felt::new(BigInteger256([
                    0xc49d016a909f0bec,
                    0xa2b64ed40ded1f10,
                    0x9aa3af77c5dc0d5b,
                    0x19cf838c1429a07a,
                ])),
                Felt::new(BigInteger256([
                    0x8696d1bc7d406b29,
                    0x4fb836a28359d04f,
                    0xed039e73c3ebfa3d,
                    0x2db8040503e534b1,
                ])),
                Felt::new(BigInteger256([
                    0xb7ff5e5da136b429,
                    0xd2363a099474614b,
                    0x7eb771b274ee4cbd,
                    0x1969cc683f62609a,
                ])),
                Felt::new(BigInteger256([
                    0xea3bd077b81f4a33,
                    0x9deb716238979f19,
                    0xe25520147a5aaf78,
                    0x1b1b8ead3d56584a,
                ])),
                Felt::new(BigInteger256([
                    0xc9f7d0a853de9c17,
                    0xf44b39f6dd90e215,
                    0x66db4f0ef9e46ee9,
                    0x07d0531c4d8b405f,
                ])),
                Felt::new(BigInteger256([
                    0x2c59867cd4694301,
                    0xe339cd4a23bf19b4,
                    0x7cf9531a14fcd90b,
                    0x262f2ea8a6ab7401,
                ])),
                Felt::new(BigInteger256([
                    0x4e4419af25f6eb56,
                    0xd665ca1df8eb9561,
                    0x84495529d4d902ba,
                    0x3d7ea940ecdfe402,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x04898a5ac71de39c,
                    0x4bf9ed78d6e3b0b8,
                    0xc2ba4fe69fbfffcf,
                    0x08fb47e779493bcf,
                ])),
                Felt::new(BigInteger256([
                    0x12899c5c497e86b4,
                    0xc970d4d61d9b4624,
                    0x8d576ae54c2905b0,
                    0x170490e2fe2b393e,
                ])),
                Felt::new(BigInteger256([
                    0x2d2b967704cf3650,
                    0x080ccc09658db143,
                    0x0aeb1d17bd6ee600,
                    0x31ff28a9cc97914f,
                ])),
                Felt::new(BigInteger256([
                    0xa22a0028c5c3cb8b,
                    0x8781ae0abe8eb60b,
                    0x961a380c855a654c,
                    0x1041192ed19dd912,
                ])),
                Felt::new(BigInteger256([
                    0x6bbe39b474e35329,
                    0xbad96d28c19b0c07,
                    0x3a5a1225241763e1,
                    0x2203a1906fbbdeb8,
                ])),
                Felt::new(BigInteger256([
                    0x7cc2714b758a20c1,
                    0x0eb9b19279659522,
                    0xe0ebb69cfb31d864,
                    0x02411bd295b5c132,
                ])),
                Felt::new(BigInteger256([
                    0xf247d888d00636d7,
                    0xd536eeaa9a58f75b,
                    0x3c85db9ddb721a46,
                    0x1601f16dc4cea99f,
                ])),
                Felt::new(BigInteger256([
                    0xabb80d2184bdd740,
                    0xe38b726dfe96443d,
                    0x2f3293e63b5bcebb,
                    0x2c9b6bc217b87477,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xc8b9f8b0e41c3a8c,
                    0x1ff0946cd2495616,
                    0x9d55a3e33faae5bb,
                    0x350e0835e60235ea,
                ])),
                Felt::new(BigInteger256([
                    0xa7f7c3632ebca2c2,
                    0x74e15fd5dac59d46,
                    0x72de526dfb5934f6,
                    0x3c22e30a116a2c39,
                ])),
                Felt::new(BigInteger256([
                    0x5e82d690b3ccb48b,
                    0x08e04f0f18b5df64,
                    0x430831a2f624356c,
                    0x25677671100ae411,
                ])),
                Felt::new(BigInteger256([
                    0x4fcc58b05b139281,
                    0x3297f0fe9464be91,
                    0x8da7b676b6cfc0dc,
                    0x0f87a69a2caf3d93,
                ])),
                Felt::new(BigInteger256([
                    0x24e919ff954ad020,
                    0xda9a20919f842c5a,
                    0xf85689b80d880559,
                    0x26d45f132facfc28,
                ])),
                Felt::new(BigInteger256([
                    0x0d9fb9ba8f77d429,
                    0xf1f31dfd1abfb256,
                    0x441a49ce73220c50,
                    0x040e46dfc116fdba,
                ])),
                Felt::new(BigInteger256([
                    0x2f9548df8dbe46ae,
                    0x2729aef7a22280cf,
                    0xd199f73e38f815c6,
                    0x245d87f89ca45444,
                ])),
                Felt::new(BigInteger256([
                    0x13c4d1392a2c6587,
                    0x4e35d273fc800f49,
                    0xf36faf09d65f801d,
                    0x2e463aa7c866f67d,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x04b08e52be1906a6,
                    0xf23f92d806ddba66,
                    0xefe579a687d41e44,
                    0x387f1663c2f5c241,
                ])),
                Felt::new(BigInteger256([
                    0x5625af617abd9a2c,
                    0xb604a624b66fdd97,
                    0x2a66279ffbc66cc2,
                    0x105156fb431a9681,
                ])),
                Felt::new(BigInteger256([
                    0x94f51fdee8a901d6,
                    0xb00b27bdbf36dbde,
                    0x1f9834b13459b13b,
                    0x32596140efb6c4fd,
                ])),
                Felt::new(BigInteger256([
                    0x309465ba990ec62d,
                    0x9670b16d787e2b11,
                    0x301e35c01bcf2753,
                    0x0551fb9eb14ba3e2,
                ])),
                Felt::new(BigInteger256([
                    0x02ddc0dc8643d42e,
                    0xe0847776623be85d,
                    0x65710b3b3ccc91b5,
                    0x23237bf0bdd212e7,
                ])),
                Felt::new(BigInteger256([
                    0xe87f2dec3c6213de,
                    0x264532dc7c27f1ca,
                    0x00a9276694f61903,
                    0x109c24204de5c3b6,
                ])),
                Felt::new(BigInteger256([
                    0xc49b23a2906ba85e,
                    0x0fb4e3555bebbf1e,
                    0xe8e25458b62504c5,
                    0x3165a28d87c90203,
                ])),
                Felt::new(BigInteger256([
                    0x287e6ecc0384fa16,
                    0x52d2eb37d594228b,
                    0x12ffb84ed77fe4a1,
                    0x3b651683cd59cbfa,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xb726182dedd1917d,
                    0x64a4392526c8bf3d,
                    0xe2d9cc54e2171016,
                    0x107ab374c0b2e91e,
                ])),
                Felt::new(BigInteger256([
                    0x298da10cf3e0e173,
                    0x58dae94b5f5ae832,
                    0xab1ccb9efc3bd1f5,
                    0x0b387fd7f79c29ae,
                ])),
                Felt::new(BigInteger256([
                    0x097157739b6cb8d1,
                    0xbc1f1067d1d48c43,
                    0x776fa343cf22f72f,
                    0x13395a0118656ecf,
                ])),
                Felt::new(BigInteger256([
                    0xf7065b2e6cd34620,
                    0xe4441d370445b3e7,
                    0x5006a194fe5e7f20,
                    0x38b9db38daa79ed2,
                ])),
                Felt::new(BigInteger256([
                    0x5796b462f434d6a5,
                    0x219c42b1adcf6e0e,
                    0x638a9bcb0b336bee,
                    0x24a83443d6ef456a,
                ])),
                Felt::new(BigInteger256([
                    0xb9892160879f06ad,
                    0x27097ba45a12d3aa,
                    0x4bdf361232b0c7ad,
                    0x2f96ee946b59e4f0,
                ])),
                Felt::new(BigInteger256([
                    0x15b71f99599ff047,
                    0x04e677bf4a3d69ae,
                    0x0ec0b273a413f1bf,
                    0x37d77a36bb830cde,
                ])),
                Felt::new(BigInteger256([
                    0xbcb99b8a1d8dc603,
                    0xb979235f200f3216,
                    0xaa0a425597ad857c,
                    0x21d36d6227fb65df,
                ])),
            ],
        ];

        for i in input.iter_mut() {
            apply_sbox(i);
        }

        for (&i, o) in input.iter().zip(output) {
            assert_eq!(i, o);
        }
    }

    #[test]
    fn test_mds() {
        // Generated from https://github.com/Nashtare/anemoi-hash/
        let mut input = [
            [Felt::zero(); 8],
            [Felt::one(); 8],
            [
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
            ],
            [
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
            ],
            [
                Felt::new(BigInteger256([
                    0x9a9d7f544e6b6083,
                    0xf8d02aaed78a299d,
                    0x4655e14ee0bd285c,
                    0x0329fb8a600db15d,
                ])),
                Felt::new(BigInteger256([
                    0x2628971cf70c61e5,
                    0x8d372b0bad381505,
                    0x0151fa64cb7ed64b,
                    0x14a16942940e954a,
                ])),
                Felt::new(BigInteger256([
                    0x7d3707a0292fdb73,
                    0xa1b5f030a8cc6878,
                    0xd110df235445e457,
                    0x182fec1c3d52fdfb,
                ])),
                Felt::new(BigInteger256([
                    0xcf6477adaff5bafc,
                    0x16372918873b9cf7,
                    0xf4e02008b298ca08,
                    0x237b98dcc4762825,
                ])),
                Felt::new(BigInteger256([
                    0x97d19b1c757edc48,
                    0x6f69fb315484c277,
                    0x9e613c0bdb6651f8,
                    0x18cb86a9c8ca854f,
                ])),
                Felt::new(BigInteger256([
                    0x65ef2096e3189d64,
                    0x7550e6a6d712a74e,
                    0x83aa6efa55f03ca5,
                    0x03edc16d289df804,
                ])),
                Felt::new(BigInteger256([
                    0x9c1ca14a6389f937,
                    0x47211b260cbe76fa,
                    0xe7f029e2775db9b8,
                    0x2f753ce5d0c7b6d4,
                ])),
                Felt::new(BigInteger256([
                    0x79fd5be580d31470,
                    0x5a628d6a0f58737b,
                    0xfaf3ad54d367d1ad,
                    0x12d855e6c55036ae,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xa7fe530dee25e61d,
                    0x139cb644149f3d5d,
                    0xd76e7c2b04e3e465,
                    0x0197a409204eefc8,
                ])),
                Felt::new(BigInteger256([
                    0xfe3caa4b5c3afc15,
                    0x8f6e77bbe11cbcab,
                    0xd7007f9d9f6cfd07,
                    0x0b7e2fcecf975643,
                ])),
                Felt::new(BigInteger256([
                    0xbb19e666542b65fb,
                    0x4ff01b3ddb7aef04,
                    0xd7c53bcf5618450a,
                    0x27d832bedbc4634d,
                ])),
                Felt::new(BigInteger256([
                    0xecd8da39bd37dbc8,
                    0x4936f9035e2ac5eb,
                    0x8f704cb93d5e9633,
                    0x041154bac8807244,
                ])),
                Felt::new(BigInteger256([
                    0x27f6b90e28e7dc4e,
                    0x2d3f177d1e59b632,
                    0x62226dd887376dac,
                    0x10ca5a87a9610d0e,
                ])),
                Felt::new(BigInteger256([
                    0x27f04baa6568e0ec,
                    0xa64d44fac1857d15,
                    0xaa41e270063cde4e,
                    0x12c02f62a7f883b8,
                ])),
                Felt::new(BigInteger256([
                    0xd23fc4800fe6d5ae,
                    0x0102545a55c4d6d9,
                    0x6dbe28633c20a9f2,
                    0x03308811ce1092bd,
                ])),
                Felt::new(BigInteger256([
                    0x3f5986c86732478f,
                    0x89f9dd154b00486f,
                    0x03618dc3e08411cd,
                    0x1cdf3b5ebd08a6d5,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x89d937903f2caef2,
                    0x116779690f5d3e80,
                    0xfeefbd8f08f83c7d,
                    0x33a551f29892a971,
                ])),
                Felt::new(BigInteger256([
                    0x7db0f34a622b6082,
                    0x43587c890ae44240,
                    0x4f35c8e01d6368f3,
                    0x151f66ae0c2f78e2,
                ])),
                Felt::new(BigInteger256([
                    0x5034a78999ede57f,
                    0xf142c149b940a1ac,
                    0x901e6441e314412e,
                    0x31368a308096f406,
                ])),
                Felt::new(BigInteger256([
                    0x0e6ce3b0621fcb9e,
                    0xea9f1d2dc248909c,
                    0x2b3e82f7ed04ad20,
                    0x38b8a933a55fcf82,
                ])),
                Felt::new(BigInteger256([
                    0xdc820e5558aef3a8,
                    0x9c284bded9a5a91b,
                    0x8c4ec01e0e051bad,
                    0x2a19588a0e5010b8,
                ])),
                Felt::new(BigInteger256([
                    0xfb5c6ed2ef41e93d,
                    0x7281672e996cdc8a,
                    0x379d650f6f79869d,
                    0x3635c1bdb7c5269c,
                ])),
                Felt::new(BigInteger256([
                    0x109d1e5deb34a042,
                    0x99b995c7f585e269,
                    0x865dac08d3941c2b,
                    0x30435330196fb7f4,
                ])),
                Felt::new(BigInteger256([
                    0xd053b30073c41e75,
                    0x4dba19c9522ec198,
                    0xb92012edd1045a08,
                    0x271e5976b0ee3aaf,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x2678afe66893bb46,
                    0xbbd9b96c27e80cf6,
                    0xb752666ee88692cd,
                    0x14c0e036bbde0faf,
                ])),
                Felt::new(BigInteger256([
                    0xb518381498a94635,
                    0xa96a3ef760e8de1b,
                    0x429b802ad9f3c504,
                    0x1e2361405e6802d4,
                ])),
                Felt::new(BigInteger256([
                    0xb14b4bf720e785e8,
                    0xb13c1ea15e10d922,
                    0xa5d79d673d141e4c,
                    0x02b6ea3bb15155cd,
                ])),
                Felt::new(BigInteger256([
                    0x59ebbdb02c5878f3,
                    0x9b3d4e5da6fc7a98,
                    0xb3d6e52877062c64,
                    0x18d922244633f400,
                ])),
                Felt::new(BigInteger256([
                    0x12ef4e75cfca9f5b,
                    0x9782335485b59079,
                    0x9f36e8a996d8920e,
                    0x2df873c3c555b050,
                ])),
                Felt::new(BigInteger256([
                    0x2d2207271a676fea,
                    0x7babea691d5bf647,
                    0x634ea646ebe6b40b,
                    0x08e53b485fc615ae,
                ])),
                Felt::new(BigInteger256([
                    0x6e36fe911d548fb6,
                    0xaf86d0603f3247d0,
                    0xec8757155d30e00f,
                    0x02c26b4ce23db050,
                ])),
                Felt::new(BigInteger256([
                    0xb10e034d39847868,
                    0x0754cabf3d8c94df,
                    0xfef91270ba89e588,
                    0x17c058b6157391fa,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xb64b406131481d1e,
                    0x4e1f02d86bdd935c,
                    0x95a97de461252bec,
                    0x2db183fa39abc261,
                ])),
                Felt::new(BigInteger256([
                    0x9a3cf5082d09b32b,
                    0x098b92000b1813f8,
                    0xf129f2118d0b6a76,
                    0x151e94e376476745,
                ])),
                Felt::new(BigInteger256([
                    0xbaa6d191cbe229f8,
                    0xdc0b5953f7f2b26e,
                    0xae437d628ad289b6,
                    0x3edcbea793e28818,
                ])),
                Felt::new(BigInteger256([
                    0xccfacea56377aa8e,
                    0xdf173b67b8921503,
                    0x714ab2c2fe404420,
                    0x2c631adf34b7c20a,
                ])),
                Felt::new(BigInteger256([
                    0xc457936f15d1efe8,
                    0xa8db7aaf84065ef6,
                    0xa382ef028ebfdb7e,
                    0x09abcc16b7fbe1b5,
                ])),
                Felt::new(BigInteger256([
                    0x28bae718e347951e,
                    0x5039a2a32e6739fc,
                    0xf3e1f620bb2d94a8,
                    0x04c5c60844bba95c,
                ])),
                Felt::new(BigInteger256([
                    0x61b1a8ef60e91931,
                    0x34f03c932cd019c4,
                    0x8b9db9d3c6202f28,
                    0x2281d5e794efd579,
                ])),
                Felt::new(BigInteger256([
                    0x4fe0821fefda4751,
                    0xba14395a5fe5d929,
                    0x4cbbe552c852663e,
                    0x0c7998cb2089f805,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xa062f09f236f96df,
                    0xbe727e7f21b68283,
                    0xce543c050fadd555,
                    0x37143de659ca1e3f,
                ])),
                Felt::new(BigInteger256([
                    0x168ac9834b96e3da,
                    0x58ec0f39d3ae92a2,
                    0x283be6949184f70e,
                    0x13db9cc4218d3c05,
                ])),
                Felt::new(BigInteger256([
                    0xc9ec06f21d2d45c4,
                    0x1763cfb52af18f4f,
                    0xa903e7f0939aaf5a,
                    0x01fc5bce855737b0,
                ])),
                Felt::new(BigInteger256([
                    0x6dc2d3f475b2aa17,
                    0x42e8a908c8d61e4e,
                    0xadf5176b8f1f03d5,
                    0x2d34ac3804095042,
                ])),
                Felt::new(BigInteger256([
                    0xfdbd277c21baf645,
                    0xc1844f9b30062e1a,
                    0x63f24bd91e9ca279,
                    0x37635211876d8c21,
                ])),
                Felt::new(BigInteger256([
                    0x31cf0a09e3c93bba,
                    0xd6c104f03c4d5e23,
                    0xdd9fdd437ca82cf4,
                    0x304614087dc50023,
                ])),
                Felt::new(BigInteger256([
                    0x7fe65ec8e011088f,
                    0xcc39777bc70c0f53,
                    0xb2df81b86a6f4717,
                    0x2518f99518876abf,
                ])),
                Felt::new(BigInteger256([
                    0x84ea4125f88fc228,
                    0xe4c21cf0a0bd503f,
                    0xbd42fbf5c462da84,
                    0x2fa61e7d90fe0985,
                ])),
            ],
        ];

        let mut input2 = input;

        let output = [
            [Felt::zero(); 8],
            [
                Felt::new(BigInteger256([
                    0x4970765cffffffbd,
                    0x0785f6097e17ce04,
                    0xfffffffffffffff7,
                    0x3fffffffffffffff,
                ])),
                Felt::new(BigInteger256([
                    0xbc7e6600fffffee1,
                    0x92da7d714256af9f,
                    0xffffffffffffffd9,
                    0x3fffffffffffffff,
                ])),
                Felt::new(BigInteger256([
                    0x9d1d81bcffffff1d,
                    0x9b665883812e438c,
                    0xffffffffffffffe1,
                    0x3fffffffffffffff,
                ])),
                Felt::new(BigInteger256([
                    0x2d400cb0ffffff91,
                    0x2363aab7d88ac7f0,
                    0xfffffffffffffff1,
                    0x3fffffffffffffff,
                ])),
                Felt::new(BigInteger256([
                    0x4970765cffffffbd,
                    0x0785f6097e17ce04,
                    0xfffffffffffffff7,
                    0x3fffffffffffffff,
                ])),
                Felt::new(BigInteger256([
                    0xbc7e6600fffffee1,
                    0x92da7d714256af9f,
                    0xffffffffffffffd9,
                    0x3fffffffffffffff,
                ])),
                Felt::new(BigInteger256([
                    0x9d1d81bcffffff1d,
                    0x9b665883812e438c,
                    0xffffffffffffffe1,
                    0x3fffffffffffffff,
                ])),
                Felt::new(BigInteger256([
                    0x2d400cb0ffffff91,
                    0x2363aab7d88ac7f0,
                    0xfffffffffffffff1,
                    0x3fffffffffffffff,
                ])),
            ],
            [
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::new(BigInteger256([
                    0x4970765cffffffbd,
                    0x0785f6097e17ce04,
                    0xfffffffffffffff7,
                    0x3fffffffffffffff,
                ])),
                Felt::new(BigInteger256([
                    0xbc7e6600fffffee1,
                    0x92da7d714256af9f,
                    0xffffffffffffffd9,
                    0x3fffffffffffffff,
                ])),
                Felt::new(BigInteger256([
                    0x9d1d81bcffffff1d,
                    0x9b665883812e438c,
                    0xffffffffffffffe1,
                    0x3fffffffffffffff,
                ])),
                Felt::new(BigInteger256([
                    0x2d400cb0ffffff91,
                    0x2363aab7d88ac7f0,
                    0xfffffffffffffff1,
                    0x3fffffffffffffff,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x4970765cffffffbd,
                    0x0785f6097e17ce04,
                    0xfffffffffffffff7,
                    0x3fffffffffffffff,
                ])),
                Felt::new(BigInteger256([
                    0xbc7e6600fffffee1,
                    0x92da7d714256af9f,
                    0xffffffffffffffd9,
                    0x3fffffffffffffff,
                ])),
                Felt::new(BigInteger256([
                    0x9d1d81bcffffff1d,
                    0x9b665883812e438c,
                    0xffffffffffffffe1,
                    0x3fffffffffffffff,
                ])),
                Felt::new(BigInteger256([
                    0x2d400cb0ffffff91,
                    0x2363aab7d88ac7f0,
                    0xfffffffffffffff1,
                    0x3fffffffffffffff,
                ])),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
            ],
            [
                Felt::new(BigInteger256([
                    0xb4f103c156719c06,
                    0x1215157a9d86cdbc,
                    0x2bf6bb87c80f9600,
                    0x294c0bf6e152efc2,
                ])),
                Felt::new(BigInteger256([
                    0x017b0365229e1314,
                    0x0c3040ee67623006,
                    0x7204f3b7718a1653,
                    0x117300769c117e50,
                ])),
                Felt::new(BigInteger256([
                    0x9997013611a43977,
                    0xa2691a2a583249c9,
                    0x8db613e355b67efb,
                    0x3ff2594caedad535,
                ])),
                Felt::new(BigInteger256([
                    0xa35f2a4261be2307,
                    0x5f9d20439fcfa949,
                    0x871e2612d7d45952,
                    0x03c09cd46a56792c,
                ])),
                Felt::new(BigInteger256([
                    0x91b54d7807ee283f,
                    0x212805afd3cae0de,
                    0xf1f3f92c8c294933,
                    0x3ae07da2d3d1ecfa,
                ])),
                Felt::new(BigInteger256([
                    0xbd9e4450e8f884d1,
                    0xd0a57bce671436f5,
                    0xb9ad637bc3461f79,
                    0x33c5d34baf69a7e9,
                ])),
                Felt::new(BigInteger256([
                    0x2df4b8ba27acf32d,
                    0x6bef77eb771a7460,
                    0x3354032c046acca4,
                    0x2c4853fbd4fd69c8,
                ])),
                Felt::new(BigInteger256([
                    0x765f1a55de99f589,
                    0x936b0cf56b7dee6f,
                    0xaa5a31886a156aff,
                    0x149afbeb7b98dc89,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xb40c676e6e781766,
                    0xe4dc860155358ea2,
                    0xe57d2487a2c41ac5,
                    0x221c68423333213b,
                ])),
                Felt::new(BigInteger256([
                    0x4819a8c82b07d8bb,
                    0x677b316a35d49ce5,
                    0x744bc77dd0a90732,
                    0x1c6873a03f90c355,
                ])),
                Felt::new(BigInteger256([
                    0x3a483eb306f0a387,
                    0x25a9d968d65b084c,
                    0x3d3d9ebed235cdd9,
                    0x0761df35fc43e826,
                ])),
                Felt::new(BigInteger256([
                    0x53c549459f945e27,
                    0x3b04cc0876778de1,
                    0xdd185c2c15b71818,
                    0x279ae034ab32f1bf,
                ])),
                Felt::new(BigInteger256([
                    0xe8e479579554964d,
                    0xb75da204ac91dbe0,
                    0x384abed175aa575a,
                    0x0a334d4d7c6c779a,
                ])),
                Felt::new(BigInteger256([
                    0x11c2ab25f16f2616,
                    0xa986722a7cd5af3d,
                    0xc87be376ba3fc13f,
                    0x1a61dac5429587d7,
                ])),
                Felt::new(BigInteger256([
                    0x230e41f8d16a4663,
                    0x9978697ae78e274b,
                    0xa8312f7886f2f225,
                    0x261f44ec3c3226b3,
                ])),
                Felt::new(BigInteger256([
                    0xdb3dacf808cb039b,
                    0xe49d86332c35e402,
                    0x126d62ca48b56e49,
                    0x08b13d1b73faf4f7,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x4e1a890578756784,
                    0x77db2a20510185e8,
                    0x8302f6f0c9c959be,
                    0x040dbafb9f81506b,
                ])),
                Felt::new(BigInteger256([
                    0x94ac3bef7f638576,
                    0x6fbdf0b1d1efd8c6,
                    0x6a1d076dd3912c36,
                    0x1c098b71728a5966,
                ])),
                Felt::new(BigInteger256([
                    0xc1d4f2a3a8462d65,
                    0x2a5c2387919b2ac1,
                    0x353f96ec302377e8,
                    0x20c0891677cb2b4f,
                ])),
                Felt::new(BigInteger256([
                    0x3890c035014d8060,
                    0x3c927f205d15a518,
                    0x34fd1a1476984210,
                    0x289dff527cabcb93,
                ])),
                Felt::new(BigInteger256([
                    0xb82bd14870bd054f,
                    0x253e5352cc52ff03,
                    0xb8f98c7fc0217c2f,
                    0x2de02ee20c9aef60,
                ])),
                Felt::new(BigInteger256([
                    0x4307985273b7bd71,
                    0x7f96391d032d40ee,
                    0x8b7bba682e8bbf1c,
                    0x2cf091e0b05e6bf5,
                ])),
                Felt::new(BigInteger256([
                    0x0a8e6919dd7141a0,
                    0x444c49c4bc385801,
                    0x907d3f00b177e5b6,
                    0x258977ec74f85b25,
                ])),
                Felt::new(BigInteger256([
                    0xe20f5d690dbca869,
                    0xca122f261a7c7319,
                    0xfb2fa2171d6ac5c8,
                    0x1856f01130f358ec,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xdfba99017ecb5ac6,
                    0x8755574756b897ef,
                    0x075ff43e88c0a65f,
                    0x13656598c7e891b1,
                ])),
                Felt::new(BigInteger256([
                    0xc050ccecc77dd9d3,
                    0x8a9608c2a9188024,
                    0x528e8f02cb720abe,
                    0x30993fd895035be2,
                ])),
                Felt::new(BigInteger256([
                    0x2fe030c549ef8087,
                    0x463e10e2d19c2a69,
                    0x451c815e052bbc31,
                    0x10181bb6e760dcb5,
                ])),
                Felt::new(BigInteger256([
                    0x525f3214b154db1c,
                    0x93cc1ba68377066b,
                    0x9cdc5a67cc2a89df,
                    0x2ab3cf10917ae245,
                ])),
                Felt::new(BigInteger256([
                    0xd8fbffb7f8ee44f8,
                    0x07a6c62138ed1391,
                    0x056a984ab1f84a5a,
                    0x360fbd76f326830e,
                ])),
                Felt::new(BigInteger256([
                    0x9d801ee44ad27079,
                    0x744ee6dfefd6edb4,
                    0x3bbcdf5bcfcb7ec4,
                    0x395a6ac1d8f6c6dc,
                ])),
                Felt::new(BigInteger256([
                    0x5fdd24e489a02b21,
                    0x97dadb881378183a,
                    0x8628446d66eac885,
                    0x0ef253e027d409cd,
                ])),
                Felt::new(BigInteger256([
                    0xdc1a9484df64e271,
                    0x32996d6c7a4088c5,
                    0x33cf73c1b646c0f0,
                    0x1e4e7225028f115b,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xf2d5053b2c4376b3,
                    0xb608c3aeb7a2aee7,
                    0xda6c1b095cc7afe5,
                    0x04a840f0ea5ba0b4,
                ])),
                Felt::new(BigInteger256([
                    0x97d222b0249f26b9,
                    0x005788330a9dc576,
                    0xd442480c31a9eb96,
                    0x1159f59c39589cc0,
                ])),
                Felt::new(BigInteger256([
                    0x693e67bd56ad804e,
                    0x7fb2c060c05c1506,
                    0x80a99cf8c312d212,
                    0x0f81cd88fef025b3,
                ])),
                Felt::new(BigInteger256([
                    0x9516474a675432a9,
                    0xa013ea649319bc42,
                    0xedd7fd9a01fae3f1,
                    0x3f1bd8248ed33304,
                ])),
                Felt::new(BigInteger256([
                    0x1a9ab0db451b405c,
                    0xd128955b7efda0e3,
                    0xeace76c21349f84b,
                    0x028bc1defcf7eadc,
                ])),
                Felt::new(BigInteger256([
                    0xc68e616d1c717e76,
                    0xfa2ba526f483a8e6,
                    0x009475105365df0c,
                    0x37c2c1aed57d1140,
                ])),
                Felt::new(BigInteger256([
                    0xaa1955791b86ec68,
                    0x8be65605c728b2e6,
                    0x9545ae42c169aa91,
                    0x1c7e9bbfb230a539,
                ])),
                Felt::new(BigInteger256([
                    0xee3c5310afe097cc,
                    0xad01a126ae5aa803,
                    0x0bcfd58b288ea6dc,
                    0x109d99a4f54d46c3,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xf4646d6dc7589d3c,
                    0xc9d19fa7a1386135,
                    0x7298a04d266c1f97,
                    0x1a2f129fd1fc2e1f,
                ])),
                Felt::new(BigInteger256([
                    0xee4d7b350f5160c2,
                    0x5ab38f6750138633,
                    0x4cde532a31840f4f,
                    0x31e3f7b9ffbbbdd7,
                ])),
                Felt::new(BigInteger256([
                    0x248fdcc8b6ff3e3e,
                    0x85f9e47c9aab9146,
                    0xd0d5d576ac4abc1b,
                    0x22a4bfc4a916e9fc,
                ])),
                Felt::new(BigInteger256([
                    0xab226148682bacea,
                    0xb3eb7764fb8bf40f,
                    0xf15e64b8db892160,
                    0x3e13042c3eba41ba,
                ])),
                Felt::new(BigInteger256([
                    0x2b27485da7a50929,
                    0x442ac4c1876f477a,
                    0xb4e74ea06a41487b,
                    0x120b20528b0b6ce5,
                ])),
                Felt::new(BigInteger256([
                    0x78fb6348c70cf7a1,
                    0xe307b40c2ca2de99,
                    0x55c8f94a9082d304,
                    0x0eee71ff5fc4c489,
                ])),
                Felt::new(BigInteger256([
                    0x7342989ce34232c0,
                    0x1f90d2ba9ef85bb8,
                    0x316109a60d58fe96,
                    0x12425f4a6b05c287,
                ])),
                Felt::new(BigInteger256([
                    0xcb7f0e109ca354d4,
                    0x44a553948523fad7,
                    0xeb5675650c532f33,
                    0x3449b67801f70f78,
                ])),
            ],
        ];

        for i in input.iter_mut() {
            apply_mds(i);
        }
        for i in input2.iter_mut() {
            apply_naive_mds(i);
        }

        for (index, (&i_1, i_2)) in input.iter().zip(input2).enumerate() {
            assert_eq!(output[index], i_1);
            assert_eq!(output[index], i_2);
        }
    }
}
