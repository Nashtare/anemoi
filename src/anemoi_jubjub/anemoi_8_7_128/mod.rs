use super::{sbox, BigInteger256, Felt};
use crate::{Jive, Sponge};
use ark_ff::{Field, One, Zero};
use unroll::unroll_for_loops;

/// Digest for Anemoi
mod digest;
/// Sponge for Anemoi
mod hasher;
/// MDS matrix for Anemoi
mod mds;
/// Round constants for Anemoi
mod round_constants;

pub use digest::AnemoiDigest;
pub use hasher::AnemoiHash;

// ANEMOI CONSTANTS
// ================================================================================================

/// Function state is set to 8 field elements or 256 bytes.
/// 1 element of the state is reserved for capacity.
pub const STATE_WIDTH: usize = 8;
/// 7 elements of the state are reserved for rate.
pub const RATE_WIDTH: usize = 7;

/// The state is divided into two even-length rows.
pub const NUM_COLUMNS: usize = 4;

/// 1 element (32-bytes) is returned as digest.
pub const DIGEST_SIZE: usize = 1;

/// The number of rounds is set to 10 to provide 128-bit security level.
pub const NUM_HASH_ROUNDS: usize = 10;

// HELPER FUNCTIONS
// ================================================================================================

#[inline(always)]
/// Applies exponentiation of the current hash
/// state elements with the Anemoi S-Box.
pub(crate) fn apply_sbox(state: &mut [Felt; STATE_WIDTH]) {
    let mut x: [Felt; NUM_COLUMNS] = state[..NUM_COLUMNS].try_into().unwrap();
    let mut y: [Felt; NUM_COLUMNS] = state[NUM_COLUMNS..].try_into().unwrap();

    x.iter_mut().enumerate().for_each(|(i, t)| {
        let y2 = y[i].square();
        let beta_y2 = y2 + (y2 + y2.double()).double();
        *t -= beta_y2;
    });

    let mut x_alpha_inv = x;
    x_alpha_inv
        .iter_mut()
        .for_each(|t| *t = sbox::exp_inv_alpha(t));

    y.iter_mut()
        .enumerate()
        .for_each(|(i, t)| *t -= x_alpha_inv[i]);

    x.iter_mut().enumerate().for_each(|(i, t)| {
        let y2 = y[i].square();
        let beta_y2 = y2 + (y2 + y2.double()).double();
        *t += beta_y2 + sbox::DELTA;
    });

    state[..NUM_COLUMNS].copy_from_slice(&x);
    state[NUM_COLUMNS..].copy_from_slice(&y);
}

#[inline(always)]
/// Applies matrix-vector multiplication of the current
/// hash state with the Anemoi MDS matrix.
pub(crate) fn apply_mds(state: &mut [Felt; STATE_WIDTH]) {
    let x: [Felt; NUM_COLUMNS] = [state[0], state[1], state[2], state[3]];
    let y: [Felt; NUM_COLUMNS] = [state[5], state[6], state[7], state[4]];

    let sum_coeffs = x[0] + x[1] + x[2] + x[3];
    state[0] = sum_coeffs + x[2] + x[3].double();
    state[1] = sum_coeffs + x[3] + x[0].double();
    state[2] = sum_coeffs + x[0] + x[1].double();
    state[3] = sum_coeffs + x[1] + x[2].double();

    let sum_coeffs = y[0] + y[1] + y[2] + y[3];
    state[4] = sum_coeffs + y[2] + y[3].double();
    state[5] = sum_coeffs + y[3] + y[0].double();
    state[6] = sum_coeffs + y[0] + y[1].double();
    state[7] = sum_coeffs + y[1] + y[2].double();
}

// ANEMOI PERMUTATION
// ================================================================================================

/// Applies Anemoi permutation to the provided state.
#[inline(always)]
#[unroll_for_loops]
pub(crate) fn apply_permutation(state: &mut [Felt; STATE_WIDTH]) {
    for i in 0..NUM_HASH_ROUNDS {
        apply_round(state, i);
    }

    apply_mds(state)
}

/// Anemoi round function;
/// implementation based on algorithm 3 of <https://eprint.iacr.org/2020/1143.pdf>
#[inline(always)]
#[unroll_for_loops]
pub(crate) fn apply_round(state: &mut [Felt; STATE_WIDTH], step: usize) {
    // determine which round constants to use
    let c = &round_constants::C[step % NUM_HASH_ROUNDS];
    let d = &round_constants::D[step % NUM_HASH_ROUNDS];

    for i in 0..NUM_COLUMNS {
        state[i] += c[i];
        state[NUM_COLUMNS + i] += d[i];
    }

    apply_mds(state);
    apply_sbox(state);
}

#[cfg(test)]
mod tests {
    use super::*;

    fn apply_naive_mds(state: &mut [Felt; STATE_WIDTH]) {
        let x: [Felt; NUM_COLUMNS] = state[..NUM_COLUMNS].try_into().unwrap();
        let mut y: [Felt; NUM_COLUMNS] = [Felt::zero(); NUM_COLUMNS];
        y[0..NUM_COLUMNS - 1].copy_from_slice(&state[NUM_COLUMNS + 1..]);
        y[NUM_COLUMNS - 1] = state[NUM_COLUMNS];

        let mut result = [Felt::zero(); STATE_WIDTH];
        for (i, r) in result.iter_mut().enumerate().take(NUM_COLUMNS) {
            for (j, s) in x.into_iter().enumerate().take(NUM_COLUMNS) {
                *r += s * mds::MDS[i * NUM_COLUMNS + j];
            }
        }
        for (i, r) in result.iter_mut().enumerate().skip(NUM_COLUMNS) {
            for (j, s) in y.into_iter().enumerate() {
                *r += s * mds::MDS[(i - NUM_COLUMNS) * NUM_COLUMNS + j];
            }
        }

        state.copy_from_slice(&result);
    }

    #[test]
    fn test_sbox() {
        // Generated from https://github.com/Nashtare/anemoi-hash/
        let mut input = [
            [Felt::zero(); 8],
            [Felt::one(); 8],
            [
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
            ],
            [
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
            ],
            [
                Felt::new(BigInteger256([
                    0x45c048bfaaf03451,
                    0xce72454c6a76dee8,
                    0xb965049553afecd9,
                    0x2bb8aa431cd115b4,
                ])),
                Felt::new(BigInteger256([
                    0x87294b4f1bebc886,
                    0x7961cc5d71bc4109,
                    0x7983e3d20475bc23,
                    0x36cdccea52802b37,
                ])),
                Felt::new(BigInteger256([
                    0x61b0a078fa2896b1,
                    0x2c83f3fb284eb37a,
                    0x7c11c033efa37dec,
                    0x11f25fa6d916a722,
                ])),
                Felt::new(BigInteger256([
                    0xabe75adcc78fb098,
                    0x37b8521ac80bed39,
                    0xccab5dc1b177e258,
                    0x51d58a351e57a915,
                ])),
                Felt::new(BigInteger256([
                    0x84373d18a7d6eb32,
                    0x5c95c14b883571be,
                    0x0b058786b4cbee39,
                    0x65efaae4154462bb,
                ])),
                Felt::new(BigInteger256([
                    0x5507063e85abf7f2,
                    0xe18a3bb2d9787da7,
                    0xeb97f0f97a248c79,
                    0x48a2a7ab61700e5e,
                ])),
                Felt::new(BigInteger256([
                    0x78a5dcad7bd2259e,
                    0x820e5ce93ab073f1,
                    0x9d498d6caf73ed0a,
                    0x3b72dc4eaae85328,
                ])),
                Felt::new(BigInteger256([
                    0x1ab0a21e4ca5c50f,
                    0x4e09df044d391be6,
                    0x24eacefc82797a84,
                    0x245c97199ad4b242,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xe60509ea896c493b,
                    0xc4d044df0e5ad3a5,
                    0x2372775748d1a103,
                    0x573b4c45ad79b6db,
                ])),
                Felt::new(BigInteger256([
                    0xc4bc29c0c52cb098,
                    0xc10695554c2a19c6,
                    0xcdab169c38364bcc,
                    0x3f9197516eb15054,
                ])),
                Felt::new(BigInteger256([
                    0x3d141e8aa5683a55,
                    0x601421b2efe9ec6b,
                    0xb51c60a68728936b,
                    0x3e6861e8dadcff7e,
                ])),
                Felt::new(BigInteger256([
                    0x8dfc8d8b691c57a0,
                    0x51616a3791614d7b,
                    0xe4a8f40b17d43b7d,
                    0x179195c723fd0978,
                ])),
                Felt::new(BigInteger256([
                    0x9a39b95eaa35bbb8,
                    0xc90ab4b6aaa82af1,
                    0xa8c84a0ed4a7720f,
                    0x5b840a5c9f57b317,
                ])),
                Felt::new(BigInteger256([
                    0xae3d6b46a2f35c49,
                    0x82313c88a4df86cc,
                    0x834fe7301f757472,
                    0x2dee2677e30301d4,
                ])),
                Felt::new(BigInteger256([
                    0xd3aaadda59edeec1,
                    0xa4a3b2ecb1f1287d,
                    0x55ffa7d9e468b478,
                    0x3e44913a0017eef0,
                ])),
                Felt::new(BigInteger256([
                    0xa512850d3ca33462,
                    0x9fcd7d443fda54a9,
                    0x8ef9d99008604ea0,
                    0x0622bfa743070932,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x6d9524dd1a092788,
                    0x6de9fc70ccf64b23,
                    0xb54da90a89be4a0d,
                    0x5bb60b7bba687ffa,
                ])),
                Felt::new(BigInteger256([
                    0x47f3f88e8d5b67c1,
                    0xedb0d2ac8a94f1f2,
                    0x3d5cb4183ce6b1c3,
                    0x46e48098d9b62977,
                ])),
                Felt::new(BigInteger256([
                    0x9372e90017ec349e,
                    0x69664f1059835f39,
                    0xc1ff6cbafba52745,
                    0x2d46ebaf17fea14c,
                ])),
                Felt::new(BigInteger256([
                    0x9d427c998a9748c2,
                    0x07090ad0f2ee6e12,
                    0x857c0cf1f8afb64e,
                    0x2e81a87835bc2487,
                ])),
                Felt::new(BigInteger256([
                    0x4a10669363ed5298,
                    0x52af5054d14b5fbe,
                    0xd06dde6a3bc46c9c,
                    0x48678060e067988a,
                ])),
                Felt::new(BigInteger256([
                    0x941cd363881f7169,
                    0x8e6e31ccf96cd536,
                    0x3b8f110b43f99c0b,
                    0x29f2398459b9d9d6,
                ])),
                Felt::new(BigInteger256([
                    0xe3c7b46fe38fee8a,
                    0x1488b79e5ace502c,
                    0xb03991fc9c2b9bac,
                    0x3805a418ac7beed6,
                ])),
                Felt::new(BigInteger256([
                    0x46260fcf10b2e0bc,
                    0xbf6af20a9c195a99,
                    0xa056e6b30db1ff57,
                    0x59eef56ccbb42006,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xcaedc14a1088661d,
                    0x3dd22a6f31f75866,
                    0xf42a73a61cdf1786,
                    0x56cc584ed0d34066,
                ])),
                Felt::new(BigInteger256([
                    0x25e25ab8f3d8c5ed,
                    0x62f6a135e2821273,
                    0xe7cba2ea5984eaea,
                    0x4300185c4a03cc50,
                ])),
                Felt::new(BigInteger256([
                    0x03063be1da115163,
                    0xcfb95e0067eb3989,
                    0x9026209f7c94298a,
                    0x1eca5324680e5e70,
                ])),
                Felt::new(BigInteger256([
                    0x3c5bdd8e315d9736,
                    0x5c1e2714a98241e1,
                    0x3ae62a9da1af5a3b,
                    0x66e7cb434b63cb8a,
                ])),
                Felt::new(BigInteger256([
                    0xfbe10891c07cb5f9,
                    0x148fa35a71ccd0c7,
                    0x7bbb11480ebbc668,
                    0x6bc352271eebd5a8,
                ])),
                Felt::new(BigInteger256([
                    0x0180983854f379d6,
                    0x3a8d7beeeb2a8959,
                    0x187d928fe19b873d,
                    0x03b2ae9885e33ac4,
                ])),
                Felt::new(BigInteger256([
                    0xee7288d0fd5e2938,
                    0x02813fab087f062b,
                    0x6b40e41f8986e6c0,
                    0x025f12e2edbc7471,
                ])),
                Felt::new(BigInteger256([
                    0xe88703d0eaf73c3a,
                    0x12af060e41fb1285,
                    0x1de729e4caf0a199,
                    0x525afa35c36cd348,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x2a7dbde7494c3aed,
                    0xbddcc6b34a4dbaab,
                    0xd95cd8101a215208,
                    0x5011df300344a78f,
                ])),
                Felt::new(BigInteger256([
                    0x32ca9c20f5d01b85,
                    0x85258c6200122530,
                    0x7683c9cb57cb22aa,
                    0x666a1c4dd06e51cd,
                ])),
                Felt::new(BigInteger256([
                    0xa5de0191a895a225,
                    0x51d5609faf71fe05,
                    0x68e87a6f9cac0146,
                    0x4b09f709f0892972,
                ])),
                Felt::new(BigInteger256([
                    0xe5a5d60656439df3,
                    0x21235cb37b3cdc4a,
                    0x4ef4aca9498d224d,
                    0x089df7edcf2c3247,
                ])),
                Felt::new(BigInteger256([
                    0xd01579aa01a083be,
                    0x14e4c36168bd0249,
                    0x4133dceed35d4d43,
                    0x71e8efcea23f6985,
                ])),
                Felt::new(BigInteger256([
                    0x3b3d8732680eb389,
                    0xbdf9fe08f7a17b1e,
                    0x4f268f704cd44779,
                    0x41a8832b4adc05df,
                ])),
                Felt::new(BigInteger256([
                    0xc166bcf4495cac90,
                    0x3136a896830c7b4e,
                    0x67e3b6f07ea70be0,
                    0x04fdc0ae5a99ae36,
                ])),
                Felt::new(BigInteger256([
                    0x601640d32c2cf95e,
                    0x0ec4fdea22334cf1,
                    0x83b23a3b1052617a,
                    0x129bedf8e1bf5044,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xee993a13110ce4c2,
                    0x753126bbb0b03221,
                    0xbf4cc3cf6b2a80d4,
                    0x38f64e9007ef52c4,
                ])),
                Felt::new(BigInteger256([
                    0x297b3770b4e658b2,
                    0x48311b7d81b990a5,
                    0x4b6cf53552a70faf,
                    0x1ee8ef23b3fd3f41,
                ])),
                Felt::new(BigInteger256([
                    0xad1ad2bac6900b0f,
                    0x8d7160761bb4dabc,
                    0xa71ba4481b39275b,
                    0x53096d428a65355b,
                ])),
                Felt::new(BigInteger256([
                    0x75519cd418cd783c,
                    0x02fcc606abba5d98,
                    0x69143b43d5322751,
                    0x18e7a951524add34,
                ])),
                Felt::new(BigInteger256([
                    0xa4b87ae9b101b16b,
                    0xe64caaaa5601cdf6,
                    0x17b4fe349cf600e8,
                    0x46d7e5e88021c3eb,
                ])),
                Felt::new(BigInteger256([
                    0x5d779b9d28511b0d,
                    0x2f2a8243cf379207,
                    0x3740ddad66b6b447,
                    0x174f77300bdc739c,
                ])),
                Felt::new(BigInteger256([
                    0xfbd840eb5c0a0bcc,
                    0xff296101d309a7a6,
                    0x1ebd68839e472d5a,
                    0x1109093003a2c038,
                ])),
                Felt::new(BigInteger256([
                    0xd19ed51e40582aac,
                    0x27d3ce8abe8b6331,
                    0x4b6335737afe635e,
                    0x5c00019208679e0d,
                ])),
            ],
        ];

        let output = [
            [
                Felt::new(BigInteger256([
                    0xdb6db6dadb6db6dc,
                    0xe6b5824adb6cc6da,
                    0xf8b356e005810db9,
                    0x66d0f1e660ec4796,
                ])),
                Felt::new(BigInteger256([
                    0xdb6db6dadb6db6dc,
                    0xe6b5824adb6cc6da,
                    0xf8b356e005810db9,
                    0x66d0f1e660ec4796,
                ])),
                Felt::new(BigInteger256([
                    0xdb6db6dadb6db6dc,
                    0xe6b5824adb6cc6da,
                    0xf8b356e005810db9,
                    0x66d0f1e660ec4796,
                ])),
                Felt::new(BigInteger256([
                    0xdb6db6dadb6db6dc,
                    0xe6b5824adb6cc6da,
                    0xf8b356e005810db9,
                    0x66d0f1e660ec4796,
                ])),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
            ],
            [
                Felt::new(BigInteger256([
                    0xd99f4a8fe00e11bd,
                    0xe12a753d82b33b30,
                    0xba87bf86c47e6f0b,
                    0x58de312b5993b67f,
                ])),
                Felt::new(BigInteger256([
                    0xd99f4a8fe00e11bd,
                    0xe12a753d82b33b30,
                    0xba87bf86c47e6f0b,
                    0x58de312b5993b67f,
                ])),
                Felt::new(BigInteger256([
                    0xd99f4a8fe00e11bd,
                    0xe12a753d82b33b30,
                    0xba87bf86c47e6f0b,
                    0x58de312b5993b67f,
                ])),
                Felt::new(BigInteger256([
                    0xd99f4a8fe00e11bd,
                    0xe12a753d82b33b30,
                    0xba87bf86c47e6f0b,
                    0x58de312b5993b67f,
                ])),
                Felt::new(BigInteger256([
                    0xb4c1972e044567f4,
                    0x8e14aacbecb9fb59,
                    0x2c0f182612f81cd9,
                    0x34d6a5db27797543,
                ])),
                Felt::new(BigInteger256([
                    0xb4c1972e044567f4,
                    0x8e14aacbecb9fb59,
                    0x2c0f182612f81cd9,
                    0x34d6a5db27797543,
                ])),
                Felt::new(BigInteger256([
                    0xb4c1972e044567f4,
                    0x8e14aacbecb9fb59,
                    0x2c0f182612f81cd9,
                    0x34d6a5db27797543,
                ])),
                Felt::new(BigInteger256([
                    0xb4c1972e044567f4,
                    0x8e14aacbecb9fb59,
                    0x2c0f182612f81cd9,
                    0x34d6a5db27797543,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x34413b9512617cf9,
                    0x7e6bdaab3f8443c5,
                    0x752178862c9a6ab7,
                    0x3dde7b14d2951772,
                ])),
                Felt::new(BigInteger256([
                    0x34413b9512617cf9,
                    0x7e6bdaab3f8443c5,
                    0x752178862c9a6ab7,
                    0x3dde7b14d2951772,
                ])),
                Felt::new(BigInteger256([
                    0x34413b9512617cf9,
                    0x7e6bdaab3f8443c5,
                    0x752178862c9a6ab7,
                    0x3dde7b14d2951772,
                ])),
                Felt::new(BigInteger256([
                    0x34413b9512617cf9,
                    0x7e6bdaab3f8443c5,
                    0x752178862c9a6ab7,
                    0x3dde7b14d2951772,
                ])),
                Felt::new(BigInteger256([
                    0xbdf2fa0b931e7a04,
                    0x60f39c6eae7a9a3c,
                    0x34e97cf1bd62a467,
                    0x13b9e8a487cc4745,
                ])),
                Felt::new(BigInteger256([
                    0xbdf2fa0b931e7a04,
                    0x60f39c6eae7a9a3c,
                    0x34e97cf1bd62a467,
                    0x13b9e8a487cc4745,
                ])),
                Felt::new(BigInteger256([
                    0xbdf2fa0b931e7a04,
                    0x60f39c6eae7a9a3c,
                    0x34e97cf1bd62a467,
                    0x13b9e8a487cc4745,
                ])),
                Felt::new(BigInteger256([
                    0xbdf2fa0b931e7a04,
                    0x60f39c6eae7a9a3c,
                    0x34e97cf1bd62a467,
                    0x13b9e8a487cc4745,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xdb6db6ecdb6db6ca,
                    0x035ffa14db8a4eec,
                    0x5ea2264f581fdd5a,
                    0x401b2e0d73d97883,
                ])),
                Felt::new(BigInteger256([
                    0xdb6db6ecdb6db6ca,
                    0x035ffa14db8a4eec,
                    0x5ea2264f581fdd5a,
                    0x401b2e0d73d97883,
                ])),
                Felt::new(BigInteger256([
                    0xdb6db6ecdb6db6ca,
                    0x035ffa14db8a4eec,
                    0x5ea2264f581fdd5a,
                    0x401b2e0d73d97883,
                ])),
                Felt::new(BigInteger256([
                    0xdb6db6ecdb6db6ca,
                    0x035ffa14db8a4eec,
                    0x5ea2264f581fdd5a,
                    0x401b2e0d73d97883,
                ])),
                Felt::new(BigInteger256([
                    0xfffffffd00000003,
                    0xfb38ec08fffb13fc,
                    0x99ad88181ce5880f,
                    0x5bc8f5f97cd877d8,
                ])),
                Felt::new(BigInteger256([
                    0xfffffffd00000003,
                    0xfb38ec08fffb13fc,
                    0x99ad88181ce5880f,
                    0x5bc8f5f97cd877d8,
                ])),
                Felt::new(BigInteger256([
                    0xfffffffd00000003,
                    0xfb38ec08fffb13fc,
                    0x99ad88181ce5880f,
                    0x5bc8f5f97cd877d8,
                ])),
                Felt::new(BigInteger256([
                    0xfffffffd00000003,
                    0xfb38ec08fffb13fc,
                    0x99ad88181ce5880f,
                    0x5bc8f5f97cd877d8,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xa5a06672dbac8a80,
                    0x83869481ae0e0b93,
                    0xe347807b58724a7c,
                    0x2edcc34bace1c311,
                ])),
                Felt::new(BigInteger256([
                    0x2ea5e0ede90edd43,
                    0x0d035d277fce9e55,
                    0xd4d89686c9246ebe,
                    0x2d318fcf866b471d,
                ])),
                Felt::new(BigInteger256([
                    0xf7e06075ca257dae,
                    0x7d1145141bb32e13,
                    0x0fa535dbeb22d94f,
                    0x1cc604f17d99e430,
                ])),
                Felt::new(BigInteger256([
                    0x0595143236ca9c3e,
                    0xbd245e62e83f42f5,
                    0xc32fafab601be9e6,
                    0x3e32a16570527392,
                ])),
                Felt::new(BigInteger256([
                    0xdc85b578f1e716af,
                    0x19f5f9ea3d18b26d,
                    0xe56bfe8d734d2eda,
                    0x3af2bac283efe7f7,
                ])),
                Felt::new(BigInteger256([
                    0xe14acfa06a8ab228,
                    0x7b199fad016599cf,
                    0x3371f163a79f927b,
                    0x36047f9b58e9014b,
                ])),
                Felt::new(BigInteger256([
                    0x57c524a066bd4aca,
                    0xfebc2f0d23c988df,
                    0xae4b787ce8f18b45,
                    0x0062000b5407e94b,
                ])),
                Felt::new(BigInteger256([
                    0x516240f1e60c00bf,
                    0x3453e58369e61444,
                    0x7a15564df0e8f50f,
                    0x260d76a062c9599c,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x26b748cec909ee9f,
                    0x2923aa8b97eb274e,
                    0x58497d8fd4883ac2,
                    0x63901920698d5bdc,
                ])),
                Felt::new(BigInteger256([
                    0xdb4af838eb2a72ee,
                    0xfd85b109925e1b99,
                    0xf73c87521f841b88,
                    0x2986e25e39226ace,
                ])),
                Felt::new(BigInteger256([
                    0x5c2ecb88db31cbeb,
                    0x46a3d77875d93950,
                    0xcfe2db087c740077,
                    0x33c31f4d8b7a3875,
                ])),
                Felt::new(BigInteger256([
                    0x8e1d43c7b42122b5,
                    0x7907fb0cfda73f66,
                    0x7e927095abc8a2e4,
                    0x318a151543d9b450,
                ])),
                Felt::new(BigInteger256([
                    0x2802d884df9b5301,
                    0x4281f7414394005d,
                    0x1230e17d3c53acf1,
                    0x262492f8cf6e8f1f,
                ])),
                Felt::new(BigInteger256([
                    0x03d394eca9a184fe,
                    0xaa2fb55c83794f74,
                    0x614ab14890352cd8,
                    0x0f281338b012b774,
                ])),
                Felt::new(BigInteger256([
                    0xd0e3cb2fa82f590b,
                    0x64d23a8e8276b853,
                    0x4ed7e561992a4f69,
                    0x6a7d9635a67206ab,
                ])),
                Felt::new(BigInteger256([
                    0xd4426ef197d33769,
                    0x49b706f06c6ed780,
                    0x5de7a344f1a75ce4,
                    0x72be6d0ce8bda4ed,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xe1f6d2b6d8ee0828,
                    0x155b81fd06ece3d1,
                    0xf9132037f0a02244,
                    0x1233c9c3df618cd2,
                ])),
                Felt::new(BigInteger256([
                    0x4a4e3d8d733c4c07,
                    0xb59a5495a9210abb,
                    0x4bba2a3976d7a149,
                    0x500043be3a099c1d,
                ])),
                Felt::new(BigInteger256([
                    0x441372941e9e30c9,
                    0xd946ca7327c9f5ae,
                    0xed5f63c384e19ae1,
                    0x4b6666452ca1d05d,
                ])),
                Felt::new(BigInteger256([
                    0xd9236da3f457bbb3,
                    0xf5bcd23c3f10d545,
                    0xb941d744338ad976,
                    0x25cc7d6d15eb7364,
                ])),
                Felt::new(BigInteger256([
                    0x02b2226901f19867,
                    0xb07ec0d3a8c0e3b7,
                    0x7ca595d0411ccfa9,
                    0x1394ed3e1de54095,
                ])),
                Felt::new(BigInteger256([
                    0x376976388e627ff5,
                    0xdb415cf4f3d4f19d,
                    0x9301b983719ce63d,
                    0x210309fe78fa5d20,
                ])),
                Felt::new(BigInteger256([
                    0x8067cf5e9561f0e7,
                    0x7cea12f5bc936705,
                    0x0c954387f7baaf21,
                    0x58be8f48f00691b6,
                ])),
                Felt::new(BigInteger256([
                    0x8b51ec547c6c17b3,
                    0xbc10330632805797,
                    0xd635cb9f556fcad6,
                    0x3e8acbe20569ef6a,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xd40f7b36d5d6baea,
                    0xd0807ac240a07cd9,
                    0xf0e64d264ab55f3c,
                    0x1b75644834cefe18,
                ])),
                Felt::new(BigInteger256([
                    0xc4f97bc877b23636,
                    0x92c318b7bfb47f75,
                    0x0af8e764be267090,
                    0x35595b08ed2f5b8e,
                ])),
                Felt::new(BigInteger256([
                    0x96e0dfaccec31705,
                    0x2dd137a946663400,
                    0x8fee73db7f68fe9b,
                    0x30d06ad848d686a3,
                ])),
                Felt::new(BigInteger256([
                    0x4b122dfc9233165c,
                    0xb16297298fcd63ec,
                    0x846fa69b3f76147a,
                    0x1654f15feceadc0b,
                ])),
                Felt::new(BigInteger256([
                    0xaff357a8157c7a1c,
                    0xcefaf4d5256908c1,
                    0xcc7fd46fa2011a7a,
                    0x62cd9790f1379c4c,
                ])),
                Felt::new(BigInteger256([
                    0x7a7c68b89a81db21,
                    0xb167e0d0317cf2d7,
                    0x78fc69f2f1bd2ff0,
                    0x651a2c2dd7b2a0e0,
                ])),
                Felt::new(BigInteger256([
                    0x3fd61c10377d5f7e,
                    0xf7b5b1d1266fe15b,
                    0x9753421ebe5a6e0a,
                    0x12fdd516f2fcca5e,
                ])),
                Felt::new(BigInteger256([
                    0xc304c41d1da20d10,
                    0x27866affc08596e1,
                    0xcaee993f1181e5cf,
                    0x129c22327a483945,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x5950b6d402da315c,
                    0xdc9343eb13d6ef51,
                    0xb7eee8601b9f0fe3,
                    0x509d6d8bfb81b23d,
                ])),
                Felt::new(BigInteger256([
                    0x610449b78e0fba8f,
                    0x98e998f01bce0b0d,
                    0xbafc544d6c945369,
                    0x5546b5e4dbc7605d,
                ])),
                Felt::new(BigInteger256([
                    0xfe4218b1219d6a01,
                    0x6aa351b98aa0f849,
                    0x2e72a6a1570c39a0,
                    0x30f80b1aa19bd925,
                ])),
                Felt::new(BigInteger256([
                    0x8076cad1e5e4b11e,
                    0x5555a3fc03301cc0,
                    0xfff7e54c71a26f9e,
                    0x5654664d0ca507e7,
                ])),
                Felt::new(BigInteger256([
                    0xdabd6c2ae9ea37a0,
                    0x38cdabaf57b19a75,
                    0x8739866f1ff5e608,
                    0x4bf39db2b02a8c9d,
                ])),
                Felt::new(BigInteger256([
                    0x2b86b43504c1463b,
                    0xf826680447b43710,
                    0x5088dcbe081052f5,
                    0x49502288c188b10b,
                ])),
                Felt::new(BigInteger256([
                    0xc8faaa134c3ebeb8,
                    0x04252aaecdd99e95,
                    0x5fe9aa19a1a52d71,
                    0x215738f05dff6737,
                ])),
                Felt::new(BigInteger256([
                    0x2eab7a6af860692b,
                    0x1ac7d65ea53b24ca,
                    0x4a8f9237698d1e6a,
                    0x17cb04da3c553e16,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x1b1fbce9eefce81f,
                    0xe0ef916197c48226,
                    0xac8548f0fe12b951,
                    0x5a0601ce4448cb19,
                ])),
                Felt::new(BigInteger256([
                    0x87df6e8b2279753b,
                    0xb74c6fe7b60cb074,
                    0x86de26e51a320aea,
                    0x205d12062be7e0bf,
                ])),
                Felt::new(BigInteger256([
                    0xb23d8d614fb80170,
                    0x42109c7567a59a95,
                    0x50138e84dd939df3,
                    0x1d546eb8ed55b37d,
                ])),
                Felt::new(BigInteger256([
                    0x75b78394aca82dfd,
                    0x3cbadab379734dc7,
                    0x59450ca4a2f3a5bb,
                    0x39d0e6c4813e4e5a,
                ])),
                Felt::new(BigInteger256([
                    0x739eb4dfdaee8f24,
                    0xd41742619b64f578,
                    0x548646dbc959de45,
                    0x6e374e80b6da5597,
                ])),
                Felt::new(BigInteger256([
                    0xe31bbaa84b638978,
                    0x95920967d01edbf1,
                    0x6872103367a17fcb,
                    0x00e1167fd056c9ea,
                ])),
                Felt::new(BigInteger256([
                    0x39b05327055dd0dc,
                    0x822557b76be91937,
                    0xc728ff0de9507944,
                    0x3f7952bd7e0f3c62,
                ])),
                Felt::new(BigInteger256([
                    0x5229417ffb133974,
                    0xc27cf24ee6e4d97c,
                    0x4b3be5793bfdc4fa,
                    0x65f07f92bd5f0ece,
                ])),
            ],
        ];

        for i in input.iter_mut() {
            apply_sbox(i);
        }

        for (&i, o) in input.iter().zip(output) {
            assert_eq!(i, o);
        }
    }

    #[test]
    fn test_mds() {
        // Generated from https://github.com/Nashtare/anemoi-hash/
        let mut input = [
            [Felt::zero(); 8],
            [Felt::one(); 8],
            [
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
            ],
            [
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::one(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
            ],
            [
                Felt::new(BigInteger256([
                    0x67ef38b77687c790,
                    0xe73d759dc02e53bd,
                    0xfda65cf8c5b69de2,
                    0x618062bb390aec45,
                ])),
                Felt::new(BigInteger256([
                    0x05425cdb5f0984e2,
                    0xa33f0e24acb7757d,
                    0xbaa5b67f30b0e7d6,
                    0x148abc8bbee7a2db,
                ])),
                Felt::new(BigInteger256([
                    0xfc70b64e9d427a89,
                    0x5248963ba15c9fc4,
                    0x54b4410986ade524,
                    0x1c8ec181ffcc3595,
                ])),
                Felt::new(BigInteger256([
                    0xc6562615d527603c,
                    0xb181e043356f28b7,
                    0xc31742242710252c,
                    0x48f3c12cb52b461b,
                ])),
                Felt::new(BigInteger256([
                    0x7c5d7f37b6a1ec55,
                    0xd5fb48d8e3e1e991,
                    0x82578efc45361b50,
                    0x542ec260d03fc840,
                ])),
                Felt::new(BigInteger256([
                    0x991ac5e22d4882b2,
                    0x48735b11f6547ef7,
                    0x80020f667842e12a,
                    0x490e08c6188dc6ed,
                ])),
                Felt::new(BigInteger256([
                    0x23ef801f3aa4192e,
                    0xf64d050a97d3ddeb,
                    0xc9fb100ba5fab504,
                    0x52bdc5ef673f1a08,
                ])),
                Felt::new(BigInteger256([
                    0x9ac2b45929826eb0,
                    0xcd6d2e1bcdc5bde5,
                    0x88c98d5fadfd8342,
                    0x5b5286f6c3e3daf6,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x03a69566bb42e3da,
                    0xa66a90060333ac33,
                    0xd6eefe8e6f325e57,
                    0x04ec7259e886f64b,
                ])),
                Felt::new(BigInteger256([
                    0x96b1dacd62f0265c,
                    0x50f387270a76dacc,
                    0x1462ac42225dd150,
                    0x26cf44c5e7ea1441,
                ])),
                Felt::new(BigInteger256([
                    0x4daf4b1e449ee096,
                    0xbf060d9666efab03,
                    0x6e5e7ee8bc42da2b,
                    0x17940896b823c8ac,
                ])),
                Felt::new(BigInteger256([
                    0xb256ecdac129d759,
                    0x4df53a07e6b5558c,
                    0x49ea3b7ea16bb1a2,
                    0x641a6b1e905d51fa,
                ])),
                Felt::new(BigInteger256([
                    0xacb5fae73c17837d,
                    0xf63f9b486abeac55,
                    0xd2311ea0fe7b036f,
                    0x1103569d9cf56f50,
                ])),
                Felt::new(BigInteger256([
                    0xde903fec2339bd28,
                    0x39125fe870d84daa,
                    0x7067259e10d63d92,
                    0x5dad44904673b0b9,
                ])),
                Felt::new(BigInteger256([
                    0x79652426f6881ed4,
                    0x0a0d8e02839f94e2,
                    0xfd1bbcb311eb4875,
                    0x10d862bdde2b54f1,
                ])),
                Felt::new(BigInteger256([
                    0x2d635c1e63fbdae9,
                    0x47279b2754d2601b,
                    0x533772b0c35a204b,
                    0x3956e96481340c1b,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x7d53682fe5c7d275,
                    0xad28f27a16a9bc88,
                    0xb32b2c7a0a69b237,
                    0x4977a35dedd76ff8,
                ])),
                Felt::new(BigInteger256([
                    0x047867909e78bad7,
                    0x7517d09b397fda2b,
                    0xae5a958145dddfe4,
                    0x1f0db442dcaf9f80,
                ])),
                Felt::new(BigInteger256([
                    0x181b986a6be152e8,
                    0xb1db52e3918824f2,
                    0x777ea50092a21349,
                    0x61015f6dafbf354d,
                ])),
                Felt::new(BigInteger256([
                    0xfed1db057bf8928a,
                    0xa9631bf85ba73bf5,
                    0x13aaa62a7d9d3881,
                    0x2363ca72351c73d1,
                ])),
                Felt::new(BigInteger256([
                    0x98c3dd7739e665bc,
                    0xfc121e24f2f58a42,
                    0xe04ea8e43c00271c,
                    0x1431c662449bb17c,
                ])),
                Felt::new(BigInteger256([
                    0x35adc3ea3a9f0b3e,
                    0x47425d2b5db7a308,
                    0x0fe17d571aa11c35,
                    0x0dcc717969bb80e6,
                ])),
                Felt::new(BigInteger256([
                    0x1421675ae8885b14,
                    0xea68906d8395c08e,
                    0x5608941cb42134f0,
                    0x66dbeaa2270137a9,
                ])),
                Felt::new(BigInteger256([
                    0x9c14111ff1ae3466,
                    0x444c6b47020c0ca0,
                    0x65c0d2aa4e9a0fe1,
                    0x73b13a06b026f701,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xdacba90b227e5312,
                    0xae35062d918acafc,
                    0xd64f4a63be6bf0f5,
                    0x30febfae85d5d4a3,
                ])),
                Felt::new(BigInteger256([
                    0x08d3a575106c80be,
                    0xb1ae57b79721b844,
                    0xbb9efc09d4a55f2d,
                    0x57a42cad0929f24f,
                ])),
                Felt::new(BigInteger256([
                    0x0f6c57821fdd8775,
                    0x83270119d3124901,
                    0x2c2a05c0a7d86d94,
                    0x425d23ff36bf595e,
                ])),
                Felt::new(BigInteger256([
                    0xaba4307ca97b86e1,
                    0x92109d1aa25cafb0,
                    0xa6abf31121aa9e37,
                    0x4019ff20cf7b6c3e,
                ])),
                Felt::new(BigInteger256([
                    0x37f22116b5cebbba,
                    0x6a89b2b29cb6b053,
                    0x25d97509c70af2c3,
                    0x3cfdab848c19d4d1,
                ])),
                Felt::new(BigInteger256([
                    0x1306bc51cd14274f,
                    0xa53f7e9badb48265,
                    0xb1ed495bc9133874,
                    0x6f247bf3ddb1b7e0,
                ])),
                Felt::new(BigInteger256([
                    0x2835371108490a80,
                    0x072ab4a8b8b98c42,
                    0x95af267bd9fc6c2f,
                    0x51869d8a7226d117,
                ])),
                Felt::new(BigInteger256([
                    0x9d7cfca2011a9325,
                    0x5d399e644d35fb48,
                    0x2433fb9a88cdbf06,
                    0x210c8bcc8ff4b090,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x2589c924deb12c7e,
                    0xa802eaeae3ed151b,
                    0x557b18eebafa7596,
                    0x30b4307bee8a308e,
                ])),
                Felt::new(BigInteger256([
                    0x12fd7f1b1f9ab14f,
                    0xa6c2cbc4780bfdb7,
                    0x215de78b7f08e4c7,
                    0x061c563b65f3a4b2,
                ])),
                Felt::new(BigInteger256([
                    0x38c07963b10858e3,
                    0x197c77153e03bb19,
                    0xb433f1b9ec4fdfb3,
                    0x0f5c8c69d59a0f67,
                ])),
                Felt::new(BigInteger256([
                    0x18e00d74533703eb,
                    0xebca68c099850ec5,
                    0xbc0cf09700fa9c01,
                    0x25fbc9308f40e18f,
                ])),
                Felt::new(BigInteger256([
                    0x7dd099ef65693dcc,
                    0x0b2dc2f0407ebe80,
                    0x97f08dd56e5cfc43,
                    0x053f8bea4cf41310,
                ])),
                Felt::new(BigInteger256([
                    0xd690a8b68a355e61,
                    0x1e7bc523ef84a47c,
                    0x31cf809da7f11d87,
                    0x3834660bc595887b,
                ])),
                Felt::new(BigInteger256([
                    0x57d56ae0c533ba92,
                    0x17619aed345c7613,
                    0xb6d69aff47dcc6dc,
                    0x602063e4a8ca8b13,
                ])),
                Felt::new(BigInteger256([
                    0x186b31b47a58b92c,
                    0x2c3f591c95b360c7,
                    0x422d829e7ecf3134,
                    0x2173dca837d459b3,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xcfc925d0608db344,
                    0x31f244760dd95319,
                    0x044393021fb02401,
                    0x4e067c79592b9c6e,
                ])),
                Felt::new(BigInteger256([
                    0xb54bf428998ed068,
                    0x62cef4476bdc1753,
                    0x78cefba9077503d2,
                    0x0cef6e86cb7e4e99,
                ])),
                Felt::new(BigInteger256([
                    0x5bdd3a1bef8920b2,
                    0x10744717ed27ff94,
                    0xcc758cb8b60ff7e0,
                    0x3599823bc2db219f,
                ])),
                Felt::new(BigInteger256([
                    0x93a70490077d74d2,
                    0xefcda11d87449dee,
                    0x0fee82e12bbf081e,
                    0x385fc7967fccc205,
                ])),
                Felt::new(BigInteger256([
                    0xf0403c02a3e74a99,
                    0xb075e470f5805d4c,
                    0xaecfbff4079dc01f,
                    0x2ff70372419d8cf0,
                ])),
                Felt::new(BigInteger256([
                    0x2c26680ee4b572db,
                    0x03d481430ebf3b3c,
                    0x5d75dd6d6704f894,
                    0x3085f2d5a4d9f634,
                ])),
                Felt::new(BigInteger256([
                    0xbc9ec88874e528fd,
                    0xcede343abf0def35,
                    0xbdfdc129e2c1455e,
                    0x65db31cb163260e0,
                ])),
                Felt::new(BigInteger256([
                    0xdeead0864d2ea73a,
                    0xe383ef94a276c93c,
                    0x383e3ea085964f3d,
                    0x1c6cda061a101e40,
                ])),
            ],
        ];

        let mut input2 = input;

        let output = [
            [Felt::zero(); 8],
            [
                Felt::new(BigInteger256([
                    0x0000000efffffff1,
                    0x17e363d300189c0f,
                    0xff9c57876f8457b0,
                    0x351332208fc5a8c4,
                ])),
                Felt::new(BigInteger256([
                    0x0000000efffffff1,
                    0x17e363d300189c0f,
                    0xff9c57876f8457b0,
                    0x351332208fc5a8c4,
                ])),
                Felt::new(BigInteger256([
                    0x0000000efffffff1,
                    0x17e363d300189c0f,
                    0xff9c57876f8457b0,
                    0x351332208fc5a8c4,
                ])),
                Felt::new(BigInteger256([
                    0x0000000efffffff1,
                    0x17e363d300189c0f,
                    0xff9c57876f8457b0,
                    0x351332208fc5a8c4,
                ])),
                Felt::new(BigInteger256([
                    0x0000000efffffff1,
                    0x17e363d300189c0f,
                    0xff9c57876f8457b0,
                    0x351332208fc5a8c4,
                ])),
                Felt::new(BigInteger256([
                    0x0000000efffffff1,
                    0x17e363d300189c0f,
                    0xff9c57876f8457b0,
                    0x351332208fc5a8c4,
                ])),
                Felt::new(BigInteger256([
                    0x0000000efffffff1,
                    0x17e363d300189c0f,
                    0xff9c57876f8457b0,
                    0x351332208fc5a8c4,
                ])),
                Felt::new(BigInteger256([
                    0x0000000efffffff1,
                    0x17e363d300189c0f,
                    0xff9c57876f8457b0,
                    0x351332208fc5a8c4,
                ])),
            ],
            [
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::new(BigInteger256([
                    0x0000000efffffff1,
                    0x17e363d300189c0f,
                    0xff9c57876f8457b0,
                    0x351332208fc5a8c4,
                ])),
                Felt::new(BigInteger256([
                    0x0000000efffffff1,
                    0x17e363d300189c0f,
                    0xff9c57876f8457b0,
                    0x351332208fc5a8c4,
                ])),
                Felt::new(BigInteger256([
                    0x0000000efffffff1,
                    0x17e363d300189c0f,
                    0xff9c57876f8457b0,
                    0x351332208fc5a8c4,
                ])),
                Felt::new(BigInteger256([
                    0x0000000efffffff1,
                    0x17e363d300189c0f,
                    0xff9c57876f8457b0,
                    0x351332208fc5a8c4,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x0000000efffffff1,
                    0x17e363d300189c0f,
                    0xff9c57876f8457b0,
                    0x351332208fc5a8c4,
                ])),
                Felt::new(BigInteger256([
                    0x0000000efffffff1,
                    0x17e363d300189c0f,
                    0xff9c57876f8457b0,
                    0x351332208fc5a8c4,
                ])),
                Felt::new(BigInteger256([
                    0x0000000efffffff1,
                    0x17e363d300189c0f,
                    0xff9c57876f8457b0,
                    0x351332208fc5a8c4,
                ])),
                Felt::new(BigInteger256([
                    0x0000000efffffff1,
                    0x17e363d300189c0f,
                    0xff9c57876f8457b0,
                    0x351332208fc5a8c4,
                ])),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
                Felt::zero(),
            ],
            [
                Felt::new(BigInteger256([
                    0xb91574748f8c6235,
                    0x485a64fa4ff16eee,
                    0x114cd3df5c0e3778,
                    0x2e3aefd79a3454c7,
                ])),
                Felt::new(BigInteger256([
                    0xc62d09800a32168f,
                    0xbf4d35b3f983f1ed,
                    0xc194329b301b90e7,
                    0x17cb8b4c2db53459,
                ])),
                Felt::new(BigInteger256([
                    0xa26c64687c95f888,
                    0xc0c9a01f5d53bc71,
                    0xa95bd884ae58758a,
                    0x0a5a87cee6ebc4f7,
                ])),
                Felt::new(BigInteger256([
                    0x2e1c3b71e189a129,
                    0x2e9becd733258ec0,
                    0xcdb21f27ceee921f,
                    0x415a92df182f1e48,
                ])),
                Felt::new(BigInteger256([
                    0x67a82c5fded73e3a,
                    0xb8d862cfd561c967,
                    0xe275aefe19b1b68c,
                    0x0b58df25a8407d3b,
                ])),
                Felt::new(BigInteger256([
                    0x82bd84925943e89a,
                    0xfa14460210617bde,
                    0x0a92897720a5b252,
                    0x61e14ead6ed5e528,
                ])),
                Felt::new(BigInteger256([
                    0xb5243fb6eaa1abef,
                    0xc83fac2c65d2cf2b,
                    0x9c2f0b2baf221fe1,
                    0x6a200f6554868a0b,
                ])),
                Felt::new(BigInteger256([
                    0x2d9f6268d5b9ed6e,
                    0xd09c044473379215,
                    0x308b2e70e33db832,
                    0x110ba74a32e3e1ba,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x4cbbcd03eaee516a,
                    0x6410f4688faec9af,
                    0x0c1fd305d17370d6,
                    0x2b6a13af74f819fc,
                ])),
                Felt::new(BigInteger256([
                    0x5402bfd75bab6130,
                    0xf7a870d9486f7d84,
                    0x34eeedc35bcb79bc,
                    0x2d822c0127226935,
                ])),
                Felt::new(BigInteger256([
                    0xcb68f330a51ef2b5,
                    0xa52fb5197374315d,
                    0x3cdb0c3a8fe90c63,
                    0x1219d8147e124971,
                ])),
                Felt::new(BigInteger256([
                    0xcc6f19391029a9ab,
                    0x2bddb91933a90064,
                    0x2e465f3b76de9113,
                    0x158632221de8d03d,
                ])),
                Felt::new(BigInteger256([
                    0xb8de0d0796001c43,
                    0x0cb2ae0cde5befc6,
                    0x2411738591a320e3,
                    0x2c622f49aaac7144,
                ])),
                Felt::new(BigInteger256([
                    0x9be535db3c60382c,
                    0xedb2936b007d22ac,
                    0xac3d5567e7d8a046,
                    0x2974d114efccda02,
                ])),
                Felt::new(BigInteger256([
                    0x03694354ca1f3530,
                    0x263958422c23ae70,
                    0x9716629705ffc834,
                    0x5062a2b5f257e124,
                ])),
                Felt::new(BigInteger256([
                    0x063a977e78550f06,
                    0x7168a0a5e1508c19,
                    0xd00265a769f282c3,
                    0x548ace30d020f3af,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xae7891a8cfeceab7,
                    0x86e7d0bc8634807c,
                    0xf1d57663d17dda24,
                    0x38ea7fd94c825dae,
                ])),
                Felt::new(BigInteger256([
                    0x9231ee98b3a2aa2f,
                    0x85fb46d4c65898a5,
                    0xcd02842cd611f2c8,
                    0x47749cb543559481,
                ])),
                Felt::new(BigInteger256([
                    0x1efd7a848ed3bade,
                    0x199ed998c707547d,
                    0x62e1dc8ad9c6c7d8,
                    0x18b4976ad9c0efb9,
                ])),
                Felt::new(BigInteger256([
                    0xcd68db98e255d362,
                    0x5b14bc4a99ee07ad,
                    0xf0596490aec35c4f,
                    0x7231fea56eb84ada,
                ])),
                Felt::new(BigInteger256([
                    0x4c42e5edb437004f,
                    0xb341328cbe4b07a2,
                    0x38aa295d03115e2f,
                    0x3cd72d5642054330,
                ])),
                Felt::new(BigInteger256([
                    0x82c67f29fde07caa,
                    0x5525077a84b712ce,
                    0x45978084b75b37a1,
                    0x447ab7334a5719c6,
                ])),
                Felt::new(BigInteger256([
                    0xdc97ac805a6bc1d6,
                    0x3f2664ff3b38aea1,
                    0x9b04d272b5b8ae26,
                    0x085905f596c75c25,
                ])),
                Felt::new(BigInteger256([
                    0xcaf0a37c1aa0c44f,
                    0x4256a9f15e05084d,
                    0xcd628e4b7a88a4bd,
                    0x072576943cbb1450,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0x05648efd6f18775a,
                    0x212a4b5fb5ec1058,
                    0x4498a30a2adc7de3,
                    0x71e23bc2ee184693,
                ])),
                Felt::new(BigInteger256([
                    0xffeb5914eabc0f28,
                    0x685cb9866392ad9f,
                    0x1e613effde315402,
                    0x516897fff3892a3e,
                ])),
                Felt::new(BigInteger256([
                    0x8b22ca783f9b36b0,
                    0x37b621aa5df0477b,
                    0xe56a21969dc3ab2b,
                    0x1baa8b3786ee50b2,
                ])),
                Felt::new(BigInteger256([
                    0xc65c2afc4c6b71ca,
                    0xde20c5f8db68563c,
                    0xabcfe6aa5a633630,
                    0x17c1e6da656d3c7b,
                ])),
                Felt::new(BigInteger256([
                    0x1e0c4fedf8fe8b44,
                    0xab419c1bd7030235,
                    0x67e33e11ece672ea,
                    0x5df43dab9736f0b3,
                ])),
                Felt::new(BigInteger256([
                    0x6eaaaad9dc3d8b02,
                    0xda3fa4394880ff64,
                    0x4e76881d25925a04,
                    0x6a4556ef0cee5dcb,
                ])),
                Felt::new(BigInteger256([
                    0x741c3b9369ecbcf9,
                    0xd8cbdc3c6f88e530,
                    0xa20e16af496d072a,
                    0x61306a8b87707348,
                ])),
                Felt::new(BigInteger256([
                    0x73da417396c4b175,
                    0x3a9289c3a3852919,
                    0xd6137614c19ab899,
                    0x568c0ff9811ec8b8,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xf4a863655a019b53,
                    0xf1603b18a4915954,
                    0xe02dddab0bf115c4,
                    0x538f53c983d71b76,
                ])),
                Felt::new(BigInteger256([
                    0xee1b6ed813249780,
                    0xe8618d1594e45dad,
                    0xe7a9552f8af9ad37,
                    0x0bb1b7d3d2730e53,
                ])),
                Felt::new(BigInteger256([
                    0xd5ac96742071c9b6,
                    0xf5d774f60788913a,
                    0x4c16f2c8d6b83d33,
                    0x352811f14a2cc2e2,
                ])),
                Felt::new(BigInteger256([
                    0x0ea640fb84369daf,
                    0xda0aac712796f49b,
                    0x3da5d5c27554a23b,
                    0x1d10a40da0e30c71,
                ])),
                Felt::new(BigInteger256([
                    0xd8ae44d0745644ad,
                    0x086a131510c75fa1,
                    0xce5f1a4a253f8b8a,
                    0x031fd85971aa0596,
                ])),
                Felt::new(BigInteger256([
                    0xef93ca99a8ff0a77,
                    0x0df48150199e8953,
                    0x57e00b1187f59921,
                    0x4cd53bde780ca9c9,
                ])),
                Felt::new(BigInteger256([
                    0x4add5db643c7e36d,
                    0xbf508b135255b67e,
                    0xc8935a94f7bf3509,
                    0x5bb46a5e8d7aa71c,
                ])),
                Felt::new(BigInteger256([
                    0x4d4dad87e9103cd2,
                    0xe1f1dd3b59db5d7c,
                    0x64484435058fb30e,
                    0x064759be8ec346f4,
                ])),
            ],
            [
                Felt::new(BigInteger256([
                    0xf7c49be3efa72383,
                    0x89d9be3ce9d82f64,
                    0xac1ba8a7f99ca7e0,
                    0x137f5041acedfc7d,
                ])),
                Felt::new(BigInteger256([
                    0xa7d2a8d8b9bbf487,
                    0xed7c5ef3911e3815,
                    0xd83ebf12572defe3,
                    0x4192ff621c9d51b4,
                ])),
                Felt::new(BigInteger256([
                    0xaefa66c884ce6d42,
                    0xe51805f1d3b6d1b3,
                    0xe8e47889244aa36d,
                    0x48f93fb3043f0dbc,
                ])),
                Felt::new(BigInteger256([
                    0xe19fc10769c42afa,
                    0x713f5b643451666e,
                    0x04bd034f69456b5a,
                    0x5936592a654b65f5,
                ])),
                Felt::new(BigInteger256([
                    0x775b85aedfadca14,
                    0xafe355f0f340c0d5,
                    0xfeb1d39c4ee694bd,
                    0x0356ed0a372cc28e,
                ])),
                Felt::new(BigInteger256([
                    0x007d4943b802bdf7,
                    0x2392847178c810c4,
                    0xd28f8fe28fbc7688,
                    0x17fef53d253303c6,
                ])),
                Felt::new(BigInteger256([
                    0x5d5436441930527c,
                    0xb946e32ff2a5faa7,
                    0x0f0b9cccdcfa708c,
                    0x0f4abb384182c51b,
                ])),
                Felt::new(BigInteger256([
                    0x3264a6b859f30519,
                    0x0159b0de69c4beae,
                    0x974e537ea802a91b,
                    0x25b0f1f6e43427ce,
                ])),
            ],
        ];

        for i in input.iter_mut() {
            apply_mds(i);
        }
        for i in input2.iter_mut() {
            apply_naive_mds(i);
        }

        for (index, (&i_1, i_2)) in input.iter().zip(input2).enumerate() {
            assert_eq!(output[index], i_1);
            assert_eq!(output[index], i_2);
        }
    }
}
